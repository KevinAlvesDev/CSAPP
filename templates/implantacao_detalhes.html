{% extends "base.html" %}

{% block title %}Detalhes da Implantação - {{ implantacao.nome_empresa }}{% endblock %}

{% block head_extra %}
<style>
    /* Estilos CSS específicos desta página (Timeline, Comentários, etc.) - Inalterado */
    .timeline-list { list-style-type: none; padding-left: 0; }
    .timeline-item { display: flex; padding: 12px 0; border-bottom: 1px solid var(--input-border); }
    .timeline-item:last-child { border-bottom: none; }
    .timeline-icon { flex-shrink: 0; width: 40px; height: 40px; background-color: var(--input-border); color: var(--accent-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-right: 15px; }
    .timeline-content { flex-grow: 1; min-width: 0; }
    .timeline-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .timeline-usuario { font-weight: 600; color: var(--body-color); }
    .timeline-data { font-size: 0.8rem; color: #8b949e; flex-shrink: 0; padding-left: 10px; }
    body.light-mode .timeline-data { color: #555; }
    .timeline-detalhes { font-size: 0.9rem; margin-bottom: 0; color: var(--body-color); opacity: 0.9; white-space: pre-wrap; word-break: break-word; }
    .comment-text { max-height: 100px; overflow: hidden; transition: max-height 0.3s ease-out; white-space: pre-wrap; word-break: break-word; }
    .comment-text.expanded { max-height: 2000px; /* Ajuste conforme necessário */ transition: max-height 0.5s ease-in; }
    .comment-image { max-height: 200px; width: auto; cursor: zoom-in; display: block; /* Garante que seja bloco */ margin-top: 5px; /* Espaçamento */ }
    .task-tag { font-size: 0.75em; vertical-align: middle; }
    .task-label-container { display: flex; align-items: center; flex-grow: 1; min-width: 0; }
    .task-label-container .form-check-label { margin-right: 0.5rem; word-break: break-word; }
    .task-label-container .task-tag { margin-left: auto; flex-shrink: 0; }
    .list-group-flush .list-group-item:last-child { border-bottom-width: 0; }
    /* Adiciona estilo para feedback de salvamento/carregamento nos botões */
    .btn .spinner-border-sm { vertical-align: text-bottom; }
    /* Estilo para o botão Marcar Todas */
    .btn-marcar-todas {
        font-size: 0.8rem;
        padding: 0.2rem 0.5rem;
    }
</style>
{% endblock %}


{% block content %}
<header class="header-bg p-3 shadow-sm d-flex justify-content-end align-items-center position-relative">
    <h1 class="main-title mb-0 fs-4" style="position: absolute; left: 50%; transform: translateX(-50%); white-space: nowrap;">CS ONBOARDING DETALHES</h1>
    <div class="d-flex align-items-center">

        {# Botão para abrir sidebar em telas pequenas #}
        <button class="btn btn-outline-secondary d-lg-none me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar" aria-controls="mobileSidebar"> <i class="bi bi-list"></i> </button>

        <div class="dropdown ms-2">
            <button class="btn btn-outline-secondary rounded-circle p-0" type="button" id="userMenuDropdownDetails" data-bs-toggle="dropdown" aria-expanded="false" title="Menu" style="width: 40px; height: 40px; border: 2px solid var(--accent-color); overflow: hidden;">
                {# g.perfil é injetado pelo decorator @login_required #}
                {% if g.perfil.foto_url %}
                    {# ATUALIZADO: Cache Buster Adicionado #}
                    <img src="{{ g.perfil.foto_url }}?v={{ range(1, 10000) | random }}" alt="Foto de Perfil" style="width: 100%; height: 100%; object-fit: cover;">
                {% else %}
                    <i class="bi bi-person-fill" style="font-size: 1.5rem; color: var(--accent-color);"></i>
                {% endif %}
            </button>
            
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenuDropdownDetails">
                 <li><a class="dropdown-item" href="{{ url_for('profile.perfil') }}"><i class="bi bi-person-circle me-2"></i> Editar Perfil</a></li>

                 {# Links Condicionais para Gestão #}
                 {% if g.perfil and g.perfil.perfil_acesso in ['Administrador', 'Gerente', 'Coordenador'] %}
                      <li><a class="dropdown-item text-primary" href="#" data-bs-toggle="modal" data-bs-target="#modalGerenciarUsuarios"><i class="bi bi-people-fill me-2"></i> Usuários</a></li>
                     <li><a class="dropdown-item text-info" href="{{ url_for('analytics.analytics_dashboard') }}"><i class="bi bi-graph-up me-2"></i> Analytics Gerencial</a></li>
                     {# Links Gamificação #}
                     <li><a class="dropdown-item text-warning" href="{{ url_for('gamification.manage_gamification_metrics') }}"><i class="bi bi-pencil-square me-2"></i> Métricas Gamificação</a></li>
                     <li><a class="dropdown-item text-success" href="{{ url_for('gamification.gamification_report') }}"><i class="bi bi-clipboard-data me-2"></i> Relatório Gamificação</a></li>
                 {% endif %}
                 {# Fim dos Links Condicionais #}

                 <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalGamificacao"><i class="bi bi-trophy-fill me-2"></i> Critérios Gamificação</a></li>
                 <li><hr class="dropdown-divider"></li>
                 <li><a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}"><i class="bi bi-box-arrow-right me-2"></i> Sair</a></li>
            </ul>
            </div>
    </div>
</header>
{# Layout Principal (Sidebar + Conteúdo) #}
<div class="d-flex">
    {# Sidebar #}
    <div class="offcanvas-lg offcanvas-start sidebar-bg d-lg-block" tabindex="-1" id="mobileSidebar" aria-labelledby="mobileSidebarLabel" style="width: 250px;">
        <div class="offcanvas-header header-bg">
            <h5 class="offcanvas-title" id="mobileSidebarLabel" style="color: var(--body-color);">Opções</h5>
            <button type="button" class="btn-close btn-close-dark" data-bs-dismiss="offcanvas" data-bs-target="#mobileSidebar" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body d-flex flex-column p-3">
            {# Link Voltar #}
            {# ATUALIZADO: url_for('main.dashboard') #}
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-primary mb-3 w-100"> <i class="bi bi-arrow-left me-2"></i> Dashboard </a>

            {# Ações Rápidas (Abrir Modais) #}
            <p class="text-secondary small mt-3 mb-2">Ações Rápidas</p>
            <ul class="list-group list-group-flush mb-4">
                {# Adicionar Tarefa #}
                <li class="list-group-item"> <button class="btn btn-sm btn-link text-decoration-none p-0" data-bs-toggle="modal" data-bs-target="#adicionarTarefaModal"> <i class="bi bi-plus-circle me-2"></i> Adicionar Tarefa </button> </li>
                {# Editar Detalhes #}
                <li class="list-group-item">
                    <button class="btn btn-sm btn-link text-decoration-none p-0"
                        data-bs-toggle="modal" data-bs-target="#modalDetalhesEmpresa"
                        data-id="{{ implantacao.id }}"
                        data-nome="{{ implantacao.nome_empresa }}"
                        data-responsavel="{{ implantacao.responsavel_cliente | default('') }}"
                        data-cargo="{{ implantacao.cargo_responsavel | default('') }}"
                        data-telefone="{{ implantacao.telefone_responsavel | default('') }}"
                        data-email="{{ implantacao.email_responsavel | default('') }}"
                        data-inicio-implantacao="{{ implantacao.data_criacao_iso | default('') }}"
                        data-inicio-producao="{{ implantacao.data_inicio_producao_iso | default('') }}"
                        data-final-implantacao="{{ implantacao.data_final_implantacao_iso | default('') }}"
                        data-chave-oamd="{{ implantacao.chave_oamd | default('') }}"
                        data-catraca="{{ implantacao.catraca | default('') }}"
                        data-facial="{{ implantacao.facial | default('') }}"
                        data-nivel-receita="{{ implantacao.nivel_receita | default('') }}"
                        data-valor-atribuido="{{ implantacao.valor_atribuido | default('') }}"
                        data-id-favorecido="{{ implantacao.id_favorecido | default('') }}"
                        data-tela-apoio-link="{{ implantacao.tela_apoio_link | default('') }}"
                        data-resp-estrategico-nome="{{ implantacao.resp_estrategico_nome | default('') }}"
                        data-resp-onb-nome="{{ implantacao.resp_onb_nome | default('') }}"
                        data-resp-estrategico-obs="{{ implantacao.resp_estrategico_obs | default('') }}"
                        data-contatos="{{ implantacao.contatos | default('') }}"
                        data-seguimento="{{ implantacao.seguimento | default('') }}"
                        data-tipos-planos="{{ implantacao.tipos_planos | default('') }}"
                        data-modalidades="{{ implantacao.modalidades | default('') }}"
                        data-horarios-func="{{ implantacao.horarios_func | default('') }}"
                        data-formas-pagamento="{{ implantacao.formas_pagamento | default('') }}"
                        data-diaria="{{ implantacao.diaria | default('') }}"
                        data-freepass="{{ implantacao.freepass | default('') }}"
                        data-alunos-ativos="{{ implantacao.alunos_ativos | default(0) }}"
                        data-sistema-anterior="{{ implantacao.sistema_anterior | default('') }}"
                        data-importacao="{{ implantacao.importacao | default('') }}"
                        data-recorrencia-usa="{{ implantacao.recorrencia_usa | default('') }}"
                        data-boleto="{{ implantacao.boleto | default('') }}"
                        data-nota-fiscal="{{ implantacao.nota_fiscal | default('') }}">
                        <i class="bi bi-pencil-square me-2"></i> Editar Detalhes
                    </button>
                </li>
                {# Ações Condicionais de Status #}
                {% if implantacao.status == 'andamento' %}
                <li class="list-group-item"> <button class="btn btn-sm btn-link text-success text-decoration-none p-0" data-bs-toggle="modal" data-bs-target="#modalFinalizar"> <i class="bi bi-check-circle me-2"></i> Finalizar </button> </li>
                <li class="list-group-item"> <button class="btn btn-sm btn-link text-danger text-decoration-none p-0" data-bs-toggle="modal" data-bs-target="#modalParar"> <i class="bi bi-stop-circle me-2"></i> Parar </button> </li>
                {% elif implantacao.status == 'parada' %}
                <li class="list-group-item"> <button class="btn btn-sm btn-link text-primary text-decoration-none p-0" data-bs-toggle="modal" data-bs-target="#modalRetomar"> <i class="bi bi-play-circle me-2"></i> Retomar </button> </li>
                {% endif %}
                {# Excluir Implantação #}
                <li class="list-group-item">
                    <button class="btn btn-sm btn-link text-danger text-decoration-none p-0" data-bs-toggle="modal" data-bs-target="#modalExcluirImplantacao">
                        <i class="bi bi-trash-fill me-2"></i> Excluir Implantação
                    </button>
                </li>
            </ul>

            {# Detalhes Empresa #}
            <h6 class="text-secondary border-bottom pb-2 mb-3 mt-3">Detalhes da Empresa</h6>
            <ul class="list-unstyled small sidebar-info-list">
                <li><i class="bi bi-building me-2"></i><strong>Empresa:</strong> {{ implantacao.nome_empresa }}</li>
                <li><i class="bi bi-person-workspace me-2"></i><strong>CS:</strong> {{ implantacao.usuario_cs }}</li>
                <li><i class="bi bi-tag me-2"></i><strong>Tipo:</strong> {{ 'Imediata' if implantacao.tipo == 'agora' else 'Futura' }}</li>
                <li><i class="bi bi-calendar-check me-2"></i><strong>Criação:</strong> {{ implantacao.data_criacao_fmt_d }}</li>
                {% if implantacao.status == 'finalizada' %}
                    <li><i class="bi bi-calendar-x me-2"></i><strong>Finalização:</strong> {{ implantacao.data_finalizacao_fmt_d }}</li>
                {% elif implantacao.status == 'parada' and implantacao.data_finalizacao %}
                    <li><i class="bi bi-calendar-pause me-2"></i><strong>Pausada em:</strong> {{ implantacao.data_finalizacao_fmt_d }}</li>
                {% endif %}
            </ul>

            <h6 class="text-secondary border-bottom pb-2 mb-3 mt-3">Detalhes do Cliente</h6>
            <ul class="list-unstyled small sidebar-info-list">
                <li><i class="bi bi-person-badge me-2"></i><strong>Responsável:</strong> {{ implantacao.responsavel_cliente | default('N/A') }}</li>
                <li><i class="bi bi-briefcase me-2"></i><strong>Cargo:</strong> {{ implantacao.cargo_responsavel | default('N/A') }}</li>
                <li><i class="bi bi-telephone me-2"></i><strong>Telefone:</strong> {{ implantacao.telefone_responsavel | default('N/A') }}</li>
                <li><i class="bi bi-envelope me-2"></i><strong>E-mail:</strong> {{ implantacao.email_responsavel | default('N/A') }}</li>
            </ul>

            <h6 class="text-secondary border-bottom pb-2 mb-3 mt-3">Datas e Atributos</h6>
            <ul class="list-unstyled small sidebar-info-list">
                <li><i class="bi bi-play-circle-fill me-2"></i><strong>Início Produção:</strong> {{ implantacao.data_inicio_producao_fmt_d }}</li>
                <li><i class="bi bi-calendar-check-fill me-2"></i><strong>Final Previsto:</strong> {{ implantacao.data_final_implantacao_fmt_d }}</li>
                <li><i class="bi bi-key me-2"></i><strong>Chave OAMD:</strong> {{ implantacao.chave_oamd | default('N/A') }}</li>
                <li><i class="bi bi-hdd-stack me-2"></i><strong>Catraca:</strong> {{ implantacao.catraca | default('N/A') }}</li>
                <li><i class="bi bi-person-bounding-box me-2"></i><strong>Facial:</strong> {{ implantacao.facial | default('N/A') }}</li>
            </ul>

            {# Botão Sair #}
            <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-secondary mt-auto w-100"> <i class="bi bi-box-arrow-right me-2"></i> Sair </a>
        </div>
    </div>

    {# Conteúdo Principal #}
    <main class="flex-grow-1 p-4" id="main-content">

        {# Mensagens Flash #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                     <div class="alert alert-{{ 'danger' if category == 'error' else ('warning' if category=='warning' else 'success') }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {# Card de Status e Progresso #}
        <div class="metric-card p-3 rounded shadow-sm mb-4">
            <div class="row align-items-center">
                <div class="col-md-6 mb-3 mb-md-0">
                    <p class="mb-1"><strong>Status:</strong>
                        {# Badges de Status #}
                        {% if implantacao.status == 'finalizada' %} <span class="badge bg-success">Concluído</span>
                        {% elif implantacao.status == 'parada' %} <span class="badge bg-danger">Parada</span>
                        {% elif implantacao.status == 'futura' %} <span class="badge bg-info text-dark">Futura</span>
                        {% else %} <span class="badge bg-warning text-dark">Em Andamento</span> {% endif %}
                    </p>
                    {% if implantacao.status == 'parada' and implantacao.motivo_parada %}
                        <p class="mb-1 small text-danger"> <strong>Motivo:</strong> {{ implantacao.motivo_parada }} </p>
                    {% endif %}
                    <p class="mb-0"><strong>Criação:</strong> {{ implantacao.data_criacao_fmt_dt_hr }}</p>
                </div>
                <div class="col-md-6">
                    <h4 class="h6 mb-2">Progresso Total</h4>
                    <div class="progress" style="height: 30px;">
                         <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: {{ progresso_porcentagem }}%;" aria-valuenow="{{ progresso_porcentagem }}">{{ progresso_porcentagem }}%</div>
                    </div>
                </div>
            </div>
        </div>

        {# --- Abas --- #}
        <ul class="nav nav-tabs" id="detalhesTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="checklist-treinamentos-tab" data-bs-toggle="tab" data-bs-target="#checklist-treinamentos-content" type="button" role="tab">
                    <i class="bi bi-check2-square me-1"></i> Checklist Treinamentos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="checklist-obrigatorio-tab" data-bs-toggle="tab" data-bs-target="#checklist-obrigatorio-content" type="button" role="tab">
                    <i class="bi bi-check-circle-fill me-1"></i> Checklist Obrigatório
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pendencias-tab" data-bs-toggle="tab" data-bs-target="#pendencias-content" type="button" role="tab">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i> Pendências
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline-content" type="button" role="tab">
                    <i class="bi bi-clock-history me-1"></i> Linha do Tempo
                </button>
            </li>
        </ul>

        {# --- Conteúdo das Abas --- #}
        <div class="tab-content" id="detalhesTabContent">

            {# --- Aba Checklist Treinamentos --- #}
            <div class="tab-pane fade show active" id="checklist-treinamentos-content" role="tabpanel" aria-labelledby="checklist-treinamentos-tab">
                <div id="checklist-area-treinamento" class="pt-4">
                    {% if not tarefas_agrupadas_treinamento %}
                        <div class="alert alert-light text-center small py-2" role="alert">Nenhuma tarefa de treinamento encontrada.</div>
                    {% endif %}
                    {% for modulo, tarefas in tarefas_agrupadas_treinamento.items() %}
                    <div class="card metric-card mb-4 shadow-sm">
                        <div class="card-header header-bg d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#collapse-trein-{{ loop.index }}" aria-expanded="false">
                            <h5 class="mb-0 fs-6">{{ modulo }}</h5>
                            <div>
                                <button class="btn btn-outline-success btn-marcar-todas me-2" 
                                        type="button" 
                                        onclick="window.marcarTodasDoModulo(this, 'collapse-trein-{{ loop.index }}')"
                                        title="Marcar todas as tarefas deste módulo como concluídas">
                                    <i class="bi bi-check-all"></i> Marcar Todas
                                </button>
                                
                                <button class="btn btn-outline-danger btn-marcar-todas me-2" 
                                        type="button" 
                                        onclick="window.excluirTodasDoModulo(this, '{{ modulo }}')"
                                        title="Excluir todas as tarefas deste módulo">
                                    <i class="bi bi-trash"></i> Excluir Todas
                                </button>
                                <i class="bi bi-chevron-down"></i>
                            </div>
                        </div>
                        <div id="collapse-trein-{{ loop.index }}" class="collapse" data-modulo="{{ modulo }}">
                            <ul class="list-group list-group-flush list-group-sortable" id="sortable-list-trein-{{ loop.index }}">
                                {% for tarefa in tarefas %}
                                <li class="list-group-item d-flex align-items-start justify-content-between" data-id="{{ tarefa.id }}">
                                    <div class="d-flex flex-column flex-grow-1 me-3">
                                        <div class="d-flex align-items-center mb-2">
                                            <input class="form-check-input me-3 task-checkbox flex-shrink-0" type="checkbox" value="1" id="task-trein-{{ tarefa.id }}" onchange="window.toggleTarefa({{ tarefa.id }}, this)" {% if tarefa.concluida %}checked{% endif %}>
                                            <div class="task-label-container">
                                                <label class="form-check-label {% if tarefa.concluida %}text-decoration-line-through text-success{% endif %}" for="task-trein-{{ tarefa.id }}">
                                                    {{ tarefa.tarefa_filho }}
                                                </label>
                                                {% if tarefa.tag %}
                                                <span class="badge rounded-pill task-tag ms-2 {% if tarefa.tag == 'Ação interna' %} bg-secondary {% elif tarefa.tag == 'Reunião' %} bg-info text-dark {% else %} bg-light text-dark {% endif %}">
                                                    {{ tarefa.tag }}
                                                </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="mt-1" style="margin-left: calc(1.25em + 0.75rem);">
                                            <label class="form-label small text-secondary mb-1">Comentários</label>
                                            <form onsubmit="return false;" class="comment-form mb-2">
                                                <textarea id="comment-text-{{ tarefa.id }}-new" class="form-control form-control-sm" name="comentario" maxlength="8000" rows="2" placeholder="Adicionar comentário..."></textarea>
                                                <input type="file" name="imagem" class="form-control form-control-sm my-1" accept="image/png, image/jpeg, image/gif">
                                                <button class="btn btn-outline-primary btn-sm px-2 py-1" type="button" onclick="window.adicionarComentario({{ tarefa.id }}, '{{ url_for('api.adicionar_comentario', tarefa_id=tarefa.id) }}', this)"> Salvar </button>
                                            </form>
                                            <div class="list-group list-group-flush border rounded-1" id="comment-list-{{ tarefa.id }}" style="max-height: 300px; overflow-y: auto;">
                                                {% if not tarefa.comentarios %}
                                                    <div class="list-group-item list-group-item-action py-1 px-2 small text-secondary fst-italic" id="no-comment-{{ tarefa.id }}"> Nenhum comentário ainda. </div>
                                                {% endif %}
                                                {% for comentario in tarefa.comentarios %}
                                                <div class="list-group-item list-group-item-action py-1 px-2" id="comentario-{{ comentario.id }}">
                                                    <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                                                        <strong class="mb-0 small"> <i class="bi bi-person-fill me-1"></i> {{ comentario.usuario_nome }} </strong>
                                                        <small class="text-secondary">{{ comentario.data_criacao_fmt_d }}</small>
                                                    </div>
                                                    <div class="comment-content-wrapper">
                                                        <p class="mb-1 small comment-text" id="comment-text-{{ comentario.id }}">{{ comentario.texto | safe }}</p>
                                                        {% if comentario.texto and comentario.texto | length > 200 %}
                                                            <button class="btn btn-sm btn-link p-0 small" onclick="toggleComment(this, 'comment-text-{{ comentario.id }}')">Ver mais...</button>
                                                        {% endif %}
                                                        {% if comentario.imagem_url %}
                                                            <a href="{{ comentario.imagem_url }}" target="_blank" title="Clique para ampliar">
                                                                <img src="{{ comentario.imagem_url }}" class="img-fluid rounded mt-1 comment-image">
                                                            </a>
                                                        {% endif %}
                                                    </div>
                                                    {% if comentario.usuario_cs == email_usuario_logado %}
                                                        <button class="btn btn-sm btn-link text-danger p-0 small mt-1" onclick="window.excluirComentario({{ comentario.id }}, '{{ url_for('api.excluir_comentario', comentario_id=comentario.id) }}', this)"> Excluir </button>
                                                    {% endif %}
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center ms-2 flex-shrink-0">
                                        <button class="btn btn-sm btn-outline-danger p-1 me-1" onclick="window.excluirTarefa({{ tarefa.id }}, this)" title="Excluir Tarefa"><i class="bi bi-x-lg"></i></button>
                                        <i class="bi bi-grip-vertical handle" style="cursor: grab;" title="Mover Tarefa"></i>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            {# --- Aba Checklist Obrigatório --- #}
            <div class="tab-pane fade" id="checklist-obrigatorio-content" role="tabpanel" aria-labelledby="checklist-obrigatorio-tab">
                {# Conteúdo da aba Checklist Obrigatório (com botão Marcar Todas) #}
                <div id="checklist-area-obrigatorio" class="pt-4">
                    {% if not tarefas_agrupadas_obrigatorio %}
                        <div class="alert alert-light text-center small py-2" role="alert">Nenhuma tarefa obrigatória encontrada.</div>
                    {% endif %}
                    {% for modulo, tarefas in tarefas_agrupadas_obrigatorio.items() %}
                    <div class="card metric-card mb-4 shadow-sm">
                        <div class="card-header header-bg d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#collapse-obrig-{{ loop.index }}" aria-expanded="false">
                            <h5 class="mb-0 fs-6">{{ modulo }}</h5>
                            <div>
                                {# Botão Marcar Todas para Módulo Obrigatório #}
                                <button class="btn btn-outline-success btn-marcar-todas me-2" 
                                        type="button" 
                                        onclick="window.marcarTodasDoModulo(this, 'collapse-obrig-{{ loop.index }}')"
                                        title="Marcar todas as tarefas deste módulo como concluídas">
                                    <i class="bi bi-check-all"></i> Marcar Todas
                                </button>
                                
                                <button class="btn btn-outline-danger btn-marcar-todas me-2" 
                                        type="button" 
                                        onclick="window.excluirTodasDoModulo(this, '{{ modulo }}')"
                                        title="Excluir todas as tarefas deste módulo">
                                    <i class="bi bi-trash"></i> Excluir Todas
                                </button>
                                <i class="bi bi-chevron-down"></i>
                            </div>
                        </div>
                        <div id="collapse-obrig-{{ loop.index }}" class="collapse" data-modulo="{{ modulo }}">
                            <ul class="list-group list-group-flush list-group-sortable" id="sortable-list-obrig-{{ loop.index }}">
                                {% for tarefa in tarefas %}
                                <li class="list-group-item d-flex align-items-start justify-content-between" data-id="{{ tarefa.id }}">
                                    <div class="d-flex flex-column flex-grow-1 me-3">
                                        <div class="d-flex align-items-center mb-2">
                                            <input class="form-check-input me-3 task-checkbox flex-shrink-0" type="checkbox" value="1" id="task-obrig-{{ tarefa.id }}" onchange="window.toggleTarefa({{ tarefa.id }}, this)" {% if tarefa.concluida %}checked{% endif %}>
                                            <div class="task-label-container">
                                                <label class="form-check-label {% if tarefa.concluida %}text-decoration-line-through text-success{% endif %}" for="task-obrig-{{ tarefa.id }}">
                                                    {{ tarefa.tarefa_filho }}
                                                </label>
                                                {% if tarefa.tag %}
                                                <span class="badge rounded-pill task-tag ms-2 {% if tarefa.tag == 'Ação interna' %} bg-secondary {% elif tarefa.tag == 'Reunião' %} bg-info text-dark {% else %} bg-light text-dark {% endif %}">
                                                    {{ tarefa.tag }}
                                                </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="mt-1" style="margin-left: calc(1.25em + 0.75rem);">
                                            <label class="form-label small text-secondary mb-1">Comentários</label>
                                            <form onsubmit="return false;" class="comment-form mb-2">
                                                <textarea id="comment-text-{{ tarefa.id }}-new" class="form-control form-control-sm" name="comentario" maxlength="8000" rows="2" placeholder="Adicionar comentário..."></textarea>
                                                <input type="file" name="imagem" class="form-control form-control-sm my-1" accept="image/png, image/jpeg, image/gif">
                                                <button class="btn btn-outline-primary btn-sm px-2 py-1" type="button" onclick="window.adicionarComentario({{ tarefa.id }}, '{{ url_for('api.adicionar_comentario', tarefa_id=tarefa.id) }}', this)"> Salvar </button>
                                            </form>
                                            <div class="list-group list-group-flush border rounded-1" id="comment-list-{{ tarefa.id }}" style="max-height: 300px; overflow-y: auto;">
                                                {% if not tarefa.comentarios %}
                                                    <div class="list-group-item list-group-item-action py-1 px-2 small text-secondary fst-italic" id="no-comment-{{ tarefa.id }}"> Nenhum comentário ainda. </div>
                                                {% endif %}
                                                {% for comentario in tarefa.comentarios %}
                                                <div class="list-group-item list-group-item-action py-1 px-2" id="comentario-{{ comentario.id }}">
                                                    <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                                                        <strong class="mb-0 small"> <i class="bi bi-person-fill me-1"></i> {{ comentario.usuario_nome }} </strong>
                                                        <small class="text-secondary">{{ comentario.data_criacao_fmt_d }}</small>
                                                    </div>
                                                    <div class="comment-content-wrapper">
                                                        <p class="mb-1 small comment-text" id="comment-text-{{ comentario.id }}">{{ comentario.texto | safe }}</p>
                                                        {% if comentario.texto and comentario.texto | length > 200 %}
                                                            <button class="btn btn-sm btn-link p-0 small" onclick="toggleComment(this, 'comment-text-{{ comentario.id }}')">Ver mais...</button>
                                                        {% endif %}
                                                        {% if comentario.imagem_url %}
                                                            <a href="{{ comentario.imagem_url }}" target="_blank" title="Clique para ampliar">
                                                                <img src="{{ comentario.imagem_url }}" class="img-fluid rounded mt-1 comment-image">
                                                            </a>
                                                        {% endif %}
                                                    </div>
                                                    {% if comentario.usuario_cs == email_usuario_logado %}
                                                        <button class="btn btn-sm btn-link text-danger p-0 small mt-1" onclick="window.excluirComentario({{ comentario.id }}, '{{ url_for('api.excluir_comentario', comentario_id=comentario.id) }}', this)"> Excluir </button>
                                                    {% endif %}
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center ms-2 flex-shrink-0">
                                        <button class="btn btn-sm btn-outline-danger p-1 me-1" onclick="window.excluirTarefa({{ tarefa.id }}, this)" title="Excluir Tarefa"><i class="bi bi-x-lg"></i></button>
                                        <i class="bi bi-grip-vertical handle" style="cursor: grab;" title="Mover Tarefa"></i>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>


            {# --- Aba Pendências --- #}
            <div class="tab-pane fade" id="pendencias-content" role="tabpanel" aria-labelledby="pendencias-tab">
                {# Conteúdo da aba Pendências (sem botão Marcar Todas) #}
                <div id="checklist-area-pendencias" class="pt-4">
                    {# Formulário Rápido para Adicionar Pendência #}
                    <div class="card metric-card mb-4 shadow-sm">
                        <div class="card-header header-bg">
                            <h5 class="mb-0 fs-6">Adicionar Nova Pendência</h5>
                        </div>
                        <div class="card-body">
                             {# Salva o ID do BOTÃO da aba ('pendencias-tab') no localStorage ANTES do submit #}
                            <form action="{{ url_for('main.adicionar_tarefa') }}" method="POST" class="row g-2 align-items-end"
                                  onsubmit="localStorage.setItem('tabAtiva-implantacao-{{ implantacao.id }}', 'pendencias-tab'); return true;">
                                <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                                <input type="hidden" name="tarefa_pai" value="{{ modulo_pendencias_nome }}">
                                <input type="hidden" name="tag" value="">
                                <div class="col-md">
                                    <label for="add-pendencia-filho" class="form-label visually-hidden">Nome da Pendência</label>
                                    <input type="text" class="form-control" id="add-pendencia-filho" name="tarefa_filho" placeholder="Descreva a pendência..." required>
                                </div>
                                <div class="col-md-auto">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="bi bi-plus-circle me-1"></i> Adicionar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    {# Lista de Pendências Existentes #}
                    {% if not tarefas_agrupadas_pendencias %}
                        <div class="alert alert-light text-center small py-2" role="alert">Nenhuma pendência registrada.</div>
                    {% else %}
                        {% for modulo, tarefas in tarefas_agrupadas_pendencias.items() %}
                        <div class="card metric-card mb-4 shadow-sm">
                             <div class="card-header header-bg">
                                <h5 class="mb-0 fs-6">{{ modulo }}</h5>
                             </div>
                             <ul class="list-group list-group-flush list-group-sortable" id="sortable-list-pend-{{ loop.index }}">
                                {% for tarefa in tarefas %}
                                <li class="list-group-item d-flex align-items-start justify-content-between" data-id="{{ tarefa.id }}">
                                    <div class="d-flex flex-column flex-grow-1 me-3">
                                        <div class="d-flex align-items-center mb-2">
                                            <input class="form-check-input me-3 task-checkbox flex-shrink-0" type="checkbox" value="1" id="task-pend-{{ tarefa.id }}" onchange="window.toggleTarefa({{ tarefa.id }}, this)" {% if tarefa.concluida %}checked{% endif %}>
                                            <div class="task-label-container">
                                                <label class="form-check-label {% if tarefa.concluida %}text-decoration-line-through text-success{% endif %}" for="task-pend-{{ tarefa.id }}">
                                                    {{ tarefa.tarefa_filho }}
                                                </label>
                                                {% if tarefa.tag %}
                                                <span class="badge rounded-pill task-tag ms-2 bg-warning text-dark">
                                                    {{ tarefa.tag }}
                                                </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="mt-1" style="margin-left: calc(1.25em + 0.75rem);">
                                            <label class="form-label small text-secondary mb-1">Comentários</label>
                                            <form onsubmit="return false;" class="comment-form mb-2">
                                                <textarea id="comment-text-{{ tarefa.id }}-new" class="form-control form-control-sm" name="comentario" maxlength="8000" rows="2" placeholder="Adicionar comentário..."></textarea>
                                                <input type="file" name="imagem" class="form-control form-control-sm my-1" accept="image/png, image/jpeg, image/gif">
                                                <button class="btn btn-outline-primary btn-sm px-2 py-1" type="button" onclick="window.adicionarComentario({{ tarefa.id }}, '{{ url_for('api.adicionar_comentario', tarefa_id=tarefa.id) }}', this)"> Salvar </button>
                                            </form>
                                            <div class="list-group list-group-flush border rounded-1" id="comment-list-{{ tarefa.id }}" style="max-height: 300px; overflow-y: auto;">
                                                {% if not tarefa.comentarios %}
                                                    <div class="list-group-item list-group-item-action py-1 px-2 small text-secondary fst-italic" id="no-comment-{{ tarefa.id }}"> Nenhum comentário ainda. </div>
                                                {% endif %}
                                                {% for comentario in tarefa.comentarios %}
                                                <div class="list-group-item list-group-item-action py-1 px-2" id="comentario-{{ comentario.id }}">
                                                    <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                                                        <strong class="mb-0 small"> <i class="bi bi-person-fill me-1"></i> {{ comentario.usuario_nome }} </strong>
                                                        <small class="text-secondary">{{ comentario.data_criacao_fmt_d }}</small>
                                                    </div>
                                                    <div class="comment-content-wrapper">
                                                        <p class="mb-1 small comment-text" id="comment-text-{{ comentario.id }}">{{ comentario.texto | safe }}</p>
                                                        {% if comentario.texto and comentario.texto | length > 200 %}
                                                            <button class="btn btn-sm btn-link p-0 small" onclick="toggleComment(this, 'comment-text-{{ comentario.id }}')">Ver mais...</button>
                                                        {% endif %}
                                                        {% if comentario.imagem_url %}
                                                            <a href="{{ comentario.imagem_url }}" target="_blank" title="Clique para ampliar">
                                                                <img src="{{ comentario.imagem_url }}" class="img-fluid rounded mt-1 comment-image">
                                                            </a>
                                                        {% endif %}
                                                    </div>
                                                    {% if comentario.usuario_cs == email_usuario_logado %}
                                                        <button class="btn btn-sm btn-link text-danger p-0 small mt-1" onclick="window.excluirComentario({{ comentario.id }}, '{{ url_for('api.excluir_comentario', comentario_id=comentario.id) }}', this)"> Excluir </button>
                                                    {% endif %}
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center ms-2 flex-shrink-0">
                                        <button class="btn btn-sm btn-outline-danger p-1 me-1" onclick="window.excluirTarefa({{ tarefa.id }}, this)" title="Excluir Tarefa"><i class="bi bi-x-lg"></i></button>
                                        <i class="bi bi-grip-vertical handle" style="cursor: grab;" title="Mover Tarefa"></i>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>


            {# Aba Timeline #}
            <div class="tab-pane fade" id="timeline-content" role="tabpanel" aria-labelledby="timeline-tab">
                <div class="metric-card p-3 rounded shadow-sm mt-3">
                    <h5 class="mb-3 border-bottom pb-2">Histórico de Eventos</h5>
                    <ul class="timeline-list">
                         {% if not logs_timeline %}
                            <li class="alert alert-light text-center small py-2" role="alert" id="no-timeline-msg">
                                Nenhum evento registrado para esta implantação ainda.
                            </li>
                         {% endif %}
                        {% for log in logs_timeline %}
                        <li class="timeline-item">
                            <div class="timeline-icon">
                                {% if log.tipo_evento == 'novo_comentario' %} <i class="bi bi-chat-left-text-fill"></i>
                                {% elif 'tarefa' in log.tipo_evento %} <i class="bi bi-check-circle-fill"></i>
                                {% elif 'status' in log.tipo_evento or 'implantacao' in log.tipo_evento or 'detalhes' in log.tipo_evento %} <i class="bi bi-flag-fill"></i>
                                {% else %} <i class="bi bi-info-circle-fill"></i> {% endif %}
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <span class="timeline-usuario">{{ log.usuario_nome }}</span>
                                    <span class="timeline-data">{{ log.data_criacao_fmt_dt_hr }}</span>
                                </div>
                                <p class="timeline-detalhes">{{ log.detalhes | safe | replace('\n', '<br>') }}</p>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

        </div> {# Fim do tab-content #}
    </main>
</div> {# Fim do d-flex principal #}

{# Modais (Finalizar, Parar, Retomar, Add Tarefa, Excluir Implantação) - SEM ALTERAÇÕES #}
{# ... (código dos modais inalterado) ... #}
{# Modal Finalizar #}
<div class="modal fade" id="modalFinalizar" tabindex="-1" aria-labelledby="modalFinalizarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: var(--container-bg); color: var(--body-color);">
            <div class="modal-header header-bg"><h5 class="modal-title" id="modalFinalizarLabel" style="color: var(--body-color);">Finalizar Implantação</h5><button type="button" class="btn-close btn-close-dark" data-bs-dismiss="modal" aria-label="Close"></button></div>
            <form action="{{ url_for('main.finalizar_implantacao') }}" method="POST">
                <div class="modal-body">
                    <p>Tem certeza que deseja marcar esta implantação como "Finalizada"?</p>
                    <p class="small text-warning"><i class="bi bi-exclamation-triangle-fill me-1"></i> A finalização só será permitida se todas as tarefas dos checklists Obrigatório e de Treinamentos estiverem concluídas.</p>
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <input type="hidden" name="redirect_to" value="detalhes">
                </div>
                <div class="modal-footer header-bg">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Confirmar Finalização</button>
                </div>
            </form>
        </div>
    </div>
</div>

{# Modal Parar #}
<div class="modal fade" id="modalParar" tabindex="-1" aria-labelledby="modalPararLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: var(--container-bg); color: var(--body-color);">
            <div class="modal-header header-bg"><h5 class="modal-title" id="modalPararLabel" style="color: var(--body-color);">Parar Implantação</h5><button type="button" class="btn-close btn-close-dark" data-bs-dismiss="modal" aria-label="Close"></button></div>
            <form action="{{ url_for('main.parar_implantacao') }}" method="POST">
                <div class="modal-body">
                    <p>Tem certeza que deseja "Parar" esta implantação?</p>
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <div class="mb-3">
                        <label for="motivo_parada" class="form-label">Motivo da Parada (Obrigatório)</label>
                        <select class="form-select" id="motivo_parada" name="motivo_parada" required>
                            <option value="">Selecione um motivo...</option>
                            {% for motivo in justificativas_parada %}
                            <option value="{{ motivo }}">{{ motivo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer header-bg">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Parar Implantação</button>
                </div>
            </form>
        </div>
    </div>
</div>

{# Modal Retomar #}
<div class="modal fade" id="modalRetomar" tabindex="-1" aria-labelledby="modalRetomarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: var(--container-bg); color: var(--body-color);">
            <div class="modal-header header-bg"><h5 class="modal-title" id="modalRetomarLabel" style="color: var(--body-color);">Retomar Implantação</h5><button type="button" class="btn-close btn-close-dark" data-bs-dismiss="modal" aria-label="Close"></button></div>
            <form action="{{ url_for('main.retomar_implantacao') }}" method="POST">
                <div class="modal-body">
                    <p>Tem certeza que deseja "Retomar" esta implantação?</p>
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <input type="hidden" name="redirect_to" value="detalhes">
                </div>
                <div class="modal-footer header-bg">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Retomar Implantação</button>
                </div>
            </form>
        </div>
    </div>
</div>

{# Modal Adicionar Tarefa #}
<div class="modal fade" id="adicionarTarefaModal" tabindex="-1" aria-labelledby="adicionarTarefaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: var(--container-bg); color: var(--body-color);">
            <div class="modal-header header-bg"><h5 class="modal-title" id="adicionarTarefaModalLabel" style="color: var(--body-color);">Adicionar Nova Tarefa</h5><button type="button" class="btn-close btn-close-dark" data-bs-dismiss="modal" aria-label="Close"></button></div>
            <form action="{{ url_for('main.adicionar_tarefa') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <div class="mb-3">
                        <label for="add-tarefa-filho-modal" class="form-label">Nome da Tarefa</label>
                        <input type="text" class="form-control" id="add-tarefa-filho-modal" name="tarefa_filho" required>
                    </div>
                    <div class="mb-3">
                        <label for="add-tarefa-pai-modal" class="form-label">Módulo (Agrupador)</label>
                        <select class="form-select" id="add-tarefa-pai-modal" name="tarefa_pai" required>
                            <option value="">Selecione um módulo existente...</option>
                            {% for modulo in todos_modulos %} 
                            <option value="{{ modulo }}">{{ modulo }}</option>
                            {% endfor %}
                            <option value="Outros">Outros (Novo Módulo)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="add-tarefa-tag-modal" class="form-label">Tag (Opcional)</label>
                        <select class="form-select" id="add-tarefa-tag-modal" name="tag">
                            <option value="">Sem Tag</option>
                            <option value="Ação interna">Ação interna</option>
                            <option value="Reunião">Reunião</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer header-bg">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Adicionar Tarefa</button>
                </div>
            </form>
        </div>
    </div>
</div>

{# Modal Excluir Implantação #}
<div class="modal fade" id="modalExcluirImplantacao" tabindex="-1" aria-labelledby="modalExcluirImplantacaoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: var(--container-bg); color: var(--body-color);">
            <div class="modal-header header-bg"><h5 class="modal-title text-danger" id="modalExcluirImplantacaoLabel" style="color: var(--body-color);">Excluir Implantação</h5><button type="button" class="btn-close btn-close-dark" data-bs-dismiss="modal" aria-label="Close"></button></div>
            <form action="{{ url_for('main.excluir_implantacao') }}" method="POST">
                <div class="modal-body">
                    <h5 class="text-danger">Atenção! Ação irreversível!</h5>
                    <p>Você tem certeza que deseja excluir permanentemente a implantação de <strong>{{ implantacao.nome_empresa }}</strong>?</p>
                    <p>Todos os dados serão perdidos.</p>
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                </div>
                <div class="modal-footer header-bg">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Sim, excluir permanentemente</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}


{% block scripts_extra %}
{# Inclui SortableJS para drag-and-drop #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js" integrity="sha512-Eezs+g9Lq4TCCq0wae01s9PuNWzHYoCMkQAi7cDM6ZQJJ5CmAGgk+FdIQ0+UI0EzfYRYzVLgsJdJAYNWMXifcA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    // --- Funções Helper para UI ---
    // ... (funções formatDataComentario, formatDataLog, toggleComment, criarTimelineItemHTML, adicionarLogNaTimeline, criarComentarioHTML, updateProgressBar - SEM ALTERAÇÕES) ...
    function formatDataComentario(dataStr) {
        if (!dataStr) return '';
        try {
            const dateObj = new Date(dataStr.replace(' ', 'T') + 'Z');
            if (isNaN(dateObj.getTime())) throw new Error("Data inválida");
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = dateObj.getFullYear();
            return `${day}/${month}/${year}`;
        } catch (e) { console.error("Erro formatando data:", dataStr, e); return 'Inválida'; }
    }
    function formatDataLog(dataStr) {
         if (!dataStr) return '';
        try {
            const dateObj = new Date(dataStr.replace(' ', 'T') + 'Z');
            if (isNaN(dateObj.getTime())) throw new Error("Data inválida");
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = dateObj.getFullYear();
            const hours = String(dateObj.getHours()).padStart(2, '0');
            const minutes = String(dateObj.getMinutes()).padStart(2, '0');
            const seconds = String(dateObj.getSeconds()).padStart(2, '0');
            return `${day}/${month}/${year} às ${hours}:${minutes}:${seconds}`;
        } catch (e) { console.error("Erro formatando data log:", dataStr, e); return 'Inválida'; }
    }
    function toggleComment(button, elementId) {
        const textElement = document.getElementById(elementId);
        if (!textElement) return;
        const isExpanded = textElement.classList.toggle('expanded');
        button.textContent = isExpanded ? 'Ver menos...' : 'Ver mais...';
    }
    function criarTimelineItemHTML(log) {
        if (!log || !log.data_criacao) return '';
        let iconClass = 'bi-info-circle-fill';
        if (log.tipo_evento === 'novo_comentario') iconClass = 'bi-chat-left-text-fill';
        else if (log.tipo_evento?.includes('tarefa')) iconClass = 'bi-check-circle-fill';
        else if (log.tipo_evento?.includes('status') || log.tipo_evento?.includes('implantacao') || log.tipo_evento?.includes('detalhes')) iconClass = 'bi-flag-fill';
        else if (log.tipo_evento === 'modulo_excluido') iconClass = 'bi-trash-fill'; // Ícone para exclusão de módulo
        const dataFormatada = formatDataLog(log.data_criacao);
        const detalhesHTML = (log.detalhes || '').replace(/\n/g, '<br>');
        return `<li class="timeline-item"><div class="timeline-icon"><i class="bi ${iconClass}"></i></div><div class="timeline-content"><div class="timeline-header"><span class="timeline-usuario">${log.usuario_nome || 'Sistema'}</span><span class="timeline-data">${dataFormatada}</span></div><p class="timeline-detalhes">${detalhesHTML}</p></div></li>`;
    }
    function adicionarLogNaTimeline(log) {
        if (!log) return;
        const timelineList = document.querySelector('#timeline-content .timeline-list');
        if (!timelineList) return;
        const noTimelineMsg = document.getElementById('no-timeline-msg');
        if (noTimelineMsg) noTimelineMsg.remove();
        const logHTML = criarTimelineItemHTML(log);
        if (logHTML) timelineList.insertAdjacentHTML('afterbegin', logHTML);
    }
    function criarComentarioHTML(comentario, emailUsuarioLogado) {
        if (!comentario || !comentario.id) return '';
        const dataFormatada = formatDataComentario(comentario.data_criacao);
        let botaoExcluir = '';
        if (comentario.usuario_cs == emailUsuarioLogado) {
            const urlExcluir = `{{ url_for('api.excluir_comentario', comentario_id=0) }}`.replace('/0', `/${comentario.id}`);
            botaoExcluir = `<button class="btn btn-sm btn-link text-danger p-0 small mt-1" onclick="window.excluirComentario(${comentario.id}, '${urlExcluir}', this)">Excluir</button>`;
        }
        let textoHTML = `<p class="mb-1 small comment-text" id="comment-text-${comentario.id}">${comentario.texto || ''}</p>`;
        if (comentario.texto && comentario.texto.length > 200) {
            textoHTML += `<button class="btn btn-sm btn-link p-0 small" onclick="toggleComment(this, 'comment-text-${comentario.id}')">Ver mais...</button>`;
        }
        let imagemHTML = '';
        if (comentario.imagem_url) {
            imagemHTML = `<a href="${comentario.imagem_url}" target="_blank" title="Clique para ampliar"><img src="${comentario.imagem_url}" class="img-fluid rounded mt-1 comment-image"></a>`;
        }
        return `<div class="list-group-item list-group-item-action py-1 px-2" id="comentario-${comentario.id}"><div class="d-flex w-100 justify-content-between align-items-center mb-1"><strong class="mb-0 small"><i class="bi bi-person-fill me-1"></i> ${comentario.usuario_nome || comentario.usuario_cs}</strong><small class="text-secondary">${dataFormatada}</small></div><div class="comment-content-wrapper">${textoHTML}${imagemHTML}</div>${botaoExcluir}</div>`;
    }
    function updateProgressBar(progress) {
        const progressBar = document.querySelector('#main-content .progress-bar');
        if (progressBar) {
            const progressNum = parseInt(progress) || 0;
            progressBar.style.width = progressNum + '%';
            progressBar.setAttribute('aria-valuenow', progressNum);
            progressBar.textContent = progressNum + '%';
        }
    }

    // --- Funções de Ação (Chamadas API via Fetch) ---
    // ... (funções adicionarComentario, excluirComentario, toggleTarefa, excluirTarefa - SEM ALTERAÇÕES RECENTES) ...
        function adicionarComentario(tarefaId, endpointUrl, button) {
        const form = button.closest('.comment-form');
        const textarea = form.querySelector('textarea');
        const fileInput = form.querySelector('input[type="file"]');
        const comentarioTexto = textarea.value.trim();
        const file = fileInput.files.length > 0 ? fileInput.files[0] : null;

        if (comentarioTexto === '' && !file) {
            alert('O comentário não pode estar vazio se não houver imagem.');
            return;
        }
        if (file) {
            const allowedTypes = ['image/png', 'image/jpeg', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                alert('Tipo de arquivo de imagem não permitido. Use PNG, JPG ou GIF.');
                fileInput.value = null;
                return;
            }
        }

        const originalBtnHTML = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salvando...';

        const formData = new FormData(form);
        fetch(endpointUrl, { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                if (data.ok && data.comentario) {
                    const commentList = document.getElementById('comment-list-' + tarefaId);
                    const noCommentMsg = document.getElementById('no-comment-' + tarefaId);
                    if (noCommentMsg) noCommentMsg.remove();

                    const emailUsuarioLogado = '{{ email_usuario_logado }}';
                    const comentarioHTML = criarComentarioHTML(data.comentario, emailUsuarioLogado);
                    if (comentarioHTML) {
                        commentList.insertAdjacentHTML('beforeend', comentarioHTML);
                        commentList.scrollTop = commentList.scrollHeight;
                    }
                    textarea.value = '';
                    fileInput.value = null;
                    adicionarLogNaTimeline(data.log_comentario);
                } else {
                    throw new Error(data.error || 'Erro desconhecido ao salvar comentário.');
                }
            })
            .catch(error => {
                console.error('Erro ao adicionar comentário:', error);
                alert(`Erro ao salvar comentário: ${error.message}`);
            })
            .finally(() => {
                button.innerHTML = originalBtnHTML;
                button.disabled = false;
            });
    }

    function excluirComentario(comentarioId, endpointUrl, button) {
        if (!confirm('Tem certeza que deseja excluir este comentário?')) {
            return;
        }
        const comentarioElement = button.closest('.list-group-item');
        if (comentarioElement) comentarioElement.style.opacity = '0.5';
        fetch(endpointUrl, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    if (comentarioElement) comentarioElement.remove();
                    const listElement = button.closest('.list-group');
                    if(listElement && listElement.children.length === 0){
                        const tarefaIdGuess = listElement.id.split('-')[2];
                         listElement.innerHTML = `<div class="list-group-item list-group-item-action py-1 px-2 small text-secondary fst-italic" id="no-comment-${tarefaIdGuess}"> Nenhum comentário ainda. </div>`;
                    }
                    adicionarLogNaTimeline(data.log_exclusao);
                } else {
                    throw new Error(data.error || 'Erro desconhecido ao excluir.');
                }
            })
            .catch(error => {
                console.error('Erro ao excluir comentário:', error);
                alert(`Erro ao excluir comentário: ${error.message}`);
                if (comentarioElement) comentarioElement.style.opacity = '1';
            });
    }

    function toggleTarefa(tarefaId, checkbox) {
        const label = checkbox.closest('li').querySelector('label.form-check-label');
        const isChecked = checkbox.checked;
        checkbox.disabled = true;
        const endpointUrl = `{{ url_for('api.toggle_tarefa', tarefa_id=0) }}`.replace('/0', `/${tarefaId}`);
        fetch(endpointUrl, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    if (data.novo_status === 1) {
                        label.classList.add('text-decoration-line-through', 'text-success');
                    } else {
                        label.classList.remove('text-decoration-line-through', 'text-success');
                    }
                    if (data.novo_progresso !== undefined) {
                        updateProgressBar(data.novo_progresso);
                    }
                    adicionarLogNaTimeline(data.log_tarefa);
                    if (data.implantacao_finalizada) {
                        adicionarLogNaTimeline(data.log_finalizacao);
                        window.location.reload();
                    }
                } else {
                    checkbox.checked = !isChecked;
                    throw new Error(data.error || 'Erro desconhecido.');
                }
            })
            .catch(error => {
                console.error('Erro ao alternar tarefa:', error);
                alert(`Erro: ${error.message}`);
                checkbox.checked = !isChecked;
            })
            .finally(() => {
                checkbox.disabled = false;
            });
    }


    function excluirTarefa(tarefaId, button) {
        if (!confirm('Tem certeza? Comentários serão perdidos.')) return;
        const endpointUrl = `{{ url_for('api.excluir_tarefa', tarefa_id=0) }}`.replace('/0', `/${tarefaId}`);
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        const listItem = button.closest('.list-group-item');
        if (listItem) listItem.style.opacity = '0.5';
        fetch(endpointUrl, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    if(listItem) listItem.remove();
                    adicionarLogNaTimeline(data.log_exclusao);
                    if (data.novo_progresso !== undefined) updateProgressBar(data.novo_progresso);
                    if (data.implantacao_finalizada) {
                        adicionarLogNaTimeline(data.log_finalizacao);
                        window.location.reload();
                    }
                } else { throw new Error(data.error || 'Erro desconhecido.'); }
            })
            .catch(error => {
                console.error('Erro ao excluir tarefa:', error);
                alert(`Erro: ${error.message}`);
                button.innerHTML = '<i class="bi bi-x-lg"></i>'; // Restaura ícone original
                button.disabled = false;
                if (listItem) listItem.style.opacity = '1';
            });
    }

    // FUNÇÃO ATUALIZADA
    function excluirTodasDoModulo(button, moduloNome) {
        if (!confirm(`Tem certeza que deseja EXCLUIR TODAS as tarefas do módulo "${moduloNome}"? Esta ação é irreversível e removerá todas as tarefas e comentários associados.`)) {
            return;
        }
        
        const implantacaoId = {{ implantacao.id }}; // Pega o ID da implantação
        const endpointUrl = '{{ url_for("api.excluir_tarefas_modulo") }}';
        const cardElement = button.closest('.card'); // O card inteiro do módulo

        const originalBtnHTML = button.innerHTML;
        button.disabled = true;
        button.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Excluindo...`;
        if (cardElement) cardElement.style.opacity = '0.5';

        fetch(endpointUrl, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                implantacao_id: implantacaoId,
                tarefa_pai: moduloNome // Envia o nome do módulo
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.ok) {
                // --- ALTERAÇÃO AQUI ---
                // Não remove o card, apenas limpa a lista de tarefas dentro dele
                if (cardElement) {
                    const taskList = cardElement.querySelector('.list-group-sortable');
                    if (taskList) {
                        taskList.innerHTML = ''; // Limpa a lista de tarefas
                    }
                }
                // --- FIM DA ALTERAÇÃO ---
                
                adicionarLogNaTimeline(data.log_exclusao_modulo); 
                if (data.novo_progresso !== undefined) updateProgressBar(data.novo_progresso);
                if (data.implantacao_finalizada) {
                    adicionarLogNaTimeline(data.log_finalizacao);
                    window.location.reload(); 
                }
            } else {
                throw new Error(data.error || 'Erro desconhecido ao excluir o módulo.');
            }
        })
        .catch(error => {
            console.error('Erro ao excluir módulo:', error);
            alert(`Erro: ${error.message}`);
        })
        .finally(() => { // Garante que o botão e a opacidade sejam restaurados
             button.innerHTML = originalBtnHTML;
             button.disabled = false;
             if (cardElement) cardElement.style.opacity = '1';
        });
    }


     function marcarTodasDoModulo(button, collapseId) {
        const collapseElement = document.getElementById(collapseId);
        if (!collapseElement) return;
        const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseElement);
        bsCollapse.show();

        setTimeout(() => {
            const checkboxesNaoMarcadas = Array.from(collapseElement.querySelectorAll('.task-checkbox:not(:checked)'));
            if (checkboxesNaoMarcadas.length === 0) { alert('Todas já concluídas.'); return; }
            if (!confirm(`Marcar ${checkboxesNaoMarcadas.length} tarefa(s) como concluída(s)?`)) return;

            const originalBtnHTML = button.innerHTML;
            button.disabled = true;
            button.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Marcando...`;
            let promises = []; let errors = []; let ultimaFinalizada = false;
            let ultimoLogTarefa = null; let ultimoLogFinalizacao = null; let ultimoProgresso = null;

            checkboxesNaoMarcadas.forEach(checkbox => {
                const tarefaId = parseInt(checkbox.closest('li').dataset.id);
                if (isNaN(tarefaId)) return;
                const endpointUrl = `{{ url_for('api.toggle_tarefa', tarefa_id=0) }}`.replace('/0', `/${tarefaId}`);
                checkbox.disabled = true;

                const promise = fetch(endpointUrl, { method: 'POST' })
                    .then(response => response.json()).then(data => {
                        if (data.ok) {
                            const label = checkbox.closest('li').querySelector('label.form-check-label');
                            checkbox.checked = true; if(label) label.classList.add('text-decoration-line-through', 'text-success');
                            ultimoProgresso = data.novo_progresso; ultimoLogTarefa = data.log_tarefa;
                            if(data.implantacao_finalizada) { ultimaFinalizada = true; ultimoLogFinalizacao = data.log_finalizacao; }
                            return { success: true };
                        } else { throw new Error(data.error || 'Erro'); }
                    }).catch(error => {
                        console.error(`Erro tarefa ${tarefaId}:`, error); errors.push(tarefaId); checkbox.checked = false;
                        const label = checkbox.closest('li').querySelector('label.form-check-label');
                        if(label) label.classList.remove('text-decoration-line-through', 'text-success');
                        return { success: false };
                    }).finally(() => { checkbox.disabled = false; });
                promises.push(promise);
            });

            Promise.all(promises).then(() => {
                button.innerHTML = originalBtnHTML; button.disabled = false;
                if (ultimoProgresso !== null) updateProgressBar(ultimoProgresso);
                if (ultimoLogTarefa) adicionarLogNaTimeline(ultimoLogTarefa);
                if (ultimaFinalizada) {
                    if (ultimoLogFinalizacao) adicionarLogNaTimeline(ultimoLogFinalizacao);
                    window.location.reload(); return;
                }
                if (errors.length > 0) alert(`Falha ao marcar ${errors.length} tarefa(s).`);
            });
        }, 300);
    }

    // --- Inicialização da Página ---
    document.addEventListener('DOMContentLoaded', function() {
        const implantacaoId = {{ implantacao.id }};
        const endpointReordenar = '{{ url_for("api.reordenar_tarefas") }}';

        // Torna as funções de ação globais
        window.toggleTarefa = toggleTarefa;
        window.adicionarComentario = adicionarComentario;
        window.excluirComentario = excluirComentario;
        window.toggleComment = toggleComment;
        window.excluirTarefa = excluirTarefa;
        window.marcarTodasDoModulo = marcarTodasDoModulo;
        window.excluirTodasDoModulo = excluirTodasDoModulo; // <-- LINHA ADICIONADA

        // Inicializa SortableJS
        document.querySelectorAll('.list-group-sortable').forEach(listEl => {
            const moduloContainer = listEl.closest('.collapse, .card');
            let modulo = moduloContainer?.dataset.modulo;
             if (!modulo && moduloContainer?.classList.contains('card')) {
                 const header = moduloContainer.querySelector('.card-header');
                 const collapseTarget = header?.getAttribute('data-bs-target');
                 if (collapseTarget) {
                      const collapseElement = document.querySelector(collapseTarget);
                      if(collapseElement) modulo = collapseElement.dataset.modulo;
                 }
                 if (!modulo) {
                     const headerText = header?.querySelector('h5')?.textContent.trim();
                     if (headerText) modulo = headerText;
                 }
            }
            if (!modulo) { console.warn("Módulo não encontrado para lista:", listEl); return; }

            new Sortable(listEl, {
                animation: 150, handle: '.handle', ghostClass: 'bg-secondary',
                onEnd: function (evt) {
                    const novaOrdemIds = Array.from(evt.to.children).map(item => parseInt(item.dataset.id));
                    fetch(endpointReordenar, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ implantacao_id: implantacaoId, tarefa_pai: modulo, ordem: novaOrdemIds }) })
                    .then(r => r.json()).then(d => { if (d.ok) adicionarLogNaTimeline(d.log_reordenar); else throw new Error(d.error); }).catch(e => alert('Erro ao salvar ordem.'));
                },
            });
        });

        // --- Lógica de Ativação de Abas (NOVA ABORDAGEM) ---
        const tabSelector = '#detalhesTab .nav-link';
        const tabPaneSelector = '#detalhesTabContent .tab-pane';
        const tabs = document.querySelectorAll(tabSelector);
        const panes = document.querySelectorAll(tabPaneSelector);
        const tabStorageKey = `tabAtiva-implantacao-${implantacaoId}`;

        // Função para ativar uma aba de forma explícita
        function activateTabById(buttonId) {
            const targetButton = document.getElementById(buttonId);
            const targetPaneId = targetButton?.getAttribute('data-bs-target');
            if (!targetButton || !targetPaneId) {
                console.warn(`[ActivateTab] Botão ou painel não encontrado para ID: ${buttonId}`);
                return false;
            }
            const targetPane = document.querySelector(targetPaneId);
            if (!targetPane) {
                 console.warn(`[ActivateTab] Painel não encontrado: ${targetPaneId}`);
                 return false;
            }

            console.log(`[ActivateTab] Forçando ativação para: ${buttonId}`);

            // 1. Remove 'active' de todos os botões e 'active show' de todos os painéis
            tabs.forEach(t => t.classList.remove('active'));
            panes.forEach(p => p.classList.remove('active', 'show'));

            // 2. Adiciona 'active' ao botão alvo e 'active show' ao painel alvo
            targetButton.classList.add('active');
            targetPane.classList.add('active', 'show');

            // 3. (Opcional, mas bom) Dispara o evento do Bootstrap para consistência
            //    Pode não ser necessário se a manipulação manual for suficiente.
            // try {
            //     const bsTab = bootstrap.Tab.getOrCreateInstance(targetButton);
            //     // bsTab.show(); // Chamar show PODE causar loop ou re-aplicar classes errado. Testar sem.
            // } catch (e) { console.error("Erro ao tentar disparar evento Bootstrap:", e); }

            console.log(`[ActivateTab] Ativação manual concluída para: ${buttonId}`);
            localStorage.setItem(tabStorageKey, buttonId); // Salva a aba ativada
            return true;
        }

        // Salva a aba no localStorage quando uma aba é mostrada pelo Bootstrap
        tabs.forEach(tab => {
            tab.addEventListener('shown.bs.tab', event => {
                console.log('[Tab Event] Bootstrap shown.bs.tab:', event.target.id);
                localStorage.setItem(tabStorageKey, event.target.id);
                // Limpa o hash APENAS se ele existir (evita adicionar # à URL)
                if (window.location.hash) {
                    console.log('[Tab Event] Limpando hash da URL.');
                    history.pushState("", document.title, window.location.pathname + window.location.search);
                }
            });
        });

        // Lógica de restauração/ativação inicial
        let activated = false;
        const urlHash = window.location.hash;
        console.log('[Init] Hash inicial:', urlHash);

        if (urlHash) {
            let hashId = urlHash.substring(1);
            let buttonIdToActivate = null;
            if (hashId.endsWith('-content')) {
                buttonIdToActivate = hashId.replace('-content', '-tab');
            } else {
                const directButton = document.getElementById(hashId);
                if (directButton && directButton.matches(tabSelector)) {
                    buttonIdToActivate = hashId;
                }
            }

            if (buttonIdToActivate) {
                console.log('[Init] Tentando ativar via hash:', buttonIdToActivate);
                // Tenta ativar imediatamente (sem delay agora, usando a função manual)
                if (activateTabById(buttonIdToActivate)) {
                    activated = true;
                     // Limpa o hash logo após a tentativa de ativação via hash
                     console.log('[Init] Limpando hash após tentativa de ativação por hash.');
                     history.pushState("", document.title, window.location.pathname + window.location.search);
                } else {
                     // Se falhar, limpa o hash inválido
                     history.pushState("", document.title, window.location.pathname + window.location.search);
                }
            } else {
                 console.warn('[Init] Hash inválido, limpando.');
                 history.pushState("", document.title, window.location.pathname + window.location.search);
            }
        }

        // Se não ativou pelo hash, tenta pelo localStorage
        if (!activated) {
            const savedTabId = localStorage.getItem(tabStorageKey);
            console.log('[Init] Tentando restaurar via localStorage:', savedTabId);
            if (savedTabId) {
                 if (activateTabById(savedTabId)) {
                     activated = true;
                 } else {
                     localStorage.removeItem(tabStorageKey); // Remove ID inválido
                 }
            }
        }

        // Se nada funcionou, ativa a primeira aba como fallback
        if (!activated) {
            const firstTabButton = document.querySelector(tabSelector);
            if (firstTabButton) {
                console.log('[Init Fallback] Ativando aba padrão:', firstTabButton.id);
                activateTabById(firstTabButton.id);
            } else {
                console.error("[Init Fallback] Nenhuma aba encontrada para ativar!");
            }
        }
        // --- Fim da Lógica de Ativação de Abas ---


        // Inicializa botões "Ver mais/menos"
         document.querySelectorAll('.comment-text').forEach(textEl => { const wrapper = textEl.closest('.comment-content-wrapper'); let button = wrapper ? wrapper.querySelector('button[onclick^="toggleComment"]') : null; const maxHeight = parseFloat(window.getComputedStyle(textEl).maxHeight); const isOverflowing = textEl.scrollHeight > maxHeight + 5; if (isOverflowing && !button) { const newButton = document.createElement('button'); newButton.className = 'btn btn-sm btn-link p-0 small'; newButton.textContent = 'Ver mais...'; newButton.onclick = function() { toggleComment(this, textEl.id); }; textElement.parentNode.insertBefore(newButton, textEl.nextSibling); } else if (!isOverflowing && button) { button.remove(); } else if (isOverflowing && button) { button.textContent = textEl.classList.contains('expanded') ? 'Ver menos...' : 'Ver mais...'; } });

        // Adiciona funcionalidade aos ícones de collapse
        document.querySelectorAll('.card-header[data-bs-toggle="collapse"]').forEach(header => { const collapseId = header.getAttribute('data-bs-target'); const collapseElement = document.querySelector(collapseId); const icon = header.querySelector('i.bi-chevron-down, i.bi-chevron-up'); if (collapseElement && icon) { collapseElement.addEventListener('show.bs.collapse', () => { icon.classList.remove('bi-chevron-down'); icon.classList.add('bi-chevron-up'); }); collapseElement.addEventListener('hide.bs.collapse', () => { icon.classList.remove('bi-chevron-up'); icon.classList.add('bi-chevron-down'); }); if (collapseElement.classList.contains('show')) { icon.classList.remove('bi-chevron-down'); icon.classList.add('bi-chevron-up'); } } });

    }); // Fim do DOMContentLoaded
</script>
{% endblock %}