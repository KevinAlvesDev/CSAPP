{% extends "base.html" %}

{% block title %}Detalhes da Implanta√ß√£o - {{ implantacao.nome_empresa }}{% endblock %}

{% block head_extra %}
<style>
    /* Estilos para a aba da Linha do Tempo */
    .timeline-list {
        list-style-type: none;
        padding-left: 0;
    }
    .timeline-item {
        display: flex;
        padding: 12px 0;
        border-bottom: 1px solid var(--input-border);
    }
    .timeline-item:last-child {
        border-bottom: none;
    }
    .timeline-icon {
        flex-shrink: 0;
        width: 40px;
        height: 40px;
        background-color: var(--input-border);
        color: var(--accent-color);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        margin-right: 15px;
    }
    .timeline-content {
        flex-grow: 1;
        min-width: 0;
    }
    .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }
    .timeline-usuario {
        font-weight: 600;
        color: var(--body-color);
    }
    .timeline-data {
        font-size: 0.8rem;
        color: #8b949e; 
        flex-shrink: 0;
        padding-left: 10px;
    }
    body.light-mode .timeline-data {
        color: #555;
    }
    .timeline-detalhes {
        font-size: 0.9rem;
        margin-bottom: 0;
        color: var(--body-color);
        opacity: 0.9;
        white-space: pre-wrap;
        word-break: break-word;
    }

    /* Estilos para Truncar Coment√°rio (Ver mais) */
    .comment-text {
        max-height: 100px; /* Altura m√°xima antes de truncar */
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        white-space: pre-wrap; /* Preserva quebra de linha */
        word-break: break-word; /* Quebra palavras longas */
    }
    .comment-text.expanded {
        max-height: 2000px; /* Altura m√°xima expandida (suficiente) */
        transition: max-height 0.5s ease-in;
    }
    .comment-image {
        max-height: 200px;
        width: auto;
        cursor: zoom-in;
    }
</style>
{% endblock %}


{% block content %}
<header class="header-bg p-3 shadow-sm d-flex justify-content-center align-items-center">
    <h1 class="main-title mb-0 fs-4 text-center flex-grow-1">CS ONBOARDING DETALHES</h1>
    <div class="d-flex align-items-center position-absolute end-0 me-3">
        <button class="btn btn-outline-light d-lg-none me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar" aria-controls="mobileSidebar">
            <i class="bi bi-list"></i>
        </button>
        <button id="mode-toggle" class="btn btn-dark" type="button" title="Alternar tema">
            <span id="mode-icon">üåô</span>
        </button>
    </div>
</header>

<div class="d-flex">
    <div class="offcanvas-lg offcanvas-start sidebar-bg d-lg-block" tabindex="-1" id="mobileSidebar" aria-labelledby="mobileSidebarLabel" style="width: 250px;">
        <div class="offcanvas-header header-bg">
            <h5 class="offcanvas-title" id="mobileSidebarLabel">Op√ß√µes de Implanta√ß√£o</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" data-bs-target="#mobileSidebar" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body d-flex flex-column p-3">
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary mb-3">
                <i class="bi bi-arrow-left me-2"></i> Voltar ao Dashboard
            </a>
            
            <h6 class="text-secondary border-bottom pb-2 mb-3">Detalhes da Empresa</h6>
            <ul class="list-unstyled small sidebar-info-list"> 
                <li><i class="bi bi-building me-2"></i><strong>Empresa:</strong> {{ implantacao.nome_empresa }}</li>
                <li><i class="bi bi-person-workspace me-2"></i><strong>CS:</strong> {{ implantacao.usuario_cs }}</li>
                <li><i class="bi bi-tag me-2"></i><strong>Tipo:</strong> {{ 'Imediata' if implantacao.tipo == 'agora' else 'Futura' }}</li>
                <li><i class="bi bi-calendar-check me-2"></i><strong>Cria√ß√£o:</strong> {{ implantacao.data_criacao.split(' ')[0] if implantacao.data_criacao else 'N/A' }}</li>
                {% if implantacao.status == 'finalizada' %}
                    <li><i class="bi bi-calendar-x me-2"></i><strong>Finaliza√ß√£o:</strong> {{ implantacao.data_finalizacao.split(' ')[0] if implantacao.data_finalizacao else 'N/A' }}</li>
                {% elif implantacao.status == 'parada' and implantacao.data_finalizacao %}
                    <li><i class="bi bi-calendar-pause me-2"></i><strong>Pausada em:</strong> {{ implantacao.data_finalizacao.split(' ')[0] }}</li>
                {% endif %}
            </ul>
            
            <h6 class="text-secondary border-bottom pb-2 mb-3 mt-3">Detalhes do Cliente</h6>
            <ul class="list-unstyled small sidebar-info-list"> 
                <li><i class="bi bi-person-badge me-2"></i><strong>Respons√°vel:</strong> {{ implantacao.responsavel_cliente | default('N/A') }}</li>
                <li><i class="bi bi-briefcase me-2"></i><strong>Cargo:</strong> {{ implantacao.cargo_responsavel | default('N/A') }}</li>
                <li><i class="bi bi-telephone me-2"></i><strong>Telefone:</strong> {{ implantacao.telefone_responsavel | default('N/A') }}</li>
                <li><i class="bi bi-envelope me-2"></i><strong>E-mail:</strong> {{ implantacao.email_responsavel | default('N/A') }}</li>
            </ul>

            <h6 class="text-secondary border-bottom pb-2 mb-3 mt-3">Datas e Atributos</h6>
            <ul class="list-unstyled small sidebar-info-list"> 
                <li><i class="bi bi-play-circle-fill me-2"></i><strong>In√≠cio Produ√ß√£o:</strong> {{ implantacao.data_inicio_producao | default('N/A') }}</li>
                <li><i class="bi bi-calendar-check-fill me-2"></i><strong>Final Previsto:</strong> {{ implantacao.data_final_implantacao | default('N/A') }}</li>
                <li><i class="bi bi-key me-2"></i><strong>Chave OAMD:</strong> {{ implantacao.chave_oamd | default('N/A') }}</li>
                <li><i class="bi bi-hdd-stack me-2"></i><strong>Catraca:</strong> {{ implantacao.catraca | default('N/A') }}</li>
                <li><i class="bi bi-person-bounding-box me-2"></i><strong>Facial:</strong> {{ implantacao.facial | default('N/A') }}</li>
            </ul>


            <p class="text-secondary small mt-4">A√ß√µes R√°pidas</p>
            <ul class="list-group list-group-flush mb-4">
                <li class="list-group-item">
                    <button class="btn btn-sm btn-link text-decoration-none p-0" data-bs-toggle="modal" data-bs-target="#adicionarTarefaModal">
                        <i class="bi bi-plus-circle me-2"></i> Adicionar Tarefa
                    </button>
                </li>
                
                {% if implantacao.status == 'andamento' %}
                <li class="list-group-item">
                    <button class="btn btn-sm btn-link text-success text-decoration-none p-0" data-bs-toggle="modal" data-bs-target="#modalFinalizar">
                        <i class="bi bi-check-circle me-2"></i> Finalizar Implanta√ß√£o
                    </button>
                </li>
                <li class="list-group-item">
                    <button class="btn btn-sm btn-link text-danger text-decoration-none p-0" data-bs-toggle="modal" data-bs-target="#modalParar">
                        <i class="bi bi-stop-circle me-2"></i> Parar Implanta√ß√£o
                    </button>
                </li>
                {% elif implantacao.status == 'parada' %}
                <li class="list-group-item">
                    <button class="btn btn-sm btn-link text-primary text-decoration-none p-0" data-bs-toggle="modal" data-bs-target="#modalRetomar">
                        <i class="bi bi-play-circle me-2"></i> Retomar Implanta√ß√£o
                    </button>
                </li>
                {% endif %}
            </ul>

            <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary mt-auto">
                <i class="bi bi-box-arrow-right me-2"></i> Sair
            </a>
        </div>
    </div>
    
    <main class="flex-grow-1 p-4" id="main-content">
        <div class="metric-card p-3 rounded shadow-sm mb-4">
            <div class="row align-items-center">
                <div class="col-md-6 mb-3 mb-md-0">
                    <p class="mb-1"><strong>Status:</strong> 
                        {% if implantacao.status == 'finalizada' %}
                            <span class="badge bg-success">Conclu√≠do</span>
                        {% elif implantacao.status == 'parada' %}
                            <span class="badge bg-danger">Parada</span>
                        {% elif implantacao.status == 'futura' %}
                            <span class="badge bg-info text-dark">Futura</span>
                        {% else %}
                            <span class="badge bg-warning text-dark">Em Andamento</span>
                        {% endif %}
                    </p>
                    
                    {% if implantacao.status == 'parada' and implantacao.motivo_parada %}
                    <p class="mb-1 small text-danger">
                        <strong>Motivo:</strong> {{ implantacao.motivo_parada }}
                    </p>
                    {% endif %}
                    
                    <p class="mb-0"><strong>Cria√ß√£o:</strong> {{ implantacao.data_criacao }}</p> 
                </div>
                <div class="col-md-6">
                    <h4 class="h6 mb-2">Progresso Total</h4>
                    <div class="progress" style="height: 30px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: {{ progresso_porcentagem }}%;" aria-valuenow="{{ progresso_porcentagem }}" aria-valuemin="0" aria-valuemax="100">{{ progresso_porcentagem }}%</div>
                    </div>
                </div>
            </div>
        </div>

        <ul class="nav nav-tabs" id="detalhesTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="checklist-tab" data-bs-toggle="tab" data-bs-target="#checklist-content" type="button" role="tab" aria-controls="checklist-content" aria-selected="true">
                    <i class="bi bi-check2-square me-1"></i> Checklist
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline-content" type="button" role="tab" aria-controls="timeline-content" aria-selected="false">
                    <i class="bi bi-clock-history me-1"></i> Linha do Tempo
                </button>
            </li>
        </ul>

        <div class="tab-content" id="detalhesTabContent">
            
            <div class="tab-pane fade show active" id="checklist-content" role="tabpanel" aria-labelledby="checklist-tab">
                <div id="checklist-area" class="pt-4">
                    {% for modulo, tarefas in tarefas_agrupadas.items() %}
                    {% if modulo != 'Observa√ß√£o' %} 
                    <div class="card metric-card mb-4 shadow-sm">
                        <div class="card-header header-bg d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="false" aria-controls="collapse{{ loop.index }}">
                            <h5 class="mb-0 fs-6">{{ modulo }}</h5>
                            <i class="bi bi-chevron-down"></i>
                        </div>
                        <div id="collapse{{ loop.index }}" class="collapse" data-modulo="{{ modulo }}">
                            <ul class="list-group list-group-flush list-group-sortable" id="sortable-list-{{ loop.index }}">
                                {% for tarefa in tarefas %}
                                <li class="list-group-item d-flex align-items-start justify-content-between" data-id="{{ tarefa.id }}">
                                    <div class="d-flex flex-column flex-grow-1">
                                        <form method="POST" action="{{ url_for('toggle_tarefa', tarefa_id=tarefa.id) }}" class="d-inline">
                                            <div class="form-check d-flex align-items-center">
                                                <input class="form-check-input me-3 task-checkbox" type="checkbox" value="1" onchange="window.toggleTarefa({{ tarefa.id }}, this)" {% if tarefa.concluida %}checked{% endif %}>
                                                <label class="form-check-label {% if tarefa.concluida %}text-decoration-line-through text-success{% endif %}">
                                                    {{ tarefa.tarefa_filho }}
                                                </label>
                                            </div>
                                        </form>
                                        
                                        <div class="mt-2 ms-5 me-5">
                                            <label class="form-label small text-secondary">Coment√°rios</label>
                                            
                                            <form onsubmit="return false;" class="comment-form mb-2">
                                                <textarea id="comment-text-{{ tarefa.id }}" class="form-control" name="comentario" maxlength="8000" rows="3" placeholder="Adicionar coment√°rio..."></textarea>
                                                
                                                <input type="file" name="imagem" class="form-control form-control-sm my-2" accept="image/png, image/jpeg, image/gif">

                                                <button class="btn btn-outline-primary btn-sm" type="button" 
                                                        onclick="window.adicionarComentario({{ tarefa.id }}, '{{ url_for('adicionar_comentario', tarefa_id=tarefa.id) }}', this)">
                                                    Salvar
                                                </button>
                                            </form>
                                            
                                            <div class="list-group list-group-flush border rounded-2" id="comment-list-{{ tarefa.id }}" style="max-height: 400px; overflow-y: auto;">
                                                {% if not tarefa.comentarios %}
                                                    <div class="list-group-item list-group-item-action py-2 small text-secondary" id="no-comment-{{ tarefa.id }}">
                                                        Nenhum coment√°rio.
                                                    </div>
                                                {% endif %}
                                                {% for comentario in tarefa.comentarios %}
                                                <div class="list-group-item list-group-item-action py-2">
                                                    <div class="d-flex w-100 justify-content-between">
                                                        <strong class="mb-1 small">
                                                            <i class="bi bi-person-fill me-1"></i>
                                                            {{ comentario.usuario_nome }}
                                                        </strong>
                                                        <small class="text-secondary">{{ comentario.data_criacao.split(' ')[0] }}</small>
                                                    </div>
                                                    
                                                    <div class="comment-content-wrapper">
                                                        <p class="mb-1 small comment-text" id="comment-text-{{ comentario.id }}">{{ comentario.texto | safe }}</p>
                                                        {% if comentario.texto | length > 300 %}
                                                            <button class="btn btn-sm btn-link p-0 small" onclick="toggleComment(this, 'comment-text-{{ comentario.id }}')">Ver mais...</button>
                                                        {% endif %}
                                                        
                                                        {% if comentario.imagem_url %}
                                                            <a href="{{ comentario.imagem_url }}" target="_blank" title="Clique para ampliar">
                                                                <img src="{{ comentario.imagem_url }}" class="img-fluid rounded mt-2 comment-image">
                                                            </a>
                                                        {% endif %}
                                                    </div>
                                                    
                                                    {% if comentario.usuario_cs == email_usuario_logado %}
                                                    <button class="btn btn-sm btn-link text-danger p-0 small mt-1" 
                                                            onclick="window.excluirComentario({{ comentario.id }}, '{{ url_for('excluir_comentario', comentario_id=comentario.id) }}', this)">
                                                        Excluir
                                                    </button>
                                                    {% endif %}
                                                </div>
                                                {% endfor %}
                                            </div>

                                        </div>
                                    </div>
                                    
                                    <div class="d-flex align-items-center ms-3">
                                        <form method="POST" action="{{ url_for('excluir_tarefa', tarefa_id=tarefa.id) }}" onsubmit="return confirm('Tem certeza que deseja excluir esta tarefa?');" class="d-inline me-2">
                                            <button type="submit" class="btn btn-sm btn-outline-danger p-1"><i class="bi bi-x-circle-fill"></i></button>
                                        </form>
                                        <i class="bi bi-grip-vertical handle" style="cursor: grab;"></i>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>

            <div class="tab-pane fade" id="timeline-content" role="tabpanel" aria-labelledby="timeline-tab">
                <div class="metric-card p-3 rounded shadow-sm mt-0">
                    <h5 class="mb-3">Hist√≥rico de Eventos</h5>
                    <ul class="timeline-list">
                        {% if not logs_timeline %}
                        <li class="alert alert-info text-center" role="alert" id="no-timeline-msg">
                            Nenhum evento registrado na linha do tempo deste cliente ainda.
                        </li>
                        {% endif %}
                        {% for log in logs_timeline %}
                        <li class="timeline-item">
                            <div class="timeline-icon">
                                {% if log.tipo_evento == 'novo_comentario' %}
                                    <i class="bi bi-chat-left-text-fill"></i>
                                {% elif 'tarefa' in log.tipo_evento %}
                                    <i class="bi bi-check-circle-fill"></i>
                                {% elif 'status' in log.tipo_evento or 'implantacao' in log.tipo_evento %}
                                    <i class="bi bi-flag-fill"></i>
                                {% else %}
                                    <i class="bi bi-info-circle-fill"></i>
                                {% endif %}
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <span class="timeline-usuario">{{ log.usuario_nome | default(log.usuario_cs) }}</span>
                                    <span class="timeline-data">{{ log.data_criacao.split('.')[0] }}</span>
                                </div>
                                <p class="timeline-detalhes">{{ log.detalhes | safe | replace('\n', '<br>') }}</p>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

        </div> </main>
</div>

<div class="modal fade" id="modalFinalizar" tabindex="-1" aria-labelledby="modalFinalizarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: var(--container-bg); color: var(--body-color);">
            <div class="modal-header header-bg">
                <h5 class="modal-title" id="modalFinalizarLabel" style="color: var(--body-color);">Finalizar Implanta√ß√£o</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Tem certeza que deseja marcar "{{ implantacao.nome_empresa }}" como **Conclu√≠da**?
            </div>
            <form method="POST" action="{{ url_for('finalizar_implantacao') }}">
                <div class="modal-footer header-bg">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <button type="submit" class="btn btn-success">Confirmar Finaliza√ß√£o</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalParar" tabindex="-1" aria-labelledby="modalPararLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: var(--container-bg); color: var(--body-color);">
            <div class="modal-header header-bg">
                <h5 class="modal-title" id="modalPararLabel" style="color: var(--body-color);">Parar Implanta√ß√£o</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('parar_implantacao') }}">
                <div class="modal-body">
                    <p>Tem certeza que deseja marcar "{{ implantacao.nome_empresa }}" como **Parada**?</p>
                    
                    <div class="mb-3">
                        <label for="motivo_parada" class="form-label">Motivo (Obrigat√≥rio)</label>
                        <select class="form-select" id="motivo_parada" name="motivo_parada" required>
                            <option value="" disabled selected>Selecione uma justificativa...</option>
                            {% for motivo in justificativas_parada %}
                            <option value="{{ motivo }}">{{ motivo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer header-bg">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <button type="submit" class="btn btn-danger">Confirmar Parada</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalRetomar" tabindex="-1" aria-labelledby="modalRetomarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: var(--container-bg); color: var(--body-color);">
            <div class="modal-header header-bg">
                <h5 class="modal-title" id="modalRetomarLabel" style="color: var(--body-color);">Retomar Implanta√ß√£o</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Tem certeza que deseja retomar a implanta√ß√£o de "{{ implantacao.nome_empresa }}"? O status ser√° alterado para "Em Andamento".
            </div>
            <form method="POST" action="{{ url_for('retomar_implantacao') }}">
                <div class="modal-footer header-bg">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <input type="hidden" name="redirect_to" value="detalhes">
                    <button type="submit" class="btn btn-primary">Confirmar Retomada</button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="adicionarTarefaModal" tabindex="-1" aria-labelledby="adicionarTarefaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: var(--container-bg); color: var(--body-color);">
            <div class="modal-header header-bg">
                <h5 class="modal-title" id="adicionarTarefaModalLabel" style="color: var(--body-color);">Adicionar Tarefa Personalizada</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('adicionar_tarefa') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <div class="mb-3">
                        <label for="tarefaPai" class="form-label">M√≥dulo (Agrupamento)</label>
                        <select class="form-select" id="tarefaPai" name="tarefa_pai" required>
                            <option value="">Selecione um m√≥dulo</option>
                            {% for modulo in tarefas_agrupadas.keys() %}
                                {% if modulo != 'Observa√ß√£o' %}
                                    <option value="{{ modulo }}">{{ modulo }}</option>
                                {% endif %}
                            {% endfor %}
                            <option value="Personalizado">Outro (Novo M√≥dulo)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="tarefaFilho" class="form-label">Nome da Tarefa</label>
                        <input type="text" class="form-control" id="tarefaFilho" name="tarefa_filho" required>
                    </div>
                </div>
                <div class="modal-footer header-bg">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="background-color: var(--accent-color); border-color: var(--accent-color);">Adicionar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script>
// Fun√ß√£o para formatar data do coment√°rio
function formatDataComentario(dataStr) {
    if (!dataStr) return '';
    if (dataStr.includes('.')) dataStr = dataStr.split('.')[0];
    return dataStr.split(' ')[0]; // Pega s√≥ a data
}

// Fun√ß√£o para formatar data do log da timeline
function formatDataLog(dataStr) {
    if (!dataStr) return '';
    if (dataStr.includes('.')) dataStr = dataStr.split('.')[0];
    return dataStr.replace(' ', ' √†s '); 
}

// Fun√ß√£o para o bot√£o "Ver mais..."
function toggleComment(button, elementId) {
    const textElement = document.getElementById(elementId);
    if (!textElement) return;

    const isExpanded = textElement.classList.toggle('expanded');
    button.textContent = isExpanded ? 'Ver menos...' : 'Ver mais...';
}

// Fun√ß√£o para criar o HTML de um item da timeline
function criarTimelineItemHTML(log) {
    let iconClass = 'bi-info-circle-fill';
    if (log.tipo_evento === 'novo_comentario') iconClass = 'bi-chat-left-text-fill';
    else if (log.tipo_evento.includes('tarefa')) iconClass = 'bi-check-circle-fill';
    else if (log.tipo_evento.includes('status')) iconClass = 'bi-flag-fill';

    const dataFormatada = formatDataLog(log.data_criacao);
    const detalhesHTML = log.detalhes.replace(/\n/g, '<br>');

    return `
    <li class="timeline-item">
        <div class="timeline-icon">
            <i class="bi ${iconClass}"></i>
        </div>
        <div class="timeline-content">
            <div class="timeline-header">
                <span class="timeline-usuario">${log.usuario_nome}</span>
                <span class="timeline-data">${dataFormatada}</span>
            </div>
            <p class="timeline-detalhes">${detalhesHTML}</p>
        </div>
    </li>
    `;
}

// Fun√ß√£o para adicionar o HTML na lista da timeline
function adicionarLogNaTimeline(log) {
    if (!log) return;
    
    const timelineList = document.querySelector('#timeline-content .timeline-list');
    if (!timelineList) return; 

    const noTimelineMsg = document.getElementById('no-timeline-msg');
    if (noTimelineMsg) {
        noTimelineMsg.remove();
    }

    const logHTML = criarTimelineItemHTML(log);
    timelineList.insertAdjacentHTML('afterbegin', logHTML);
}


// Fun√ß√£o para criar o HTML de um *novo* coment√°rio
function criarComentarioHTML(comentario, emailUsuarioLogado) {
    const dataFormatada = formatDataComentario(comentario.data_criacao);
    let botaoExcluir = '';
    
    if (comentario.usuario_cs === emailUsuarioLogado) {
        const urlExcluir = `{{ url_for('excluir_comentario', comentario_id=0) }}`.replace('0', comentario.id);
        botaoExcluir = `
            <button class="btn btn-sm btn-link text-danger p-0 small mt-1" 
                    onclick="window.excluirComentario(${comentario.id}, '${urlExcluir}', this)">
                Excluir
            </button>
        `;
    }

    // L√≥gica de "Ver mais" e imagem para o JS
    let textoHTML = `<p class="mb-1 small comment-text" id="comment-text-${comentario.id}">${comentario.texto}</p>`;
    if (comentario.texto.length > 300) {
        textoHTML += `<button class="btn btn-sm btn-link p-0 small" onclick="toggleComment(this, 'comment-text-${comentario.id}')">Ver mais...</button>`;
    }
    
    let imagemHTML = '';
    if (comentario.imagem_url) {
        imagemHTML = `
            <a href="${comentario.imagem_url}" target="_blank" title="Clique para ampliar">
                <img src="${comentario.imagem_url}" class="img-fluid rounded mt-2 comment-image">
            </a>
        `;
    }

    return `
        <div class="list-group-item list-group-item-action py-2">
            <div class="d-flex w-100 justify-content-between">
                <strong class="mb-1 small">
                    <i class="bi bi-person-fill me-1"></i>
                    ${comentario.usuario_nome}
                </strong>
                <small class="text-secondary">${dataFormatada}</small>
            </div>
            <div class="comment-content-wrapper">
                ${textoHTML}
                ${imagemHTML}
            </div>
            ${botaoExcluir}
        </div>
    `;
}

// Fun√ß√£o para adicionar coment√°rio (agora usa FormData)
function adicionarComentario(tarefaId, endpointUrl, button) {
    const form = button.closest('.comment-form');
    const textarea = form.querySelector('textarea');
    const fileInput = form.querySelector('input[type="file"]');
    
    const comentario = textarea.value.trim();
    const file = fileInput.files.length > 0 ? fileInput.files[0] : null;

    if (comentario === '' && !file) {
        alert('O coment√°rio n√£o pode estar vazio ou sem imagem.');
        return;
    }
    
    if (file) {
        const allowedTypes = ['image/png', 'image/jpeg', 'image/gif'];
        if (!allowedTypes.includes(file.type)) {
            alert('Tipo de arquivo n√£o permitido. Use apenas PNG, JPG ou GIF.');
            return;
        }
    }

    const originalBtnText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = 'Salvando...';

    const formData = new FormData();
    formData.append('comentario', comentario);
    if (file) {
        formData.append('imagem', file);
    }

    fetch(endpointUrl, {
        method: 'POST',
        body: formData 
    })
    .then(response => response.json())
    .then(data => {
        if (data.ok) {
            const commentList = document.getElementById('comment-list-' + tarefaId); 
            const noCommentMsg = document.getElementById('no-comment-' + tarefaId);
            
            if (noCommentMsg) noCommentMsg.remove();
            
            const emailUsuarioLogado = '{{ email_usuario_logado }}';
            const comentarioHTML = criarComentarioHTML(data.comentario, emailUsuarioLogado);
            commentList.insertAdjacentHTML('beforeend', comentarioHTML);
            
            textarea.value = '';
            fileInput.value = null; 
            
            adicionarLogNaTimeline(data.log_comentario);

        } else {
            throw new Error(data.error || 'Erro desconhecido');
        }
    })
    .catch(error => {
        console.error('Erro ao adicionar coment√°rio:', error);
        alert('Erro ao salvar o coment√°rio. Tente novamente.');
    })
    .finally(() => {
        button.innerHTML = originalBtnText;
        button.disabled = false;
    });
}

function excluirComentario(comentarioId, endpointUrl, button) {
    if (!confirm('Tem certeza que deseja excluir este coment√°rio?')) {
        return;
    }

    fetch(endpointUrl, {
        method: 'POST',
    })
    .then(response => response.json())
    .then(data => {
        if (data.ok) {
            const comentarioElement = button.closest('.list-group-item');
            const commentList = comentarioElement.parentElement;
            comentarioElement.remove();
            
            if (commentList.children.length === 0) {
                const tarefaId = commentList.id.split('-')[2];
                commentList.innerHTML = `
                    <div class="list-group-item list-group-item-action py-2 small text-secondary" id="no-comment-${tarefaId}">
                        Nenhum coment√°rio.
                    </div>
                `;
            }
            
            adicionarLogNaTimeline(data.log_exclusao);

        } else {
            throw new Error(data.error || 'Erro desconhecido');
        }
    })
    .catch(error => {
        console.error('Erro ao excluir coment√°rio:', error);
        alert('Erro ao excluir o coment√°rio. Tente novamente.');
    });
}

function updateProgressBar(progress) {
    const progressBar = document.querySelector('.progress-bar');
    if (progressBar) {
        progressBar.style.width = progress + '%';
        progressBar.setAttribute('aria-valuenow', progress);
        progressBar.textContent = progress + '%';
    }
}

function toggleTarefa(tarefaId, checkbox) {
    const label = checkbox.closest('.form-check').querySelector('label');
    const isChecked = checkbox.checked;

    fetch(`/toggle_tarefa/${tarefaId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.ok) {
            if (data.novo_status === 1) {
                label.classList.add('text-decoration-line-through', 'text-success');
            } else {
                label.classList.remove('text-decoration-line-through', 'text-success');
            }
            
            if (data.novo_progresso !== undefined) {
                updateProgressBar(data.novo_progresso);
            }
            
            adicionarLogNaTimeline(data.log_tarefa);

            if (data.implantacao_finalizada) {
                 adicionarLogNaTimeline(data.log_finalizacao);
                 alert('Parab√©ns! Implanta√ß√£o finalizada automaticamente.');
                 window.location.reload(); 
            }
        } else {
            console.error('Erro ao alternar tarefa:', data.error);
            alert('Erro ao salvar a tarefa. Tente novamente.');
            checkbox.checked = !isChecked; 
        }
    })
    .catch(error => {
        console.error('Erro de rede:', error);
        alert('Erro ao salvar a tarefa. Por favor, tente novamente.');
        checkbox.checked = !isChecked;
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const implantacaoId = {{ implantacao.id }};
    const endpointReordenar = '{{ url_for('reordenar_tarefas') }}';
    const endpointDetalhes = '{{ url_for('ver_implantacao', impl_id=implantacao.id) }}';
    
    window.toggleTarefa = toggleTarefa;
    window.adicionarComentario = adicionarComentario;
    window.excluirComentario = excluirComentario;
    window.toggleComment = toggleComment; 

    document.querySelectorAll('.list-group-sortable').forEach(list => {
        const modulo = list.closest('.collapse').dataset.modulo;
        
        new Sortable(list, {
            animation: 150,
            handle: '.handle', 
            onEnd: function (evt) {
                const novaOrdem = Array.from(evt.to.children).map(item => parseInt(item.dataset.id));
                
                fetch(endpointReordenar, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        implantacao_id: implantacaoId,
                        tarefa_pai: modulo,
                        ordem: novaOrdem
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                        adicionarLogNaTimeline(data.log_reordenar);
                    } else {
                        console.error('Erro ao reordenar:', data.error);
                        alert('Erro ao reordenar as tarefas. A p√°gina ser√° recarregada.');
                        window.location.href = endpointDetalhes; 
                    }
                })
                .catch(error => {
                    console.error('Erro de rede ao reordenar:', error);
                    alert('Erro ao reordenar as tarefas. A p√°gina ser√° recarregada.');
                    window.location.href = endpointDetalhes;
                });
            },
        });
    });

    // Salva e restaura a aba ativa (Checklist ou Linha do Tempo)
    const tabSelector = '#detalhesTab .nav-link';
    const tabs = document.querySelectorAll(tabSelector);
    const tabStorageKey = `tabAtiva-implantacao-{{ implantacao.id }}`;

    tabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', event => {
            localStorage.setItem(tabStorageKey, event.target.id);
        });
    });

    const abaAtivaId = localStorage.getItem(tabStorageKey);
    if (abaAtivaId) {
        const tabEl = document.getElementById(abaAtivaId);
        if (tabEl) {
            new bootstrap.Tab(tabEl).show();
        }
    }

    // [NOVO] Inicializa o "Ver mais" para coment√°rios j√° carregados
    document.querySelectorAll('.comment-text').forEach(textEl => {
        if (textEl.scrollHeight > textEl.clientHeight) {
            // O texto est√° truncado, mas n√£o temos o bot√£o no JS
            // O bot√£o j√° √© renderizado pelo Jinja, ent√£o est√° tudo certo
        }
    });

});
</script>
{% endblock %}