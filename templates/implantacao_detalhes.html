{% extends "base.html" %}

{% block title %}Detalhes da Implanta√ß√£o - {{ implantacao.nome_empresa }}{% endblock %}

{% block head_extra %}
<style>
    /* Estilos para a aba da Linha do Tempo */
    .timeline-list { list-style-type: none; padding-left: 0; }
    .timeline-item { display: flex; padding: 12px 0; border-bottom: 1px solid var(--input-border); }
    .timeline-item:last-child { border-bottom: none; }
    .timeline-icon { flex-shrink: 0; width: 40px; height: 40px; background-color: var(--input-border); color: var(--accent-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-right: 15px; }
    .timeline-content { flex-grow: 1; min-width: 0; }
    .timeline-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .timeline-usuario { font-weight: 600; color: var(--body-color); }
    .timeline-data { font-size: 0.8rem; color: #8b949e; flex-shrink: 0; padding-left: 10px; }
<<<<<<< HEAD
    body.light-mode .timeline-data { color: #555; }
=======
    /* Removido: body.light-mode .timeline-data { color: #555; } */
>>>>>>> 6d78c716439a5aa5a8166507cdeea87fc9f15668
    .timeline-detalhes { font-size: 0.9rem; margin-bottom: 0; color: var(--body-color); opacity: 0.9; white-space: pre-wrap; word-break: break-word; }

    /* Estilos para Truncar Coment√°rio (Ver mais) */
    .comment-text { max-height: 100px; overflow: hidden; transition: max-height 0.3s ease-out; white-space: pre-wrap; word-break: break-word; }
    .comment-text.expanded { max-height: 2000px; transition: max-height 0.5s ease-in; }
    .comment-image { max-height: 200px; width: auto; cursor: zoom-in; }

    /* Estilo para a etiqueta da tarefa */
    .task-tag { font-size: 0.75em; vertical-align: middle; }

    /* Garante que o container da tarefa/tag use todo o espa√ßo */
    .task-label-container { display: flex; align-items: center; flex-grow: 1; min-width: 0; }
    .task-label-container .form-check-label { margin-right: 0.5rem; word-break: break-word; }
    .task-label-container .task-tag { margin-left: auto; flex-shrink: 0; }

    /* Remove a borda inferior do √∫ltimo item de a√ß√£o r√°pida */
    .list-group-flush .list-group-item:last-child { border-bottom-width: 0; }
</style>
{% endblock %}


{% block content %}
<header class="header-bg p-3 shadow-sm d-flex justify-content-center align-items-center">
    <h1 class="main-title mb-0 fs-4 text-center flex-grow-1">CS ONBOARDING DETALHES</h1>
    <div class="d-flex align-items-center position-absolute end-0 me-3">
        <button class="btn btn-outline-light d-lg-none me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar" aria-controls="mobileSidebar"> <i class="bi bi-list"></i> </button>
<<<<<<< HEAD
        <button id="mode-toggle" class="btn btn-dark" type="button" title="Alternar tema"> <span id="mode-icon">üåô</span> </button>
    </div>
=======
        </div>
>>>>>>> 6d78c716439a5aa5a8166507cdeea87fc9f15668
</header>

<div class="d-flex">
    <div class="offcanvas-lg offcanvas-start sidebar-bg d-lg-block" tabindex="-1" id="mobileSidebar" aria-labelledby="mobileSidebarLabel" style="width: 250px;">
        <div class="offcanvas-header header-bg">
            <h5 class="offcanvas-title" id="mobileSidebarLabel">Op√ß√µes de Implanta√ß√£o</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" data-bs-target="#mobileSidebar" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body d-flex flex-column p-3">
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary mb-3"> <i class="bi bi-arrow-left me-2"></i> Voltar ao Dashboard </a>

<<<<<<< HEAD
            <p class="text-secondary small mt-3 mb-2">A√ß√µes R√°pidas</p>
            <ul class="list-group list-group-flush mb-4">
                <li class="list-group-item"> <button class="btn btn-sm btn-link text-decoration-none p-0" data-bs-toggle="modal" data-bs-target="#adicionarTarefaModal"> <i class="bi bi-plus-circle me-2"></i> Adicionar Tarefa </button> </li>
=======
            <p class="text-secondary small mt-3 mb-2">A√ß√µes R√°pidas</p> {# Ajustado mt/mb #}
            <ul class="list-group list-group-flush mb-4">
                <li class="list-group-item"> <button class="btn btn-sm btn-link text-decoration-none p-0" data-bs-toggle="modal" data-bs-target="#adicionarTarefaModal"> <i class="bi bi-plus-circle me-2"></i> Adicionar Tarefa </button> </li>

>>>>>>> 6d78c716439a5aa5a8166507cdeea87fc9f15668
                <li class="list-group-item">
                    <button class="btn btn-sm btn-link text-decoration-none p-0"
                        data-bs-toggle="modal" data-bs-target="#modalDetalhesEmpresa"
                        data-id="{{ implantacao.id }}"
                        data-nome="{{ implantacao.nome_empresa }}"
                        data-responsavel="{{ implantacao.responsavel_cliente | default('') }}"
                        data-cargo="{{ implantacao.cargo_responsavel | default('') }}"
                        data-telefone="{{ implantacao.telefone_responsavel | default('') }}"
                        data-email="{{ implantacao.email_responsavel | default('') }}"
<<<<<<< HEAD
                        data-inicio-implantacao="{{ implantacao.data_criacao.strftime('%Y-%m-%d') if implantacao.data_criacao else 'N/A' }}" {# Formato YYYY-MM-DD para JS #}
                        data-inicio-producao="{{ implantacao.data_inicio_producao.strftime('%Y-%m-%d') if implantacao.data_inicio_producao else '' }}" {# Formato YYYY-MM-DD para input date #}
                        data-final-implantacao="{{ implantacao.data_final_implantacao.strftime('%Y-%m-%d') if implantacao.data_final_implantacao else '' }}" {# Formato YYYY-MM-DD para input date #}
=======
                        data-inicio-implantacao="{{ implantacao.data_criacao.strftime('%Y-%m-%d') if implantacao.data_criacao else 'N/A' }}"
                        data-inicio-producao="{{ implantacao.data_inicio_producao | default('') }}"
                        data-final-implantacao="{{ implantacao.data_final_implantacao | default('') }}"
>>>>>>> 6d78c716439a5aa5a8166507cdeea87fc9f15668
                        data-chave-oamd="{{ implantacao.chave_oamd | default('') }}"
                        data-catraca="{{ implantacao.catraca | default('') }}"
                        data-facial="{{ implantacao.facial | default('') }}">
                        <i class="bi bi-pencil-square me-2"></i> Editar Detalhes
                    </button>
                </li>
<<<<<<< HEAD
=======

>>>>>>> 6d78c716439a5aa5a8166507cdeea87fc9f15668
                {% if implantacao.status == 'andamento' %}
                <li class="list-group-item"> <button class="btn btn-sm btn-link text-success text-decoration-none p-0" data-bs-toggle="modal" data-bs-target="#modalFinalizar"> <i class="bi bi-check-circle me-2"></i> Finalizar Implanta√ß√£o </button> </li>
                <li class="list-group-item"> <button class="btn btn-sm btn-link text-danger text-decoration-none p-0" data-bs-toggle="modal" data-bs-target="#modalParar"> <i class="bi bi-stop-circle me-2"></i> Parar Implanta√ß√£o </button> </li>
                {% elif implantacao.status == 'parada' %}
                <li class="list-group-item"> <button class="btn btn-sm btn-link text-primary text-decoration-none p-0" data-bs-toggle="modal" data-bs-target="#modalRetomar"> <i class="bi bi-play-circle me-2"></i> Retomar Implanta√ß√£o </button> </li>
                {% endif %}
<<<<<<< HEAD
=======

>>>>>>> 6d78c716439a5aa5a8166507cdeea87fc9f15668
                <li class="list-group-item">
                    <button class="btn btn-sm btn-link text-danger text-decoration-none p-0" data-bs-toggle="modal" data-bs-target="#modalExcluirImplantacao">
                        <i class="bi bi-trash-fill me-2"></i> Excluir Implanta√ß√£o
                    </button>
                </li>
            </ul>

<<<<<<< HEAD
            <h6 class="text-secondary border-bottom pb-2 mb-3 mt-3">Detalhes da Empresa</h6>
=======
            <h6 class="text-secondary border-bottom pb-2 mb-3 mt-3">Detalhes da Empresa</h6> {# Adicionado mt #}
>>>>>>> 6d78c716439a5aa5a8166507cdeea87fc9f15668
            <ul class="list-unstyled small sidebar-info-list">
                <li><i class="bi bi-building me-2"></i><strong>Empresa:</strong> {{ implantacao.nome_empresa }}</li>
                <li><i class="bi bi-person-workspace me-2"></i><strong>CS:</strong> {{ implantacao.usuario_cs }}</li>
                <li><i class="bi bi-tag me-2"></i><strong>Tipo:</strong> {{ 'Imediata' if implantacao.tipo == 'agora' else 'Futura' }}</li>
<<<<<<< HEAD
                <li><i class="bi bi-calendar-check me-2"></i><strong>Cria√ß√£o:</strong> {{ implantacao.data_criacao_fmt_d }}</li> {# Usa formato BR #}
                {% if implantacao.status == 'finalizada' %}
                    <li><i class="bi bi-calendar-x me-2"></i><strong>Finaliza√ß√£o:</strong> {{ implantacao.data_finalizacao_fmt_d }}</li> {# Usa formato BR #}
                {% elif implantacao.status == 'parada' and implantacao.data_finalizacao %}
                    <li><i class="bi bi-calendar-pause me-2"></i><strong>Pausada em:</strong> {{ implantacao.data_finalizacao_fmt_d }}</li> {# Usa formato BR #}
=======
                <li><i class="bi bi-calendar-check me-2"></i><strong>Cria√ß√£o:</strong> {{ implantacao.data_criacao.strftime('%Y-%m-%d') if implantacao.data_criacao else 'N/A' }}</li>
                {% if implantacao.status == 'finalizada' %}
                    <li><i class="bi bi-calendar-x me-2"></i><strong>Finaliza√ß√£o:</strong> {{ implantacao.data_finalizacao.strftime('%Y-%m-%d') if implantacao.data_finalizacao else 'N/A' }}</li>
                {% elif implantacao.status == 'parada' and implantacao.data_finalizacao %}
                    <li><i class="bi bi-calendar-pause me-2"></i><strong>Pausada em:</strong> {{ implantacao.data_finalizacao.strftime('%Y-%m-%d') if implantacao.data_finalizacao else 'N/A' }}</li> {# Adicionado if #}
>>>>>>> 6d78c716439a5aa5a8166507cdeea87fc9f15668
                {% endif %}
            </ul>

            <h6 class="text-secondary border-bottom pb-2 mb-3 mt-3">Detalhes do Cliente</h6>
            <ul class="list-unstyled small sidebar-info-list">
                <li><i class="bi bi-person-badge me-2"></i><strong>Respons√°vel:</strong> {{ implantacao.responsavel_cliente | default('N/A') }}</li>
                <li><i class="bi bi-briefcase me-2"></i><strong>Cargo:</strong> {{ implantacao.cargo_responsavel | default('N/A') }}</li>
                <li><i class="bi bi-telephone me-2"></i><strong>Telefone:</strong> {{ implantacao.telefone_responsavel | default('N/A') }}</li>
                <li><i class="bi bi-envelope me-2"></i><strong>E-mail:</strong> {{ implantacao.email_responsavel | default('N/A') }}</li>
            </ul>

            <h6 class="text-secondary border-bottom pb-2 mb-3 mt-3">Datas e Atributos</h6>
            <ul class="list-unstyled small sidebar-info-list">
<<<<<<< HEAD
                <li><i class="bi bi-play-circle-fill me-2"></i><strong>In√≠cio Produ√ß√£o:</strong> {{ implantacao.data_inicio_producao_fmt_d }}</li> {# Usa formato BR #}
                <li><i class="bi bi-calendar-check-fill me-2"></i><strong>Final Previsto:</strong> {{ implantacao.data_final_implantacao_fmt_d }}</li> {# Usa formato BR #}
=======
                <li><i class="bi bi-play-circle-fill me-2"></i><strong>In√≠cio Produ√ß√£o:</strong> {{ implantacao.data_inicio_producao | default('N/A') }}</li>
                <li><i class="bi bi-calendar-check-fill me-2"></i><strong>Final Previsto:</strong> {{ implantacao.data_final_implantacao | default('N/A') }}</li>
>>>>>>> 6d78c716439a5aa5a8166507cdeea87fc9f15668
                <li><i class="bi bi-key me-2"></i><strong>Chave OAMD:</strong> {{ implantacao.chave_oamd | default('N/A') }}</li>
                <li><i class="bi bi-hdd-stack me-2"></i><strong>Catraca:</strong> {{ implantacao.catraca | default('N/A') }}</li>
                <li><i class="bi bi-person-bounding-box me-2"></i><strong>Facial:</strong> {{ implantacao.facial | default('N/A') }}</li>
            </ul>

            <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary mt-auto"> <i class="bi bi-box-arrow-right me-2"></i> Sair </a>
        </div>
    </div>

    <main class="flex-grow-1 p-4" id="main-content">
<<<<<<< HEAD

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else ('warning' if category=='warning' else 'success') }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
=======
>>>>>>> 6d78c716439a5aa5a8166507cdeea87fc9f15668
        <div class="metric-card p-3 rounded shadow-sm mb-4">
            <div class="row align-items-center">
                <div class="col-md-6 mb-3 mb-md-0">
                    <p class="mb-1"><strong>Status:</strong>
                        {% if implantacao.status == 'finalizada' %} <span class="badge bg-success">Conclu√≠do</span>
                        {% elif implantacao.status == 'parada' %} <span class="badge bg-danger">Parada</span>
                        {% elif implantacao.status == 'futura' %} <span class="badge bg-info text-dark">Futura</span>
                        {% else %} <span class="badge bg-warning text-dark">Em Andamento</span> {% endif %}
                    </p>
                    {% if implantacao.status == 'parada' and implantacao.motivo_parada %} <p class="mb-1 small text-danger"> <strong>Motivo:</strong> {{ implantacao.motivo_parada }} </p> {% endif %}
<<<<<<< HEAD
                    <p class="mb-0"><strong>Cria√ß√£o:</strong> {{ implantacao.data_criacao_fmt_dt_hr }}</p> {# Usa formato BR com hora #}
=======
                    <p class="mb-0"><strong>Cria√ß√£o:</strong> {{ implantacao.data_criacao.strftime('%Y-%m-%d %H:%M:%S') if implantacao.data_criacao else 'N/A' }}</p>
>>>>>>> 6d78c716439a5aa5a8166507cdeea87fc9f15668
                </div>
                <div class="col-md-6">
                    <h4 class="h6 mb-2">Progresso Total</h4>
                    <div class="progress" style="height: 30px;"> <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: {{ progresso_porcentagem }}%;" aria-valuenow="{{ progresso_porcentagem }}" aria-valuemin="0" aria-valuemax="100">{{ progresso_porcentagem }}%</div> </div>
                </div>
            </div>
        </div>

        <ul class="nav nav-tabs" id="detalhesTab" role="tablist">
            <li class="nav-item" role="presentation"> <button class="nav-link active" id="checklist-tab" data-bs-toggle="tab" data-bs-target="#checklist-content" type="button" role="tab" aria-controls="checklist-content" aria-selected="true"> <i class="bi bi-check2-square me-1"></i> Checklist </button> </li>
            <li class="nav-item" role="presentation"> <button class="nav-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline-content" type="button" role="tab" aria-controls="timeline-content" aria-selected="false"> <i class="bi bi-clock-history me-1"></i> Linha do Tempo </button> </li>
        </ul>

        <div class="tab-content" id="detalhesTabContent">

            <div class="tab-pane fade show active" id="checklist-content" role="tabpanel" aria-labelledby="checklist-tab">
                <div id="checklist-area" class="pt-4">
                    {% for modulo, tarefas in tarefas_agrupadas.items() %}
                    <div class="card metric-card mb-4 shadow-sm">
                        <div class="card-header header-bg d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="false" aria-controls="collapse{{ loop.index }}">
                            <h5 class="mb-0 fs-6">{{ modulo }}</h5>
                            <i class="bi bi-chevron-down"></i>
                        </div>
                        <div id="collapse{{ loop.index }}" class="collapse" data-modulo="{{ modulo }}">
                            <ul class="list-group list-group-flush list-group-sortable" id="sortable-list-{{ loop.index }}">
                                {% for tarefa in tarefas %}
                                <li class="list-group-item d-flex align-items-start justify-content-between" data-id="{{ tarefa.id }}">
                                    <div class="d-flex flex-column flex-grow-1">
                                        <div class="d-flex align-items-center mb-2">
                                            <input class="form-check-input me-3 task-checkbox flex-shrink-0" type="checkbox" value="1" id="task-{{ tarefa.id }}" onchange="window.toggleTarefa({{ tarefa.id }}, this)" {% if tarefa.concluida %}checked{% endif %}>
<<<<<<< HEAD
                                            <div class="task-label-container">
=======
                                            <div class="task-label-container"> {# WRAPPER para label e tag #}
>>>>>>> 6d78c716439a5aa5a8166507cdeea87fc9f15668
                                                <label class="form-check-label {% if tarefa.concluida %}text-decoration-line-through text-success{% endif %}" for="task-{{ tarefa.id }}">
                                                    {{ tarefa.tarefa_filho }}
                                                </label>
                                                {% if tarefa.tag %}
                                                <span class="badge rounded-pill task-tag
                                                    {% if tarefa.tag == 'A√ß√£o interna' %} bg-secondary
                                                    {% elif tarefa.tag == 'Reuni√£o' %} bg-info text-dark
                                                    {% else %} bg-light text-dark {% endif %}">
                                                    {{ tarefa.tag }}
                                                </span>
                                                {% endif %}
                                            </div>
                                        </div>

<<<<<<< HEAD
                                        <div class="mt-1 ms-5 me-5">
=======
                                        <div class="mt-1 ms-5 me-5"> {# Indenta√ß√£o visual #}
>>>>>>> 6d78c716439a5aa5a8166507cdeea87fc9f15668
                                            <label class="form-label small text-secondary">Coment√°rios</label>
                                            <form onsubmit="return false;" class="comment-form mb-2">
                                                <textarea id="comment-text-{{ tarefa.id }}-new" class="form-control" name="comentario" maxlength="8000" rows="3" placeholder="Adicionar coment√°rio..."></textarea>
                                                <input type="file" name="imagem" class="form-control form-control-sm my-2" accept="image/png, image/jpeg, image/gif">
                                                <button class="btn btn-outline-primary btn-sm" type="button" onclick="window.adicionarComentario({{ tarefa.id }}, '{{ url_for('adicionar_comentario', tarefa_id=tarefa.id) }}', this)"> Salvar </button>
                                            </form>
                                            <div class="list-group list-group-flush border rounded-2" id="comment-list-{{ tarefa.id }}" style="max-height: 400px; overflow-y: auto;">
                                                {% if not tarefa.comentarios %} <div class="list-group-item list-group-item-action py-2 small text-secondary" id="no-comment-{{ tarefa.id }}"> Nenhum coment√°rio. </div> {% endif %}
<<<<<<< HEAD
                                                {% for comentario in tarefa.comentarios %}
                                                <div class="list-group-item list-group-item-action py-2">
                                                    <div class="d-flex w-100 justify-content-between">
                                                        <strong class="mb-1 small"> <i class="bi bi-person-fill me-1"></i> {{ comentario.usuario_nome }} </strong>
                                                        <small class="text-secondary">{{ comentario.data_criacao_fmt_d }}</small> {# Usa formato BR #}
=======
                                                {% for comentario in tarefa.comentarios %} {# Loop j√° est√° DESC vindo do backend #}
                                                <div class="list-group-item list-group-item-action py-2">
                                                    <div class="d-flex w-100 justify-content-between">
                                                        <strong class="mb-1 small"> <i class="bi bi-person-fill me-1"></i> {{ comentario.usuario_nome }} </strong>
                                                        <small class="text-secondary">{{ comentario.data_criacao.strftime('%Y-%m-%d') if comentario.data_criacao else '' }}</small>
>>>>>>> 6d78c716439a5aa5a8166507cdeea87fc9f15668
                                                    </div>
                                                    <div class="comment-content-wrapper">
                                                        <p class="mb-1 small comment-text" id="comment-text-{{ comentario.id }}">{{ comentario.texto | safe }}</p>
                                                        {% if comentario.texto | length > 300 %} <button class="btn btn-sm btn-link p-0 small" onclick="toggleComment(this, 'comment-text-{{ comentario.id }}')">Ver mais...</button> {% endif %}
                                                        {% if comentario.imagem_url %} <a href="{{ comentario.imagem_url }}" target="_blank" title="Clique para ampliar"> <img src="{{ comentario.imagem_url }}" class="img-fluid rounded mt-2 comment-image"> </a> {% endif %}
                                                    </div>
                                                    {% if comentario.usuario_cs == email_usuario_logado %} <button class="btn btn-sm btn-link text-danger p-0 small mt-1" onclick="window.excluirComentario({{ comentario.id }}, '{{ url_for('excluir_comentario', comentario_id=comentario.id) }}', this)"> Excluir </button> {% endif %}
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center ms-3 flex-shrink-0">
                                        <button class="btn btn-sm btn-outline-danger p-1 me-2" onclick="window.excluirTarefa({{ tarefa.id }}, this)" title="Excluir Tarefa"><i class="bi bi-x-circle-fill"></i></button>
                                        <i class="bi bi-grip-vertical handle" style="cursor: grab;" title="Mover Tarefa"></i>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
<<<<<<< HEAD
                    {% endfor %}
                </div>
            </div>
=======
                    {% endfor %} {# Fim do loop de m√≥dulos #}
                </div> {# Fim da checklist-area #}
            </div> {# Fim da tab-pane checklist #}
>>>>>>> 6d78c716439a5aa5a8166507cdeea87fc9f15668


            <div class="tab-pane fade" id="timeline-content" role="tabpanel" aria-labelledby="timeline-tab">
                <div class="metric-card p-3 rounded shadow-sm mt-0">
                    <h5 class="mb-3">Hist√≥rico de Eventos</h5>
                    <ul class="timeline-list">
                         {% if not logs_timeline %} <li class="alert alert-info text-center" role="alert" id="no-timeline-msg"> Nenhum evento registrado na linha do tempo deste cliente ainda. </li> {% endif %}
                        {% for log in logs_timeline %}
                        <li class="timeline-item">
                            <div class="timeline-icon">
                                {% if log.tipo_evento == 'novo_comentario' %} <i class="bi bi-chat-left-text-fill"></i>
                                {% elif 'tarefa' in log.tipo_evento %} <i class="bi bi-check-circle-fill"></i>
                                {% elif 'status' in log.tipo_evento or 'implantacao' in log.tipo_evento %} <i class="bi bi-flag-fill"></i>
                                {% else %} <i class="bi bi-info-circle-fill"></i> {% endif %}
                            </div>
                            <div class="timeline-content">
<<<<<<< HEAD
                                <div class="timeline-header"> <span class="timeline-usuario">{{ log.usuario_nome | default(log.usuario_cs) }}</span> <span class="timeline-data">{{ log.data_criacao_fmt_dt_hr }}</span> </div> {# Usa formato BR #}
=======
                                <div class="timeline-header"> <span class="timeline-usuario">{{ log.usuario_nome | default(log.usuario_cs) }}</span> <span class="timeline-data">{{ log.data_criacao.strftime('%Y-%m-%d %H:%M:%S') if log.data_criacao else '' }}</span> </div>
>>>>>>> 6d78c716439a5aa5a8166507cdeea87fc9f15668
                                <p class="timeline-detalhes">{{ log.detalhes | safe | replace('\n', '<br>') }}</p>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

        </div> </main>
</div>

<div class="modal fade" id="modalFinalizar" tabindex="-1" aria-labelledby="modalFinalizarLabel" aria-hidden="true">
    <div class="modal-dialog"> <div class="modal-content" style="background-color: var(--container-bg); color: var(--body-color);"> <div class="modal-header header-bg"> <h5 class="modal-title" id="modalFinalizarLabel" style="color: var(--body-color);">Finalizar Implanta√ß√£o</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> Tem certeza que deseja marcar "{{ implantacao.nome_empresa }}" como **Conclu√≠da**? </div> <form method="POST" action="{{ url_for('finalizar_implantacao') }}"> <div class="modal-footer header-bg"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button> <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}"> <button type="submit" class="btn btn-success">Confirmar Finaliza√ß√£o</button> </div> </form> </div> </div>
</div>
<div class="modal fade" id="modalParar" tabindex="-1" aria-labelledby="modalPararLabel" aria-hidden="true">
    <div class="modal-dialog"> <div class="modal-content" style="background-color: var(--container-bg); color: var(--body-color);"> <div class="modal-header header-bg"> <h5 class="modal-title" id="modalPararLabel" style="color: var(--body-color);">Parar Implanta√ß√£o</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button> </div> <form method="POST" action="{{ url_for('parar_implantacao') }}"> <div class="modal-body"> <p>Tem certeza que deseja marcar "{{ implantacao.nome_empresa }}" como **Parada**?</p> <div class="mb-3"> <label for="motivo_parada" class="form-label">Motivo (Obrigat√≥rio)</label> <select class="form-select" id="motivo_parada" name="motivo_parada" required> <option value="" disabled selected>Selecione uma justificativa...</option> {% for motivo in justificativas_parada %} <option value="{{ motivo }}">{{ motivo }}</option> {% endfor %} </select> </div> </div> <div class="modal-footer header-bg"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button> <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}"> <button type="submit" class="btn btn-danger">Confirmar Parada</button> </div> </form> </div> </div>
</div>
<div class="modal fade" id="modalRetomar" tabindex="-1" aria-labelledby="modalRetomarLabel" aria-hidden="true">
    <div class="modal-dialog"> <div class="modal-content" style="background-color: var(--container-bg); color: var(--body-color);"> <div class="modal-header header-bg"> <h5 class="modal-title" id="modalRetomarLabel" style="color: var(--body-color);">Retomar Implanta√ß√£o</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> Tem certeza que deseja retomar a implanta√ß√£o de "{{ implantacao.nome_empresa }}"? O status ser√° alterado para "Em Andamento". </div> <form method="POST" action="{{ url_for('retomar_implantacao') }}"> <div class="modal-footer header-bg"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button> <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}"> <input type="hidden" name="redirect_to" value="detalhes"> <button type="submit" class="btn btn-primary">Confirmar Retomada</button> </div> </form> </div> </div>
</div>
<div class="modal fade" id="adicionarTarefaModal" tabindex="-1" aria-labelledby="adicionarTarefaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: var(--container-bg); color: var(--body-color);">
            <div class="modal-header header-bg">
                <h5 class="modal-title" id="adicionarTarefaModalLabel" style="color: var(--body-color);">Adicionar Tarefa Personalizada</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('adicionar_tarefa') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <div class="mb-3">
                        <label for="tarefaPai" class="form-label">M√≥dulo (Agrupamento)</label>
                        <select class="form-select" id="tarefaPai" name="tarefa_pai" required>
                            <option value="">Selecione um m√≥dulo</option>
                            {% for modulo in tarefas_agrupadas.keys() %}
                                {% if modulo != 'Observa√ß√£o' %} {# Evita adicionar em m√≥dulo inexistente #}
                                    <option value="{{ modulo }}">{{ modulo }}</option>
                                {% endif %}
                            {% endfor %}
                            <option value="Personalizado">Outro (Novo M√≥dulo)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="tarefaFilho" class="form-label">Nome da Tarefa</label>
                        <input type="text" class="form-control" id="tarefaFilho" name="tarefa_filho" required>
                    </div>
                    <div class="mb-3">
                        <label for="tarefaTag" class="form-label">Etiqueta (Tag)</label>
                        <select class="form-select" id="tarefaTag" name="tarefa_tag">
                            <option value="" selected>Nenhuma</option>
                            <option value="A√ß√£o interna">A√ß√£o interna</option>
                            <option value="Reuni√£o">Reuni√£o</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer header-bg">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="background-color: var(--accent-color); border-color: var(--accent-color);">Adicionar</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="modalExcluirImplantacao" tabindex="-1" aria-labelledby="modalExcluirImplantacaoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: var(--container-bg); color: var(--body-color);">
            <div class="modal-header header-bg">
                <h5 class="modal-title" id="modalExcluirImplantacaoLabel" style="color: var(--body-color);">Excluir Implanta√ß√£o</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-danger fw-bold">Aten√ß√£o: A√ß√£o Irrevers√≠vel!</p>
<<<<<<< HEAD
                <p>Tem certeza que deseja excluir permanentemente a implanta√ß√£o de "{{ implantacao.nome_empresa }}"?</p>
                <p>Todas as tarefas, coment√°rios e imagens associadas ser√£o removidos. Esta a√ß√£o n√£o pode ser desfeita.</p>
=======
                <p>
                    Tem certeza que deseja excluir permanentemente a implanta√ß√£o de "{{ implantacao.nome_empresa }}"?
                </p>
                <p>
                    Todas as tarefas, coment√°rios e imagens associadas ser√£o removidos. Esta a√ß√£o n√£o pode ser desfeita.
                </p>
>>>>>>> 6d78c716439a5aa5a8166507cdeea87fc9f15668
            </div>
            <form method="POST" action="{{ url_for('excluir_implantacao') }}">
                <div class="modal-footer header-bg">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <button type="submit" class="btn btn-danger">Confirmar Exclus√£o</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script>
// Fun√ß√µes JS (formatDataComentario, formatDataLog, toggleComment, criarTimelineItemHTML, adicionarLogNaTimeline, criarComentarioHTML, adicionarComentario, excluirComentario, updateProgressBar, toggleTarefa, excluirTarefa)

<<<<<<< HEAD
// [CORRE√á√ÉO APLICADA] - Recebe YYYY-MM-DD HH:MM:SS (ou apenas YYYY-MM-DD) e exibe DD/MM/AAAA
function formatDataComentario(dataStr) {
    if (!dataStr) return '';
    try {
        const isoStr = typeof dataStr === 'string' ? dataStr.replace(' ', 'T')+'Z' : dataStr; // Adiciona 'Z' para UTC
        const dateObj = new Date(isoStr);
        if (isNaN(dateObj.getTime())) { throw new Error("Data inv√°lida ap√≥s parse"); }
        const day = String(dateObj.getDate()).padStart(2, '0');
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const year = dateObj.getFullYear();
        return `${day}/${month}/${year}`;
    } catch (e) {
        console.error("Erro formatando data do coment√°rio para DD/MM/AAAA:", dataStr, e);
        if (typeof dataStr === 'string'){ const parts = dataStr.split(' ')[0].split('-'); if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`; }
=======
// [AJUSTE APLICADO] - Formata data YYYY-MM-DD
function formatDataComentario(dataStr) {
    if (!dataStr) return '';
    try {
        // Assume YYYY-MM-DD HH:MM:SS format from backend (data_criacao)
        const datePart = dataStr.split(' ')[0];
        return datePart;
    } catch (e) {
        console.error("Erro formatando data do coment√°rio:", dataStr, e);
>>>>>>> 6d78c716439a5aa5a8166507cdeea87fc9f15668
        return 'Data inv√°lida';
    }
}

<<<<<<< HEAD
// [CORRE√á√ÉO APLICADA] - Recebe YYYY-MM-DD HH:MM:SS e exibe DD/MM/AAAA √†s HH:MM:SS
function formatDataLog(dataStr) {
     if (!dataStr) return '';
    try {
        const isoStr = typeof dataStr === 'string' ? dataStr.replace(' ', 'T')+'Z' : dataStr; // Adiciona 'Z' para UTC
        const dateObj = new Date(isoStr);
        if (isNaN(dateObj.getTime())) { throw new Error("Data inv√°lida ap√≥s parse"); }
        const day = String(dateObj.getDate()).padStart(2, '0');
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const year = dateObj.getFullYear();
        const hours = String(dateObj.getHours()).padStart(2, '0');
        const minutes = String(dateObj.getMinutes()).padStart(2, '0');
        const seconds = String(dateObj.getSeconds()).padStart(2, '0');
        return `${day}/${month}/${year} √†s ${hours}:${minutes}:${seconds}`;
    } catch (e) {
        console.error("Erro formatando data do log para DD/MM/AAAA HH:MM:SS:", dataStr, e);
         if (typeof dataStr === 'string'){
            const dateTimeParts = dataStr.split(' '); const dateParts = dateTimeParts[0].split('-'); const timePart = dateTimeParts.length > 1 ? dateTimeParts[1] : '';
            if (dateParts.length === 3) { const timeStr = timePart ? ` √†s ${timePart}` : ''; return `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}${timeStr}`; }
        }
=======
// [AJUSTE APLICADO] - Formata data/hora YYYY-MM-DD HH:MM:SS
function formatDataLog(dataStr) {
     if (!dataStr) return '';
    try {
        // Assume YYYY-MM-DD HH:MM:SS format from backend (data_criacao)
        return dataStr;
    } catch (e) {
        console.error("Erro formatando data do log:", dataStr, e);
>>>>>>> 6d78c716439a5aa5a8166507cdeea87fc9f15668
        return 'Data inv√°lida';
    }
}

function toggleComment(button, elementId) { const textElement = document.getElementById(elementId); if (!textElement) return; const isExpanded = textElement.classList.toggle('expanded'); button.textContent = isExpanded ? 'Ver menos...' : 'Ver mais...'; }
<<<<<<< HEAD
function criarTimelineItemHTML(log) { let iconClass = 'bi-info-circle-fill'; if (log.tipo_evento === 'novo_comentario') iconClass = 'bi-chat-left-text-fill'; else if (log.tipo_evento.includes('tarefa')) iconClass = 'bi-check-circle-fill'; else if (log.tipo_evento.includes('status')) iconClass = 'bi-flag-fill'; const dataFormatada = formatDataLog(log.data_criacao); const detalhesHTML = (log.detalhes || '').replace(/\n/g, '<br>'); return ` <li class="timeline-item"> <div class="timeline-icon"> <i class="bi ${iconClass}"></i> </div> <div class="timeline-content"> <div class="timeline-header"> <span class="timeline-usuario">${log.usuario_nome || 'Usu√°rio Desconhecido'}</span> <span class="timeline-data">${dataFormatada}</span> </div> <p class="timeline-detalhes">${detalhesHTML}</p> </div> </li> `; }
function adicionarLogNaTimeline(log) { if (!log || !log.data_criacao) return; const timelineList = document.querySelector('#timeline-content .timeline-list'); if (!timelineList) return; const noTimelineMsg = document.getElementById('no-timeline-msg'); if (noTimelineMsg) noTimelineMsg.remove(); const logHTML = criarTimelineItemHTML(log); timelineList.insertAdjacentHTML('afterbegin', logHTML); }

function criarComentarioHTML(comentario, emailUsuarioLogado) {
    const dataFormatada = formatDataComentario(comentario.data_criacao); // Formato BR
=======
function criarTimelineItemHTML(log) { let iconClass = 'bi-info-circle-fill'; if (log.tipo_evento === 'novo_comentario') iconClass = 'bi-chat-left-text-fill'; else if (log.tipo_evento.includes('tarefa')) iconClass = 'bi-check-circle-fill'; else if (log.tipo_evento.includes('status')) iconClass = 'bi-flag-fill'; const dataFormatada = formatDataLog(log.data_criacao); const detalhesHTML = log.detalhes.replace(/\n/g, '<br>'); return ` <li class="timeline-item"> <div class="timeline-icon"> <i class="bi ${iconClass}"></i> </div> <div class="timeline-content"> <div class="timeline-header"> <span class="timeline-usuario">${log.usuario_nome}</span> <span class="timeline-data">${dataFormatada}</span> </div> <p class="timeline-detalhes">${detalhesHTML}</p> </div> </li> `; }
function adicionarLogNaTimeline(log) { if (!log) return; const timelineList = document.querySelector('#timeline-content .timeline-list'); if (!timelineList) return; const noTimelineMsg = document.getElementById('no-timeline-msg'); if (noTimelineMsg) { noTimelineMsg.remove(); } const logHTML = criarTimelineItemHTML(log); timelineList.insertAdjacentHTML('afterbegin', logHTML); }

function criarComentarioHTML(comentario, emailUsuarioLogado) {
    // Usamos apenas a parte da data para o formato YYYY-MM-DD
    const dataFormatada = formatDataComentario(comentario.data_criacao); 
>>>>>>> 6d78c716439a5aa5a8166507cdeea87fc9f15668
    let botaoExcluir = '';
    if (comentario.usuario_cs === emailUsuarioLogado) {
        const urlExcluir = `{{ url_for('excluir_comentario', comentario_id=0) }}`.replace('0', comentario.id);
        botaoExcluir = ` <button class="btn btn-sm btn-link text-danger p-0 small mt-1" onclick="window.excluirComentario(${comentario.id}, '${urlExcluir}', this)"> Excluir </button> `;
    }
<<<<<<< HEAD
    let textoHTML = `<p class="mb-1 small comment-text" id="comment-text-${comentario.id}">${comentario.texto || ''}</p>`;
=======
    let textoHTML = `<p class="mb-1 small comment-text" id="comment-text-${comentario.id}">${comentario.texto}</p>`;
>>>>>>> 6d78c716439a5aa5a8166507cdeea87fc9f15668
    if (comentario.texto && comentario.texto.length > 300) {
        textoHTML += `<button class="btn btn-sm btn-link p-0 small" onclick="toggleComment(this, 'comment-text-${comentario.id}')">Ver mais...</button>`;
    }
    let imagemHTML = '';
    if (comentario.imagem_url) {
        imagemHTML = ` <a href="${comentario.imagem_url}" target="_blank" title="Clique para ampliar"> <img src="${comentario.imagem_url}" class="img-fluid rounded mt-2 comment-image"> </a> `;
    }
<<<<<<< HEAD
    return ` <div class="list-group-item list-group-item-action py-2"> <div class="d-flex w-100 justify-content-between"> <strong class="mb-1 small"> <i class="bi bi-person-fill me-1"></i> ${comentario.usuario_nome || 'Usu√°rio'} </strong> <small class="text-secondary">${dataFormatada}</small> </div> <div class="comment-content-wrapper"> ${textoHTML} ${imagemHTML} </div> ${botaoExcluir} </div> `;
}

function adicionarComentario(tarefaId, endpointUrl, button) {
    const form = button.closest('.comment-form'); const textarea = form.querySelector('textarea'); const fileInput = form.querySelector('input[type="file"]'); const comentario = textarea.value.trim(); const file = fileInput.files.length > 0 ? fileInput.files[0] : null; if (comentario === '' && !file) { alert('Coment√°rio vazio ou sem imagem.'); return; } if (file) { const allowedTypes = ['image/png', 'image/jpeg', 'image/gif']; if (!allowedTypes.includes(file.type)) { alert('Tipo de arquivo n√£o permitido.'); return; } } const originalBtnText = button.innerHTML; button.disabled = true; button.innerHTML = 'Salvando...'; const formData = new FormData(); formData.append('comentario', comentario); if (file) { formData.append('imagem', file); }
    fetch(endpointUrl, { method: 'POST', body: formData })
        .then(response => response.json())
        .then(data => { if (data.ok) { const commentList = document.getElementById('comment-list-' + tarefaId); const noCommentMsg = document.getElementById('no-comment-' + tarefaId); if (noCommentMsg) noCommentMsg.remove(); const emailUsuarioLogado = '{{ email_usuario_logado }}'; const comentarioHTML = criarComentarioHTML(data.comentario, emailUsuarioLogado); commentList.insertAdjacentHTML('beforeend', comentarioHTML); textarea.value = ''; fileInput.value = null; adicionarLogNaTimeline(data.log_comentario); } else { throw new Error(data.error || 'Erro desconhecido'); } })
        .catch(error => { console.error('Erro add coment√°rio:', error); alert('Erro ao salvar.'); })
        .finally(() => { button.innerHTML = originalBtnText; button.disabled = false; });
}
function excluirComentario(comentarioId, endpointUrl, button) { if (!confirm('Excluir este coment√°rio?')) return; fetch(endpointUrl, { method: 'POST', }) .then(response => response.json()) .then(data => { if (data.ok) { const comentarioElement = button.closest('.list-group-item'); const commentList = comentarioElement.parentElement; comentarioElement.remove(); if (commentList.children.length === 0) { const tarefaId = commentList.id.split('-')[2]; commentList.innerHTML = ` <div class="list-group-item list-group-item-action py-2 small text-secondary" id="no-comment-${tarefaId}"> Nenhum coment√°rio. </div> `; } adicionarLogNaTimeline(data.log_exclusao); } else { throw new Error(data.error || 'Erro desconhecido'); } }) .catch(error => { console.error('Erro excluir coment√°rio:', error); alert('Erro ao excluir.'); }); }
function updateProgressBar(progress) { const progressBar = document.querySelector('.progress-bar'); if (progressBar) { progressBar.style.width = progress + '%'; progressBar.setAttribute('aria-valuenow', progress); progressBar.textContent = progress + '%'; } }
function toggleTarefa(tarefaId, checkbox) { const label = checkbox.closest('.d-flex.align-items-center').querySelector('label.form-check-label'); const isChecked = checkbox.checked; fetch(`/toggle_tarefa/${tarefaId}`, { method: 'POST', headers: { 'Content-Type': 'application/json' } }) .then(response => response.json()) .then(data => { if (data.ok) { if (data.novo_status === 1) { label.classList.add('text-decoration-line-through', 'text-success'); } else { label.classList.remove('text-decoration-line-through', 'text-success'); } if (data.novo_progresso !== undefined) { updateProgressBar(data.novo_progresso); } adicionarLogNaTimeline(data.log_tarefa); if (data.implantacao_finalizada) { adicionarLogNaTimeline(data.log_finalizacao); alert('Parab√©ns! Implanta√ß√£o finalizada automaticamente.'); window.location.reload(); } } else { console.error('Erro toggle tarefa:', data.error); alert('Erro ao salvar tarefa.'); checkbox.checked = !isChecked; } }) .catch(error => { console.error('Erro rede toggle tarefa:', error); alert('Erro ao salvar tarefa.'); checkbox.checked = !isChecked; }); }
function excluirTarefa(tarefaId, button) { if (!confirm('Excluir esta tarefa e seus coment√°rios?')) return; const endpointUrl = `{{ url_for('excluir_tarefa', tarefa_id=0) }}`.replace('0', tarefaId); button.disabled = true; const originalIcon = button.innerHTML; button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>'; fetch(endpointUrl, { method: 'POST' }) .then(response => response.json()) .then(data => { if (data.ok) { const listItem = button.closest('.list-group-item'); if(listItem) listItem.remove(); adicionarLogNaTimeline(data.log_exclusao); if (data.implantacao_finalizada) { adicionarLogNaTimeline(data.log_finalizacao); alert('Parab√©ns! Implanta√ß√£o finalizada automaticamente.'); } if (data.novo_progresso !== undefined) { updateProgressBar(data.novo_progresso); } } else { throw new Error(data.error || 'Erro desconhecido'); } }) .catch(error => { console.error('Erro excluir tarefa:', error); alert('Erro ao excluir tarefa.'); button.disabled = false; button.innerHTML = originalIcon; }); }
=======
    return ` <div class="list-group-item list-group-item-action py-2"> <div class="d-flex w-100 justify-content-between"> <strong class="mb-1 small"> <i class="bi bi-person-fill me-1"></i> ${comentario.usuario_nome} </strong> <small class="text-secondary">${dataFormatada}</small> </div> <div class="comment-content-wrapper"> ${textoHTML} ${imagemHTML} </div> ${botaoExcluir} </div> `;
}

function adicionarComentario(tarefaId, endpointUrl, button) {
    const form = button.closest('.comment-form'); const textarea = form.querySelector('textarea'); const fileInput = form.querySelector('input[type="file"]'); const comentario = textarea.value.trim(); const file = fileInput.files.length > 0 ? fileInput.files[0] : null; if (comentario === '' && !file) { alert('O coment√°rio n√£o pode estar vazio ou sem imagem.'); return; } if (file) { const allowedTypes = ['image/png', 'image/jpeg', 'image/gif']; if (!allowedTypes.includes(file.type)) { alert('Tipo de arquivo n√£o permitido. Use apenas PNG, JPG ou GIF.'); return; } } const originalBtnText = button.innerHTML; button.disabled = true; button.innerHTML = 'Salvando...'; const formData = new FormData(); formData.append('comentario', comentario); if (file) { formData.append('imagem', file); }
    fetch(endpointUrl, { method: 'POST', body: formData })
        .then(response => response.json())
        .then(data => { if (data.ok) { const commentList = document.getElementById('comment-list-' + tarefaId); const noCommentMsg = document.getElementById('no-comment-' + tarefaId); if (noCommentMsg) noCommentMsg.remove(); const emailUsuarioLogado = '{{ email_usuario_logado }}'; const comentarioHTML = criarComentarioHTML(data.comentario, emailUsuarioLogado); commentList.insertAdjacentHTML('afterbegin', comentarioHTML); textarea.value = ''; fileInput.value = null; adicionarLogNaTimeline(data.log_comentario); } else { throw new Error(data.error || 'Erro desconhecido'); } })
        .catch(error => { console.error('Erro ao adicionar coment√°rio:', error); alert('Erro ao salvar o coment√°rio. Tente novamente.'); })
        .finally(() => { button.innerHTML = originalBtnText; button.disabled = false; });
}
function excluirComentario(comentarioId, endpointUrl, button) { if (!confirm('Tem certeza que deseja excluir este coment√°rio?')) { return; } fetch(endpointUrl, { method: 'POST', }) .then(response => response.json()) .then(data => { if (data.ok) { const comentarioElement = button.closest('.list-group-item'); const commentList = comentarioElement.parentElement; comentarioElement.remove(); if (commentList.children.length === 0) { const tarefaId = commentList.id.split('-')[2]; commentList.innerHTML = ` <div class="list-group-item list-group-item-action py-2 small text-secondary" id="no-comment-${tarefaId}"> Nenhum coment√°rio. </div> `; } adicionarLogNaTimeline(data.log_exclusao); } else { throw new Error(data.error || 'Erro desconhecido'); } }) .catch(error => { console.error('Erro ao excluir coment√°rio:', error); alert('Erro ao excluir o coment√°rio. Tente novamente.'); }); }
function updateProgressBar(progress) { const progressBar = document.querySelector('.progress-bar'); if (progressBar) { progressBar.style.width = progress + '%'; progressBar.setAttribute('aria-valuenow', progress); progressBar.textContent = progress + '%'; } }
function toggleTarefa(tarefaId, checkbox) { const label = checkbox.closest('.d-flex.align-items-center').querySelector('label.form-check-label'); const isChecked = checkbox.checked; fetch(`/toggle_tarefa/${tarefaId}`, { method: 'POST', headers: { 'Content-Type': 'application/json' } }) .then(response => response.json()) .then(data => { if (data.ok) { if (data.novo_status === 1) { label.classList.add('text-decoration-line-through', 'text-success'); } else { label.classList.remove('text-decoration-line-through', 'text-success'); } if (data.novo_progresso !== undefined) { updateProgressBar(data.novo_progresso); } adicionarLogNaTimeline(data.log_tarefa); if (data.implantacao_finalizada) { adicionarLogNaTimeline(data.log_finalizacao); alert('Parab√©ns! Implanta√ß√£o finalizada automaticamente.'); window.location.reload(); } } else { console.error('Erro ao alternar tarefa:', data.error); alert('Erro ao salvar a tarefa. Tente novamente.'); checkbox.checked = !isChecked; } }) .catch(error => { console.error('Erro de rede:', error); alert('Erro ao salvar a tarefa. Por favor, tente novamente.'); checkbox.checked = !isChecked; }); }
function excluirTarefa(tarefaId, button) { if (!confirm('Tem certeza que deseja excluir esta tarefa? Coment√°rios associados tamb√©m ser√£o removidos.')) { return; } const endpointUrl = `{{ url_for('excluir_tarefa', tarefa_id=0) }}`.replace('0', tarefaId); button.disabled = true; const originalIcon = button.innerHTML; button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>'; fetch(endpointUrl, { method: 'POST' }) .then(response => response.json()) .then(data => { if (data.ok) { const listItem = button.closest('.list-group-item'); if(listItem) listItem.remove(); adicionarLogNaTimeline(data.log_exclusao); if (data.implantacao_finalizada) { adicionarLogNaTimeline(data.log_finalizacao); alert('Parab√©ns! Implanta√ß√£o finalizada automaticamente ap√≥s exclus√£o da tarefa.'); } if (data.novo_progresso !== undefined) { updateProgressBar(data.novo_progresso); } } else { throw new Error(data.error || 'Erro desconhecido ao excluir tarefa'); } }) .catch(error => { console.error('Erro ao excluir tarefa:', error); alert('Erro ao excluir a tarefa. Tente novamente.'); button.disabled = false; button.innerHTML = originalIcon; }); }
>>>>>>> 6d78c716439a5aa5a8166507cdeea87fc9f15668

// C√≥digo principal do DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    const implantacaoId = {{ implantacao.id }};
    const endpointReordenar = '{{ url_for('reordenar_tarefas') }}';
    const endpointDetalhes = '{{ url_for('ver_implantacao', impl_id=implantacao.id) }}';

<<<<<<< HEAD
    window.toggleTarefa = toggleTarefa; window.adicionarComentario = adicionarComentario; window.excluirComentario = excluirComentario; window.toggleComment = toggleComment; window.excluirTarefa = excluirTarefa;

    document.querySelectorAll('.list-group-sortable').forEach(list => {
        const modulo = list.closest('.collapse').dataset.modulo;
        new Sortable(list, { animation: 150, handle: '.handle', onEnd: function (evt) {
                const novaOrdem = Array.from(evt.to.children).map(item => parseInt(item.dataset.id));
                fetch(endpointReordenar, { method: 'POST', headers: {'Content-Type': 'application/json', }, body: JSON.stringify({ implantacao_id: implantacaoId, tarefa_pai: modulo, ordem: novaOrdem }) })
                .then(r => r.json()).then(d => { if (d.ok) adicionarLogNaTimeline(d.log_reordenar); else { console.error('Erro reordenar:', d.error); alert('Erro. Recarregando.'); window.location.href = endpointDetalhes; } })
                .catch(e => { console.error('Erro rede reordenar:', e); alert('Erro. Recarregando.'); window.location.href = endpointDetalhes; });
        }, });
    });

    const tabSelector = '#detalhesTab .nav-link'; const tabs = document.querySelectorAll(tabSelector); const tabKey = `tabAtiva-implantacao-${implantacaoId}`;
    tabs.forEach(tab => tab.addEventListener('shown.bs.tab', e => localStorage.setItem(tabKey, e.target.id)));
    const activeTabId = localStorage.getItem(tabKey); if (activeTabId) { const tabEl = document.getElementById(activeTabId); if (tabEl) new bootstrap.Tab(tabEl).show(); }

    document.querySelectorAll('.comment-text').forEach(textEl => {
        const wrapper = textEl.closest('.comment-content-wrapper'); let button = wrapper ? wrapper.querySelector('button[onclick^="toggleComment"]') : null;
        const maxHeight = parseFloat(window.getComputedStyle(textEl).maxHeight); const isOverflowing = textEl.scrollHeight > maxHeight + 5;
        if (isOverflowing && !button) { const newBtn = document.createElement('button'); newBtn.className = 'btn btn-sm btn-link p-0 small'; newBtn.textContent = 'Ver mais...'; newBtn.onclick = function() { toggleComment(this, textEl.id); }; (wrapper || textEl.parentNode).insertBefore(newBtn, textEl.nextSibling); }
        else if (!isOverflowing && button) { button.remove(); }
        else if (button) { button.textContent = textEl.classList.contains('expanded') ? 'Ver menos...' : 'Ver mais...'; }
=======
    window.toggleTarefa = toggleTarefa;
    window.adicionarComentario = adicionarComentario;
    window.excluirComentario = excluirComentario;
    window.toggleComment = toggleComment;
    window.excluirTarefa = excluirTarefa;

    document.querySelectorAll('.list-group-sortable').forEach(list => {
        const modulo = list.closest('.collapse').dataset.modulo;
        new Sortable(list, {
            animation: 150, handle: '.handle',
            onEnd: function (evt) {
                const novaOrdem = Array.from(evt.to.children).map(item => parseInt(item.dataset.id));
                fetch(endpointReordenar, { method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify({ implantacao_id: implantacaoId, tarefa_pai: modulo, ordem: novaOrdem }) })
                .then(response => response.json())
                .then(data => { if (data.ok) { adicionarLogNaTimeline(data.log_reordenar); } else { console.error('Erro ao reordenar:', data.error); alert('Erro ao reordenar as tarefas. A p√°gina ser√° recarregada.'); window.location.href = endpointDetalhes; } })
                .catch(error => { console.error('Erro de rede ao reordenar:', error); alert('Erro ao reordenar as tarefas. A p√°gina ser√° recarregada.'); window.location.href = endpointDetalhes; });
            },
        });
    });

    const tabSelector = '#detalhesTab .nav-link';
    const tabs = document.querySelectorAll(tabSelector);
    const tabStorageKey = `tabAtiva-implantacao-{{ implantacao.id }}`;
    tabs.forEach(tab => { tab.addEventListener('shown.bs.tab', event => { localStorage.setItem(tabStorageKey, event.target.id); }); });
    const abaAtivaId = localStorage.getItem(tabStorageKey);
    if (abaAtivaId) { const tabEl = document.getElementById(abaAtivaId); if (tabEl) { new bootstrap.Tab(tabEl).show(); } }

     document.querySelectorAll('.comment-text').forEach(textEl => {
        const wrapper = textEl.closest('.comment-content-wrapper'); let button = null; if(wrapper) { button = wrapper.querySelector('button[onclick^="toggleComment"]'); }
        const maxHeight = parseFloat(window.getComputedStyle(textEl).maxHeight); const isOverflowing = textEl.scrollHeight > maxHeight + 5;
        if (isOverflowing && !button) {
             const newButton = document.createElement('button'); newButton.className = 'btn btn-sm btn-link p-0 small'; newButton.textContent = 'Ver mais...'; newButton.onclick = function() { toggleComment(this, textEl.id); };
             if (wrapper) { wrapper.insertBefore(newButton, textEl.nextSibling); } else { textEl.parentNode.insertBefore(newButton, textEl.nextSibling); }
        } else if (!isOverflowing && button) { button.remove(); }
        else if (isOverflowing && button && !textEl.classList.contains('expanded')) { button.textContent = 'Ver mais...'; }
        else if (isOverflowing && button && textEl.classList.contains('expanded')) { button.textContent = 'Ver menos...'; }
>>>>>>> 6d78c716439a5aa5a8166507cdeea87fc9f15668
    });
});
</script>
{% endblock %}