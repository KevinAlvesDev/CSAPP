{% extends "base.html" %}

{% block title %}CS Onboarding Dashboard{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <header class="header-bg p-3 shadow-sm d-flex justify-content-end align-items-center position-relative">
        <h1 class="main-title mb-0 fs-4" style="position: absolute; left: 50%; transform: translateX(-50%); white-space: nowrap;">CS ONBOARDING DASHBOARD</h1>

        <div class="d-flex align-items-center">

            {# Apenas usuários com permissão (Admin, Gerente, Coord) veem o botão #}
            {% if g.perfil and g.perfil.perfil_acesso in PERFIS_COM_CRIACAO %}
            <button class="btn btn-success ms-3" data-bs-toggle="modal" data-bs-target="#novaImplantacaoModal" style="background-color: var(--accent-color); border-color: var(--accent-color);">
                <i class="bi bi-plus-circle me-1"></i> Nova Implantação
            </button>
            {% endif %}
            <div class="dropdown ms-2">
                <button class="btn btn-outline-secondary rounded-circle p-0" type="button" id="userMenuDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="Menu" style="width: 40px; height: 40px; border: 2px solid var(--accent-color); overflow: hidden;">
                    {# g.perfil é injetado pelo decorator @login_required #}
                    {% if g.perfil.foto_url %}
                        <img src="{{ g.perfil.foto_url }}?v={{ range(1, 10000) | random }}" alt="Foto de Perfil" style="width: 100%; height: 100%; object-fit: cover;">
                    {% else %}
                        <i class="bi bi-person-fill" style="font-size: 1.5rem; color: var(--accent-color);"></i>
                    {% endif %}
                </button>

                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenuDropdown">
                     <li><a class="dropdown-item" href="{{ url_for('profile.perfil') }}"><i class="bi bi-person-circle me-2"></i> Editar Perfil</a></li>

                     {# Links Condicionais (ESCONDIDOS DE IMPLANTADORES) #}
                     {% if g.perfil and g.perfil.perfil_acesso in ['Administrador', 'Gerente', 'Coordenador'] %}
                          <li><a class="dropdown-item text-primary" href="#" data-bs-toggle="modal" data-bs-target="#modalGerenciarUsuarios"><i class="bi bi-people-fill me-2"></i> Usuários</a></li>
                         
                         {# O LINK "Analytics Gerencial" FOI REMOVIDO AQUI, pois o conteúdo está na página principal #}

                         {# Links Gamificação #}
                         <li><a class="dropdown-item text-warning" href="{{ url_for('gamification.manage_gamification_metrics') }}"><i class="bi bi-pencil-square me-2"></i> Métricas Gamificação</a></li>
                         <li><a class="dropdown-item text-success" href="{{ url_for('gamification.gamification_report') }}"><i class="bi bi-clipboard-data me-2"></i> Relatório Gamificação</a></li>
                     {% endif %}
                     {# Fim dos Links Condicionais #}

                     <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalGamificacao"><i class="bi bi-trophy-fill me-2"></i> Critérios Gamificação</a></li>
                     <li><hr class="dropdown-divider"></li>
                     <li><a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}"><i class="bi bi-box-arrow-right me-2"></i> Sair</a></li>
                </ul>
                </div>
            </div>
    </header>
    <main class="p-4" id="main-content">

        {# Mensagens Flash (MOVIDO PARA O TOPO) #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {# --- FILTROS DA CARTEIRA (APENAS GESTÃO) --- #}
        {% if is_manager %}
        <div class="metric-card p-3 rounded shadow-sm mb-4">
            <h6 class="text-secondary mb-3 border-bottom pb-2">Filtros da Carteira</h6>
            <form method="GET" action="{{ url_for('main.dashboard') }}">
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label for="cs_filter" class="form-label small text-secondary">Filtrar Colaborador CS</label>
                        <select id="cs_filter" name="cs_filter" class="form-select form-select-sm" onchange="this.form.submit()">
                            <option value="todos" {% if selected_cs_filter == 'todos' %}selected{% endif %}>
                                -- Visualizar Toda a Carteira --
                            </option>
                            {% for cs in all_cs_users %}
                                <option value="{{ cs.usuario }}" {% if cs.usuario == selected_cs_filter %}selected{% endif %}>
                                    {{ cs.nome }} ({{ cs.usuario }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary btn-sm w-100" style="background-color: var(--accent-color); border-color: var(--accent-color);">
                            Aplicar Filtro
                        </button>
                    </div>
                </div>
            </form>
        </div>
        {% endif %}
        {# --- FIM DO BLOCO DE FILTRO --- #}

        {# Resumo Rápido (VISÍVEL PARA TODOS) #}
        <h2 class="h5 mb-3">Resumo Rápido</h2>
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-5 g-3 mb-4">
            {% set m = metrics or {} %}
            <div class="col"><div class="metric-card p-3 rounded shadow-sm text-center"><h6 class="text-secondary">Em Andamento</h6><h4 class="mb-0 text-primary">{{ m.impl_andamento_total | default(0) }}</h4></div></div>
            <div class="col"><div class="metric-card p-3 rounded shadow-sm text-center"><h6 class="text-secondary">Atrasadas (> 25d)</h6><h4 class="mb-0 text-danger">{{ m.implantacoes_atrasadas | default(0) }}</h4></div></div>
            <div class="col"><div class="metric-card p-3 rounded shadow-sm text-center"><h6 class="text-secondary">Futuras</h6><h4 class="mb-0 text-info">{{ m.implantacoes_futuras | default(0) }}</h4></div></div>
            <div class="col"><div class="metric-card p-3 rounded shadow-sm text-center"><h6 class="text-secondary">Concluídas</h6><h4 class="mb-0 text-success">{{ m.impl_finalizadas | default(0) }}</h4></div></div>
            <div class="col"><div class="metric-card p-3 rounded shadow-sm text-center"><h6 class="text-secondary">Paradas</h6><h4 class="mb-0 text-danger">{{ m.impl_paradas | default(0) }}</h4></div></div>
        </div>

        {# Abas (VISÍVEL PARA TODOS) #}
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" id="andamento-tab" data-bs-toggle="tab" data-bs-target="#andamento" type="button" role="tab">Em Andamento</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="atrasadas-tab" data-bs-toggle="tab" data-bs-target="#atrasadas" type="button" role="tab">Atrasadas</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="futuras-tab" data-bs-toggle="tab" data-bs-target="#futuras" type="button" role="tab">Futuras</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="finalizadas-tab" data-bs-toggle="tab" data-bs-target="#finalizadas" type="button" role="tab">Concluídas</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="paradas-tab" data-bs-toggle="tab" data-bs-target="#paradas" type="button" role="tab">Paradas</button></li>
        </ul>

        {# Conteúdo das Abas #}
        <div class="tab-content metric-card p-3 mb-5" id="myTabContent" style="border-top: none;">

            {# Aba Em Andamento #}
            <div class="tab-pane fade show active" id="andamento" role="tabpanel" aria-labelledby="andamento-tab">
                <h2 class="h5 mb-3">Clientes em Andamento</h2>
                {% if not implantacoes_andamento %} <div class="alert alert-info text-center" role="alert"> Nenhuma implantação em andamento. </div>
                {% else %} <div class="table-responsive"> <table class="table table-hover align-middle"> <thead> <tr> <th scope="col">Empresa</th> <th scope="col">Dias</th> <th scope="col" style="width: 20%;">Progresso</th> <th scope="col">Ações</th> </tr> </thead> <tbody>
                {% for impl in implantacoes_andamento %} <tr> <td class="text-truncate" style="max-width: 200px;">
                    <a href="#" class="btn-edit-empresa fw-bold text-decoration-none"
                       data-bs-toggle="modal" data-bs-target="#modalDetalhesEmpresa"
                       data-id="{{ impl.id }}"
                       data-nome="{{ impl.nome_empresa }}"
                       data-responsavel="{{ impl.responsavel_cliente | default('') }}"
                       data-cargo="{{ impl.cargo_responsavel | default('') }}"
                       data-telefone="{{ impl.telefone_responsavel | default('') }}"
                       data-email="{{ impl.email_responsavel | default('') }}"
                       data-inicio-implantacao="{{ impl.data_criacao_iso | default('') }}"
                       data-inicio-efetivo="{{ impl.data_inicio_efetivo_iso | default('') }}"
                       data-inicio-producao="{{ impl.data_inicio_producao_iso | default('') }}"
                       data-final-implantacao="{{ impl.data_final_implantacao_iso | default('') }}"
                       data-chave-oamd="{{ impl.chave_oamd | default('') }}"
                       data-catraca="{{ impl.catraca | default('') }}"
                       data-facial="{{ impl.facial | default('') }}"
                       data-nivel-receita="{{ impl.nivel_receita | default('') }}"
                       data-valor-atribuido="{{ impl.valor_atribuido | default('') }}"
                       data-id-favorecido="{{ impl.id_favorecido | default('') }}"
                       data-tela-apoio-link="{{ impl.tela_apoio_link | default('') }}"
                       data-resp-estrategico-nome="{{ impl.resp_estrategico_nome | default('') }}"
                       data-resp-onb-nome="{{ impl.resp_onb_nome | default('') }}"
                       data-resp-estrategico-obs="{{ impl.resp_estrategico_obs | default('') }}"
                       data-contatos="{{ impl.contatos | default('') }}"
                       data-seguimento="{{ impl.seguimento | default('') }}"
                       data-tipos-planos="{{ impl.tipos_planos | default('') }}"
                       data-modalidades="{{ impl.modalidades | default('') }}"
                       data-horarios-func="{{ impl.horarios_func | default('') }}"
                       data-formas-pagamento="{{ impl.formas_pagamento | default('') }}"
                       data-diaria="{{ impl.diaria | default('') }}"
                       data-freepass="{{ impl.freepass | default('') }}"
                       data-alunos-ativos="{{ impl.alunos_ativos | default(0) }}"
                       data-sistema-anterior="{{ impl.sistema_anterior | default('') }}"
                       data-importacao="{{ impl.importacao | default('') }}"
                       data-recorrencia-usa="{{ impl.recorrencia_usa | default('') }}"
                       data-boleto="{{ impl.boleto | default('') }}"
                       data-nota-fiscal="{{ impl.nota_fiscal | default('') }}">
                        {{ impl.nome_empresa }}
                    </a>
                </td> <td class="text-nowrap"> <span class="badge bg-secondary text-white">{{ impl.dias_passados | int }} dias</span> </td> <td> <div class="progress" style="height: 20px;"> <div class="progress-bar progress-bar-striped bg-warning text-dark" role="progressbar" style="width: {{ impl.progresso }}%;" aria-valuenow="{{ impl.progresso }}">{{ impl.progresso }}%</div> </div> </td> <td> <a href="{{ url_for('main.ver_implantacao', impl_id=impl.id) }}" class="btn btn-sm btn-primary">Ver Detalhes</a> </td> </tr> {% endfor %} </tbody> </table> </div> {% endif %}
            </div>

            {# Aba Atrasadas #}
            <div class="tab-pane fade" id="atrasadas" role="tabpanel" aria-labelledby="atrasadas-tab">
                <h2 class="h5 mb-3">Implantações Atrasadas (> 25 dias)</h2>
                {% if not implantacoes_atrasadas %} <div class="alert alert-info text-center" role="alert"> Nenhuma implantação atrasada. </div>
                {% else %} <div class="table-responsive"> <table class="table table-hover align-middle"> <thead> <tr> <th scope="col">Empresa</th> <th scope="col">Dias</th> <th scope="col">Status</th> <th scope="col" style="width: 20%;">Progresso</th> <th scope="col">Ações</th> </tr> </thead> <tbody>
                {% for impl in implantacoes_atrasadas %} <tr> <td class="text-truncate" style="max-width: 200px;">
                    <a href="#" class="btn-edit-empresa fw-bold text-decoration-none" data-bs-toggle="modal" data-bs-target="#modalDetalhesEmpresa"
                       data-id="{{ impl.id }}" data-nome="{{ impl.nome_empresa }}"
                       data-responsavel="{{ impl.responsavel_cliente | default('') }}" data-cargo="{{ impl.cargo_responsavel | default('') }}"
                       data-telefone="{{ impl.telefone_responsavel | default('') }}" data-email="{{ impl.email_responsavel | default('') }}"
                       data-inicio-implantacao="{{ impl.data_criacao_iso | default('') }}"
                       data-inicio-efetivo="{{ impl.data_inicio_efetivo_iso | default('') }}"
                       data-inicio-producao="{{ impl.data_inicio_producao_iso | default('') }}"
                       data-final-implantacao="{{ impl.data_final_implantacao_iso | default('') }}"
                       data-chave-oamd="{{ impl.chave_oamd | default('') }}" data-catraca="{{ impl.catraca | default('') }}" data-facial="{{ impl.facial | default('') }}"
                       data-nivel-receita="{{ impl.nivel_receita | default('') }}" data-valor-atribuido="{{ impl.valor_atribuido | default('') }}"
                       data-id-favorecido="{{ impl.id_favorecido | default('') }}" data-tela-apoio-link="{{ impl.tela_apoio_link | default('') }}"
                       data-resp-estrategico-nome="{{ impl.resp_estrategico_nome | default('') }}" data-resp-onb-nome="{{ impl.resp_onb_nome | default('') }}"
                       data-resp-estrategico-obs="{{ impl.resp_estrategico_obs | default('') }}" data-contatos="{{ impl.contatos | default('') }}"
                       data-seguimento="{{ impl.seguimento | default('') }}" data-tipos-planos="{{ impl.tipos_planos | default('') }}"
                       data-modalidades="{{ impl.modalidades | default('') }}" data-horarios-func="{{ impl.horarios_func | default('') }}"
                       data-formas-pagamento="{{ impl.formas_pagamento | default('') }}" data-diaria="{{ impl.diaria | default('') }}"
                       data-freepass="{{ impl.freepass | default('') }}" data-alunos-ativos="{{ impl.alunos_ativos | default(0) }}"
                       data-sistema-anterior="{{ impl.sistema_anterior | default('') }}" data-importacao="{{ impl.importacao | default('') }}"
                       data-recorrencia-usa="{{ impl.recorrencia_usa | default('') }}" data-boleto="{{ impl.boleto | default('') }}"
                       data-nota-fiscal="{{ impl.nota_fiscal | default('') }}">
                         {{ impl.nome_empresa }}
                     </a>
                </td> <td><span class="badge bg-danger">{{ impl.dias_passados | int }} dias</span></td> <td> {% if impl.status == 'parada' %} <span class="badge bg-danger">Parada</span> {% else %} <span class="badge bg-warning text-dark">Em Andamento</span> {% endif %} </td> <td> <div class="progress" style="height: 20px;"> <div class="progress-bar progress-bar-striped bg-danger" role="progressbar" style="width: {{ impl.progresso }}%;" aria-valuenow="{{ impl.progresso }}">{{ impl.progresso }}%</div> </div> </td> <td> <a href="{{ url_for('main.ver_implantacao', impl_id=impl.id) }}" class="btn btn-sm btn-primary">Ver Detalhes</a> </td> </tr> {% endfor %} </tbody> </table> </div> {% endif %}
            </div>

            {# Aba Futuras #}
            <div class="tab-pane fade" id="futuras" role="tabpanel" aria-labelledby="futuras-tab">
                <h2 class="h5 mb-3">Implantações Futuras</h2>
                {% if not implantacoes_futuras %} <div class="alert alert-info text-center" role="alert"> Nenhuma implantação futura. </div>
                {% else %} <div class="table-responsive"> <table class="table table-hover align-middle"> <thead> <tr> <th scope="col">Empresa</th> <th scope="col">Status</th> <th scope="col">Início Previsto</th> <th scope="col">Ações</th> </tr> </thead> <tbody>
                {% for impl in implantacoes_futuras %} <tr> <td class="text-truncate" style="max-width: 200px;">
                    <a href="#" class="btn-edit-empresa fw-bold text-decoration-none" data-bs-toggle="modal" data-bs-target="#modalDetalhesEmpresa"
                       data-id="{{ impl.id }}" data-nome="{{ impl.nome_empresa }}"
                       data-responsavel="{{ impl.responsavel_cliente | default('') }}" data-cargo="{{ impl.cargo_responsavel | default('') }}"
                       data-telefone="{{ impl.telefone_responsavel | default('') }}" data-email="{{ impl.email_responsavel | default('') }}"
                       data-inicio-implantacao="{{ impl.data_criacao_iso | default('') }}"
                       data-inicio-efetivo="{{ impl.data_inicio_efetivo_iso | default('') }}"
                       data-inicio-producao="{{ impl.data_inicio_producao_iso | default('') }}"
                       data-final-implantacao="{{ impl.data_final_implantacao_iso | default('') }}"
                       data-chave-oamd="{{ impl.chave_oamd | default('') }}" data-catraca="{{ impl.catraca | default('') }}" data-facial="{{ impl.facial | default('') }}"
                       data-nivel-receita="{{ impl.nivel_receita | default('') }}" data-valor-atribuido="{{ impl.valor_atribuido | default('') }}"
                       data-id-favorecido="{{ impl.id_favorecido | default('') }}" data-tela-apoio-link="{{ impl.tela_apoio_link | default('') }}"
                       data-resp-estrategico-nome="{{ impl.resp_estrategico_nome | default('') }}" data-resp-onb-nome="{{ impl.resp_onb_nome | default('') }}"
                       data-resp-estrategico-obs="{{ impl.resp_estrategico_obs | default('') }}" data-contatos="{{ impl.contatos | default('') }}"
                       data-seguimento="{{ impl.seguimento | default('') }}" data-tipos-planos="{{ impl.tipos_planos | default('') }}"
                       data-modalidades="{{ impl.modalidades | default('') }}" data-horarios-func="{{ impl.horarios_func | default('') }}"
                       data-formas-pagamento="{{ impl.formas_pagamento | default('') }}" data-diaria="{{ impl.diaria | default('') }}"
                       data-freepass="{{ impl.freepass | default('') }}" data-alunos-ativos="{{ impl.alunos_ativos | default(0) }}"
                       data-sistema-anterior="{{ impl.sistema_anterior | default('') }}" data-importacao="{{ impl.importacao | default('') }}"
                       data-recorrencia-usa="{{ impl.recorrencia_usa | default('') }}" data-boleto="{{ impl.boleto | default('') }}"
                       data-nota-fiscal="{{ impl.nota_fiscal | default('') }}">
                        {{ impl.nome_empresa }}
                    </a>
                </td> <td><span class="badge bg-info text-dark">Futura</span></td> <td> {% if impl.data_inicio_previsto %} <span class="badge bg-secondary">{{ impl.data_inicio_previsto_fmt_d }}</span> {% else %} <span class="text-muted small">N/A</span> {% endif %} </td> <td> <form method="POST" action="{{ url_for('main.iniciar_implantacao') }}" style="display:inline;"> <input type="hidden" name="implantacao_id" value="{{ impl.id }}"> <button type="submit" class="btn btn-sm btn-success">Iniciar</button> </form> <a href="{{ url_for('main.ver_implantacao', impl_id=impl.id) }}" class="btn btn-sm btn-primary ms-1">Ver Detalhes</a> </td> </tr> {% endfor %} </tbody> </table> </div> {% endif %}
            </div>

            {# Aba Finalizadas #}
            <div class="tab-pane fade" id="finalizadas" role="tabpanel" aria-labelledby="finalizadas-tab">
                <h2 class="h5 mb-3">Implantações Concluídas</h2>
                {% if not implantacoes_finalizadas %} <div class="alert alert-info text-center" role="alert"> Nenhuma implantação finalizada. </div>
                {% else %} <div class="table-responsive"> <table class="table table-hover align-middle"> <thead> <tr> <th scope="col">Empresa</th> <th scope="col">Progresso</th> <th scope="col">Ações</th> </tr> </thead> <tbody>
                {% for impl in implantacoes_finalizadas %} <tr> <td class="text-truncate" style="max-width: 200px;">
                    <a href="#" class="btn-edit-empresa fw-bold text-decoration-none" data-bs-toggle="modal" data-bs-target="#modalDetalhesEmpresa"
                       data-id="{{ impl.id }}" data-nome="{{ impl.nome_empresa }}"
                       data-responsavel="{{ impl.responsavel_cliente | default('') }}" data-cargo="{{ impl.cargo_responsavel | default('') }}"
                       data-telefone="{{ impl.telefone_responsavel | default('') }}" data-email="{{ impl.email_responsavel | default('') }}"
                       data-inicio-implantacao="{{ impl.data_criacao_iso | default('') }}"
                       data-inicio-efetivo="{{ impl.data_inicio_efetivo_iso | default('') }}"
                       data-inicio-producao="{{ impl.data_inicio_producao_iso | default('') }}"
                       data-final-implantacao="{{ impl.data_final_implantacao_iso | default('') }}"
                       data-chave-oamd="{{ impl.chave_oamd | default('') }}" data-catraca="{{ impl.catraca | default('') }}" data-facial="{{ impl.facial | default('') }}"
                       data-nivel-receita="{{ impl.nivel_receita | default('') }}" data-valor-atribuido="{{ impl.valor_atribuido | default('') }}"
                       data-id-favorecido="{{ impl.id_favorecido | default('') }}" data-tela-apoio-link="{{ impl.tela_apoio_link | default('') }}"
                       data-resp-estrategico-nome="{{ impl.resp_estrategico_nome | default('') }}" data-resp-onb-nome="{{ impl.resp_onb_nome | default('') }}"
                       data-resp-estrategico-obs="{{ impl.resp_estrategico_obs | default('') }}" data-contatos="{{ impl.contatos | default('') }}"
                       data-seguimento="{{ impl.seguimento | default('') }}" data-tipos-planos="{{ impl.tipos_planos | default('') }}"
                       data-modalidades="{{ impl.modalidades | default('') }}" data-horarios-func="{{ impl.horarios_func | default('') }}"
                       data-formas-pagamento="{{ impl.formas_pagamento | default('') }}" data-diaria="{{ impl.diaria | default('') }}"
                       data-freepass="{{ impl.freepass | default('') }}" data-alunos-ativos="{{ impl.alunos_ativos | default(0) }}"
                       data-sistema-anterior="{{ impl.sistema_anterior | default('') }}" data-importacao="{{ impl.importacao | default('') }}"
                       data-recorrencia-usa="{{ impl.recorrencia_usa | default('') }}" data-boleto="{{ impl.boleto | default('') }}"
                       data-nota-fiscal="{{ impl.nota_fiscal | default('') }}">
                        {{ impl.nome_empresa }}
                    </a>
                </td> <td> <span class="badge bg-success">100% Concluída</span> </td> <td> <a href="{{ url_for('main.ver_implantacao', impl_id=impl.id) }}" class="btn btn-sm btn-primary">Ver Histórico</a> <form method="POST" action="{{ url_for('main.reabrir_implantacao') }}" style="display:inline;" onsubmit="return confirm('Tem certeza?');"> <input type="hidden" name="implantacao_id" value="{{ impl.id }}"> <input type="hidden" name="redirect_to" value="dashboard"> <button type="submit" class="btn btn-sm btn-warning ms-1">Reabrir</button> </form> </td> </tr> {% endfor %} </tbody> </table> </div> {% endif %}
            </div>

            {# Aba Paradas #}
            <div class="tab-pane fade" id="paradas" role="tabpanel" aria-labelledby="paradas-tab">
                <h2 class="h5 mb-3">Implantações Paradas</h2>
                {% if not implantacoes_paradas %} <div class="alert alert-info text-center" role="alert"> Nenhuma implantação parada. </div>
                {% else %} <div class="table-responsive"> <table class="table table-hover align-middle"> <thead> <tr> <th scope="col">Empresa</th> <th scope="col">Motivo</th> <th scope="col">Ações</th> </tr> </thead> <tbody>
                {% for impl in implantacoes_paradas %} <tr> <td class="text-truncate" style="max-width: 200px;">
                    <a href="#" class="btn-edit-empresa fw-bold text-decoration-none" data-bs-toggle="modal" data-bs-target="#modalDetalhesEmpresa"
                       data-id="{{ impl.id }}" data-nome="{{ impl.nome_empresa }}"
                       data-responsavel="{{ impl.responsavel_cliente | default('') }}" data-cargo="{{ impl.cargo_responsavel | default('') }}"
                       data-telefone="{{ impl.telefone_responsavel | default('') }}" data-email="{{ impl.email_responsavel | default('') }}"
                       data-inicio-implantacao="{{ impl.data_criacao_iso | default('') }}"
                       data-inicio-efetivo="{{ impl.data_inicio_efetivo_iso | default('') }}"
                       data-inicio-producao="{{ impl.data_inicio_producao_iso | default('') }}"
                       data-final-implantacao="{{ impl.data_final_implantacao_iso | default('') }}"
                       data-chave-oamd="{{ impl.chave_oamd | default('') }}" data-catraca="{{ impl.catraca | default('') }}" data-facial="{{ impl.facial | default('') }}"
                       data-nivel-receita="{{ impl.nivel_receita | default('') }}" data-valor-atribuido="{{ impl.valor_atribuido | default('') }}"
                       data-id-favorecido="{{ impl.id_favorecido | default('') }}" data-tela-apoio-link="{{ impl.tela_apoio_link | default('') }}"
                       data-resp-estrategico-nome="{{ impl.resp_estrategico_nome | default('') }}" data-resp-onb-nome="{{ impl.resp_onb_nome | default('') }}"
                       data-resp-estrategico-obs="{{ impl.resp_estrategico_obs | default('') }}" data-contatos="{{ impl.contatos | default('') }}"
                       data-seguimento="{{ impl.seguimento | default('') }}" data-tipos-planos="{{ impl.tipos_planos | default('') }}"
                       data-modalidades="{{ impl.modalidades | default('') }}" data-horarios-func="{{ impl.horarios_func | default('') }}"
                       data-formas-pagamento="{{ impl.formas_pagamento | default('') }}" data-diaria="{{ impl.diaria | default('') }}"
                       data-freepass="{{ impl.freepass | default('') }}" data-alunos-ativos="{{ impl.alunos_ativos | default(0) }}"
                       data-sistema-anterior="{{ impl.sistema_anterior | default('') }}" data-importacao="{{ impl.importacao | default('') }}"
                       data-recorrencia-usa="{{ impl.recorrencia_usa | default('') }}" data-boleto="{{ impl.boleto | default('') }}"
                       data-nota-fiscal="{{ impl.nota_fiscal | default('') }}">
                        {{ impl.nome_empresa }}
                    </a>
                </td> <td class="text-truncate" style="max-width: 200px;">{{ impl.motivo_parada | default('N/A') }}</td> <td> <a href="{{ url_for('main.ver_implantacao', impl_id=impl.id) }}" class="btn btn-sm btn-primary">Ver Detalhes</a> <form method="POST" action="{{ url_for('main.retomar_implantacao') }}" style="display:inline;" onsubmit="return confirm('Tem certeza?');"> <input type="hidden" name="implantacao_id" value="{{ impl.id }}"> <input type="hidden" name="redirect_to" value="dashboard"> <button type="submit" class="btn btn-sm btn-success ms-1">Retomar</button> </form> </td> </tr> {% endfor %} </tbody> </table> </div> {% endif %}
            </div>

        </div> {# Fim do tab-content #}

        {# --- NOVO: SEÇÕES DE ANALYTICS (APENAS SE GESTÃO) --- #}
        {% if is_manager %}
        
        {# --- 1. Filtros Detalhados de Analytics (Status e Data) --- #}
        <h2 class="h5 mb-3 mt-5">Filtros Detalhados (Ações e TMA)</h2>
        <form method="GET" action="{{ url_for('main.dashboard') }}" class="metric-card p-4 rounded shadow-sm mb-4">
             {# Campos Ocultos para Reter Filtro de CS #}
            <input type="hidden" name="cs_filter" value="{{ selected_cs_filter }}">

            <div class="row g-3 align-items-end">
                
                {# Filtro por Status #}
                 <div class="col-md-3">
                    <label for="status_filter" class="form-label small text-secondary">Status da Implantação</label>
                    <select name="status_filter" id="status_filter" class="form-select form-select-sm">
                        {% for option in status_options %}
                            <option value="{{ option.value }}" {% if current_status_filter == option.value %}selected{% endif %}>
                                {{ option.label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                {# Filtro de Data Inicial #}
                <div class="col-md-3">
                    <label for="start_date_prod" class="form-label small text-secondary">Data Inicial 🗓️</label>
                    <input type="date" class="form-control form-control-sm" name="start_date" id="start_date_prod" value="{{ current_start_date | default('') }}">
                </div>
                <div class="col-md-3">
                    <label for="end_date_prod" class="form-label small text-secondary">Data Final 🗓️</label>
                    <input type="date" class="form-control form-control-sm" name="end_date" id="end_date_prod" value="{{ current_end_date | default('') }}">
                </div>
                
                {# Botão Aplicar #}
                <div class="col-md-3">
                    <button type="submit" class="btn btn-success btn-sm me-2 w-100">Atualizar Detalhes</button>
                </div>
            </div>
        </form>

        {# --- 2. Visão de Produtividade por Colaborador --- #}
        <h2 class="h5 mb-3">Produtividade por Customer Success ({{ global_metrics.total_impl | default(0) }} Implantações)</h2>
        {% if not cs_metrics %}
            <div class="alert alert-info text-center" role="alert">Nenhum Customer Success encontrado com as implantações filtradas.</div>
        {% else %}
        <div class="table-responsive metric-card p-3 rounded shadow-sm mb-5">
             <table class="table table-hover align-middle mb-0">
                <thead>
                    <tr class="table-light">
                        <th>CS / E-mail</th>
                        <th class="text-center">Total de Impl.</th>
                        <th class="text-center">Finalizadas</th>
                        <th class="text-center text-primary">Ação Interna Concluída</th>
                        <th class="text-center text-info">Reunião Concluída</th>
                        <th class="text-center">TMA Médio (dias)</th>
                        <th class="text-center text-danger">Tempo Parado Total (dias)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cs in cs_metrics %}
                    <tr>
                        <td>
                            <strong>{{ cs.nome }}</strong>
                            <small class="d-block text-muted">({{ cs.perfil }} - {{ cs.cargo }})</small>
                        </td>
                        <td class="text-center">{{ cs.impl_total }}</td>
                        <td class="text-center">{{ cs.impl_finalizadas }}</td>
                        <td class="text-center">{{ cs.prod_tags['Ação interna'] | default(0) }}</td>
                        <td class="text-center">{{ cs.prod_tags['Reunião'] | default(0) }}</td>
                        <td class="text-center">{{ cs.tma_medio }}</td>
                        <td class="text-center">
                            {% if cs.impl_paradas > 0 and cs.parada_dias_total > 0 %}
                                <span class="badge bg-danger">{{ cs.parada_dias_total }}</span>
                            {% elif cs.impl_paradas > 0 %}
                                <span class="badge bg-danger">0</span>
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
             </table>
        </div>
        {% endif %}
        
        {# --- 3. Implantações Paradas (Detalhes) --- #}
        <h2 class="h5 mb-3 mt-5">Implantações Paradas (Detalhes - {{ global_metrics.total_paradas | default(0) }} Registros)</h2>
        <div class="row g-3">
            <div class="col-md-12">
                 <div class="metric-card p-3 rounded shadow-sm">
                    <h6 class="text-secondary border-bottom pb-2 mb-3">Detalhes de Paralisação por Implantação</h6>
                    
                     {% if global_metrics.total_paradas == 0 %}
                        <div class="alert alert-info small">Nenhuma implantação parada nos filtros atuais.</div>
                     {% else %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover paradas-table mb-0">
                                <thead>
                                    <tr>
                                        <th>Empresa</th>
                                        <th>Motivo da Parada</th>
                                        <th class="text-center">CS Responsável</th>
                                        <th class="text-center">Tempo Parado (dias)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for impl in implantacoes_paradas_detalhadas %}
                                        <tr>
                                            <td><strong>{{ impl.nome_empresa }}</strong></td>
                                            <td>{{ impl.motivo_parada }}</td>
                                            <td class="text-center">{{ impl.cs_nome }}</td>
                                            <td class="text-center">
                                                <span class="badge bg-danger">
                                                    {{ impl.parada_dias }} dias
                                                </span>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    
                                    {% if not implantacoes_paradas_detalhadas %}
                                         <tr>
                                            <td colspan="4" class="text-center text-muted">
                                                Nenhuma implantação parada encontrada para os filtros ativos.
                                            </td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                     {% endif %}
                 </div>
            </div>
        </div>

        {% endif %}
        {# --- FIM DAS SEÇÕES DE ANALYTICS --- #}

    </main>
</div>

{# Modal Nova Implantação e outros modais (Não alterados) #}
<div class="modal fade" id="novaImplantacaoModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header header-bg"><h5 class="modal-title">Nova Implantação</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div> <form action="{{ url_for('main.criar_implantacao') }}" method="POST"> <div class="modal-body">
    {# CORREÇÃO: Altera a verificação para PERFIS_COM_CRIACAO #}
    {% if g.perfil.perfil_acesso in PERFIS_COM_CRIACAO %}
    <div class="mb-3"> <label for="nomeEmpresa" class="form-label">Nome Empresa</label> <input type="text" class="form-control" id="nomeEmpresa" name="nome_empresa" required> </div> <div class="mb-3"> <label class="form-label">Tipo</label> <div class="form-check"> <input class="form-check-input" type="radio" name="tipo" id="tipoAgora" value="agora" checked onchange="toggleDataPrevista(this.value)"> <label class="form-check-label" for="tipoAgora"> Imediata (Completa) </label> </div> <div class="form-check"> <input class="form-check-input" type="radio" name="tipo" id="tipoFutura" value="futura" onchange="toggleDataPrevista(this.value)"> <label class="form-check-label" for="tipoFutura"> Futura (Completa Agendada) </label> </div> <div class="form-check"> <input class="form-check-input" type="radio" name="tipo" id="tipoModulo" value="modulo" onchange="toggleDataPrevista(this.value)"> <label class="form-check-label" for="tipoModulo"> Módulo (Em branco) </label> </div> </div> <div class="mb-3" id="campoDataPrevista" style="display: none;"> <label for="data_inicio_previsto" class="form-label">Início Previsto</label> <input type="date" class="form-control" id="data_inicio_previsto" name="data_inicio_previsto"> </div>
    {% else %}
    <div class="alert alert-warning"> Seu perfil de acesso ({{ g.perfil.perfil_acesso or 'Nenhum' }}) não tem permissão para criar novas implantações. </div>
    {% endif %}
</div> <div class="modal-footer header-bg"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button> {% if g.perfil.perfil_acesso in PERFIS_COM_CRIACAO %} <button type="submit" class="btn btn-primary">Criar</button> {% endif %} </div> </form> </div> </div> </div>

{% endblock %}


{% block scripts_extra %}
<script>
    // Memória da Aba Ativa (Dashboard)
    document.addEventListener('DOMContentLoaded', function () {
        const tabSelector = '#myTab .nav-link'; const tabs = document.querySelectorAll(tabSelector); const tabStorageKey = 'tabAtiva-dashboard';
        tabs.forEach(tab => { tab.addEventListener('shown.bs.tab', event => { localStorage.setItem(tabStorageKey, event.target.id); }); });
        const abaAtivaId = localStorage.getItem(tabStorageKey); if (abaAtivaId) { const tabEl = document.getElementById(abaAtivaId); if (tabEl) { try { new bootstrap.Tab(tabEl).show(); } catch (e) { console.warn("Erro aba:", e); localStorage.removeItem(tabStorageKey); const defaultTab = document.getElementById('andamento-tab'); if(defaultTab) new bootstrap.Tab(defaultTab).show(); } } else { localStorage.removeItem(tabStorageKey); const defaultTab = document.getElementById('andamento-tab'); if(defaultTab) new bootstrap.Tab(defaultTab).show(); } } else { const defaultTab = document.getElementById('andamento-tab'); if(defaultTab) new bootstrap.Tab(defaultTab).show(); }
    });
    // Script Modal Nova Implantação
    function toggleDataPrevista(tipo) { const campoData = document.getElementById('campoDataPrevista'); const inputData = document.getElementById('data_inicio_previsto'); if (tipo === 'futura') { campoData.style.display = 'block'; inputData.required = true; } else { campoData.style.display = 'none'; inputData.required = false; inputData.value = ''; } }
    document.getElementById('novaImplantacaoModal').addEventListener('show.bs.modal', function () { document.getElementById('tipoAgora').checked = true; toggleDataPrevista('agora'); });
</script>
{% endblock %}