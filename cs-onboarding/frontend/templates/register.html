<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - CS Onboarding</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
</head>
<body>

    <div class="login-box">
        <h1 class="main-title">CS Onboarding</h1>
        <p class="login-subtitle">Pacto Soluções</p>
        <p class="lead mb-4" style="color: var(--main-text-color);">Crie sua conta para começar.</p>
        
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show my-3" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        
        <form method="POST" action="{{ url_for('auth.register') }}" class="mt-3" autocomplete="off">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="mb-3">
                <label for="nome" class="form-label">Nome Completo</label>
                <input type="text" class="form-control" id="nome" name="nome" required autofocus minlength="2" maxlength="100">
            </div>
            <div class="mb-3">
                <label for="email" class="form-label">E-mail</label>
                <input type="email" class="form-control" id="email" name="email" required autocomplete="off" value="">
                <div id="email-feedback" class="form-text"></div>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Senha</label>
                <div class="input-group">
                    <input type="password" class="form-control" id="password" name="password" required>
                    <button class="btn btn-outline-secondary" type="button" id="togglePasswordREG" aria-label="Mostrar senha">
                        <i class="bi bi-eye"></i>
                    </button>
                </div>
                <div id="password-rules" class="form-text mt-2">
                    <ul class="list-unstyled">
                        <li id="rule-len" class="text-danger"><i class="bi bi-x-circle me-1"></i>Mínimo de 8 caracteres</li>
                        <li id="rule-upper" class="text-danger"><i class="bi bi-x-circle me-1"></i>Pelo menos uma letra maiúscula</li>
                        <li id="rule-lower" class="text-danger"><i class="bi bi-x-circle me-1"></i>Pelo menos uma letra minúscula</li>
                        <li id="rule-digit" class="text-danger"><i class="bi bi-x-circle me-1"></i>Pelo menos um número</li>
                        <li id="rule-symbol" class="text-danger"><i class="bi bi-x-circle me-1"></i>Pelo menos um símbolo</li>
                        <li id="rule-repeat" class="text-danger"><i class="bi bi-x-circle me-1"></i>Sem 4 caracteres iguais consecutivos</li>
                        <li id="rule-seq" class="text-danger"><i class="bi bi-x-circle me-1"></i>Sem sequências simples (ex: 12345, abcde)</li>
                        <li id="rule-common" class="text-danger"><i class="bi bi-x-circle me-1"></i>Não ser senha comum</li>
                    </ul>
                </div>
            </div>
            <div class="mb-3">
                <label for="password_confirm" class="form-label">Confirmar Senha</label>
                <div class="input-group">
                    <input type="password" class="form-control" id="password_confirm" name="password_confirm" required minlength="6">
                    <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPasswordREG" aria-label="Mostrar senha">
                        <i class="bi bi-eye"></i>
                    </button>
                </div>
            </div>
            <button type="submit" class="btn btn-login btn-lg w-100">
                <i class="bi bi-person-plus me-2"></i> Criar Conta
            </button>
        </form>
        <div class="text-center mt-3">
            <p class="text-muted">Já tem uma conta? <a href="{{ url_for('auth.login') }}" class="text-primary">Faça login</a></p>
        </div>
    </div>

    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const form = document.querySelector('form');
        const emailInput = document.getElementById('email');
        const emailFeedback = document.getElementById('email-feedback');
        const submitBtn = form.querySelector('button[type="submit"]');
        const pwd = document.getElementById('password');
        const pwdConfirm = document.getElementById('password_confirm');
        const togglePwd = document.getElementById('togglePasswordREG');
        const toggleConfirm = document.getElementById('toggleConfirmPasswordREG');

        const COMMON_PASSWORDS = new Set([
            '123456','123456789','12345678','12345','1234567890','111111','000000','123123','1234567','1234','password','password1','password123','Password1','Password123','qwerty','qwerty123','qwertyuiop','asdfgh','zxcvbn','qwerty1','asdfghjkl','1qaz2wsx','abc123','welcome','monkey','dragon','master','sunshine','princess','letmein','shadow','admin','iloveyou','football','baseball','superman','batman','passw0rd','p@ssw0rd','p@ssword','123qwe','qwe123','admin123','root','toor','test','guest','2024','2023','2022','2021','2020'
        ]);

        function checkPasswordRules(p) {
            const len = typeof p === 'string' && p.length >= 8 && p.length <= 128;
            const upper = /[A-Z]/.test(p);
            const lower = /[a-z]/.test(p);
            const digit = /\d/.test(p);
            const symbol = /[!@#$%^&*(),.?":{}|<>\-_=+\[\]\\\/;\'`~]/.test(p);
            const repeat = !/(.)\1{3,}/.test(p);
            const sequences = ['0123456789','abcdefghijklmnopqrstuvwxyz','qwertyuiop','asdfghjkl','zxcvbnm'];
            const pl = (p || '').toLowerCase();
            let seqOk = true;
            for (const seq of sequences) {
                for (let i = 0; i < seq.length - 4; i++) {
                    const s = seq.slice(i, i+5);
                    if (pl.includes(s) || pl.includes([...s].reverse().join(''))) { seqOk = false; break; }
                }
                if (!seqOk) break;
            }
            const common = !COMMON_PASSWORDS.has(pl);
            return { len, upper, lower, digit, symbol, repeat, seqOk, common };
        }

        function mark(el, ok) {
            el.className = ok ? 'text-success' : 'text-danger';
            const icon = el.querySelector('i');
            if (icon) icon.className = ok ? 'bi bi-check-circle me-1' : 'bi bi-x-circle me-1';
        }

        function updatePasswordUI() {
            const r = checkPasswordRules(pwd.value || '');
            mark(document.getElementById('rule-len'), r.len);
            mark(document.getElementById('rule-upper'), r.upper);
            mark(document.getElementById('rule-lower'), r.lower);
            mark(document.getElementById('rule-digit'), r.digit);
            mark(document.getElementById('rule-symbol'), r.symbol);
            mark(document.getElementById('rule-repeat'), r.repeat);
            mark(document.getElementById('rule-seq'), r.seqOk);
            mark(document.getElementById('rule-common'), r.common);
            const confirmOk = (pwdConfirm.value || '') === (pwd.value || '');
            submitBtn.disabled = !(r.len && r.upper && r.lower && r.digit && r.symbol && r.repeat && r.seqOk && r.common && confirmOk);
        }

        pwd.addEventListener('input', updatePasswordUI);
        pwdConfirm.addEventListener('input', updatePasswordUI);
        updatePasswordUI();

        let emailTimer;
        emailInput.addEventListener('input', () => {
            clearTimeout(emailTimer);
            emailTimer = setTimeout(async () => {
                const email = emailInput.value.trim();
                if (!email) {
                    emailFeedback.textContent = '';
                    submitBtn.disabled = false;
                    return;
                }
                try {
                    const res = await fetch(`/check-email?email=${encodeURIComponent(email)}`);
                    const data = await res.json();
                    if (!data.valid) {
                        emailFeedback.textContent = 'E-mail inválido.';
                        emailFeedback.className = 'form-text text-danger';
                        submitBtn.disabled = true;
                    } else if (data.exists) {
                        emailFeedback.textContent = 'Este e-mail já está cadastrado. Faça login ou use outro e-mail.';
                        emailFeedback.className = 'form-text text-danger';
                        submitBtn.disabled = true;
                    } else {
                        emailFeedback.textContent = 'E-mail disponível para cadastro.';
                        emailFeedback.className = 'form-text text-success';
                        submitBtn.disabled = false;
                    }
                } catch (e) {
                    emailFeedback.textContent = '';
                    submitBtn.disabled = false;
                }
            }, 300);
        });

        form.addEventListener('submit', function(e) {
            if (submitBtn.disabled) { e.preventDefault(); }
        });
        function bindToggle(btn, input) {
            if (!btn || !input) return;
            btn.addEventListener('click', function(){
                const showing = input.type === 'text';
                input.type = showing ? 'password' : 'text';
                const icon = btn.querySelector('i');
                if (icon) icon.className = showing ? 'bi bi-eye' : 'bi bi-eye-slash';
                btn.setAttribute('aria-label', showing ? 'Mostrar senha' : 'Ocultar senha');
            });
        }
        bindToggle(togglePwd, pwd);
        bindToggle(toggleConfirm, pwdConfirm);
    </script>
</body>
</html>

