<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}CS Onboarding{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  {% block head_extra %}{% endblock %}
</head>

<body>

  <div class="main-layout">
    <!-- Sidebar sempre visível -->
    <nav id="menu" class="sidebar-menu" role="navigation">
    <div class="d-flex align-items-center mb-3">
      <div class="user-profile-btn-sidebar me-2">
        {% if g.perfil and g.perfil.foto_url %}
        <img src="{{ g.perfil.foto_url }}?v={{ range(1, 10000) | random }}" alt="Foto"
          style="width:40px;height:40px;object-fit:cover;border-radius:50%;">
        {% else %}
        <i class="bi bi-person-fill" style="font-size: 1.5rem;"></i>
        {% endif %}
      </div>
      <strong class="nav-link-text">{{ g.perfil.nome or g.user_email }}</strong>
    </div>
    <ul class="nav flex-column">
      <li class="nav-item"><a class="nav-link {% if request.endpoint == 'main.dashboard' %}active{% endif %}"
          href="{{ url_for('main.dashboard') }}"><i class="bi bi-speedometer2 me-2"></i><span class="nav-link-text"> Dashboard</span></a></li>
      {% if implantacao and implantacao.id %}
      <li class="nav-item"><a class="nav-link {% if request.endpoint == 'main.ver_implantacao' %}active{% endif %}"
          href="{{ url_for('main.ver_implantacao', impl_id=implantacao.id) }}"><i class="bi bi-kanban me-2"></i><span class="nav-link-text"> Detalhes da Implantação</span></a></li>
      {% endif %}
      <li class="nav-item"><a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#modalPerfil"><i
            class="bi bi-person-circle me-2"></i><span class="nav-link-text"> Perfil</span></a></li>

      <li class="nav-item"><a
          class="nav-link {% if request.endpoint and request.endpoint.startswith('agenda.') %}active{% endif %}"
          href="{{ url_for('agenda.agenda_home') }}"><i class="bi bi-calendar-week me-2"></i><span class="nav-link-text"> Agenda</span></a></li>

      <li class="nav-item"><a
          class="nav-link {% if request.endpoint and request.endpoint.startswith('planos.') %}active{% endif %}"
          href="{{ url_for('planos.listar_planos') }}"><i class="bi bi-diagram-3 me-2"></i><span class="nav-link-text"> Planos de Sucesso</span></a></li>

      {% if g.perfil and g.perfil.perfil_acesso in g.PERFIS_COM_GESTAO %}
      <li class="nav-item nav-item-divider">
        <hr>
      </li>
      <li class="nav-item"><a class="nav-link" href="#" data-bs-toggle="modal"
          data-bs-target="#modalGerenciarUsuarios"><i class="bi bi-people-fill me-2"></i><span class="nav-link-text"> Usuários</span></a></li>
      <li class="nav-item"><a
          class="nav-link {% if request.endpoint == 'analytics.analytics_dashboard' %}active{% endif %}"
          href="{{ url_for('analytics.analytics_dashboard') }}"><i class="bi bi-graph-up me-2"></i><span class="nav-link-text"> Gerencial</span></a></li>
      <li class="nav-item"><a
          class="nav-link {% if request.endpoint == 'analytics.cancelamentos_dashboard' %}active{% endif %}"
          href="{{ url_for('analytics.cancelamentos_dashboard') }}"><i class="bi bi-x-circle me-2"></i><span class="nav-link-text"> Cancelamentos</span></a></li>
      <li class="nav-item nav-item-divider">
        <hr>
      </li>
      <li class="nav-item"><span class="nav-link disabled nav-link-text">Gamificação</span></li>
      <li class="nav-item"><a
          class="nav-link {% if request.endpoint == 'gamification.manage_gamification_metrics' %}active{% endif %}"
          href="{{ url_for('gamification.manage_gamification_metrics') }}"><i class="bi bi-pencil-square me-2"></i><span class="nav-link-text"> Métricas</span></a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#modalGamificacao"><i
            class="bi bi-list-check me-2"></i><span class="nav-link-text"> Critérios da Gamificação</span></a></li>
      <li class="nav-item"><a
          class="nav-link {% if request.endpoint == 'gamification.gamification_report' %}active{% endif %}"
          href="{{ url_for('gamification.gamification_report') }}"><i class="bi bi-clipboard-data me-2"></i><span class="nav-link-text"> Relatório</span></a></li>
      {% endif %}
      <li class="nav-item nav-item-divider">
        <hr>
      </li>
      <li class="nav-item"><a class="nav-link text-danger" href="{{ url_for('auth.logout') }}"><i
            class="bi bi-box-arrow-left me-2"></i><span class="nav-link-text"> Sair</span></a></li>
    </ul>
    </nav>

    <!-- Botão de toggle no centro -->
    <button id="sidebarToggle" class="sidebar-toggle-btn" title="Expandir/Colapsar menu">
      <i class="bi bi-chevron-left"></i>
    </button>

    <!-- Conteúdo principal -->
    <div class="main-content">
    {% block content %}
    <div class="container py-4">
      <div class="card">
        <div class="card-body">
          <h1 class="main-title mb-2">Conteúdo Padrão</h1>
          <p class="text-muted text-center mb-0">Substitua no template filho.</p>
        </div>
      </div>
    </div>
    {% endblock %}
    </div>
  </div>

  {% include 'modals/_detalhes_empresa.html' %}
  {% include 'modals/_gamificacao_regras.html' %}
  {% include 'modals/_gerenciar_usuarios.html' %}
  {% include 'modals/_perfil.html' %}
  
  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;" id="toastContainer">
    <!-- Toasts serão inseridos aqui dinamicamente -->
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
  <script>
    // Configurar locale PT-BR para flatpickr
    if (window.flatpickr) {
      flatpickr.localize({
        weekdays: {
          shorthand: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'],
          longhand: ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado']
        },
        months: {
          shorthand: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
          longhand: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro']
        },
        firstDayOfWeek: 1,
        rangeSeparator: ' até ',
        weekAbbreviation: 'Sem',
        scrollTitle: 'Role para aumentar',
        toggleTitle: 'Clique para alternar',
        amPM: ['AM', 'PM'],
        yearAriaLabel: 'Ano',
        monthAriaLabel: 'Mês',
        hourAriaLabel: 'Hora',
        minuteAriaLabel: 'Minuto',
        time_24hr: false
      });
    }
  </script>
  
  <script>
    // Função para aplicar máscara de data DD/MM/AAAA
    function applyDateMask(input) {
      if (!input || input.dataset.maskApplied) return;
      
      input.dataset.maskApplied = 'true';
      input.setAttribute('maxlength', '10');
      input.setAttribute('inputmode', 'numeric');
      
      // Aplicar máscara enquanto digita
      input.addEventListener('input', function(e) {
        var oldValue = this.dataset.oldValue || '';
        var cursorPos = this.selectionStart;
        var value = this.value.replace(/\D/g, ''); // Remove tudo que não é número
        
        // Se o valor não mudou (apenas formatação), não fazer nada
        if (value === oldValue.replace(/\D/g, '')) {
          return;
        }
        
        // Salvar valor antigo
        this.dataset.oldValue = value;
        
        if (value.length > 8) {
          value = value.substring(0, 8);
        }
        
        // Aplicar formatação DD/MM/AAAA apenas se houver números
        var formatted = '';
        if (value.length > 0) {
          formatted = value.substring(0, 2);
          if (value.length > 2) {
            formatted += '/' + value.substring(2, 4);
          }
          if (value.length > 4) {
            formatted += '/' + value.substring(4, 8);
          }
        }
        
        // Só atualizar se o valor realmente mudou
        if (this.value !== formatted) {
          this.value = formatted;
          
          // Ajustar posição do cursor após formatação
          var newCursorPos = cursorPos;
          var addedChars = formatted.length - (oldValue.replace(/\D/g, '').length);
          
          // Se adicionamos uma barra, ajustar cursor
          if (formatted.length > cursorPos && formatted.charAt(cursorPos) === '/') {
            newCursorPos = cursorPos + 1;
          } else if (addedChars > 0 && cursorPos < formatted.length) {
            newCursorPos = cursorPos + addedChars;
          }
          
          // Garantir que o cursor não ultrapasse o tamanho
          if (newCursorPos > formatted.length) {
            newCursorPos = formatted.length;
          }
          
          if (typeof this.setSelectionRange === 'function' && (this.type || '').toLowerCase() !== 'hidden' && document.activeElement === this) {
            try { this.setSelectionRange(newCursorPos, newCursorPos); } catch (_) {}
          }
        }
        
        // Validar data em tempo real apenas se tiver 10 caracteres (data completa)
        if (formatted.length === 10) {
          validateDateInput(this);
        } else {
          this.classList.remove('is-invalid', 'is-valid');
        }
      });
      
      // Validar ao perder o foco
      input.addEventListener('blur', function() {
        validateDateInput(this);
      });
      
      // Prevenir entrada de caracteres não numéricos (exceto teclas de controle)
      input.addEventListener('keypress', function(e) {
        // Permitir teclas de controle
        if (e.ctrlKey || e.metaKey || e.altKey) {
          return true;
        }
        
        var char = String.fromCharCode(e.which || e.keyCode);
        // Permitir apenas números
        if (!/[0-9]/.test(char)) {
          e.preventDefault();
          return false;
        }
      });
      
      // Permitir teclas de navegação e controle
      input.addEventListener('keydown', function(e) {
        // Permitir backspace, delete, tab, escape, enter, setas, home, end
        if ([8, 9, 27, 13, 46, 35, 36, 37, 38, 39, 40].indexOf(e.keyCode) !== -1) {
          return true;
        }
        // Permitir Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
        if ((e.keyCode === 65 || e.keyCode === 67 || e.keyCode === 86 || e.keyCode === 88) && (e.ctrlKey || e.metaKey)) {
          return true;
        }
      });
    }
    
    // Validar data
    function validateDateInput(input) {
      var value = input.value.trim();
      input.classList.remove('is-invalid', 'is-valid');
      
      if (!value || value.length === 0) {
        return;
      }
      
      // Verificar formato DD/MM/AAAA
      var regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
      var match = value.match(regex);
      
      if (!match) {
        input.classList.add('is-invalid');
        return false;
      }
      
      var day = parseInt(match[1], 10);
      var month = parseInt(match[2], 10);
      var year = parseInt(match[3], 10);
      
      // Validar limites
      if (day < 1 || day > 31 || month < 1 || month > 12 || year < 1900 || year > 2100) {
        input.classList.add('is-invalid');
        return false;
      }
      
      // Validar se a data existe
      var date = new Date(year, month - 1, day);
      if (date.getDate() !== day || date.getMonth() !== month - 1 || date.getFullYear() !== year) {
        input.classList.add('is-invalid');
        return false;
      }
      
      input.classList.add('is-valid');
      return true;
    }
    
    // Função global para aplicar flatpickr e máscara em todos os campos de data
    window.initDateFields = function() {
      // Aplicar máscara em todos os campos de data
      document.querySelectorAll('input[type="text"]').forEach(function(input) {
        if (input.disabled || input.readOnly || input.classList.contains('no-datepicker')) {
          return;
        }
        
        var placeholder = (input.getAttribute('placeholder') || '').toLowerCase();
        var name = (input.getAttribute('name') || '').toLowerCase();
        var id = (input.getAttribute('id') || '').toLowerCase();
        var className = (input.className || '').toLowerCase();
        
        // Verificar se é um campo de data
        var isDateField = (
          className.includes('flatpickr-date') ||
          className.includes('date-input') ||
          placeholder.includes('dd/mm') || 
          placeholder.includes('dd/mm/aaaa') ||
          (name.includes('data_') && !name.includes('data_cadastro')) || 
          (name.includes('_data') && !name.includes('cadastro_data')) ||
          (id.includes('data_') && !id.includes('data_cadastro')) || 
          (id.includes('_data') && !id.includes('cadastro_data')) ||
          (id.includes('date') && !id.includes('update')) ||
          (name.includes('date') && !name.includes('update'))
        );
        
        if (isDateField) {
          // Se flatpickr não estiver disponível, aplicar máscara no input original
          if (!window.flatpickr) {
            applyDateMask(input);
          }
          
          // Aplicar flatpickr (se disponível)
          if (window.flatpickr && !input._flatpickr) {
            try {
              var dateConfig = {
                dateFormat: 'Y-m-d',
                altInput: true,
                altFormat: 'd/m/Y',
                allowInput: false,
                clickOpens: true,
                locale: {
                  weekdays: {
                    shorthand: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'],
                    longhand: ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado']
                  },
                  months: {
                    shorthand: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
                    longhand: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro']
                  },
                  firstDayOfWeek: 1,
                  rangeSeparator: ' até ',
                  weekAbbreviation: 'Sem',
                  scrollTitle: 'Role para aumentar',
                  toggleTitle: 'Clique para alternar',
                  amPM: ['AM', 'PM'],
                  yearAriaLabel: 'Ano',
                  monthAriaLabel: 'Mês',
                  hourAriaLabel: 'Hora',
                  minuteAriaLabel: 'Minuto',
                  time_24hr: false
                },
                parseDate: function(datestr, format) {
                  var regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
                  var match = datestr.match(regex);
                  if (!match) return null;
                  
                  var day = parseInt(match[1], 10);
                  var month = parseInt(match[2], 10) - 1;
                  var year = parseInt(match[3], 10);
                  
                  var date = new Date(year, month, day);
                  if (date.getDate() !== day || date.getMonth() !== month || date.getFullYear() !== year) {
                    return null;
                  }
                  
                  return date;
                }
              };
              
              var fp = window.flatpickr(input, dateConfig);
              
              // Aplicar máscara também no altInput do flatpickr
              if (fp && fp.altInput) {
                // Remover o atributo para permitir aplicar a máscara novamente
                fp.altInput.removeAttribute('data-mask-applied');
                applyDateMask(fp.altInput);
                
                // Sincronizar quando o usuário seleciona data no calendário
                fp.config.onChange.push(function(selectedDates, dateStr, instance) {
                  if (instance.altInput) {
                    validateDateInput(instance.altInput);
                  }
                });
                
                // Garantir que a máscara funcione mesmo quando o flatpickr atualiza o campo
                var originalSetDate = fp.setDate;
                fp.setDate = function(date, triggerChange) {
                  var result = originalSetDate.call(this, date, triggerChange);
                  if (this.altInput) {
                    setTimeout(function() {
                      validateDateInput(fp.altInput);
                    }, 10);
                  }
                  return result;
                };
              }
            } catch (e) {
            }
          }
        }
      });
    };
    
    // Inicializar quando o DOM estiver pronto
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', window.initDateFields);
    } else {
      window.initDateFields();
    }
    
    // Re-inicializar quando modais são abertos (para campos criados dinamicamente)
    document.addEventListener('shown.bs.modal', function() {
      setTimeout(window.initDateFields, 100);
    });
  </script>
  <script>
    (function () {
      function ensureHTMX() {
        if (window.htmx) return true;
        var urls = [
          'https://cdn.jsdelivr.net/npm/htmx.org@1.9.10/dist/htmx.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/htmx/1.9.10/htmx.min.js'
        ];
        var i = 0;
        function loadNext() {
          if (window.htmx) return;
          if (i >= urls.length) { polyfillHTMX(); return; }
          var s = document.createElement('script'); s.src = urls[i++]; s.async = true;
          s.onload = function () { };
          s.onerror = function () { loadNext(); };
          document.head.appendChild(s);
        }
        loadNext();
        return !!window.htmx;
      }
      function polyfillHTMX() {
        // Fallback mínimo: intercepta formulários de comentário e envia via fetch
        document.addEventListener('submit', function (ev) {
          var form = ev.target;
          if (!form || !form.matches('form[hx-post]')) return;
          ev.preventDefault();
          try {
            var targetSel = form.getAttribute('hx-target');
            var postUrl = form.getAttribute('hx-post');
            var swapMode = (form.getAttribute('hx-swap') || 'beforeend').toLowerCase();
            var target = targetSel ? document.querySelector(targetSel) : null;
            if (!postUrl || !target) { form.submit(); return; }
            var fd = new FormData(form);
            fetch(postUrl, { method: 'POST', body: fd, headers: { 'HX-Request': 'true' } })
              .then(function (r) { return r.text(); })
              .then(function (html) {
                var temp = document.createElement('div'); temp.innerHTML = html;
                var nodes = Array.from(temp.childNodes);
                if (swapMode === 'beforeend') nodes.forEach(function (n) { target.appendChild(n); });
                else if (swapMode === 'outerhtml') { target.outerHTML = html; }
                else { target.innerHTML = html; }
                var evt = new Event('comment_saved_fallback'); document.body.dispatchEvent(evt);
              })
              .catch(function (e) { console.error('Falha ao enviar comentário:', e); alert('Erro ao salvar comentário.'); });
          } catch (e2) { console.error('Fallback HTMX falhou:', e2); form.submit(); }
        }, true);
        document.addEventListener('click', function (ev) {
          var el = ev.target && ev.target.closest('[hx-post]');
          if (!el) return;
          if (el.closest('form')) return;
          if (!(el.tagName === 'BUTTON' || el.tagName === 'A')) return;
          ev.preventDefault();
          var confirmMsg = el.getAttribute('hx-confirm');
          if (confirmMsg && !window.confirm(confirmMsg)) return;
          var postUrl = el.getAttribute('hx-post');
          var targetSel = el.getAttribute('hx-target');
          var swapMode = (el.getAttribute('hx-swap') || 'innerHTML').toLowerCase();
          var target = targetSel ? document.querySelector(targetSel) : null;
          if (!postUrl || !target) return;
          try { el.disabled = true; } catch (e) { }
          fetch(postUrl, { method: 'POST', headers: { 'HX-Request': 'true' } })
            .then(function (r) { return r.text(); })
            .then(function (html) {
              if (swapMode === 'outerhtml') { target.outerHTML = html; }
              else if (swapMode === 'beforeend') {
                var temp = document.createElement('div'); temp.innerHTML = html;
                Array.from(temp.childNodes).forEach(function (n) { target.appendChild(n); });
              } else { target.innerHTML = html; }
            })
            .catch(function () {
              try {
                var alert = document.createElement('div');
                alert.className = 'alert alert-danger alert-dismissible fade show my-2';
                alert.innerHTML = 'Falha ao excluir comentário.' + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
                var container = document.querySelector('.container') || document.body;
                container.prepend(alert);
                setTimeout(function () { try { var ai = bootstrap.Alert.getOrCreateInstance(alert); ai.close(); } catch (e) { } }, 3000);
              } catch (e) { }
            })
            .finally(function () { try { el.disabled = false; } catch (e) { } });
        }, true);
      }
      if (!window.htmx) {
        if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', ensureHTMX); }
        else { ensureHTMX(); }
      }
      document.addEventListener('submit', function (ev) {
        var form = ev.target;
        if (!form || !form.matches('#modalGerenciarUsuarios form[hx-post]')) return;
        ev.preventDefault();
        try {
          var targetSel = form.getAttribute('hx-target');
          var postUrl = form.getAttribute('hx-post');
          var swapMode = (form.getAttribute('hx-swap') || 'innerHTML').toLowerCase();
          var target = targetSel ? document.querySelector(targetSel) : null;
          if (!postUrl || !target) return;
          var fd = new FormData(form);
          fetch(postUrl, { method: 'POST', body: fd, headers: { 'HX-Request': 'true' } })
            .then(function (r) { return r.text(); })
            .then(function (html) {
              if (swapMode === 'outerhtml') { target.outerHTML = html; }
              else if (swapMode === 'beforeend') {
                var temp = document.createElement('div'); temp.innerHTML = html;
                Array.from(temp.childNodes).forEach(function (n) { target.appendChild(n); });
              } else { target.innerHTML = html; }
            })
            .catch(function (e) { console.error('Falha no envio do formulário do modal:', e); });
        } catch (e) { console.error('Erro ao processar submit do modal:', e); }
      }, true);
      document.addEventListener('click', function (ev) {
        var el = ev.target && ev.target.closest('button[hx-post], a[hx-post]');
        if (!el) return;
        var postUrl = el.getAttribute('hx-post');
        if (!postUrl || postUrl.indexOf('/api/excluir_comentario/') === -1) return;
        ev.preventDefault();
        ev.stopPropagation();
        try { ev.stopImmediatePropagation(); } catch (e) { }
        var confirmMsg = el.getAttribute('hx-confirm');
        if (confirmMsg && !window.confirm(confirmMsg)) return;
        var targetSel = el.getAttribute('hx-target');
        var swapMode = (el.getAttribute('hx-swap') || 'outerHTML').toLowerCase();
        var target = targetSel ? document.querySelector(targetSel) : null;
        if (!target) return;
        try { el.disabled = true; } catch (e) { }
        fetch(postUrl, { method: 'POST', headers: { 'HX-Request': 'true' } })
          .then(function (r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
          .then(function (html) {
            if (swapMode === 'outerhtml') { target.outerHTML = html; }
            else if (swapMode === 'beforeend') {
              var temp = document.createElement('div'); temp.innerHTML = html;
              Array.from(temp.childNodes).forEach(function (n) { target.appendChild(n); });
            } else { target.innerHTML = html; }
          })
          .catch(function () {
            try {
              var alert = document.createElement('div');
              alert.className = 'alert alert-danger alert-dismissible fade show my-2';
              alert.innerHTML = 'Falha ao excluir comentário.' + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
              var container = document.querySelector('.container') || document.body;
              container.prepend(alert);
              setTimeout(function () { try { var ai = bootstrap.Alert.getOrCreateInstance(alert); ai.close(); } catch (e) { } }, 3000);
            } catch (e) { }
          })
          .finally(function () { try { el.disabled = false; } catch (e) { } });
      }, true);
      document.addEventListener('click', function (ev) {
        var el = ev.target && ev.target.closest('button[hx-post], a[hx-post]');
        if (!el) return;
        var postUrl = el.getAttribute('hx-post');
        if (!postUrl || postUrl.indexOf('/api/enviar_email_comentario/') === -1) return;
        ev.preventDefault();
        ev.stopPropagation();
        try { ev.stopImmediatePropagation(); } catch (e) { }
        var confirmMsg = el.getAttribute('hx-confirm');
        if (confirmMsg && !window.confirm(confirmMsg)) return;
        var targetSel = el.getAttribute('hx-target');
        var swapMode = (el.getAttribute('hx-swap') || 'beforeend').toLowerCase();
        var target = targetSel ? document.querySelector(targetSel) : null;
        if (!target) return;
        try { el.disabled = true; } catch (e) { }
        fetch(postUrl, { method: 'POST', headers: { 'HX-Request': 'true' } })
          .then(function (r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
          .then(function (html) {
            if (swapMode === 'outerhtml') { target.outerHTML = html; }
            else if (swapMode === 'beforeend') {
              var temp = document.createElement('div'); temp.innerHTML = html;
              Array.from(temp.childNodes).forEach(function (n) { target.appendChild(n); });
            } else { target.innerHTML = html; }
            try {
              var ok = /text-success/.test(html);
              var msg = ok ? 'E-mail enviado ao responsável.' : 'Falha ao enviar e-mail ao responsável.';
              var cls = ok ? 'alert-success' : 'alert-danger';
              var alert = document.createElement('div');
              alert.className = 'alert ' + cls + ' alert-dismissible fade show my-2';
              alert.innerHTML = msg + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
              var container = document.querySelector('#detalhesTabContent') || document.querySelector('.container') || document.body;
              container.prepend(alert);
              setTimeout(function () { try { var ai = bootstrap.Alert.getOrCreateInstance(alert); ai.close(); } catch (e) { } }, 3000);
            } catch (e) { }
          })
          .catch(function () {
            try {
              var alert = document.createElement('div');
              alert.className = 'alert alert-danger alert-dismissible fade show my-2';
              alert.innerHTML = 'Falha ao enviar e-mail ao responsável.' + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
              var container = document.querySelector('#detalhesTabContent') || document.querySelector('.container') || document.body;
              container.prepend(alert);
              setTimeout(function () { try { var ai = bootstrap.Alert.getOrCreateInstance(alert); ai.close(); } catch (e) { } }, 3000);
            } catch (e) { }
          })
          .finally(function () { try { el.disabled = false; } catch (e) { } });
      }, true);
      document.addEventListener('htmx:responseError', function (ev) {
        try {
          var alert = document.createElement('div');
          alert.className = 'alert alert-danger alert-dismissible fade show my-2';
          alert.innerHTML = 'Falha ao salvar. Tente novamente.' + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
          var container = document.querySelector('.container') || document.body;
          container.prepend(alert);
          setTimeout(function () { try { var alertInst = bootstrap.Alert.getOrCreateInstance(alert); alertInst.close(); } catch (e) { } }, 3000);
        } catch (e) { }
      });
    })();
  </script>
  <script>
    (function () {
      document.addEventListener('DOMContentLoaded', function () {
        try {
          var tooltipEls = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
          tooltipEls.forEach(function (el) { bootstrap.Tooltip.getOrCreateInstance(el); });
        } catch (e) { }
      });
    })();
  </script>



  <script>
    // Toggle do sidebar
    document.addEventListener('DOMContentLoaded', function() {
      const sidebarToggle = document.getElementById('sidebarToggle');
      const sidebar = document.getElementById('menu');
      const mainContent = document.querySelector('.main-content');
      
      if (sidebarToggle && sidebar) {
        // Função para atualizar posição do botão
        function updateTogglePosition() {
          if (sidebar.classList.contains('collapsed')) {
            sidebarToggle.style.left = '60px';
            if (mainContent) {
              mainContent.style.marginLeft = '60px';
              mainContent.style.width = 'calc(100% - 60px)';
            }
          } else {
            sidebarToggle.style.left = '280px';
            if (mainContent) {
              mainContent.style.marginLeft = '280px';
              mainContent.style.width = 'calc(100% - 280px)';
            }
          }
        }
        
        // Verificar estado salvo no localStorage
        const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        if (isCollapsed) {
          sidebar.classList.add('collapsed');
        }
        updateTogglePosition();
        
        // Inicializar rotação do ícone
        const icon = sidebarToggle.querySelector('i');
        if (icon) {
          if (isCollapsed) {
            icon.style.transform = 'rotate(180deg)';
          } else {
            icon.style.transform = 'rotate(0deg)';
          }
        }
        
        sidebarToggle.addEventListener('click', function() {
          sidebar.classList.toggle('collapsed');
          // Rotacionar ícone
          const icon = sidebarToggle.querySelector('i');
          if (icon) {
            if (sidebar.classList.contains('collapsed')) {
              icon.style.transform = 'rotate(180deg)';
            } else {
              icon.style.transform = 'rotate(0deg)';
            }
          }
          updateTogglePosition();
          // Salvar estado no localStorage
          localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        });
      }
    });
  </script>

  <script>
    document.addEventListener('show.bs.modal', function () {
      try {
        var menu = document.getElementById('menu');
        var push = document.querySelector('.push');
        var backdrop = document.querySelector('.bigslide-backdrop');
        if (document.body.classList.contains('menu-open')) {
          document.body.classList.remove('menu-open');
          if (menu) menu.classList.remove('open');
          if (push) push.classList.remove('push-shifted');
          if (backdrop) backdrop.classList.add('d-none');
        }
        // Se bigSlide estiver ativo, aciona o fechamento para sincronizar estado interno
        if (window.jQuery && jQuery.fn && jQuery.fn.bigSlide) {
          jQuery('.menu-link').trigger('click');
        }
      } catch (e) { /* ignora erros de ambiente */ }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
  <script>
    function formatarTelefone(input) {
      // Remove tudo que não é número
      let v = input.value.replace(/\D/g, '').substring(0, 11);
      
      // Aplica máscara conforme o tamanho
      if (v.length > 10) {
        // Celular: (XX) XXXXX-XXXX
        v = v.replace(/^(\d{2})(\d{5})(\d{4}).*/, '($1) $2-$3');
      } else if (v.length > 6) {
        // Telefone fixo: (XX) XXXX-XXXX
        v = v.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, '($1) $2-$3');
      } else if (v.length > 2) {
        // DDD + início: (XX) XXXX
        v = v.replace(/^(\d{2})(\d{0,5}).*/, '($1) $2');
      } else if (v.length > 0) {
        // Apenas DDD: (XX
        v = v.replace(/^(\d{0,2}).*/, '($1');
      }
      
      input.value = v;
      
      // Validação visual
      const telefoneInput = input;
      const telefoneNumeros = v.replace(/\D/g, '');
      const isValid = telefoneNumeros.length >= 10 && telefoneNumeros.length <= 11;
      
      // Remove classes anteriores
      telefoneInput.classList.remove('is-valid', 'is-invalid');
      
      // Adiciona classe de validação
      if (telefoneNumeros.length > 0) {
        if (isValid) {
          telefoneInput.classList.add('is-valid');
          telefoneInput.setCustomValidity('');
        } else {
          telefoneInput.classList.add('is-invalid');
          telefoneInput.setCustomValidity('Telefone deve ter 10 ou 11 dígitos');
        }
      } else {
        telefoneInput.setCustomValidity('');
      }
    }
    
    // Função para validar telefone
    function validarTelefone(telefone) {
      if (!telefone) return true; // Campo opcional
      const numeros = telefone.replace(/\D/g, '');
      return numeros.length >= 10 && numeros.length <= 11;
    }
    
    // Função para validar telefone completo ao sair do campo
    function validarTelefoneCompleto(input) {
      const telefone = input.value.trim();
      const telefoneInput = input;
      
      // Remove classes anteriores
      telefoneInput.classList.remove('is-valid', 'is-invalid');
      
      if (telefone.length === 0) {
        // Campo vazio é válido (opcional)
        telefoneInput.setCustomValidity('');
        return true;
      }
      
      const numeros = telefone.replace(/\D/g, '');
      const isValid = numeros.length >= 10 && numeros.length <= 11;
      
      if (isValid) {
        telefoneInput.classList.add('is-valid');
        telefoneInput.setCustomValidity('');
        return true;
      } else {
        telefoneInput.classList.add('is-invalid');
        telefoneInput.setCustomValidity('Telefone deve ter 10 ou 11 dígitos');
        return false;
      }
    }

    const setMultipleSelect = (selectElement, dataValue) => {
      if (!selectElement) return;
      Array.from(selectElement.options).forEach(opt => opt.selected = false);
      const values = (typeof dataValue === 'string' && dataValue)
        ? dataValue.split(',').map(s => s.trim()).filter(s => s.length > 0)
        : [];
      if (values.length > 0) {
        let hasSelection = false;
        Array.from(selectElement.options).forEach(opt => {
          if (values.includes(opt.value)) {
            opt.selected = true;
            hasSelection = true;
          }
        });
        if (!hasSelection && selectElement.options.length > 0 && selectElement.options[0].value === "") {
          selectElement.options[0].selected = true;
        }
      } else {
        if (selectElement.options.length > 0 && selectElement.options[0].value === "") {
          selectElement.options[0].selected = true;
        }
      }
    };

    document.addEventListener('DOMContentLoaded', function () {

      let tomSelectInstances = {};

      const initializeMultiTagInput = (selector, dataValue) => {
        const selectElement = modalDetalhesEmpresa.querySelector(selector);
        if (!selectElement) return;

        if (tomSelectInstances[selector]) {
          tomSelectInstances[selector].destroy();
        }

        const values = (typeof dataValue === 'string' && dataValue)
          ? dataValue.split(',').map(s => s.trim()).filter(s => s.length > 0)
          : [];

        const tomSelect = new TomSelect(selectElement, {
          create: true,
          persist: false,
          delimiter: ',',
          items: []
        });

        values.forEach(value => {
          if (!tomSelect.options.hasOwnProperty(value)) {
            tomSelect.addOption({ value: value, text: value });
          }
        });

        tomSelect.setValue(values);
        tomSelectInstances[selector] = tomSelect;
      };

      const initializeSingleTagInput = (selector, dataValue) => {
        const selectElement = modalDetalhesEmpresa.querySelector(selector);
        if (!selectElement) return;

        if (tomSelectInstances[selector]) {
          tomSelectInstances[selector].destroy();
        }

        const tomSelect = new TomSelect(selectElement, {
          create: true,
          persist: false,
          items: []
        });

        if (dataValue && !tomSelect.options.hasOwnProperty(dataValue)) {
          tomSelect.addOption({ value: dataValue, text: dataValue });
        }

        tomSelect.setValue(dataValue);
        tomSelectInstances[selector] = tomSelect;
      };


      const modalDetalhesEmpresa = document.getElementById('modalDetalhesEmpresa');
      if (modalDetalhesEmpresa) {
        modalDetalhesEmpresa.addEventListener('show.bs.modal', function (event) {
          const safeSet = function(selOrEl, value, root){
            const el = typeof selOrEl === 'string' ? (root || document).querySelector(selOrEl) : selOrEl;
            if (!el) return; 
            try { el.value = value; } catch (_) {}
          };
          const button = event.relatedTarget;
          const getData = (key, defaultVal = '') => { const val = button && button.getAttribute ? button.getAttribute(`data-${key}`) : null; return (val === 'null' || val === 'undefined' || val === null || val === 'None' || val === undefined || val === '') ? defaultVal : val; };
          const modal = event.target || modalDetalhesEmpresa;
          let implId = getData('id');
          if (!implId) {
            const hiddenIdEl = modal.querySelector('#modal-implantacao_id');
            implId = hiddenIdEl && hiddenIdEl.value ? hiddenIdEl.value : implId;
          }
          if (!implId) {
            const m = (location.pathname || '').match(/\/implantacao\/(\d+)/);
            implId = m && m[1] ? m[1] : implId;
          }

          safeSet('#modal-implantacao_id', implId, modal);
          safeSet('#modal-responsavel_cliente', getData('responsavel'), modal);
          safeSet('#modal-cargo_responsavel', getData('cargo'), modal);
          safeSet('#modal-telefone_responsavel', getData('telefone'), modal);
          safeSet('#modal-email_responsavel', getData('email'), modal);
          const inicioProducaoIsoAttr = getData('inicio-producao');
          const finalImplantacaoIsoAttr = getData('final-implantacao');
          safeSet('#modal-id_favorecido', getData('id-favorecido'), modal);
          safeSet('#modal-chave_oamd', getData('chave-oamd'), modal);
          safeSet('#modal-tela_apoio_link', getData('tela-apoio-link'), modal);
          safeSet('#modal-nivel_receita', getData('nivel-receita'), modal);

          initializeMultiTagInput('#modal-modalidades', getData('modalidades'));
          initializeMultiTagInput('#modal-horarios_func', getData('horarios-func'));
          initializeMultiTagInput('#modal-formas_pagamento', getData('formas-pagamento'));
          initializeMultiTagInput('#modal-seguimento', getData('seguimento'));
          initializeMultiTagInput('#modal-tipos_planos', getData('tipos-planos'));

          safeSet('#modal-diaria', getData('diaria', 'Não definido'), modal);
          safeSet('#modal-freepass', getData('freepass', 'Não definido'), modal);
          safeSet('#modal-alunos_ativos', getData('alunos-ativos', '0'), modal);
          safeSet('#modal-sistema_anterior', getData('sistema-anterior'), modal);
          safeSet('#modal-recorrencia_usa', getData('recorrencia-usa'), modal);
          safeSet('#modal-importacao', getData('importacao', 'Não definido'), modal);
          safeSet('#modal-boleto', getData('boleto', 'Não definido'), modal);
          safeSet('#modal-nota_fiscal', getData('nota-fiscal', 'Não definido'), modal);
          safeSet('#modal-catraca', getData('catraca', 'Não preenchido'), modal);
          safeSet('#modal-facial', getData('facial', 'Não preenchido'), modal);

          safeSet('#modal-valor_atribuido', getData('valor-atribuido', '0.00'), modal);

          safeSet('#modal-resp_estrategico_nome', getData('resp-estrategico-nome'), modal);
          safeSet('#modal-resp_onb_nome', getData('resp-onb-nome'), modal);
          safeSet('#modal-contatos', getData('contatos'), modal);
          safeSet('#modal-resp_estrategico_obs', getData('resp-estrategico-obs'), modal);

          const inicioEfetivoIsoAttr = getData('inicio-efetivo-iso');

          const normalizeToISO = (s) => {
            if (!s) return '';
            const t = String(s).trim();
            let m = t.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
            if (m) return `${m[3]}-${m[2]}-${m[1]}`;
            m = t.match(/^(\d{4})-(\d{2})-(\d{2})/);
            if (m) return `${m[1]}-${m[2]}-${m[3]}`;
            return '';
          };
          const setFpDate = (fp, s) => { const iso = normalizeToISO(s); if (fp && iso) { fp.setDate(iso, true, 'Y-m-d'); } };
          setFpDate(window.fpInicioEfetivo, inicioEfetivoIsoAttr);
          setFpDate(window.fpInicioProd, inicioProducaoIsoAttr);
          setFpDate(window.fpFinalImpl, finalImplantacaoIsoAttr);

          if (!inicioEfetivoIsoAttr) {
            const v = (modal.querySelector('#modal-inicio_efetivo') || {}).value || '';
            if (v) setFpDate(window.fpInicioEfetivo, v);
          }
          if (!inicioProducaoIsoAttr) {
            const v = (modal.querySelector('#modal-data_inicio_producao') || {}).value || '';
            if (v) setFpDate(window.fpInicioProd, v);
          }
          if (!finalImplantacaoIsoAttr) {
            const v = (modal.querySelector('#modal-data_final_implantacao') || {}).value || '';
            if (v) setFpDate(window.fpFinalImpl, v);
          }

          const inicioImplantacaoIso = getData('inicio-implantacao');
          safeSet('#modal-data_cadastro', (function (iso) { if (!iso) return ''; var p = iso.split('T')[0].split('-'); if (p.length !== 3) return ''; return p[2].padStart(2, '0') + '/' + p[1].padStart(2, '0') + '/' + p[0]; })(inicioImplantacaoIso), modal);

          fetch(`/api/v1/implantacoes/${implId}`)
            .then(r => r.ok ? r.json() : Promise.reject(new Error('Falha ao carregar implantação')))
            .then(j => {
              if (!j || !j.ok || !j.data || !j.data.implantacao) return;
              const impl = j.data.implantacao;
              setFpDate(window.fpInicioEfetivo, impl.data_inicio_efetivo);
              setFpDate(window.fpInicioProd, impl.data_inicio_producao);
              setFpDate(window.fpFinalImpl, impl.data_final_implantacao);
            })
            .catch(() => { });

          formatarTelefone(modal.querySelector('#modal-telefone_responsavel'));
          const isDetailsPage = document.getElementById('checklist-area-treinamento');
          safeSet('#modal-redirect_to', isDetailsPage ? 'detalhes' : 'dashboard', modal);
        });

        modalDetalhesEmpresa.addEventListener('hide.bs.modal', function (event) {
          for (const selector in tomSelectInstances) {
            if (tomSelectInstances[selector]) {
              tomSelectInstances[selector].destroy();
            }
          }
          tomSelectInstances = {};
        });
      }

      document.addEventListener('show.bs.modal', function (event) {
        const target = event.target;
        if (!target || target.id !== 'modalDetalhesEmpresa') return;
        const button = event.relatedTarget;
        const modal = target;
        const getData = (key, def='') => { const val = button && button.getAttribute ? button.getAttribute(`data-${key}`) : null; return (!val || val === 'null' || val === 'undefined' || val === 'None') ? def : val; };
        let implId = getData('id');
        if (!implId) {
          const hiddenIdEl = modal.querySelector('#modal-implantacao_id') || modal.querySelector('[name="implantacao_id"]');
          implId = hiddenIdEl && hiddenIdEl.value ? hiddenIdEl.value : implId;
        }
        if (!implId) {
          const m = (location.pathname || '').match(/\/implantacao\/(\d+)/);
          implId = m && m[1] ? m[1] : implId;
        }
        const inicioEfetivoIsoAttr = getData('inicio-efetivo-iso');
        const inicioProducaoIsoAttr = getData('inicio-producao');
        const finalImplantacaoIsoAttr = getData('final-implantacao');
        const normalizeToISO = (s) => { if (!s) return ''; const t = String(s).trim(); let m = t.match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if (m) return `${m[3]}-${m[2]}-${m[1]}`; m = t.match(/^(\d{4})-(\d{2})-(\d{2})/); if (m) return `${m[1]}-${m[2]}-${m[3]}`; return ''; };
        const setFpDate = (fp, s) => { const iso = normalizeToISO(s); if (fp && iso) { fp.setDate(iso, true, 'Y-m-d'); } };
        setFpDate(window.fpInicioEfetivo, inicioEfetivoIsoAttr);
        setFpDate(window.fpInicioProd, inicioProducaoIsoAttr);
        setFpDate(window.fpFinalImpl, finalImplantacaoIsoAttr);
        if (!inicioEfetivoIsoAttr) { const v = (modal.querySelector('#modal-inicio_efetivo') || modal.querySelector('[name="data_inicio_efetivo"]') || {}).value || ''; if (v) setFpDate(window.fpInicioEfetivo, v); }
        if (!inicioProducaoIsoAttr) { const v = (modal.querySelector('#modal-data_inicio_producao') || modal.querySelector('[name="data_inicio_producao"]') || {}).value || ''; if (v) setFpDate(window.fpInicioProd, v); }
        if (!finalImplantacaoIsoAttr) { const v = (modal.querySelector('#modal-data_final_implantacao') || modal.querySelector('[name="data_final_implantacao"]') || {}).value || ''; if (v) setFpDate(window.fpFinalImpl, v); }
        fetch(`/api/v1/implantacoes/${implId}`).then(r => r.ok ? r.json() : Promise.reject(new Error('Falha ao carregar implantação'))).then(j => { if (!j || !j.ok || !j.data || !j.data.implantacao) return; const impl = j.data.implantacao; setFpDate(window.fpInicioEfetivo, impl.data_inicio_efetivo); setFpDate(window.fpInicioProd, impl.data_inicio_producao); setFpDate(window.fpFinalImpl, impl.data_final_implantacao); }).catch(() => {});
      }, true);

      (function() {
        let formInitialValues = {};
        let formHasChanges = false;
        let isClosingAfterConfirm = false;
        const modalDetalhesEmpresa = document.getElementById('modalDetalhesEmpresa');
        const modalForm = modalDetalhesEmpresa ? modalDetalhesEmpresa.querySelector('form') : null;
        
        if (!modalForm) return;
        
        function saveFormInitialValues() {
          formInitialValues = {};
          const inputs = modalForm.querySelectorAll('input, select, textarea');
          inputs.forEach(input => {
            if (input.type === 'checkbox' || input.type === 'radio') {
              formInitialValues[input.name || input.id] = input.checked;
            } else {
              formInitialValues[input.name || input.id] = input.value;
            }
          });
          formHasChanges = false;
        }
        
        function checkFormChanges() {
          formHasChanges = false;
          const inputs = modalForm.querySelectorAll('input, select, textarea');
          for (let input of inputs) {
            const key = input.name || input.id;
            let currentValue;
            if (input.type === 'checkbox' || input.type === 'radio') {
              currentValue = input.checked;
            } else {
              currentValue = input.value;
            }
            if (formInitialValues[key] !== currentValue) {
              formHasChanges = true;
              break;
            }
          }
          return formHasChanges;
        }
        
        function validateFormFields() {
          const emailInput = modalForm.querySelector('#modal-email_responsavel');
          if (emailInput && emailInput.value && emailInput.value.trim() !== '') {
            const emailValue = emailInput.value.trim();
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (!emailRegex.test(emailValue)) {
              return { valid: false, field: emailInput, message: 'O campo "E-mail Resp." contém um valor inválido. Digite um email válido (exemplo: nome@dominio.com)' };
            }
          }
          
          if (!modalForm.checkValidity()) {
            const firstInvalid = modalForm.querySelector(':invalid');
            if (firstInvalid) {
              return { valid: false, field: firstInvalid, message: 'Há campos com valores inválidos. Corrija os erros antes de continuar.' };
            }
          }
          
          return { valid: true };
        }
        
        function processarDatas() {
          const toIso = (br) => { 
            if (!br || typeof br !== 'string') return ''; 
            const m = br.match(/^(\d{2})\/(\d{2})\/(\d{4})$/); 
            if (!m) return br; 
            const dd=m[1], mm=m[2], yyyy=m[3]; 
            return `${yyyy}-${mm}-${dd}`; 
          };
          
          const inicioEfetivo = modalForm.querySelector('#modal-inicio_efetivo') || modalForm.querySelector('[name="data_inicio_efetivo"]');
          const dataInicioProd = modalForm.querySelector('#modal-data_inicio_producao') || modalForm.querySelector('[name="data_inicio_producao"]');
          const dataFinalImpl = modalForm.querySelector('#modal-data_final_implantacao') || modalForm.querySelector('[name="data_final_implantacao"]');
          
          if (inicioEfetivo && inicioEfetivo.value) inicioEfetivo.value = toIso(inicioEfetivo.value);
          if (dataInicioProd && dataInicioProd.value) dataInicioProd.value = toIso(dataInicioProd.value);
          if (dataFinalImpl && dataFinalImpl.value) dataFinalImpl.value = toIso(dataFinalImpl.value);

          if (window.fpInicioEfetivo && window.fpInicioEfetivo._input) {
            const v = window.fpInicioEfetivo._input.value;
            if (v) {
              const iso = toIso(v);
              if (iso) { window.fpInicioEfetivo.setDate(iso, true, 'Y-m-d'); }
            }
          }
          if (window.fpInicioProd && window.fpInicioProd._input) {
            const v = window.fpInicioProd._input.value;
            if (v) {
              const iso = toIso(v);
              if (iso) { window.fpInicioProd.setDate(iso, true, 'Y-m-d'); }
            }
          }
          if (window.fpFinalImpl && window.fpFinalImpl._input) {
            const v = window.fpFinalImpl._input.value;
            if (v) {
              const iso = toIso(v);
              if (iso) { window.fpFinalImpl.setDate(iso, true, 'Y-m-d'); }
            }
          }
        }
        
        modalForm.addEventListener('submit', function (e) {
          if (isClosingAfterConfirm) {
            e.preventDefault();
            return false;
          }
          processarDatas();
        });
        
        if (modalDetalhesEmpresa) {
          modalDetalhesEmpresa.addEventListener('show.bs.modal', function() {
            isClosingAfterConfirm = false;
            setTimeout(() => {
              saveFormInitialValues();
            }, 100);
          });
          
          modalDetalhesEmpresa.addEventListener('hide.bs.modal', async function(e) {
            if (isClosingAfterConfirm) {
              return;
            }
            
            checkFormChanges();
            
            if (formHasChanges) {
              e.preventDefault();
              
              const validation = validateFormFields();
              
              if (!validation.valid) {
                if (validation.field) {
                  validation.field.focus();
                  validation.field.reportValidity();
                }
                
                if (window.showToast) {
                  showToast(validation.message, 'error');
                } else {
                  alert(validation.message);
                }
                
                const bsModal = bootstrap.Modal.getInstance(modalDetalhesEmpresa);
                if (bsModal) {
                  bsModal.show();
                }
                return;
              }
              
              let confirmed = false;
              if (window.showConfirm) {
                confirmed = await showConfirm({
                  title: 'Descartar Alterações?',
                  message: 'Você fez alterações no formulário. Deseja descartar as alterações e fechar o modal?',
                  confirmText: 'Descartar',
                  cancelText: 'Cancelar',
                  type: 'warning',
                  icon: 'bi-exclamation-triangle-fill'
                });
              } else {
                confirmed = confirm('Você fez alterações no formulário. Deseja descartar as alterações e fechar o modal?');
              }
              
              if (!confirmed) {
                e.preventDefault();
                const bsModal = bootstrap.Modal.getInstance(modalDetalhesEmpresa);
                if (bsModal) {
                  bsModal.show();
                }
                return;
              }
              
              isClosingAfterConfirm = true;
              formHasChanges = false;
              
              const bsModal = bootstrap.Modal.getInstance(modalDetalhesEmpresa);
              if (bsModal) {
                bsModal.hide();
              }
            }
          });
          
          modalDetalhesEmpresa.addEventListener('hidden.bs.modal', function() {
            if (isClosingAfterConfirm) {
              const inputs = modalForm.querySelectorAll('input, select, textarea');
              inputs.forEach(input => {
                const key = input.name || input.id;
                if (formInitialValues.hasOwnProperty(key)) {
                  if (input.type === 'checkbox' || input.type === 'radio') {
                    input.checked = formInitialValues[key] || false;
                  } else {
                    input.value = formInitialValues[key] || '';
                  }
                }
              });
            }
            
            formHasChanges = false;
            isClosingAfterConfirm = false;
            formInitialValues = {};
          });
        }
        
        modalForm.addEventListener('input', function() {
          checkFormChanges();
        });
        
        modalForm.addEventListener('change', function() {
          checkFormChanges();
        });
        
        document.addEventListener('click', function(e) {
          const submitBtn = e.target.closest('#modalDetalhesEmpresa .btn-salvar-detalhes');
          if (submitBtn && modalForm) {
            e.preventDefault();
            e.stopPropagation();
            
            const validation = validateFormFields();
            if (!validation.valid) {
              if (validation.field) {
                validation.field.focus();
                validation.field.reportValidity();
              }
              if (window.showToast) {
                showToast(validation.message, 'error');
              }
              return false;
            }
            
            processarDatas();
            formHasChanges = false;
            modalForm.submit();
          }
        });
        
      })();


      // Inicializa calendário e máscara nos campos do modal Detalhes
      (function initModalCalendars() {
        if (!window.flatpickr) return;
        var makeConfig = function() {
          return {
            dateFormat: 'Y-m-d',
            altInput: true,
            altFormat: 'd/m/Y',
            allowInput: false,
            parseDate: function(datestr) {
              var m = datestr && datestr.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
              if (!m) return null;
              var d = parseInt(m[1], 10);
              var mo = parseInt(m[2], 10) - 1;
              var y = parseInt(m[3], 10);
              var dd = new Date(y, mo, d);
              if (dd.getDate() !== d || dd.getMonth() !== mo || dd.getFullYear() !== y) return null;
              return dd;
            }
          };
        };
        var ensureInstance = function(selector) {
          var el = document.querySelector(selector);
          if (!el) return null;
          if (el._flatpickr) return el._flatpickr;
          var fp = window.flatpickr(el, makeConfig());
          try {
            var rawVal = el.value || '';
            if (rawVal) {
              var m = rawVal.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
              var iso = '';
              if (m) iso = m[3] + '-' + m[2] + '-' + m[1];
              else {
                var m2 = rawVal.match(/^(\d{4})-(\d{2})-(\d{2})/);
                if (m2) iso = m2[1] + '-' + m2[2] + '-' + m2[3];
              }
              if (iso) fp.setDate(iso, true, 'Y-m-d');
            }
          } catch (e) {}
          return fp;
        };
        var fpInicioEfetivo = ensureInstance('#modal-inicio_efetivo') || ensureInstance('[name="data_inicio_efetivo"]');
        var fpInicioProd = ensureInstance('#modal-data_inicio_producao') || ensureInstance('[name="data_inicio_producao"]');
        var fpFinalImpl = ensureInstance('#modal-data_final_implantacao') || ensureInstance('[name="data_final_implantacao"]');
        window.fpInicioEfetivo = fpInicioEfetivo;
        window.fpInicioProd = fpInicioProd;
        window.fpFinalImpl = fpFinalImpl;
        var btnInicioEfetivo = document.getElementById('btn-cal-inicio_efetivo');
        var btnInicioProd = document.getElementById('btn-cal-data_inicio_producao');
        var btnFinalImpl = document.getElementById('btn-cal-data_final_implantacao');
        if (btnInicioEfetivo && fpInicioEfetivo) btnInicioEfetivo.addEventListener('click', function () { fpInicioEfetivo.open(); });
        if (btnInicioProd && fpInicioProd) btnInicioProd.addEventListener('click', function () { fpInicioProd.open(); });
        if (btnFinalImpl && fpFinalImpl) btnFinalImpl.addEventListener('click', function () { fpFinalImpl.open(); });
        var attachMask = function(fp) {
          var alt = fp && fp._input ? fp._input : null;
          if (!alt) return;
          alt.addEventListener('input', function (e) {
            var v = e.target.value.replace(/[^\d]/g, '').slice(0, 8);
            var out = '';
            if (v.length >= 2) out = v.slice(0, 2);
            if (v.length >= 4) out = out + '/' + v.slice(2, 4);
            if (v.length >= 5) out = out + '/' + v.slice(4, 8);
            e.target.value = out;
          });
        };
        attachMask(fpInicioEfetivo);
        attachMask(fpInicioProd);
        attachMask(fpFinalImpl);
      })();

      const modalGerenciarUsuarios = document.getElementById('modalGerenciarUsuarios');
      if (modalGerenciarUsuarios) {
        const urlParams = new URLSearchParams(window.location.search);
        const shouldOpenModal = urlParams.get('open_users_modal') === 'true';
        const loadManagementContent = () => {
          const contentDiv = document.getElementById('users-management-content'); const spinnerHTML = `<div class="text-center py-5" id="users-loading-spinner"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div><p class="mt-2">Carregando lista de usuários...</p></div>`; contentDiv.innerHTML = spinnerHTML;
          fetch('{{ url_for("management.manage_users_modal") }}')
            .then(response => { if (!response.ok) { return response.text().then(text => { throw new Error(text || `Erro ${response.status} ao carregar usuários.`); }); } return response.text(); })
            .then(html => { contentDiv.innerHTML = html; })
            .catch(error => { console.error('Erro ao carregar gerenciamento de usuários:', error); contentDiv.innerHTML = `<div class="alert alert-danger">Falha ao carregar a lista de usuários. Detalhes: ${error.message}</div>`; });
        };
        modalGerenciarUsuarios.addEventListener('shown.bs.modal', loadManagementContent);
        if (shouldOpenModal) { setTimeout(() => { const bsModal = bootstrap.Modal.getOrCreateInstance(modalGerenciarUsuarios); if (bsModal) { bsModal.show(); const currentUrl = new URL(window.location); currentUrl.searchParams.delete('open_users_modal'); history.replaceState(null, '', currentUrl.toString()); } }, 100); }
      }

      const modalPerfil = document.getElementById('modalPerfil');
      if (modalPerfil) {
        const urlParams = new URLSearchParams(window.location.search);
        const shouldOpenProfileModal = urlParams.get('open_profile_modal') === 'true';
        const loadProfileContent = () => {
          const contentDiv = document.getElementById('profile-content');
          const spinnerHTML = `<div class="text-center py-5" id="profile-loading-spinner"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div><p class="mt-2">Carregando perfil...</p></div>`;
          contentDiv.innerHTML = spinnerHTML;
          fetch('{{ url_for("profile.profile_modal") }}')
            .then(response => { if (!response.ok) { return response.text().then(text => { throw new Error(text || `Erro ${response.status} ao carregar perfil.`); }); } return response.text(); })
            .then(html => { contentDiv.innerHTML = html; })
            .catch(error => { console.error('Erro ao carregar perfil:', error); contentDiv.innerHTML = `<div class="alert alert-danger">Falha ao carregar o perfil. Detalhes: ${error.message}</div>`; });
        };
        modalPerfil.addEventListener('shown.bs.modal', loadProfileContent);
        modalPerfil.addEventListener('submit', function (ev) {
          const form = ev.target;
          if (!form || !modalPerfil.contains(form)) return;
          ev.preventDefault();
          try {
            const contentDiv = document.getElementById('profile-content');
            const postUrl = form.getAttribute('hx-post') || form.getAttribute('action');
            if (!postUrl) { form.submit(); return; }
            const fd = new FormData(form);
            fetch(postUrl, { method: 'POST', body: fd, headers: { 'HX-Request': 'true' } })
              .then(function (r) { return r.text(); })
              .then(function (html) { contentDiv.innerHTML = html; })
              .catch(function (err) { console.error('Falha ao salvar perfil no modal:', err); });
          } catch (e) { console.error('Erro ao interceptar submit no modal Perfil:', e); }
        }, true);
        if (shouldOpenProfileModal) {
          setTimeout(() => {
            const bsModal = bootstrap.Modal.getOrCreateInstance(modalPerfil);
            if (bsModal) {
              bsModal.show();
              const currentUrl = new URL(window.location);
              currentUrl.searchParams.delete('open_profile_modal');
              history.replaceState(null, '', currentUrl.toString());
            }
          }, 100);
        }
      }
    });

    // ========================================
    // SISTEMA DE TOASTS
    // ========================================
    window.showToast = function(message, type = 'info', duration = 5000) {
      const toastContainer = document.getElementById('toastContainer');
      if (!toastContainer) {
        return;
      }

      const toastId = 'toast-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      const bgClass = {
        'success': 'bg-success',
        'error': 'bg-danger',
        'warning': 'bg-warning',
        'info': 'bg-info',
        'primary': 'bg-primary'
      }[type] || 'bg-info';

      const icon = {
        'success': 'bi-check-circle-fill',
        'error': 'bi-x-circle-fill',
        'warning': 'bi-exclamation-triangle-fill',
        'info': 'bi-info-circle-fill',
        'primary': 'bi-bell-fill'
      }[type] || 'bi-info-circle-fill';

      const toastHTML = `
        <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body d-flex align-items-center">
              <i class="bi ${icon} me-2"></i>
              <span>${message}</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      `;

      toastContainer.insertAdjacentHTML('beforeend', toastHTML);
      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: duration
      });
      toast.show();

      // Remove o elemento do DOM após ser escondido
      toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
      });
    };

    // ========================================
    // SISTEMA DE CONFIRMAÇÕES INTELIGENTES
    // ========================================
    window.showConfirm = function(options) {
      return new Promise((resolve) => {
        const {
          title = 'Confirmar ação',
          message = 'Tem certeza que deseja continuar?',
          confirmText = 'Confirmar',
          cancelText = 'Cancelar',
          type = 'warning',
          icon = 'bi-exclamation-triangle-fill'
        } = options;

        const modalId = 'confirmModal-' + Date.now();
        const modalHTML = `
          <div class="modal fade" id="${modalId}" tabindex="-1" aria-labelledby="${modalId}Label" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                  <h5 class="modal-title" id="${modalId}Label">
                    <i class="bi ${icon} text-${type} me-2"></i>${title}
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <p>${message}</p>
                </div>
                <div class="modal-footer border-0">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${cancelText}</button>
                  <button type="button" class="btn btn-${type === 'danger' ? 'danger' : 'primary'}" id="${modalId}Confirm">${confirmText}</button>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
        const modalElement = document.getElementById(modalId);
        const modal = new bootstrap.Modal(modalElement);

        document.getElementById(modalId + 'Confirm').addEventListener('click', () => {
          modal.hide();
          resolve(true);
          modalElement.addEventListener('hidden.bs.modal', () => modalElement.remove(), { once: true });
        });

        modalElement.addEventListener('hidden.bs.modal', () => {
          resolve(false);
          modalElement.remove();
        }, { once: true });

        modal.show();
      });
    };

    // ========================================
    // LOADING STATES - Skeleton Screen Helper
    // ========================================
    window.showSkeleton = function(container, count = 3) {
      if (!container) return;
      
      const skeletonHTML = `
        <div class="skeleton-item mb-3">
          <div class="skeleton-line" style="height: 20px; width: 60%; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: skeleton-loading 1.5s ease-in-out infinite; border-radius: 4px; margin-bottom: 10px;"></div>
          <div class="skeleton-line" style="height: 16px; width: 100%; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: skeleton-loading 1.5s ease-in-out infinite; border-radius: 4px; margin-bottom: 8px;"></div>
          <div class="skeleton-line" style="height: 16px; width: 80%; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: skeleton-loading 1.5s ease-in-out infinite; border-radius: 4px;"></div>
        </div>
      `;

      container.innerHTML = skeletonHTML.repeat(count);
    };

    // Adicionar animação CSS para skeleton
    if (!document.getElementById('skeleton-styles')) {
      const style = document.createElement('style');
      style.id = 'skeleton-styles';
      style.textContent = `
        @keyframes skeleton-loading {
          0% { background-position: 200% 0; }
          100% { background-position: -200% 0; }
        }
        .skeleton-item {
          padding: 1rem;
          background: #fff;
          border-radius: 8px;
          border: 1px solid #e9ecef;
        }
      `;
      document.head.appendChild(style);
    }
  </script>
  {% block scripts_extra %}{% endblock %}
</body>

</html>
