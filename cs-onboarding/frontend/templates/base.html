<!DOCTYPE html>
<html lang="pt-BR">
<!-- CRITICAL: Prevent flash of white on dark mode -->
<script>
  (function () {
    var theme = localStorage.getItem('theme');
    if (theme === 'dark') {
      document.documentElement.classList.add('dark-mode');
      document.documentElement.style.backgroundColor = '#0f172a';
      document.documentElement.style.colorScheme = 'dark';
    }
  })();
</script>
{% set current_dashboard = 'onboarding.dashboard' %}
{% if request.blueprint == 'ongoing' %}
{% set current_dashboard = 'ongoing.dashboard' %}
{% elif request.blueprint == 'grandes_contas' %}
{% set current_dashboard = 'grandes_contas.dashboard' %}
{% elif request.blueprint == 'onboarding' %}
{% set current_dashboard = 'onboarding.dashboard' %}
{% elif g.modulo_atual == 'grandes_contas' %}
{% set current_dashboard = 'grandes_contas.dashboard' %}
{% elif g.modulo_atual == 'ongoing' %}
{% set current_dashboard = 'ongoing.dashboard' %}
{% endif %}

{% set current_context = 'onboarding' %}
{% if request.blueprint == 'grandes_contas' or (request.blueprint in ['analytics', 'planos'] and
request.args.get('context') == 'grandes_contas') or (request.blueprint == 'perfis' and g.modulo_atual ==
'grandes_contas') %}
{% set current_context = 'grandes_contas' %}
{% elif request.blueprint == 'ongoing' or (request.blueprint in ['analytics', 'planos'] and request.args.get('context')
== 'ongoing') or (request.blueprint == 'perfis' and g.modulo_atual == 'ongoing') %}
{% set current_context = 'ongoing' %}
{% endif %}

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-site-verification" content="fYdVPcoNNnG6eyLSXqa39Ukhx7yWRzK5y5e6XyJMTdY">
  <title>{% block title %}CS Onboarding{% endblock %}</title>

  <!-- Inline critical CSS to prevent flash -->
  <style>
    html.dark-mode,
    html.dark-mode body {
      background-color: #0f172a !important;
      color: #e2e8f0;
    }
  </style>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <!-- Design System CSS (novo) - Com cache-busting automático -->
  <link rel="stylesheet" href="{{ 'css/main.css' | static_versioned }}">

  <!-- Legacy CSS (mantido para compatibilidade - serão removidos gradualmente) -->
  <link rel="stylesheet" href="{{ 'css/style.css' | static_versioned }}">
  <link rel="stylesheet" href="{{ 'css/theme.css' | static_versioned }}">
  <link rel="stylesheet" href="{{ 'css/responsive_global.css' | static_versioned }}">


  {% block head_extra %}{% endblock %}
  <script>
    // Global context for JS components (notifications, etc)
    window.currentContext = "{{ current_context }}";
  </script>
</head>

<body class="{% if request.cookies.get('theme') == 'dark' %}dark-mode{% endif %}">


  <div class="main-layout">
    <!-- Sidebar sempre visível -->
    {% block sidebar %}
    <nav id="menu" class="sidebar-menu" role="navigation">
      <div class="sidebar-header">
        <div class="sidebar-user-block d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center sidebar-user-meta">
            <div class="user-profile-btn-sidebar me-2">
              <span class="sidebar-user-status-dot" aria-hidden="true"></span>
              {% if g.perfil and g.perfil.foto_url %}
              <img src="{{ g.perfil.foto_url }}?v={{ range(1, 10000) | random }}" alt="Foto" id="sidebar-user-photo"
                class="user-photo-global">
              {% else %}
              <i class="bi bi-person-fill" style="font-size: 1.5rem;"></i>
              {% endif %}
            </div>
            <div class="sidebar-user-info">
              <strong class="nav-link-text user-name-global" id="sidebar-user-name">{{ g.perfil.nome or g.user_email
                }}</strong>
              <span class="nav-link-text sidebar-user-role">{{ (g.perfil.perfil_acesso if g.perfil and
                g.perfil.perfil_acesso else 'Admin') }}</span>
            </div>
          </div>
          <button id="sidebarToggle" class="sidebar-toggle-btn" title="Colapsar menu" aria-label="Colapsar menu">
            <i class="bi bi-chevron-left"></i>
          </button>
        </div>
      </div>
      <ul class="nav flex-column sidebar-nav-main">
        <li class="nav-item"><a
            class="nav-link {% if request.endpoint and 'dashboard' in request.endpoint %}active{% endif %}"
            href="{{ url_for(current_dashboard) }}"><i class="bi bi-grid me-2"></i><span class="nav-link-text">
              Dashboard</span></a></li>
        {% if implantacao and implantacao.id %}
        {% set ver_impl_blueprint = (request.blueprint if request.blueprint in ['onboarding', 'grandes_contas',
        'ongoing'] else (implantacao.contexto if (implantacao and implantacao.contexto) else 'onboarding')) %}
        <li class="nav-item"><a
            class="nav-link {% if '.ver_implantacao' in (request.endpoint or '') %}active{% endif %}"
            href="{{ url_for(ver_impl_blueprint + '.ver_implantacao', impl_id=implantacao.id) }}"><i
              class="bi bi-kanban me-2"></i><span class="nav-link-text"> Detalhes da Implantação</span></a></li>
        {% endif %}
        <li class="nav-item"><a class="nav-link {% if request.endpoint == 'profile.profile' %}active{% endif %}"
            href="{{ url_for('profile.profile') }}"><i class="bi bi-person-circle me-2"></i><span class="nav-link-text">
              Perfil</span></a></li>
        {% if g.perfil and g.perfil.perfil_acesso in g.PERFIS_COM_GESTAO %}
        <li class="nav-item"><a
            class="nav-link {% if request.endpoint and request.endpoint.startswith('planos.') %}active{% endif %}"
            href="{{ url_for('planos.listar_planos', context=current_context) }}"><i
              class="bi bi-signpost-split me-2"></i><span class="nav-link-text"> Planos de Sucesso</span></a></li>
        <li class="nav-item"><a class="nav-link {% if request.endpoint == 'management.manage_users' %}active{% endif %}"
            href="{{ url_for('management.manage_users') }}"><i class="bi bi-people me-2"></i><span class="nav-link-text">
              Usuários</span></a></li>
        <li class="nav-item"><a
            class="nav-link {% if request.endpoint and request.endpoint.startswith('perfis.') %}active{% endif %}"
            href="{{ url_for('perfis.listar_perfis') }}"><i class="bi bi-shield-shaded me-2"></i><span
              class="nav-link-text"> Perfis de Acesso</span></a></li>
        <li class="nav-item"><a
            class="nav-link {% if request.endpoint == 'analytics.analytics_dashboard' %}active{% endif %}"
            href="{{ url_for('analytics.analytics_dashboard', context=current_context) }}"><i
              class="bi bi-graph-up-arrow me-2"></i><span class="nav-link-text"> Gerencial</span></a></li>
        <li class="nav-item nav-item-section-title"><span class="nav-link disabled nav-link-text">GAMIFICAÇÃO</span>
        </li>
        <li class="nav-item"><a
            class="nav-link {% if request.endpoint == 'gamification.manage_gamification_metrics' %}active{% endif %}"
            href="{{ url_for('gamification.manage_gamification_metrics', context=current_context) }}"><i
              class="bi bi-list-check me-2"></i><span class="nav-link-text"> Métricas</span></a></li>
        <li class="nav-item"><a
            class="nav-link {% if request.endpoint == 'gamification.manage_gamification_rules' %}active{% endif %}"
            href="/gamification/rules"><i class="bi bi-card-list me-2"></i><span
              class="nav-link-text"> Critérios da Gamificação</span></a></li>
        <li class="nav-item"><a
            class="nav-link {% if request.endpoint == 'gamification.gamification_report' %}active{% endif %}"
            href="{{ url_for('gamification.gamification_report', context=current_context) }}"><i
              class="bi bi-file-earmark-bar-graph me-2"></i><span class="nav-link-text"> Relatório</span></a></li>
        {% endif %}
      </ul>
      <ul class="nav flex-column sidebar-nav-footer">
        <li class="nav-item nav-item-divider">
          <hr>
        </li>
        <li class="nav-item">
          <a class="nav-link nav-link-theme" href="#" id="themeToggle">
            <span class="nav-link-theme-left">
              <i class="bi bi-moon-stars me-2" id="themeIcon"></i>
              <span class="nav-link-text" id="themeText">Tema Escuro</span>
            </span>
            <span class="theme-switch" aria-hidden="true">
              <span class="theme-switch-thumb"></span>
            </span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('core.modules_selection') }}">
            <i class="bi bi-grid me-2"></i>
            <span class="nav-link-text">Trocar Módulo</span>
          </a>
        </li>
        <li class="nav-item"><a class="nav-link nav-link-danger" href="{{ url_for('auth.logout') }}"><i
              class="bi bi-box-arrow-left me-2"></i><span class="nav-link-text"> Sair</span></a></li>
      </ul>
    </nav>
    {% endblock %}

    <!-- Conteúdo principal -->
    <div class="main-content">
      {% block content %}
      <div class="container py-4">
        <div class="card">
          <div class="card-body">
            <h1 class="main-title mb-2">Conteúdo Padrão</h1>
            <p class="text-muted text-center mb-0">Substitua no template filho.</p>
          </div>
        </div>
      </div>
      {% endblock %}
    </div>
  </div>

  {% include 'modals/_detalhes_empresa.html' %}

  <!-- Modal de Confirmação Reutilizável (Bootstrap) -->
  <div class="modal fade" id="modalConfirmacao" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header header-bg">
          <h5 class="modal-title" id="modalConfirmacaoTitulo">Confirmar ação</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="modalConfirmacaoAlerta" class="mb-3 d-none">
            <h5 class="fw-bold" id="modalConfirmacaoAlertaTexto">
              <i class="bi bi-exclamation-triangle-fill me-2" id="modalConfirmacaoIcone"></i>
              <span id="modalConfirmacaoAlertaLabel">Atenção!</span>
            </h5>
          </div>
          <p id="modalConfirmacaoMensagem">Tem certeza que deseja continuar?</p>
          <p class="text-muted small d-none" id="modalConfirmacaoDetalhe"></p>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
            id="modalConfirmacaoCancelar">Cancelar</button>
          <button type="button" class="btn btn-primary" id="modalConfirmacaoConfirmar">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;" id="toastContainer">
    <!-- Toasts serão inseridos aqui dinamicamente -->
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
  <script src="https://unpkg.com/imask"></script>
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

  <!-- ========================================
       MODULAR ARCHITECTURE (SOLID Principles)
       ======================================== -->

  <!-- Utils Layer - Com cache-busting automático -->
  <script src="{{ 'js/utils/date-utils.js' | static_versioned }}"></script>
  <script src="{{ 'js/utils/phone-utils.js' | static_versioned }}"></script>
  <script src="{{ 'js/utils/html-utils.js' | static_versioned }}"></script>
  <script src="{{ 'js/utils/fetch_retry.js' | static_versioned }}"></script>

  <!-- UI Layer -->
  <script src="{{ 'js/ui/toast.js' | static_versioned }}"></script>
  <script src="{{ 'js/ui/confirm-dialog.js' | static_versioned }}"></script>
  <script src="{{ 'js/ui/loading.js' | static_versioned }}"></script>
  <script src="{{ 'js/ui/nprogress.js' | static_versioned }}"></script>
  <script src="{{ 'js/ui/sidebar.js' | static_versioned }}"></script>

  <!-- Core (Legacy - will be refactored) -->
  <script src="{{ 'js/common.js' | static_versioned }}"></script>

  <!-- Services & Utilities -->
  <script src="{{ 'js/utils/bug_prevention_service.js' | static_versioned }}"></script>
  <script src="{{ 'js/utils/table_sort.js' | static_versioned }}"></script>

  <!-- Components -->
  <script src="{{ 'js/components/modal_detalhes_empresa.js' | static_versioned }}"></script>
  <script src="{{ 'js/components/notifications.js' | static_versioned }}"></script>

  {% block scripts_extra %}{% endblock %}

  <!-- Converte flash messages para toasts flutuantes automaticamente -->
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const flashMessages = {{ messages | tojson | safe
    }};
    flashMessages.forEach(function (msg) {
      const category = msg[0];
      const message = msg[1];
      // Mapeia categorias do Flask para tipos de toast
      const typeMap = {
        'success': 'success',
        'error': 'error',
        'danger': 'error',
        'warning': 'warning',
        'info': 'info',
        'primary': 'primary'
      };
      const toastType = typeMap[category] || 'info';
      if (window.showToast) {
        window.showToast(message, toastType, 6000);
      }
    });
    });
  </script>
  {% endif %}
  {% endwith %}
</body>

</html>
