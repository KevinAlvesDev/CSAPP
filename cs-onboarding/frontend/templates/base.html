<!DOCTYPE html>
<html lang="pt-BR">
<!-- CRITICAL: Prevent flash of white on dark mode -->
<script>
  (function () {
    var theme = localStorage.getItem('theme');
    if (theme === 'dark') {
      document.documentElement.classList.add('dark-mode');
      document.documentElement.style.backgroundColor = '#0f172a';
      document.documentElement.style.colorScheme = 'dark';
    }
  })();
</script>
{% set current_dashboard = 'onboarding.dashboard' %}
{% if request.blueprint == 'ongoing' %}
{% set current_dashboard = 'ongoing.dashboard' %}
{% elif request.blueprint == 'grandes_contas' %}
{% set current_dashboard = 'grandes_contas.dashboard' %}
{% elif request.blueprint == 'onboarding' %}
{% set current_dashboard = 'onboarding.dashboard' %}
{% elif g.modulo_atual == 'grandes_contas' %}
{% set current_dashboard = 'grandes_contas.dashboard' %}
{% elif g.modulo_atual == 'ongoing' %}
{% set current_dashboard = 'ongoing.dashboard' %}
{% endif %}

{% set current_context = 'onboarding' %}
{% if request.blueprint == 'grandes_contas' or (request.blueprint in ['analytics', 'planos'] and
request.args.get('context') == 'grandes_contas') or (request.blueprint == 'perfis' and g.modulo_atual ==
'grandes_contas') %}
{% set current_context = 'grandes_contas' %}
{% elif request.blueprint == 'ongoing' or (request.blueprint in ['analytics', 'planos'] and request.args.get('context')
== 'ongoing') or (request.blueprint == 'perfis' and g.modulo_atual == 'ongoing') %}
{% set current_context = 'ongoing' %}
{% endif %}

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-site-verification" content="fYdVPcoNNnG6eyLSXqa39Ukhx7yWRzK5y5e6XyJMTdY">
  <title>{% block title %}CS Onboarding{% endblock %}</title>

  <!-- Inline critical CSS to prevent flash -->
  <style>
    html.dark-mode,
    html.dark-mode body {
      background-color: #0f172a !important;
      color: #e2e8f0;
    }
  </style>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <!-- Design System CSS (novo) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">

  <!-- Legacy CSS (mantido para compatibilidade - serão removidos gradualmente) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">


  {% block head_extra %}{% endblock %}
  <script>
    // Global context for JS components (notifications, etc)
    window.currentContext = "{{ current_context }}";
  </script>
</head>

<body class="{% if request.cookies.get('theme') == 'dark' %}dark-mode{% endif %}">


  <div class="main-layout">
    <!-- Sidebar sempre visível -->
    {% block sidebar %}
    <nav id="menu" class="sidebar-menu" role="navigation">
      <div class="sidebar-header d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center">
          <div class="user-profile-btn-sidebar me-2">
            {% if g.perfil and g.perfil.foto_url %}
            <img src="{{ g.perfil.foto_url }}?v={{ range(1, 10000) | random }}" alt="Foto" id="sidebar-user-photo"
              class="user-photo-global">
            {% else %}
            <i class="bi bi-person-fill" style="font-size: 1.5rem;"></i>
            {% endif %}
          </div>
          <strong class="nav-link-text user-name-global" id="sidebar-user-name">{{ g.perfil.nome or g.user_email
            }}</strong>
        </div>
        <button id="sidebarToggle" class="sidebar-toggle-btn" title="Colapsar menu">
          <i class="bi bi-chevron-left"></i>
        </button>
      </div>
      <ul class="nav flex-column">
        <li class="nav-item"><a
            class="nav-link {% if request.endpoint and 'dashboard' in request.endpoint %}active{% endif %}"
            href="{{ url_for(current_dashboard) }}"><i class="bi bi-speedometer2 me-2"></i><span class="nav-link-text">
              Dashboard</span></a></li>
        {% if implantacao and implantacao.id %}
        {% set ver_impl_blueprint = (request.blueprint if request.blueprint in ['onboarding', 'grandes_contas',
        'ongoing'] else (implantacao.contexto if (implantacao and implantacao.contexto) else 'onboarding')) %}
        <li class="nav-item"><a
            class="nav-link {% if '.ver_implantacao' in (request.endpoint or '') %}active{% endif %}"
            href="{{ url_for(ver_impl_blueprint + '.ver_implantacao', impl_id=implantacao.id) }}"><i
              class="bi bi-kanban me-2"></i><span class="nav-link-text"> Detalhes da Implantação</span></a></li>
        {% endif %}
        <li class="nav-item"><a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#modalPerfil"><i
              class="bi bi-person-circle me-2"></i><span class="nav-link-text"> Perfil</span></a></li>

        {# Acesso restrito: Coordenador, Gerente e Administrador #}
        {% if g.perfil and g.perfil.perfil_acesso in g.PERFIS_COM_GESTAO %}
        <li class="nav-item nav-item-divider">
          <hr>
        </li>

        <li class="nav-item"><a
            class="nav-link {% if request.endpoint and request.endpoint.startswith('planos.') %}active{% endif %}"
            href="{{ url_for('planos.listar_planos', context=current_context) }}"><i
              class="bi bi-diagram-3 me-2"></i><span class="nav-link-text"> Planos de Sucesso</span></a></li>

        <li class="nav-item"><a class="nav-link" href="#" data-bs-toggle="modal"
            data-bs-target="#modalGerenciarUsuarios"><i class="bi bi-people-fill me-2"></i><span class="nav-link-text">
              Usuários</span></a></li>
        <li class="nav-item"><a
            class="nav-link {% if request.endpoint and request.endpoint.startswith('perfis.') %}active{% endif %}"
            href="{{ url_for('perfis.listar_perfis') }}"><i class="bi bi-shield-lock me-2"></i><span
              class="nav-link-text"> Perfis de Acesso</span></a></li>
        <li class="nav-item"><a
            class="nav-link {% if request.endpoint == 'analytics.analytics_dashboard' %}active{% endif %}"
            href="{{ url_for('analytics.analytics_dashboard', context=current_context) }}"><i
              class="bi bi-graph-up me-2"></i><span class="nav-link-text"> Gerencial</span></a></li>
        <!-- <li class="nav-item"><a
          class="nav-link {% if request.endpoint == 'analytics.cancelamentos_dashboard' %}active{% endif %}"
          href="{{ url_for('analytics.cancelamentos_dashboard') }}"><i class="bi bi-x-circle me-2"></i><span class="nav-link-text"> Cancelamentos</span></a></li> -->
        <!-- TEMPORARIAMENTE DESATIVADO - EM MELHORIA -->
        <!-- <li class="nav-item nav-item-divider">
          <hr>
        </li>
        <li class="nav-item"><span class="nav-link disabled nav-link-text">Gamificação</span></li>
        <li class="nav-item"><a
            class="nav-link {% if request.endpoint == 'gamification.manage_gamification_metrics' %}active{% endif %}"
            href="{{ url_for('gamification.manage_gamification_metrics') }}"><i
              class="bi bi-pencil-square me-2"></i><span class="nav-link-text"> Métricas</span></a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#modalGamificacao"><i
              class="bi bi-list-check me-2"></i><span class="nav-link-text"> Critérios da Gamificação</span></a></li>
        <li class="nav-item"><a
            class="nav-link {% if request.endpoint == 'gamification.gamification_report' %}active{% endif %}"
            href="{{ url_for('gamification.gamification_report') }}"><i class="bi bi-clipboard-data me-2"></i><span
              class="nav-link-text"> Relatório</span></a></li> -->
        {% endif %}
        <li class="nav-item nav-item-divider">
          <hr>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" id="themeToggle">
            <i class="bi bi-moon-stars me-2" id="themeIcon"></i>
            <span class="nav-link-text" id="themeText">Tema Escuro</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('core.modules_selection') }}">
            <i class="bi bi-grid-3x3-gap me-2"></i>
            <span class="nav-link-text">Trocar Módulo</span>
          </a>
        </li>
        <li class="nav-item"><a class="nav-link text-danger" href="{{ url_for('auth.logout') }}"><i
              class="bi bi-box-arrow-left me-2"></i><span class="nav-link-text"> Sair</span></a></li>
      </ul>
    </nav>
    {% endblock %}

    <!-- Conteúdo principal -->
    <div class="main-content">
      {% block content %}
      <div class="container py-4">
        <div class="card">
          <div class="card-body">
            <h1 class="main-title mb-2">Conteúdo Padrão</h1>
            <p class="text-muted text-center mb-0">Substitua no template filho.</p>
          </div>
        </div>
      </div>
      {% endblock %}
    </div>
  </div>

  {% include 'modals/_detalhes_empresa.html' %}
  {% include 'modals/_gamificacao_regras.html' %}
  {% include 'modals/_gerenciar_usuarios.html' %}
  {% include 'modals/_perfil.html' %}

  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;" id="toastContainer">
    <!-- Toasts serão inseridos aqui dinamicamente -->
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
  <script src="https://unpkg.com/imask"></script>
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

  <!-- ========================================
       MODULAR ARCHITECTURE (SOLID Principles)
       ======================================== -->

  <!-- Utils Layer -->
  <script src="{{ url_for('static', filename='js/utils/date-utils.js') }}"></script>
  <script src="{{ url_for('static', filename='js/utils/phone-utils.js') }}"></script>
  <script src="{{ url_for('static', filename='js/utils/html-utils.js') }}"></script>
  <script src="{{ url_for('static', filename='js/utils/fetch_retry.js') }}"></script>

  <!-- UI Layer -->
  <script src="{{ url_for('static', filename='js/ui/toast.js') }}"></script>
  <script src="{{ url_for('static', filename='js/ui/confirm-dialog.js') }}"></script>
  <script src="{{ url_for('static', filename='js/ui/loading.js') }}"></script>
  <script src="{{ url_for('static', filename='js/ui/nprogress.js') }}"></script>
  <script src="{{ url_for('static', filename='js/ui/sidebar.js') }}"></script>

  <!-- Core (Legacy - will be refactored) -->
  <script src="{{ url_for('static', filename='js/common.js') }}"></script>

  <!-- Services & Utilities -->
  <script src="{{ url_for('static', filename='js/utils/bug_prevention_service.js') }}"></script>
  <script src="{{ url_for('static', filename='js/utils/table_sort.js') }}"></script>

  <!-- Components -->
  <script src="{{ url_for('static', filename='js/components/modal_detalhes_empresa.js') }}"></script>
  <script src="{{ url_for('static', filename='js/components/notifications.js') }}"></script>

  {% block scripts_extra %}{% endblock %}

  <!-- Converte flash messages para toasts flutuantes automaticamente -->
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const flashMessages = {{ messages | tojson | safe
    }};
    flashMessages.forEach(function (msg) {
      const category = msg[0];
      const message = msg[1];
      // Mapeia categorias do Flask para tipos de toast
      const typeMap = {
        'success': 'success',
        'error': 'error',
        'danger': 'error',
        'warning': 'warning',
        'info': 'info',
        'primary': 'primary'
      };
      const toastType = typeMap[category] || 'info';
      if (window.showToast) {
        window.showToast(message, toastType, 6000);
      }
    });
    });
  </script>
  {% endif %}
  {% endwith %}
</body>

</html>