{% extends "base.html" %}

{% block title %}Detalhes da Implantação - {{ implantacao.nome_empresa }}{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/implantacao_detalhes.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid p-4 content-wrapper" id="main-content" data-implantacao-id="{{ implantacao.id }}"
    data-email-usuario-logado="{{ email_usuario_logado }}"
    data-email-responsavel="{{ implantacao.email_responsavel or '' }}"
    data-is-manager="{{ 'true' if g.perfil and g.perfil.get('perfil_acesso') in ['Administrador', 'Gerente', 'Coordenador'] else 'false' }}">

    <header class="header-bg p-3 d-flex align-items-center position-relative rounded-3 mb-4">
        <h1 class="main-title mb-0 fs-4 w-100 text-center">CS ONBOARDING Detalhes da Implantação</h1>
        <div class="d-flex align-items-center position-absolute end-0 top-50 translate-middle-y">
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-house me-1"></i> Dashboard
            </a>
        </div>
    </header>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show mb-3 shadow-sm" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}


    <div class="row g-3">
        <!-- Sidebar (Coluna Esquerda) -->
        <div class="sidebar-column">

            <!-- Card Plano de Sucesso (Lógica Importante) -->
            {% if plano_sucesso %}
            <div class="custom-card border-primary border-top border-4">
                <div class="custom-card-header">
                    <h5 class="custom-card-title"><i class="bi bi-diagram-3-fill me-2 text-primary"></i>Plano Atual</h5>
                    <div class="d-flex gap-1">
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
                            data-bs-target="#modalSelecionarPlano">Alterar</button>
                        <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
                            data-bs-target="#modalRemoverPlano" title="Remover plano da implantação">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="custom-card-body">
                    <h5 class="fw-bold mb-1">{{ plano_sucesso.nome }}</h5>
                    <p class="text-muted small mb-3">{{ plano_sucesso.descricao }}</p>

                    <!-- Info de datas da implantação -->
                    <div class="plano-datas-info">
                        <div class="data-item">
                            <span class="data-label"><i class="bi bi-calendar-event me-1"></i>Início</span>
                            <span class="data-value">{{ implantacao.data_inicio_efetivo_fmt_d or
                                implantacao.data_criacao_fmt_d or 'Não definido' }}</span>
                        </div>
                        {% if plano_sucesso.dias_duracao %}
                        <div class="data-item">
                            <span class="data-label"><i class="bi bi-hourglass-split me-1"></i>Duração</span>
                            <span class="data-value">{{ plano_sucesso.dias_duracao }} dias</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label"><i class="bi bi-calendar-check me-1"></i>Previsão Término</span>
                            <span class="data-value destaque">{{ implantacao.data_previsao_termino_fmt_d or
                                'Calculando...' }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="custom-card cta-card mb-4">
                <div class="custom-card-body text-center">
                    <div class="mb-3 text-danger">
                        <i class="bi bi-exclamation-circle-fill" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="cta-title mb-2">Nenhum Plano Definido</h5>
                    <p class="text-muted small mb-3">Esta implantação ainda não possui um plano de sucesso vinculado.
                        Selecione um para gerar as tarefas.</p>
                    <button class="btn btn-danger w-100 fw-bold shadow-sm" data-bs-toggle="modal"
                        data-bs-target="#modalSelecionarPlano">
                        <i class="bi bi-plus-circle me-2"></i>Selecionar Plano Agora
                    </button>
                </div>
            </div>
            {% endif %}

            <!-- Card Ações Rápidas -->
            <div class="custom-card">
                <div class="custom-card-header">
                    <h5 class="custom-card-title">Ações Rápidas</h5>
                </div>
                <div class="list-group list-group-flush">
                    <!-- Removido: Adicionar Tarefa -->
                    <button class="list-group-item list-group-item-action py-3 d-flex align-items-center gap-3"
                        data-bs-toggle="modal" data-bs-target="#modalDetalhesEmpresa" data-id="{{ implantacao.id }}"
                        data-id-favorecido="{{ implantacao.id_favorecido | default('') }}"
                        data-cargo="{{ implantacao.cargo_responsavel | default('') }}"
                        data-nivel-receita="{{ implantacao.nivel_receita | default('') }}"
                        data-seguimento="{{ implantacao.seguimento | default('') }}"
                        data-tipos-planos="{{ implantacao.tipos_planos | default('') }}"
                        data-sistema-anterior="{{ implantacao.sistema_anterior | default('') }}"
                        data-recorrencia-usa="{{ implantacao.recorrencia_usa | default('') }}"
                        data-catraca="{{ implantacao.catraca | default('') }}"
                        data-facial="{{ implantacao.facial | default('') }}"
                        data-modelo-catraca="{{ implantacao.modelo_catraca | default('') }}"
                        data-modelo-facial="{{ implantacao.modelo_facial | default('') }}"
                        data-wellhub="{{ implantacao.wellhub | default('') }}"
                        data-totalpass="{{ implantacao.totalpass | default('') }}">
                        <div class="bg-light p-2 rounded text-info"><i class="bi bi-pencil-square"></i></div>
                        <div>
                            <h6 class="mb-0 fw-bold">Editar Detalhes</h6>
                        </div>
                    </button>

                    {% if implantacao.status == 'andamento' %}
                    <button class="list-group-item list-group-item-action py-3 d-flex align-items-center gap-3"
                        data-bs-toggle="modal" data-bs-target="#modalFinalizar">
                        <div class="bg-success bg-opacity-10 p-2 rounded text-success"><i class="bi bi-check-lg"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold text-dark">Finalizar Implantação</h6>
                        </div>
                    </button>
                    <button class="list-group-item list-group-item-action py-3 d-flex align-items-center gap-3"
                        data-bs-toggle="modal" data-bs-target="#modalParar">
                        <div class="bg-warning bg-opacity-10 p-2 rounded text-warning"><i class="bi bi-pause-fill"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold text-dark">Parar Implantação</h6>
                        </div>
                    </button>
                    {% elif implantacao.status == 'parada' %}
                    <button class="list-group-item list-group-item-action py-3 d-flex align-items-center gap-3"
                        data-bs-toggle="modal" data-bs-target="#modalRetomar">
                        <div class="bg-primary bg-opacity-10 p-2 rounded text-primary"><i class="bi bi-play-fill"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold text-dark">Retomar Implantação</h6>
                        </div>
                    </button>
                    {% endif %}

                    <button class="list-group-item list-group-item-action py-3 d-flex align-items-center gap-3"
                        data-bs-toggle="modal" data-bs-target="#modalTransferir">
                        <div class="bg-info bg-opacity-10 p-2 rounded text-info"><i class="bi bi-arrow-left-right"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold text-dark">Transferir Implantação</h6>
                        </div>
                    </button>

                    {% if implantacao.status != 'cancelada' %}
                    <button class="list-group-item list-group-item-action py-3 d-flex align-items-center gap-3"
                        data-bs-toggle="modal" data-bs-target="#modalCancelar">
                        <div class="bg-warning bg-opacity-10 p-2 rounded text-warning"><i class="bi bi-x-circle"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold text-dark">Cancelar Implantação</h6>
                        </div>
                    </button>
                    {% endif %}

                    <button class="list-group-item list-group-item-action py-3 d-flex align-items-center gap-3"
                        data-bs-toggle="modal" data-bs-target="#modalExcluirImplantacao">
                        <div class="bg-danger bg-opacity-10 p-2 rounded text-danger"><i class="bi bi-trash"></i></div>
                        <div>
                            <h6 class="mb-0 fw-bold text-dark">Excluir Implantação</h6>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Card Resumo da Empresa -->
            <div class="custom-card mt-3">
                <div class="custom-card-header">
                    <h5 class="custom-card-title"><i class="bi bi-building me-2 text-primary"></i>Resumo da Empresa</h5>
                </div>
                <div class="custom-card-body">
                    <!-- Informações Principais -->
                    <div class="company-summary">
                        <!-- Nome da Empresa -->
                        <div class="summary-item mb-3">
                            <div class="d-flex align-items-center mb-1">
                                <i class="bi bi-briefcase-fill text-primary me-2"></i>
                                <span class="summary-label fw-bold">Empresa</span>
                            </div>
                            <div class="summary-value ps-4">{{ implantacao.nome_empresa }}</div>
                        </div>

                        <!-- Status da Implantação -->
                        <div class="summary-item mb-3">
                            <div class="d-flex align-items-center mb-1">
                                <i class="bi bi-flag-fill text-primary me-2"></i>
                                <span class="summary-label fw-bold">Status</span>
                            </div>
                            <div class="summary-value ps-4">
                                {% if implantacao.status == 'nova' %}
                                <span class="badge bg-secondary">Nova</span>
                                {% elif implantacao.status == 'futura' %}
                                <span class="badge bg-info">Futura</span>
                                {% elif implantacao.status == 'andamento' %}
                                <span class="badge bg-primary">Em Andamento</span>
                                {% elif implantacao.status == 'parada' %}
                                <span class="badge bg-warning">Parada</span>
                                {% elif implantacao.status == 'finalizada' %}
                                <span class="badge bg-success">Finalizada</span>
                                {% elif implantacao.status == 'cancelada' %}
                                <span class="badge bg-danger">Cancelada</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ implantacao.status|title }}</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Data de Início -->
                        <div class="summary-item mb-3">
                            <div class="d-flex align-items-center mb-1">
                                <i class="bi bi-calendar-event text-primary me-2"></i>
                                <span class="summary-label fw-bold">Data de Início</span>
                            </div>
                            <div class="summary-value ps-4">
                                {% if implantacao.data_inicio_efetivo_fmt_d %}
                                {{ implantacao.data_inicio_efetivo_fmt_d }}
                                <span class="text-muted small">(Efetivo)</span>
                                {% elif implantacao.data_inicio_previsto_fmt_d %}
                                {{ implantacao.data_inicio_previsto_fmt_d }}
                                <span class="text-muted small">(Previsto)</span>
                                {% elif implantacao.data_criacao_fmt_d %}
                                {{ implantacao.data_criacao_fmt_d }}
                                <span class="text-muted small">(Criação)</span>
                                {% else %}
                                <span class="text-muted">Não definida</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- ID Favorecido -->
                        {% if implantacao.id_favorecido %}
                        <div class="summary-item mb-3">
                            <div class="d-flex align-items-center mb-1">
                                <i class="bi bi-hash text-primary me-2"></i>
                                <span class="summary-label fw-bold">ID Favorecido</span>
                            </div>
                            <div class="summary-value ps-4">{{ implantacao.id_favorecido }}</div>
                        </div>
                        {% endif %}

                        <!-- Responsável -->
                        {% if implantacao.responsavel_cliente %}
                        <div class="summary-item mb-3">
                            <div class="d-flex align-items-center mb-1">
                                <i class="bi bi-person-fill text-primary me-2"></i>
                                <span class="summary-label fw-bold">Responsável</span>
                            </div>
                            <div class="summary-value ps-4">
                                {{ implantacao.responsavel_cliente }}
                                {% if implantacao.cargo_responsavel %}
                                <span class="text-muted small">- {{ implantacao.cargo_responsavel }}</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Contato -->
                        {% if implantacao.email_responsavel or implantacao.telefone_responsavel %}
                        <div class="summary-item mb-3">
                            <div class="d-flex align-items-center mb-1">
                                <i class="bi bi-envelope-fill text-primary me-2"></i>
                                <span class="summary-label fw-bold">Contato</span>
                            </div>
                            <div class="summary-value ps-4">
                                {% if implantacao.email_responsavel %}
                                <div><a href="mailto:{{ implantacao.email_responsavel }}"
                                        class="text-decoration-none">{{ implantacao.email_responsavel }}</a></div>
                                {% endif %}
                                {% if implantacao.telefone_responsavel %}
                                <div class="text-muted small">{{ implantacao.telefone_responsavel }}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Seguimento -->
                        {% if implantacao.seguimento %}
                        <div class="summary-item mb-3">
                            <div class="d-flex align-items-center mb-1">
                                <i class="bi bi-tag-fill text-primary me-2"></i>
                                <span class="summary-label fw-bold">Seguimento</span>
                            </div>
                            <div class="summary-value ps-4">
                                {% set seguimentos = implantacao.seguimento.split(',') if implantacao.seguimento else []
                                %}
                                {% for seg in seguimentos %}
                                <span class="badge bg-primary bg-opacity-10 text-primary me-1 mb-1">{{ seg.strip()
                                    }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Modalidades -->
                        {% if implantacao.modalidades %}
                        <div class="summary-item mb-3">
                            <div class="d-flex align-items-center mb-1">
                                <i class="bi bi-activity text-primary me-2"></i>
                                <span class="summary-label fw-bold">Modalidades</span>
                            </div>
                            <div class="summary-value ps-4">
                                {% set mods = implantacao.modalidades.split(',') if implantacao.modalidades else [] %}
                                {% for mod in mods %}
                                <span class="badge bg-info bg-opacity-10 text-info me-1 mb-1">{{ mod.strip() }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Alunos Ativos -->
                        {% if implantacao.alunos_ativos %}
                        <div class="summary-item mb-3">
                            <div class="d-flex align-items-center mb-1">
                                <i class="bi bi-people-fill text-primary me-2"></i>
                                <span class="summary-label fw-bold">Alunos Ativos</span>
                            </div>
                            <div class="summary-value ps-4">{{ implantacao.alunos_ativos }}</div>
                        </div>
                        {% endif %}

                        <!-- Sistema Anterior -->
                        {% if implantacao.sistema_anterior %}
                        <div class="summary-item mb-3">
                            <div class="d-flex align-items-center mb-1">
                                <i class="bi bi-arrow-left-right text-primary me-2"></i>
                                <span class="summary-label fw-bold">Sistema Anterior</span>
                            </div>
                            <div class="summary-value ps-4">{{ implantacao.sistema_anterior }}</div>
                        </div>
                        {% endif %}

                        <!-- Integrações -->
                        {% set integracoes = [] %}
                        {% if implantacao.wellhub == 'Sim' %}{% set _ = integracoes.append('Wellhub') %}{% endif %}
                        {% if implantacao.totalpass == 'Sim' %}{% set _ = integracoes.append('TotalPass') %}{% endif %}
                        {% if implantacao.catraca == 'Sim' %}{% set _ = integracoes.append('Catraca') %}{% endif %}
                        {% if implantacao.facial == 'Sim' %}{% set _ = integracoes.append('Facial') %}{% endif %}

                        {% if integracoes %}
                        <div class="summary-item">
                            <div class="d-flex align-items-center mb-1">
                                <i class="bi bi-plugin text-primary me-2"></i>
                                <span class="summary-label fw-bold">Integrações</span>
                            </div>
                            <div class="summary-value ps-4">
                                {% for integ in integracoes %}
                                <span class="badge bg-success bg-opacity-10 text-success me-1 mb-1">{{ integ }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Card Detalhes da Empresa (Resumo) -->
        </div>

        <!-- Coluna Principal (Conteúdo) -->
        <div class="main-column">

            <!-- Card Unificado: Plano de Sucesso + Linha do Tempo -->
            <div class="custom-card" style="min-height: 400px;">
                <div class="custom-card-header flex-column align-items-stretch gap-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="custom-card-title mb-0">
                            <i class="bi bi-clipboard-data me-2 text-primary"></i>Acompanhamento
                        </h5>
                    </div>

                    <!-- Tabs de navegação -->
                    <ul class="nav tab-switcher" id="contentTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="plano-tab" data-bs-toggle="tab"
                                data-bs-target="#plano-content" type="button" role="tab">
                                <i class="bi bi-diagram-3 me-1"></i>Plano de Sucesso
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="timeline-tab" data-bs-toggle="tab"
                                data-bs-target="#timeline-content" type="button" role="tab">
                                <i class="bi bi-clock-history me-1"></i>Linha do Tempo
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="comments-tab" data-bs-toggle="tab"
                                data-bs-target="#comments-content" type="button" role="tab">
                                <i class="bi bi-chat-square-text me-1"></i>Comentários
                            </button>
                        </li>
                    </ul>
                </div>

                <div class="tab-content">
                    <style>
                        .custom-card .tab-content>.tab-pane:not(.active) {
                            display: none !important;
                        }

                        .custom-card .tab-content>.tab-pane.active {
                            display: block !important;
                        }
                    </style>
                    <!-- Tab: Plano de Sucesso -->
                    <div class="tab-pane fade show active" id="plano-content" role="tabpanel">
                        <div class="custom-card-body plano-sucesso-container" id="plano-hierarquia">
                            {% if checklist_tree and checklist_tree|length > 0 %}
                            <!-- Novo Checklist Hierárquico -->
                            <div id="checklist-container" data-implantacao-id="{{ implantacao.id }}"
                                data-previsao-termino="{{ implantacao.data_previsao_termino or '' }}">
                                <!-- Progresso Global -->
                                <div class="checklist-global-progress mb-4">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-muted small">Progresso Global do Onboarding</span>
                                        <span id="checklist-global-progress-percent"
                                            class="fw-bold text-primary">0%</span>
                                    </div>
                                    <div class="progress-thick">
                                        <div id="checklist-global-progress-bar" class="progress-bar" role="progressbar"
                                            style="width: 0%; transition: width 0.25s ease-in-out;" aria-valuenow="0"
                                            aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>

                                <!-- Checklist Tree será renderizado via JavaScript -->
                                <div class="checklist-grid px-2 py-1 text-muted small"
                                    style="border-bottom: 1px solid rgba(0,0,0,0.06);">
                                    <span class="col-empty"></span>
                                    <span class="col-checkbox"></span>
                                    <span class="col-title">Tarefa</span>
                                    <span class="col-spacer"></span>
                                    <span class="col-tag">Tag</span>
                                    <span class="col-qtd" style="text-align:center">QTD</span>
                                    <span class="col-responsavel">Responsável</span>
                                    <span class="col-prev-orig">Prev. orig</span>
                                    <span class="col-prev-atual">Nova previsão</span>
                                    <span class="col-conclusao d-none">Data de conclusão</span>
                                    <span class="col-status">Status</span>
                                    <span class="col-comment"></span>
                                    <span class="col-delete"></span>
                                </div>
                                <div id="checklist-tree-root"></div>
                            </div>
                            {% elif false %}
                            <!-- Modelo Antigo (Compatibilidade) -->
                            {% for fase in hierarquia.fases %}
                            <div class="fase-card" data-fase-id="{{ fase.id }}">
                                <div class="fase-header" data-bs-toggle="collapse" data-bs-target="#fase-{{ fase.id }}"
                                    aria-expanded="false">
                                    <h6 class="fase-title">
                                        <i class="bi bi-layers-fill"></i>
                                        {{ fase.nome }}
                                        {% if fase.responsavel %}
                                        <span class="badge bg-light text-dark ms-2"
                                            style="font-size: 0.65rem; font-weight: 500;">
                                            <i class="bi bi-person-fill me-1"></i>{{ fase.responsavel }}
                                        </span>
                                        {% endif %}
                                    </h6>
                                    <div class="d-flex align-items-center gap-3">
                                        <span class="fase-progress">
                                            <span class="fase-progresso-valor" data-fase-id="{{ fase.id }}">0</span>%
                                        </span>
                                    </div>
                                </div>
                                <div class="collapse" id="fase-{{ fase.id }}">
                                    <div class="fase-content">
                                        {% if fase.grupos %}
                                        {% for grupo in fase.grupos %}
                                        <div class="grupo-card" data-grupo-id="{{ grupo.id }}">
                                            <div class="grupo-header" data-bs-toggle="collapse"
                                                data-bs-target="#grupo-{{ grupo.id }}" aria-expanded="false">
                                                <h6 class="grupo-title">
                                                    <i class="bi bi-folder2 me-2"></i>{{ grupo.nome }}
                                                    {% if grupo.responsavel %}
                                                    <span class="badge bg-secondary bg-opacity-25 text-dark ms-2"
                                                        style="font-size: 0.6rem; font-weight: 500;">
                                                        <i class="bi bi-person me-1"></i>{{ grupo.responsavel }}
                                                    </span>
                                                    {% endif %}
                                                </h6>
                                                <div class="d-flex align-items-center gap-2">
                                                    <span class="grupo-count">
                                                        <span class="grupo-concluidas"
                                                            data-grupo-id="{{ grupo.id }}">0</span>/{{
                                                        grupo.tarefas|length }} tarefas
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="collapse" id="grupo-{{ grupo.id }}">
                                                <div class="grupo-content">
                                                    {% if grupo.tarefas %}
                                                    {% for tarefa in grupo.tarefas %}
                                                    {% set status_raw = tarefa.status or 'pendente' %}
                                                    {% set status_lower = status_raw|lower %}
                                                    {% if status_lower == 'concluida' %}
                                                    {% set status_tarefa = 'concluida' %}
                                                    {% set is_concluida = True %}
                                                    {% elif status_lower == 'concluido' %}
                                                    {% set status_tarefa = 'concluida' %}
                                                    {% set is_concluida = True %}
                                                    {% else %}
                                                    {% set status_tarefa = 'pendente' %}
                                                    {% set is_concluida = False %}
                                                    {% endif %}
                                                    <div class="tarefa-item {% if is_concluida %}concluida{% endif %}"
                                                        data-tarefa-id="{{ tarefa.id }}"
                                                        data-tarefa-status="{{ status_tarefa }}">
                                                        <div class="tarefa-header">
                                                            <input type="checkbox" class="tarefa-checkbox"
                                                                id="tarefa-{{ tarefa.id }}"
                                                                data-tarefa-id="{{ tarefa.id }}" {% if is_concluida
                                                                %}checked{% endif %}>
                                                            <label class="tarefa-nome" for="tarefa-{{ tarefa.id }}">
                                                                {{ tarefa.nome }}
                                                            </label>
                                                            <div class="tarefa-actions">
                                                                <button type="button"
                                                                    class="btn-icon btn-toggle-comentarios"
                                                                    data-tarefa-id="{{ tarefa.id }}"
                                                                    title="Comentários">
                                                                    <i class="bi bi-chat-left-text"></i>
                                                                </button>
                                                                <button type="button"
                                                                    class="btn-icon btn-excluir-tarefa"
                                                                    data-tarefa-id="{{ tarefa.id }}"
                                                                    data-delete-url="/api/checklist/delete/{{ tarefa.id }}"
                                                                    title="Excluir tarefa">
                                                                    <i class="bi bi-trash text-danger"></i>
                                                                </button>
                                                            </div>
                                                        </div>


                                                        <!-- Comentários da Tarefa -->
                                                        <div class="comentarios-section collapse"
                                                            id="comentarios-tarefa-{{ tarefa.id }}">
                                                            <div class="comentario-form">
                                                                <textarea class="form-control mb-2"
                                                                    placeholder="Escreva um comentário..." rows="2"
                                                                    id="comentario-texto-{{ tarefa.id }}"></textarea>
                                                                <div class="alert alert-warning alert-sm d-none mb-2 py-2"
                                                                    id="alerta-email-{{ tarefa.id }}" role="alert">
                                                                    <i class="bi bi-exclamation-triangle-fill me-1"></i>
                                                                    <small>Email do responsável não cadastrado. <a
                                                                            href="#" class="alert-link"
                                                                            data-bs-toggle="modal"
                                                                            data-bs-target="#modalDetalhesEmpresa">Acesse
                                                                            "Editar Detalhes"</a> para adicionar o email
                                                                        antes de enviar comentários externos.</small>
                                                                </div>
                                                                <div
                                                                    class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                                                    <div class="d-flex gap-2 align-items-center">
                                                                        <span class="comentario-tipo-tag interno active"
                                                                            data-tipo="interno"
                                                                            data-tarefa-id="{{ tarefa.id }}">
                                                                            <i class="bi bi-lock-fill"></i> Interno
                                                                        </span>
                                                                        <span class="comentario-tipo-tag externo"
                                                                            data-tipo="externo"
                                                                            data-tarefa-id="{{ tarefa.id }}">
                                                                            <i class="bi bi-globe"></i> Externo
                                                                        </span>
                                                                        <span class="comentario-tipo-tag noshow"
                                                                            data-tarefa-id="{{ tarefa.id }}"
                                                                            data-noshow="false">
                                                                            <i class="bi bi-calendar-x"></i> No show
                                                                        </span>
                                                                        <label
                                                                            class="btn btn-sm btn-outline-secondary mb-0">
                                                                            <i class="bi bi-image"></i>
                                                                            <input type="file"
                                                                                class="d-none comentario-imagem-input"
                                                                                accept="image/*"
                                                                                data-tarefa-id="{{ tarefa.id }}">
                                                                        </label>
                                                                    </div>
                                                                    <div class="d-flex gap-2">
                                                                        <button type="button"
                                                                            class="btn btn-sm btn-primary btn-salvar-comentario"
                                                                            data-tarefa-id="{{ tarefa.id }}"
                                                                            data-tipo="tarefa">
                                                                            <i class="bi bi-send me-1"></i>Salvar
                                                                        </button>
                                                                        <button type="button"
                                                                            class="btn btn-sm btn-primary btn-enviar-email d-none"
                                                                            data-tarefa-id="{{ tarefa.id }}"
                                                                            id="btn-email-{{ tarefa.id }}">
                                                                            <i class="bi bi-envelope me-1"></i>Enviar
                                                                            Email
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="comentario-historico"
                                                                id="historico-tarefa-{{ tarefa.id }}">
                                                                <!-- Comentários carregados via JS -->
                                                                <div class="text-center text-muted small py-2">
                                                                    <i class="bi bi-chat-left-text"></i> Nenhum
                                                                    comentário ainda
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                    {% else %}
                                                    <div class="empty-state py-3">
                                                        <i class="bi bi-inbox"></i>
                                                        <p class="mb-0 small">Nenhuma tarefa neste grupo</p>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                        {% else %}
                                        <div class="empty-state py-3">
                                            <i class="bi bi-folder2-open"></i>
                                            <p class="mb-0 small">Nenhum grupo nesta fase</p>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            {% else %}
                            <div class="empty-state">
                                <i class="bi bi-diagram-3"></i>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Tab: Linha do Tempo -->
                    <div class="tab-pane fade d-none" id="timeline-content" role="tabpanel"
                        data-impl-id="{{ implantacao.id }}">
                        <div class="custom-card-body" style="max-height: calc(100vh - 350px); overflow-y: auto;">
                            <ul class="timeline-list" id="timeline-list">
                                {% if not logs_timeline %}
                                <li class="alert alert-light text-center small py-2">Nenhum evento registrado.</li>
                                {% endif %}
                                {% for log in logs_timeline %}
                                <li class="timeline-item">
                                    <div class="timeline-icon">
                                        {% if log.tipo_evento == 'novo_comentario' %} <i
                                            class="bi bi-chat-left-text-fill"></i>
                                        {% elif 'tarefa' in log.tipo_evento %} <i class="bi bi-check-circle-fill"></i>
                                        {% elif 'status' in log.tipo_evento %} <i class="bi bi-flag-fill"></i>
                                        {% else %} <i class="bi bi-info-circle-fill"></i>
                                        {% endif %}
                                    </div>
                                    <div class="timeline-content shadow-sm">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="fw-bold text-primary">{{ log.usuario_nome }}</span>
                                            <span class="small text-muted">{{ log.data_criacao_fmt_dt_hr }}</span>
                                        </div>
                                        <p class="mb-0 text-secondary">{{ log.detalhes | safe | replace('\n', '<br>') }}
                                        </p>
                                        <div class="mt-2 d-flex gap-2">
                                            {% if log.tipo_evento == 'novo_comentario' and log.related_item_id %}
                                            <button class="btn btn-sm btn-outline-primary timeline-action-comments"
                                                data-item-id="{{ log.related_item_id }}">
                                                Ver comentários
                                            </button>
                                            {% endif %}

                                        </div>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <!-- Tab: Comentários -->
                    <div class="tab-pane fade d-none" id="comments-content" role="tabpanel">
                        <div class="custom-card-body">
                            <div id="comments-list-container" class="d-flex flex-column gap-3"
                                style="max-height: calc(100vh - 350px); overflow-y: auto;">
                                <!-- Comments will be loaded here -->
                                <div class="text-center py-5 text-muted" id="comments-loading">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Carregando...</span>
                                    </div>
                                    <p class="mt-2 small">Carregando comentários...</p>
                                </div>
                                <div class="text-center py-5 text-muted d-none" id="comments-empty">
                                    <i class="bi bi-chat-square text-secondary fs-1"></i>
                                    <p class="mt-2">Nenhum comentário encontrado nesta implantação.</p>
                                </div>
                            </div>
                            <div class="text-center mt-3 d-none" id="comments-pagination">
                                <button class="btn btn-sm btn-outline-primary" id="btn-load-more-comments">
                                    Carregar mais
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Offcanvas Mobile Sidebar (Menu de Ações) -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="mobileSidebar">
    <div class="offcanvas-header bg-light">
        <h5 class="offcanvas-title">Menu de Ações</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        <div class="d-grid gap-2">
            <button class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#modalDetalhesEmpresa"
                data-id="{{ implantacao.id }}" data-id-favorecido="{{ implantacao.id_favorecido | default('') }}"
                data-cargo="{{ implantacao.cargo_responsavel | default('') }}"
                data-nivel-receita="{{ implantacao.nivel_receita | default('') }}"
                data-seguimento="{{ implantacao.seguimento | default('') }}"
                data-tipos-planos="{{ implantacao.tipos_planos | default('') }}"
                data-sistema-anterior="{{ implantacao.sistema_anterior | default('') }}"
                data-recorrencia-usa="{{ implantacao.recorrencia_usa | default('') }}"
                data-catraca="{{ implantacao.catraca | default('') }}"
                data-facial="{{ implantacao.facial | default('') }}"
                data-modelo-catraca="{{ implantacao.modelo_catraca | default('') }}"
                data-modelo-facial="{{ implantacao.modelo_facial | default('') }}"
                data-wellhub="{{ implantacao.wellhub | default('') }}"
                data-totalpass="{{ implantacao.totalpass | default('') }}">
                Editar Detalhes
            </button>
            <!-- Mais botões mobile aqui se necessário -->
        </div>
    </div>
</div>

<!-- Modais Originais (Preservados para manter funcionalidade) -->
<!-- Modal Detalhes Empresa -->
<!-- Modal Remover Plano -->
<div class="modal fade" id="modalRemoverPlano" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Remover Plano</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('actions.remover_plano_implantacao') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                <div class="modal-body">
                    <p>Tem certeza que deseja remover o plano <strong>{{ plano_sucesso.nome if plano_sucesso else ''
                            }}</strong> desta implantação?</p>
                    <p class="text-danger small mb-0">
                        <i class="bi bi-info-circle me-1"></i>
                        Esta ação irá remover todas as fases, ações e tarefas associadas a este plano nesta implantação.
                    </p>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Confirmar Remoção</button>
                </div>
            </form>
        </div>
    </div>
</div>



<!-- Modal Finalizar -->
<div class="modal fade" id="modalFinalizar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header-bg">
                <h5 class="modal-title">Finalizar Implantação</h5><button type="button" class="btn-close"
                    data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('actions.finalizar_implantacao') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>Para finalizar, conclua as tarefas do Plano de
                        Sucesso associado.
                    </div>
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <input type="hidden" name="redirect_to" value="detalhes">
                    <div class="mb-3">
                        <label for="data_finalizacao" class="form-label fw-bold">Data da Finalização *</label>
                        <div class="input-group">
                            <input type="text" class="form-control custom-datepicker date-mask no-datepicker"
                                id="data_finalizacao" name="data_finalizacao" required placeholder="DD/MM/AAAA">
                            <button class="btn btn-outline-secondary" type="button" id="btn_cal_data_finalizacao"><i
                                    class="bi bi-calendar3"></i></button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Confirmar Finalização</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Parar -->
<div class="modal fade" id="modalParar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header-bg">
                <h5 class="modal-title">Parar Implantação</h5><button type="button" class="btn-close"
                    data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('actions.parar_implantacao') }}" method="POST" id="formPararImplantacao">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <div class="mb-3">
                        <label for="data_parada" class="form-label fw-bold">Data da Parada *</label>
                        <input type="text" class="form-control" id="data_parada" name="data_parada" required
                            placeholder="DD/MM/AAAA">
                        <small class="text-danger d-none" id="data_parada_error">A data da parada é obrigatória.</small>
                    </div>
                    <div class="mb-3">
                        <label for="motivo_parada" class="form-label">Motivo *</label>
                        <select class="form-select" id="motivo_parada" name="motivo_parada" required>
                            <option value="">Selecione...</option>
                            {% for motivo in justificativas_parada %}
                            <option value="{{ motivo }}">{{ motivo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Parar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Retomar -->
<div class="modal fade" id="modalRetomar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header-bg">
                <h5 class="modal-title">Retomar Implantação</h5><button type="button" class="btn-close"
                    data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('actions.retomar_implantacao') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <p>Deseja retomar esta implantação e alterar o status para "Em Andamento"?</p>
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <input type="hidden" name="redirect_to" value="detalhes">
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Retomar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Reabrir -->
<div class="modal fade" id="modalReabrir" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header-bg">
                <h5 class="modal-title">Reabrir Implantação</h5><button type="button" class="btn-close"
                    data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('actions.reabrir_implantacao') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <p>A implantação voltará para o status "Em Andamento". Confirmar?</p>
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <input type="hidden" name="redirect_to" value="detalhes">
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">Reabrir</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Adicionar Tarefa - DESABILITADO: endpoint 'actions.adicionar_tarefa' não implementado
<div class="modal fade" id="adicionarTarefaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header-bg">
                <h5 class="modal-title">Adicionar Tarefa Avulsa</h5><button type="button" class="btn-close"
                    data-bs-dismiss="modal"></button>
            </div>
            <form action="#" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <div class="mb-3">
                        <label class="form-label">Nome da Tarefa</label>
                        <input type="text" class="form-control" name="tarefa_filho" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Módulo (Grupo)</label>
                        <select class="form-select" name="tarefa_pai" required>
                            <option value="">Selecione...</option>
                            {% for modulo in todos_modulos %}
                            <option value="{{ modulo }}">{{ modulo }}</option>
                            {% endfor %}
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tag</label>
                        <select class="form-select" name="tag">
                            <option value="Ação interna">Ação interna</option>
                            <option value="Reunião">Reunião</option>
                            <option value="Configuração">Configuração</option>
                            <option value="Rede">Rede</option>
                            <option value="No Show">No Show</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" disabled title="Funcionalidade não implementada">Adicionar</button>
                </div>
            </form>
        </div>
    </div>
</div>
-->

<!-- Modal Transferir -->
<div class="modal fade" id="modalTransferir" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header-bg">
                <h5 class="modal-title">Transferir CS</h5><button type="button" class="btn-close"
                    data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('actions.transferir_implantacao') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <p>Transferir <strong>{{ implantacao.nome_empresa }}</strong> de <strong>{{ implantacao.usuario_cs
                            }}</strong> para:</p>
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <div class="mb-3">
                        <label class="form-label">Novo CS</label>
                        <select class="form-select" name="novo_usuario_cs" required>
                            <option value="">Selecione...</option>
                            {% for user in all_cs_users %}
                            {% if user.usuario != implantacao.usuario_cs %}
                            <option value="{{ user.usuario }}">{{ user.nome }} ({{ user.usuario }})</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-info text-white">Confirmar Transferência</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Excluir -->
<div class="modal fade" id="modalExcluirImplantacao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header-bg">
                <h5 class="modal-title text-danger">Excluir Implantação</h5><button type="button" class="btn-close"
                    data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('actions.excluir_implantacao') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <h5 class="text-danger fw-bold"><i class="bi bi-exclamation-octagon-fill me-2"></i>Atenção!
                        Irreversível!</h5>
                    <p>Tem certeza que deseja excluir permanentemente a implantação de <strong>{{
                            implantacao.nome_empresa }}</strong>?</p>
                    <p class="text-muted small">Todos os dados, tarefas e histórico serão perdidos.</p>
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Excluir Permanentemente</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Cancelar -->
<div class="modal fade" id="modalCancelar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header-bg">
                <h5 class="modal-title text-danger">Cancelar Implantação</h5><button type="button" class="btn-close"
                    data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('actions.cancelar_implantacao') }}" method="POST" enctype="multipart/form-data"
                id="formCancelarImplantacao">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <p class="fw-bold">Deseja realmente cancelar esta implantação?</p>
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Data do Cancelamento *</label>
                        <input type="text" class="form-control" id="data_cancelamento" name="data_cancelamento" required
                            placeholder="DD/MM/AAAA">
                        <small class="text-danger d-none" id="data_cancelamento_error">A data do cancelamento é
                            obrigatória.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Motivo *</label>
                        <textarea class="form-control" name="motivo_cancelamento" rows="3" required
                            placeholder="Descreva o motivo..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Comprovante (Print/PDF) *</label>
                        <input type="file" class="form-control" name="comprovante_cancelamento"
                            accept="image/*, application/pdf" required>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Voltar</button>
                    <button type="submit" class="btn btn-danger">Confirmar Cancelamento</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Dados do checklist para renderização
    window.CHECKLIST_DATA = {{ checklist_tree | tojson if checklist_tree else '[]' }};
    window.IMPLANTACAO_ID = {{ implantacao.id }};
</script>
<script src="{{ url_for('static', filename='js/checklist_renderer.js') }}"></script>

<script src="{{ url_for('static', filename='js/implantacao_detalhes_ui.js') }}"></script>

<!-- Modal Selecionar Plano (Externo) -->
{% include 'partials/_modal_selecionar_plano.html' %}

{% endblock %}

{% block scripts_extra %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
{% endblock %}
/* cabeçalho e linhas continuam com flex; larguras são controladas pelos wrappers de coluna */