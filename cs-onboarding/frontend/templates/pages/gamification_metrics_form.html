{% extends "base.html" %}

{% block title %}Métricas Manuais{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ 'css/pages/gamification_metrics_form.css' | static_versioned }}">
{% endblock %}

{% block content %}
<div class="container-fluid p-0 mm-page">
    <header class="header-bg p-3 d-flex align-items-center position-relative rounded-3">
        <h1 class="main-title mb-0 fs-4 w-100 text-center">Métricas Manuais</h1>
        <div class="d-flex align-items-center position-absolute end-0 top-50 translate-middle-y pe-3 gap-2">
            <a href="{{ url_for(current_dashboard) }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-house me-1"></i>
                Dashboard
            </a>
            <a href="{{ url_for('gamification.gamification_report', context=current_context) }}" class="btn btn-sm btn-warning">
                <i class="bi bi-clipboard-data me-1"></i>
                Ver Relatório
            </a>
        </div>
    </header>
    <main class="p-4">

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show mt-3" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <section class="mm-filter-card">
        <form method="GET" action="{{ url_for('gamification.manage_gamification_metrics') }}" id="metrics-filter-form" class="mm-filter-grid">
            {% if current_context %}
            <input type="hidden" name="context" value="{{ current_context }}">
            {% endif %}

            <div class="mm-filter-field mm-colaborador">
                <label for="cs_email_filter">Colaborador</label>
                <select class="form-select" id="cs_email_filter" name="cs_email" required>
                    <option value="">-- Selecione um Colaborador --</option>
                    {% for cs in all_cs_users %}
                    <option value="{{ cs.usuario }}" {% if cs.usuario==current_cs_email %}selected{% endif %}>
                        {{ cs.nome }} ({{ cs.cargo or 'N/A' }})
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="mm-filter-field">
                <label for="mes_filter">Mês</label>
                <select class="form-select" id="mes_filter" name="mes" required>
                    {% for i in range(1, 13) %}
                    <option value="{{ i }}" {% if i==current_mes %}selected{% endif %}>
                        {{ ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"][i-1] }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="mm-filter-field">
                <label for="ano_filter">Ano</label>
                <select class="form-select" id="ano_filter" name="ano" required>
                    {% if current_year %}
                    {% for i in range(current_year, current_year - 5, -1) %}
                    <option value="{{ i }}" {% if i==current_ano %}selected{% endif %}>{{ i }}</option>
                    {% endfor %}
                    {% else %}
                    <option value="{{ current_ano }}" selected>{{ current_ano }}</option>
                    {% endif %}
                </select>
            </div>

            <div class="mm-filter-action">
                <button type="submit" class="btn mm-btn mm-btn-search w-100">
                    <i class="bi bi-search"></i>
                    Buscar
                </button>
            </div>
        </form>
    </section>

    {% if current_cs_email %}
    <section class="mm-launch-head">
        <div>
            <h2>Lançar Métricas</h2>
            <p>
                Colaborador:
                <span>{{ current_cs_email }}</span>
                •
                Período:
                {{ "%02d"|format(current_mes) }}/{{ current_ano }}
            </p>
        </div>
        <span class="mm-badge-active">Período Ativo</span>
    </section>

    <form action="{{ url_for('gamification.manage_gamification_metrics', cs_email=current_cs_email, mes=current_mes, ano=current_ano, context=current_context) }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <script>
            const pontosRegrasManuais = {};
        </script>

        <div class="mm-workspace">
            <div class="mm-main-column">
                <article class="mm-metric-card mm-performance">
                    <h3><i class="bi bi-award"></i> Métricas de Performance</h3>
                    <div class="mm-input-grid two-col">
                        <label for="nota_qualidade" class="visually-hidden">Nota de Qualidade (0-100)</label>
                        <input type="number" class="form-control metric-input" id="nota_qualidade" name="nota_qualidade" min="0" max="100" step="0.1" placeholder="Nota de Qualidade (0-100)" value="{{ metricas_atuais.nota_qualidade if metricas_atuais.nota_qualidade is not none }}" data-regra-id="pts_qualidade" data-score-type="performance">

                        <label for="assiduidade" class="visually-hidden">Assiduidade (0-100)</label>
                        <input type="number" class="form-control metric-input" id="assiduidade" name="assiduidade" min="0" max="100" step="0.1" placeholder="Assiduidade (0-100)" value="{{ metricas_atuais.assiduidade if metricas_atuais.assiduidade is not none }}" data-regra-id="pts_assiduidade" data-score-type="performance">

                        <label for="planos_sucesso_perc" class="visually-hidden">Planos de Sucesso (0-100)</label>
                        <input type="number" class="form-control metric-input" id="planos_sucesso_perc" name="planos_sucesso_perc" min="0" max="100" step="0.1" placeholder="Planos de Sucesso (0-100)" value="{{ metricas_atuais.planos_sucesso_perc if metricas_atuais.planos_sucesso_perc is not none }}" data-regra-id="pts_planos" data-score-type="performance">

                        <label for="satisfacao_processo" class="visually-hidden">Satisfação do Processo (0-100)</label>
                        <input type="number" class="form-control metric-input" id="satisfacao_processo" name="satisfacao_processo" min="0" max="100" step="0.1" placeholder="Satisfação do Processo (0-100)" value="{{ metricas_atuais.satisfacao_processo if metricas_atuais.satisfacao_processo is not none }}" data-regra-id="pts_satisfacao" data-score-type="performance">
                    </div>
                </article>

                <script>
                    pontosRegrasManuais['pts_qualidade'] = {
                        100: {{ regras_agrupadas['Pontos: Qualidade'] | selectattr('regra_id', 'equalto', 'pts_qualidade_100') | map(attribute='valor_pontos') | first | default(0) }},
                        95: {{ regras_agrupadas['Pontos: Qualidade'] | selectattr('regra_id', 'equalto', 'pts_qualidade_95') | map(attribute='valor_pontos') | first | default(0) }},
                        90: {{ regras_agrupadas['Pontos: Qualidade'] | selectattr('regra_id', 'equalto', 'pts_qualidade_90') | map(attribute='valor_pontos') | first | default(0) }},
                        85: {{ regras_agrupadas['Pontos: Qualidade'] | selectattr('regra_id', 'equalto', 'pts_qualidade_85') | map(attribute='valor_pontos') | first | default(0) }},
                        80: {{ regras_agrupadas['Pontos: Qualidade'] | selectattr('regra_id', 'equalto', 'pts_qualidade_80') | map(attribute='valor_pontos') | first | default(0) }}
                    };

                    pontosRegrasManuais['pts_assiduidade'] = {
                        100: {{ regras_agrupadas['Pontos: Assiduidade'] | selectattr('regra_id', 'equalto', 'pts_assiduidade_100') | map(attribute='valor_pontos') | first | default(0) }},
                        98: {{ regras_agrupadas['Pontos: Assiduidade'] | selectattr('regra_id', 'equalto', 'pts_assiduidade_98') | map(attribute='valor_pontos') | first | default(0) }},
                        95: {{ regras_agrupadas['Pontos: Assiduidade'] | selectattr('regra_id', 'equalto', 'pts_assiduidade_95') | map(attribute='valor_pontos') | first | default(0) }}
                    };

                    pontosRegrasManuais['pts_planos'] = {
                        100: {{ regras_agrupadas['Pontos: Planos Sucesso'] | selectattr('regra_id', 'equalto', 'pts_planos_100') | map(attribute='valor_pontos') | first | default(0) }},
                        95: {{ regras_agrupadas['Pontos: Planos Sucesso'] | selectattr('regra_id', 'equalto', 'pts_planos_95') | map(attribute='valor_pontos') | first | default(0) }},
                        90: {{ regras_agrupadas['Pontos: Planos Sucesso'] | selectattr('regra_id', 'equalto', 'pts_planos_90') | map(attribute='valor_pontos') | first | default(0) }},
                        85: {{ regras_agrupadas['Pontos: Planos Sucesso'] | selectattr('regra_id', 'equalto', 'pts_planos_85') | map(attribute='valor_pontos') | first | default(0) }},
                        80: {{ regras_agrupadas['Pontos: Planos Sucesso'] | selectattr('regra_id', 'equalto', 'pts_planos_80') | map(attribute='valor_pontos') | first | default(0) }}
                    };

                    pontosRegrasManuais['pts_satisfacao'] = {
                        100: {{ regras_agrupadas['Pontos: Satisfação'] | selectattr('regra_id', 'equalto', 'pts_satisfacao_100') | map(attribute='valor_pontos') | first | default(0) }},
                        95: {{ regras_agrupadas['Pontos: Satisfação'] | selectattr('regra_id', 'equalto', 'pts_satisfacao_95') | map(attribute='valor_pontos') | first | default(0) }},
                        90: {{ regras_agrupadas['Pontos: Satisfação'] | selectattr('regra_id', 'equalto', 'pts_satisfacao_90') | map(attribute='valor_pontos') | first | default(0) }},
                        85: {{ regras_agrupadas['Pontos: Satisfação'] | selectattr('regra_id', 'equalto', 'pts_satisfacao_85') | map(attribute='valor_pontos') | first | default(0) }},
                        80: {{ regras_agrupadas['Pontos: Satisfação'] | selectattr('regra_id', 'equalto', 'pts_satisfacao_80') | map(attribute='valor_pontos') | first | default(0) }}
                    };
                </script>

                <article class="mm-metric-card mm-automatic">
                    <div class="mm-card-head">
                        <h3><i class="bi bi-gear"></i> Métricas Automáticas</h3>
                        <p>Sugeridas, podem ser editadas.</p>
                    </div>

                    <div class="mm-input-grid two-col">
                        <label for="impl_finalizadas_mes" class="visually-hidden">Implantações / Planos Finalizados</label>
                        <input type="number" class="form-control metric-input" id="impl_finalizadas_mes" name="impl_finalizadas_mes" min="0" step="1" placeholder="Implantações / Planos Finalizados" value="{{ metricas_atuais.impl_finalizadas_mes if metricas_atuais.impl_finalizadas_mes is not none else (metricas_automaticas.impl_finalizadas_mes | default(0)) }}" data-regra-id="eleg_finalizadas" data-score-type="none">

                        <label for="tma_medio_mes" class="visually-hidden">Tempo Médio de Implantação (TMA)</label>
                        <input type="number" class="form-control metric-input" id="tma_medio_mes" name="tma_medio_mes" min="0" step="0.1" placeholder="Tempo Médio de Implantação (TMA)" value="{{ metricas_atuais.tma_medio_mes if metricas_atuais.tma_medio_mes is not none else (metricas_automaticas.tma_medio_mes_raw | default(0)) }}" data-regra-id="pts_tma" data-score-type="performance">

                        <label for="impl_iniciadas_mes" class="visually-hidden">Implantações / Planos Iniciados</label>
                        <input type="number" class="form-control metric-input" id="impl_iniciadas_mes" name="impl_iniciadas_mes" min="0" step="1" placeholder="Implantações / Planos Iniciados" value="{{ metricas_atuais.impl_iniciadas_mes if metricas_atuais.impl_iniciadas_mes is not none else (metricas_automaticas.impl_iniciadas_mes | default(0)) }}" data-regra-id="pts_iniciadas" data-score-type="performance">

                        <label for="acoes_concluidas_dia_media" class="visually-hidden">Ações realizadas por dia</label>
                        <input type="number" class="form-control metric-input" id="acoes_concluidas_dia_media" name="acoes_concluidas_dia_media" min="0" step="0.1" placeholder="Ações realizadas por dia" value="{{ metricas_atuais.acoes_concluidas_dia_media if metricas_atuais.acoes_concluidas_dia_media is not none else (metricas_automaticas.acoes_concluidas_dia_media | default(0)) }}" data-regra-id="pts_acoes" data-score-type="performance">

                        <label for="reunioes_concluidas_dia_media" class="visually-hidden">Reuniões Realizadas por Dia</label>
                        <input type="number" class="form-control metric-input mm-full-row" id="reunioes_concluidas_dia_media" name="reunioes_concluidas_dia_media" min="0" step="0.1" placeholder="Reuniões Realizadas por Dia" value="{{ metricas_atuais.reunioes_concluidas_dia_media if metricas_atuais.reunioes_concluidas_dia_media is not none else (metricas_automaticas.reunioes_concluidas_dia_media | default(0)) }}" data-regra-id="pts_reunioes" data-score-type="performance">
                    </div>
                </article>

                <script>
                    pontosRegrasManuais['pts_tma'] = {
                        30: {{ regras_agrupadas['Pontos: TMA'] | selectattr('regra_id', 'equalto', 'pts_tma_30') | map(attribute='valor_pontos') | first | default(0) }},
                        35: {{ regras_agrupadas['Pontos: TMA'] | selectattr('regra_id', 'equalto', 'pts_tma_35') | map(attribute='valor_pontos') | first | default(0) }},
                        40: {{ regras_agrupadas['Pontos: TMA'] | selectattr('regra_id', 'equalto', 'pts_tma_40') | map(attribute='valor_pontos') | first | default(0) }},
                        45: {{ regras_agrupadas['Pontos: TMA'] | selectattr('regra_id', 'equalto', 'pts_tma_45') | map(attribute='valor_pontos') | first | default(0) }},
                        46: {{ regras_agrupadas['Pontos: TMA'] | selectattr('regra_id', 'equalto', 'pts_tma_46_mais') | map(attribute='valor_pontos') | first | default(0) }}
                    };

                    pontosRegrasManuais['pts_iniciadas'] = {
                        10: {{ regras_agrupadas['Pontos: Impl. Iniciadas'] | selectattr('regra_id', 'equalto', 'pts_iniciadas_10') | map(attribute='valor_pontos') | first | default(0) }},
                        9: {{ regras_agrupadas['Pontos: Impl. Iniciadas'] | selectattr('regra_id', 'equalto', 'pts_iniciadas_9') | map(attribute='valor_pontos') | first | default(0) }},
                        8: {{ regras_agrupadas['Pontos: Impl. Iniciadas'] | selectattr('regra_id', 'equalto', 'pts_iniciadas_8') | map(attribute='valor_pontos') | first | default(0) }},
                        7: {{ regras_agrupadas['Pontos: Impl. Iniciadas'] | selectattr('regra_id', 'equalto', 'pts_iniciadas_7') | map(attribute='valor_pontos') | first | default(0) }},
                        6: {{ regras_agrupadas['Pontos: Impl. Iniciadas'] | selectattr('regra_id', 'equalto', 'pts_iniciadas_6') | map(attribute='valor_pontos') | first | default(0) }}
                    };

                    pontosRegrasManuais['pts_reunioes'] = {
                        5: {{ regras_agrupadas['Pontos: Reuniões/Dia'] | selectattr('regra_id', 'equalto', 'pts_reunioes_5') | map(attribute='valor_pontos') | first | default(0) }},
                        4: {{ regras_agrupadas['Pontos: Reuniões/Dia'] | selectattr('regra_id', 'equalto', 'pts_reunioes_4') | map(attribute='valor_pontos') | first | default(0) }},
                        3: {{ regras_agrupadas['Pontos: Reuniões/Dia'] | selectattr('regra_id', 'equalto', 'pts_reunioes_3') | map(attribute='valor_pontos') | first | default(0) }},
                        2: {{ regras_agrupadas['Pontos: Reuniões/Dia'] | selectattr('regra_id', 'equalto', 'pts_reunioes_2') | map(attribute='valor_pontos') | first | default(0) }}
                    };

                    pontosRegrasManuais['pts_acoes'] = {
                        5: {{ regras_agrupadas['Pontos: Ações/Dia'] | selectattr('regra_id', 'equalto', 'pts_acoes_5') | map(attribute='valor_pontos') | first | default(0) }},
                        4: {{ regras_agrupadas['Pontos: Ações/Dia'] | selectattr('regra_id', 'equalto', 'pts_acoes_4') | map(attribute='valor_pontos') | first | default(0) }},
                        3: {{ regras_agrupadas['Pontos: Ações/Dia'] | selectattr('regra_id', 'equalto', 'pts_acoes_3') | map(attribute='valor_pontos') | first | default(0) }},
                        2: {{ regras_agrupadas['Pontos: Ações/Dia'] | selectattr('regra_id', 'equalto', 'pts_acoes_2') | map(attribute='valor_pontos') | first | default(0) }}
                    };

                    pontosRegrasManuais['eleg_finalizadas'] = {};
                </script>

                {% if regras_agrupadas['Bônus'] or regras_agrupadas['Bônus: Reuniões Pres.'] %}
                <article class="mm-metric-card mm-bonus">
                    <h3><i class="bi bi-plus-circle"></i> Métricas de Bônus</h3>
                    <div class="mm-input-grid two-col">
                        {% if regras_agrupadas['Bônus'] %}
                        {% for regra in regras_agrupadas['Bônus'] %}
                        {% set field_name = regra.regra_id | replace('bonus_', '') %}
                        <label for="{{ field_name }}" class="visually-hidden">{{ regra.descricao }}</label>
                        <input type="number" class="form-control metric-input" id="{{ field_name }}" name="{{ field_name }}" min="0" placeholder="{{ regra.descricao }}" value="{{ metricas_atuais[field_name] | default(0) }}" data-regra-id="{{ regra.regra_id }}" data-score-type="bonus">
                        <script>
                            pontosRegrasManuais['{{ regra.regra_id }}'] = {{ regra.valor_pontos }};
                        </script>
                        {% endfor %}
                        {% endif %}

                        {% if regras_agrupadas['Bônus: Reuniões Pres.'] %}
                        {% set field_name = 'reunioes_presenciais' %}
                        <label for="{{ field_name }}" class="visually-hidden">Bônus: Reuniões Presenciais (Ocorr.)</label>
                        <input type="number" class="form-control metric-input" id="{{ field_name }}" name="{{ field_name }}" min="0" placeholder="Bônus: Reuniões Presenciais (Ocorr.)" value="{{ metricas_atuais[field_name] | default(0) }}" data-regra-id="bonus_reun_pres" data-score-type="bonus">
                        <script>
                            pontosRegrasManuais['bonus_reun_pres'] = {
                                10: {{ regras_agrupadas['Bônus: Reuniões Pres.'] | selectattr('regra_id', 'equalto', 'bonus_reun_pres_10') | map(attribute='valor_pontos') | first | default(0) }},
                                7: {{ regras_agrupadas['Bônus: Reuniões Pres.'] | selectattr('regra_id', 'equalto', 'bonus_reun_pres_7') | map(attribute='valor_pontos') | first | default(0) }},
                                5: {{ regras_agrupadas['Bônus: Reuniões Pres.'] | selectattr('regra_id', 'equalto', 'bonus_reun_pres_5') | map(attribute='valor_pontos') | first | default(0) }},
                                3: {{ regras_agrupadas['Bônus: Reuniões Pres.'] | selectattr('regra_id', 'equalto', 'bonus_reun_pres_3') | map(attribute='valor_pontos') | first | default(0) }},
                                1: {{ regras_agrupadas['Bônus: Reuniões Pres.'] | selectattr('regra_id', 'equalto', 'bonus_reun_pres_1') | map(attribute='valor_pontos') | first | default(0) }}
                            };
                        </script>
                        {% endif %}
                    </div>
                </article>
                {% endif %}

                {% if regras_agrupadas['Penalidades'] %}
                <article class="mm-metric-card mm-penalty">
                    <h3><i class="bi bi-exclamation-triangle"></i> Métricas de Penalidade</h3>
                    <div class="mm-input-grid two-col">
                        {% for regra in regras_agrupadas['Penalidades'] %}
                        {% set field_name = regra.regra_id | replace('penal_', '') %}
                        <label for="{{ field_name }}" class="visually-hidden">{{ regra.descricao }}</label>
                        <input type="number" class="form-control metric-input" id="{{ field_name }}" name="{{ field_name }}" min="0" placeholder="{{ regra.descricao }}" value="{{ metricas_atuais[field_name] | default(0) }}" data-regra-id="{{ regra.regra_id }}" data-score-type="penalty">
                        <script>
                            pontosRegrasManuais['{{ regra.regra_id }}'] = {{ regra.valor_pontos }};
                        </script>
                        {% endfor %}
                    </div>
                </article>
                {% endif %}
            </div>

            <aside class="mm-side-column">
                <section class="mm-score-card">
                    <p class="mm-score-label">TOTAL DE PONTOS</p>
                    <div class="mm-score-total"><span id="total_pontos_display">0</span> <small>pts</small></div>
                    <div class="mm-score-progress">
                        <span id="total_pontos_progress"></span>
                    </div>
                    <dl class="mm-breakdown">
                        <div><dt>Performance</dt><dd id="pontos_performance">0</dd></div>
                        <div><dt>Bônus</dt><dd id="pontos_bonus">0</dd></div>
                        <div><dt>Penalidades</dt><dd id="pontos_penalidade">0</dd></div>
                    </dl>
                </section>

                <button type="submit" class="btn mm-btn mm-btn-save w-100">
                    <i class="bi bi-save"></i>
                    Salvar Métricas
                </button>

                <a href="{{ url_for('gamification.gamification_report', context=current_context) }}" class="btn mm-btn mm-btn-history w-100">
                    <i class="bi bi-clock-history"></i>
                    Ver Histórico
                </a>

                <section class="mm-tip-card">
                    <h4><i class="bi bi-lightbulb"></i> Dica Rápida</h4>
                    <p>Lembre-se de verificar as métricas automáticas antes de salvar. Elas impactam diretamente o score final.</p>
                </section>
            </aside>
        </div>

        <input type="text" id="total_pontos_manuais" value="0" readonly class="visually-hidden" aria-hidden="true">
    </form>
    {% else %}
    <div class="alert alert-info mt-3">Selecione um colaborador e um período para lançar as métricas manuais.</div>
    {% endif %}

    <footer class="mm-footer">© 2026 CS Onboarding Management System</footer>
    </main>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const inputs = document.querySelectorAll('.metric-input');
    const totalField = document.getElementById('total_pontos_manuais');
    const totalDisplay = document.getElementById('total_pontos_display');
    const performanceDisplay = document.getElementById('pontos_performance');
    const bonusDisplay = document.getElementById('pontos_bonus');
    const penaltyDisplay = document.getElementById('pontos_penalidade');
    const progress = document.getElementById('total_pontos_progress');

    if (typeof pontosRegrasManuais === 'undefined' || !totalField) {
        return;
    }

    function calcularPontosPorRegra(regraId, valorInput, regraPontos) {
        if (typeof regraPontos === 'number') {
            if (regraId === 'bonus_elogios' || regraId === 'bonus_certificacoes') {
                return Math.min(valorInput, 1) * regraPontos;
            }
            return valorInput * regraPontos;
        }

        if (typeof regraPontos !== 'object' || !regraPontos) {
            return 0;
        }

        if (regraId === 'pts_tma') {
            if (valorInput <= 30) return regraPontos[30] || 0;
            if (valorInput <= 35) return regraPontos[35] || 0;
            if (valorInput <= 40) return regraPontos[40] || 0;
            if (valorInput <= 45) return regraPontos[45] || 0;
            if (valorInput >= 46) return regraPontos[46] || 0;
        }

        if (regraId === 'pts_iniciadas') {
            if (valorInput >= 10) return regraPontos[10] || 0;
            if (valorInput >= 9) return regraPontos[9] || 0;
            if (valorInput >= 8) return regraPontos[8] || 0;
            if (valorInput >= 7) return regraPontos[7] || 0;
            if (valorInput >= 6) return regraPontos[6] || 0;
        }

        if (regraId === 'pts_reunioes') {
            if (valorInput >= 5) return regraPontos[5] || 0;
            if (valorInput >= 4) return regraPontos[4] || 0;
            if (valorInput >= 3) return regraPontos[3] || 0;
            if (valorInput >= 2) return regraPontos[2] || 0;
        }

        if (regraId === 'pts_acoes') {
            if (valorInput >= 5) return regraPontos[5] || 0;
            if (valorInput >= 4) return regraPontos[4] || 0;
            if (valorInput >= 3) return regraPontos[3] || 0;
            if (valorInput >= 2) return regraPontos[2] || 0;
        }

        if (regraId === 'bonus_reun_pres') {
            if (valorInput > 10) return regraPontos[10] || 0;
            if (valorInput >= 7) return regraPontos[7] || 0;
            if (valorInput >= 5) return regraPontos[5] || 0;
            if (valorInput >= 3) return regraPontos[3] || 0;
            if (valorInput >= 1) return regraPontos[1] || 0;
        }

        if (regraId === 'pts_qualidade') {
            if (valorInput >= 100) return regraPontos[100] || 0;
            if (valorInput >= 95) return regraPontos[95] || 0;
            if (valorInput >= 90) return regraPontos[90] || 0;
            if (valorInput >= 85) return regraPontos[85] || 0;
            if (valorInput >= 80) return regraPontos[80] || 0;
        }

        if (regraId === 'pts_assiduidade') {
            if (valorInput >= 100) return regraPontos[100] || 0;
            if (valorInput >= 98) return regraPontos[98] || 0;
            if (valorInput >= 95) return regraPontos[95] || 0;
        }

        if (regraId === 'pts_planos') {
            if (valorInput >= 100) return regraPontos[100] || 0;
            if (valorInput >= 95) return regraPontos[95] || 0;
            if (valorInput >= 90) return regraPontos[90] || 0;
            if (valorInput >= 85) return regraPontos[85] || 0;
            if (valorInput >= 80) return regraPontos[80] || 0;
        }

        if (regraId === 'pts_satisfacao') {
            if (valorInput >= 100) return regraPontos[100] || 0;
            if (valorInput >= 95) return regraPontos[95] || 0;
            if (valorInput >= 90) return regraPontos[90] || 0;
            if (valorInput >= 85) return regraPontos[85] || 0;
            if (valorInput >= 80) return regraPontos[80] || 0;
        }

        return 0;
    }

    function calcularTotal() {
        let total = 0;
        let performance = 0;
        let bonus = 0;
        let penalidade = 0;

        inputs.forEach(input => {
            const regraId = input.dataset.regraId;
            const scoreType = input.dataset.scoreType || 'none';
            const valorInput = (input.step === '0.1' || input.step === '0.01')
                ? parseFloat(input.value)
                : parseInt(input.value, 10);

            if (isNaN(valorInput) || (valorInput === 0 && regraId !== 'pts_tma')) {
                return;
            }

            const regraPontos = pontosRegrasManuais[regraId];
            if (!regraPontos) {
                return;
            }

            const pontos = calcularPontosPorRegra(regraId, valorInput, regraPontos);
            total += pontos;

            if (scoreType === 'performance') {
                performance += pontos;
            } else if (scoreType === 'bonus') {
                bonus += pontos;
            } else if (scoreType === 'penalty') {
                penalidade += pontos;
            }
        });

        const totalRounded = Math.round(total * 100) / 100;
        totalField.value = String(totalRounded);

        if (totalDisplay) {
            totalDisplay.textContent = totalRounded;
        }
        if (performanceDisplay) {
            performanceDisplay.textContent = performance > 0 ? `+${performance}` : String(performance);
        }
        if (bonusDisplay) {
            bonusDisplay.textContent = bonus > 0 ? `+${bonus}` : String(bonus);
        }
        if (penaltyDisplay) {
            penaltyDisplay.textContent = penalidade > 0 ? `+${penalidade}` : String(penalidade);
        }

        if (progress) {
            const pct = Math.max(0, Math.min(100, totalRounded));
            progress.style.width = `${pct}%`;
        }
    }

    inputs.forEach(input => {
        input.addEventListener('input', calcularTotal);
    });

    calcularTotal();
});
</script>
{% endblock %}
