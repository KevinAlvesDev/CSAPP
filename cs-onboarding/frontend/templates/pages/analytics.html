{% extends "base.html" %}

{% block title %}Dashboard Gerencial{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script
    src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

<style>
    .chart-container {
        position: relative;
        height: 350px;
        width: 100%;
    }

    /* Loading Overlay para gráficos */
    .chart-loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10;
        border-radius: 0.375rem;
    }

    .chart-spinner {
        width: 3rem;
        height: 3rem;
    }

    /* Tabelas com scroll interno */
    .limited-height-table {
        max-height: 600px;
        /* Aprox 15-20 linhas visíveis */
        overflow-y: auto;
        position: relative;
    }

    /* Garante que o padding do card-body não afete os gráficos */
    .card-body-chart {
        padding: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <header class="header-bg p-3 d-flex align-items-center position-relative rounded-3">
        <h1 class="main-title mb-0 fs-4 w-100 text-center">Dashboard Gerencial</h1>
        <div class="d-flex align-items-center position-absolute end-0 top-50 translate-middle-y">
            <a href="{{ url_for('onboarding.dashboard') }}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-arrow-left me-1"></i> Voltar ao Dashboard
            </a>
        </div>
    </header>

    <main class="p-4" id="main-content">
        <!-- Flash messages agora são exibidos como toasts flutuantes automaticamente -->

        <div class="card metric-card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Filtros Principais (Gráficos e Listas)</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('analytics.analytics_dashboard') }}" id="analytics-filter-form">
                    {% if current_task_cs_email %}
                    <input type="hidden" name="task_cs_email" value="{{ current_task_cs_email }}">
                    {% endif %}
                    <input type="hidden" name="task_start_date" value="{{ current_task_start_date | default('') }}">
                    <input type="hidden" name="task_end_date" value="{{ current_task_end_date | default('') }}">

                    <div class="row g-3 align-items-end" id="analytics-filters-row">
                        <div class="col-md-3">
                            <label for="cs_email_filter" class="form-label small">Filtrar por Colaborador</label>
                            <select class="form-select" id="cs_email_filter" name="cs_email">
                                <option value="">Todos os CS</option>
                                {% for cs in all_cs %}
                                <option value="{{ cs.usuario }}" {% if cs.usuario==current_cs_email %}selected{% endif
                                    %}>
                                    {{ cs.nome }} ({{ cs.perfil_acesso or 'N/A' }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="status_filter" class="form-label small">Filtrar por Status</label>
                            <select class="form-select" id="status_filter" name="status_filter">
                                {% for opt in status_options %}
                                <option value="{{ opt.value }}" {% if opt.value==current_status_filter %}selected{%
                                    endif %}>
                                    {{ opt.label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="start_date_filter" class="form-label small">Período (Início)</label>
                            <div class="input-group">
                                <input type="text" class="form-control flatpickr-date" id="start_date_filter"
                                    name="start_date" placeholder="DD/MM/AAAA" inputmode="numeric"
                                    pattern="\d{2}/\d{2}/\d{4}" value="{{ current_start_date or '' }}">
                                <button class="btn btn-outline-secondary" type="button" id="btn-cal-start_date_filter"
                                    aria-label="Abrir calendário"><i class="bi bi-calendar3"></i></button>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label for="end_date_filter" class="form-label small">Período (Fim)</label>
                            <div class="input-group">
                                <input type="text" class="form-control flatpickr-date" id="end_date_filter"
                                    name="end_date" placeholder="DD/MM/AAAA" inputmode="numeric"
                                    pattern="\d{2}/\d{2}/\d{4}" value="{{ current_end_date or '' }}">
                                <button class="btn btn-outline-secondary" type="button" id="btn-cal-end_date_filter"
                                    aria-label="Abrir calendário"><i class="bi bi-calendar3"></i></button>
                            </div>
                        </div>
                        <div class="col-md-2 d-flex">
                            <button type="submit" class="btn btn-primary w-100 me-2"><i
                                    class="bi bi-funnel-fill me-1"></i> Filtrar</button>
                            <a href="{{ url_for('analytics.analytics_dashboard') }}" class="btn btn-outline-secondary"
                                title="Limpar Filtros"><i class="bi bi-x-lg"></i></a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        {% from 'macros/cards.html' import card_stats %}
        {% set k = kpi_cards %}
        <div class="kpi-grid">
            {{ card_stats('Clientes (Filtro)', k.total_clientes | default(0), 'primary') }}
            {{ card_stats('Impl. Novas', k.total_novas | default(0), 'dark') }}
            {{ card_stats('Impl. Em Andamento', k.total_andamento | default(0), 'warning') }}
            {{ card_stats('Impl. Futuras', k.total_futuras | default(0), 'info') }}
            {{ card_stats('Impl. Paradas', k.total_paradas | default(0), 'danger') }}
            <div class="metric-card p-3 text-center" style="background-color: #f8d7da;">
                <h6 class="text-secondary">Impl. Canceladas</h6>
                <h4 class="mb-0 text-dark">{{ k.total_canceladas | default(0) }}</h4>
            </div>
            {{ card_stats('Impl. Finalizadas', k.total_finalizadas | default(0), 'success') }}
            {{ card_stats('Impl. Sem Previsão', k.total_sem_previsao | default(0), 'danger') }}
            {{ card_stats('Média Implantação', (k.media_tma | default(0))|string + 'd', 'primary') }}
        </div>
        <div class="row g-4 mb-4">
            <div class="col-lg-6">
                <div class="card metric-card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">Nível Clientes em Implantação (MRR) <i
                                class="bi bi-question-circle-fill text-muted" style="font-size: 0.9rem; cursor: help;"
                                data-bs-toggle="tooltip" data-bs-placement="top"
                                title="Distribuição dos clientes em implantação por faixa de MRR (Receita Recorrente Mensal). Ajuda a identificar o perfil de receita da carteira."></i>
                        </h5>
                    </div>
                    <div class="card-body card-body-chart">
                        <div class="chart-container">
                            <div class="chart-loading-overlay" id="loadingNivel">
                                <div class="spinner-border text-primary chart-spinner" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </div>
                            <canvas id="chartNivelReceita"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card metric-card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">Status Clientes Implantação <i class="bi bi-question-circle-fill text-muted"
                                style="font-size: 0.9rem; cursor: help;" data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="Quantidade de clientes por status: Novas, Em Andamento, Finalizadas, Paradas, Futuras e Canceladas. Visão geral do funil de implantação."></i>
                        </h5>
                    </div>
                    <div class="card-body card-body-chart">
                        <div class="chart-container">
                            <div class="chart-loading-overlay" id="loadingStatus">
                                <div class="spinner-border text-primary chart-spinner" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </div>
                            <canvas id="chartStatusClientes"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Chart: Tags Completed by User -->
        <div class="card metric-card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Relatório de tags</h5>
            </div>
            <div class="card-body">
                <p class="small text-muted mb-3">
                    Visualização de tarefas concluídas agrupadas por tag (Ação interna, Reunião, etc.) para cada
                    usuário.
                    Use os filtros abaixo para refinar o período de análise.
                </p>

                <!-- Date Range Filter for Tags Chart -->
                <form method="GET" id="tags-filter-form" class="mb-4">
                    <!-- Preserve main filters -->
                    {% if current_cs_email %}
                    <input type="hidden" name="cs_email" value="{{ current_cs_email }}">
                    {% endif %}
                    {% if current_status_filter %}
                    <input type="hidden" name="status_filter" value="{{ current_status_filter }}">
                    {% endif %}
                    {% if current_start_date %}
                    <input type="hidden" name="start_date" value="{{ current_start_date }}">
                    {% endif %}
                    {% if current_end_date %}
                    <input type="hidden" name="end_date" value="{{ current_end_date }}">
                    {% endif %}

                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label small">Filtrar por Usuário (Tags)</label>
                            <select class="form-select" name="task_cs_email">
                                <option value="">Todos os Usuários</option>
                                {% for cs in all_cs %}
                                <option value="{{ cs.usuario }}" {% if cs.usuario==current_task_cs_email %}selected{%
                                    endif %}>
                                    {{ cs.nome }} ({{ cs.perfil_acesso or 'N/A' }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Data Início (Tags)</label>
                            <div class="input-group">
                                <input type="text" class="form-control flatpickr-date" name="task_start_date"
                                    placeholder="DD/MM/AAAA" value="{{ current_task_start_date or '' }}">
                                <button class="btn btn-outline-secondary" type="button" id="btn-cal-task-start">
                                    <i class="bi bi-calendar3"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Data Fim (Tags)</label>
                            <div class="input-group">
                                <input type="text" class="form-control flatpickr-date" name="task_end_date"
                                    placeholder="DD/MM/AAAA" value="{{ current_task_end_date or '' }}">
                                <button class="btn btn-outline-secondary" type="button" id="btn-cal-task-end">
                                    <i class="bi bi-calendar3"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3 d-flex gap-2">
                            <button type="submit" class="btn btn-primary flex-grow-1">
                                <i class="bi bi-funnel-fill me-1"></i> Filtrar Tags
                            </button>
                            <a href="{{ url_for('analytics.analytics_dashboard', cs_email=current_cs_email, status_filter=current_status_filter, start_date=current_start_date, end_date=current_end_date) }}"
                                class="btn btn-outline-secondary" title="Limpar Filtros de Tags">
                                <i class="bi bi-x-lg"></i>
                            </a>
                        </div>
                    </div>
                </form>

                <!-- Table Container -->
                {% if tags_chart_data and tags_chart_data.labels %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center" style="min-width: 150px;">Usuário</th>
                                {% for dataset in tags_chart_data.datasets %}
                                <th class="text-center" style="min-width: 120px;">{{ dataset.label }}</th>
                                {% endfor %}
                                <th class="text-center bg-light" style="min-width: 100px;"><strong>Total</strong></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user_idx in range(tags_chart_data.labels|length) %}
                            <tr>
                                <td class="fw-semibold">{{ tags_chart_data.labels[user_idx] }}</td>
                                {% set row_total = namespace(value=0) %}
                                {% for dataset in tags_chart_data.datasets %}
                                {% set count = dataset.data[user_idx] %}
                                {% set row_total.value = row_total.value + count %}
                                <td class="text-center">
                                    {% if count > 0 %}
                                    <span class="badge rounded-pill"
                                        style="background-color: {{ dataset.backgroundColor }}; color: white; font-size: 0.9rem; padding: 0.4rem 0.8rem;">
                                        {{ count }}
                                    </span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                                <td class="text-center bg-light">
                                    <strong class="text-primary">{{ row_total.value }}</strong>
                                </td>
                            </tr>
                            {% endfor %}
                            <!-- Totals Row -->
                            <tr class="table-secondary fw-bold">
                                <td class="text-start">Total por Tag:</td>
                                {% for dataset in tags_chart_data.datasets %}
                                {% set col_total = dataset.data|sum %}
                                <td class="text-center">{{ col_total }}</td>
                                {% endfor %}
                                <td class="text-center bg-primary text-white">
                                    <strong>{{ tags_chart_data.total_tasks or 0 }}</strong>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info text-center">
                    <i class="bi bi-info-circle me-2"></i>
                    Nenhum dado disponível para o período selecionado.
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card metric-card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Lista Detalhada de Implantações</h5>
            </div>
            <div class="card-body">
                {% if not implantacoes_lista_detalhada %}
                <div class="alert alert-light text-center small py-2 mb-0">Nenhum cliente encontrado para os filtros
                    selecionados.</div>
                {% else %}
                <div class="table-responsive limited-height-table">
                    <table class="table table-sm table-hover align-middle caption-top">
                        <caption class="small text-muted">
                            Listando {{ implantacoes_lista_detalhada | length }} implantações
                            {% if current_sort_impl_date in ['asc','desc'] %}
                            (ordenadas por data de implantação {{ 'mais antiga' if current_sort_impl_date == 'asc' else
                            'mais recente' }})
                            {% else %}
                            (ordenadas por nome da empresa)
                            {% endif %}.
                        </caption>
                        <thead class="table-light" style="position: sticky; top: 0;">
                            <tr>
                                <th scope="col">Empresa</th>
                                <th scope="col">Implantador</th>
                                <th scope="col">
                                    Início da Implantação
                                    <a href="{{ url_for('analytics.analytics_dashboard', cs_email=current_cs_email, status_filter=current_status_filter, start_date=current_start_date, end_date=current_end_date, sort_impl_date='desc') }}"
                                        class="ms-1" title="Ordenar por mais recente"><i
                                            class="bi bi-sort-down-alt"></i></a>
                                    <a href="{{ url_for('analytics.analytics_dashboard', cs_email=current_cs_email, status_filter=current_status_filter, start_date=current_start_date, end_date=current_end_date, sort_impl_date='asc') }}"
                                        class="ms-1" title="Ordenar por mais antiga"><i class="bi bi-sort-up"></i></a>
                                </th>
                                <th scope="col">Início em Produção</th>
                                <th scope="col">Status</th>
                                <th scope="col">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for impl in implantacoes_lista_detalhada %}
                            <tr>
                                <td class="text-truncate" style="max-width: 200px;">{{ impl.nome_empresa |
                                    default('N/A') }}</td>
                                <td class="text-truncate" style="max-width: 150px;">{{ impl.cs_nome | default('N/A') }}
                                </td>
                                <td>{{ impl.data_criacao | format_date_br(include_time=False) }}</td>
                                <td>{{ impl.data_inicio_producao | format_date_br(include_time=False) }}</td>
                                <td>
                                    {% if impl.status == 'finalizada' %} <span class="badge bg-success">Concluído</span>
                                    {% elif impl.status == 'parada' %} <span class="badge bg-danger">Parada</span>
                                    {% elif impl.status == 'futura' %} <span
                                        class="badge bg-info text-dark">Futura</span>
                                    {% elif impl.status == 'nova' %} <span class="badge bg-dark">Nova</span>
                                    {% elif impl.status == 'cancelada' %} <span
                                        class="badge bg-secondary text-dark">Cancelada</span>
                                    {% else %} <span class="badge bg-warning text-dark">Em Andamento</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('onboarding.ver_implantacao', impl_id=impl.id) }}"
                                        class="btn btn-sm btn-outline-primary py-0 px-2">Ver</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card metric-card border border-danger mt-4">
            <div class="card-header">
                <h5 class="mb-0 text-danger">Implantações Paradas <i class="bi bi-question-circle-fill text-muted"
                        style="font-size: 0.9rem; cursor: help;" data-bs-toggle="tooltip" data-bs-placement="top"
                        title="Lista de implantações com status 'Parada' e o gráfico de rosca mostra a distribuição dos principais motivos de parada (gargalos)."></i>
                </h5>
            </div>
            <div class="card-body">
                {% if not implantacoes_paradas_lista %}
                <div class="alert alert-light text-center small py-2 mb-0">Nenhuma implantação parada encontrada para os
                    filtros selecionados.</div>
                {% else %}
                <div class="row">
                    <div class="col-lg-8">
                        <div class="table-responsive limited-height-table">
                            <table class="table table-sm table-hover align-middle caption-top">
                                <caption class="small text-muted">Listando {{ implantacoes_paradas_lista | length }}
                                    implantações paradas.</caption>
                                <thead style="position: sticky; top: 0;">
                                    <tr>
                                        <th scope="col">Empresa</th>
                                        <th scope="col">Motivo da Parada</th>
                                        <th scope="col">Dias Parada</th>
                                        <th scope="col">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for impl in implantacoes_paradas_lista %}
                                    <tr>
                                        <td class="text-truncate" style="max-width: 250px;">{{ impl.nome_empresa |
                                            default('N/A') }}</td>
                                        <td class="text-truncate" style="max-width: 300px;">{{ impl.motivo_parada |
                                            default('N/A') }}</td>
                                        <td><span class="badge bg-danger">{{ impl.dias_parada | int }} dias</span></td>
                                        <td>
                                            <a href="{{ url_for('onboarding.ver_implantacao', impl_id=impl.id) }}"
                                                class="btn btn-sm btn-outline-primary py-0 px-2">Ver</a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card h-100 border-0 bg-light">
                            <div class="card-body p-3 d-flex flex-column align-items-center justify-content-center">
                                <h6 class="card-title text-center text-muted mb-3">Principais Motivos (Gargalos)</h6>
                                <div class="chart-container" style="height: 250px;">
                                    <div class="chart-loading-overlay" id="loadingGargalos">
                                        <div class="spinner-border text-danger chart-spinner" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                    </div>
                                    <canvas id="chartGargalos"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card metric-card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Implantações Canceladas</h5>
            </div>
            <div class="card-body">
                {% if not implantacoes_canceladas_lista %}
                <div class="alert alert-dark text-center small py-2 mb-0">Nenhuma implantação cancelada encontrada para
                    os filtros selecionados.</div>
                {% else %}
                <div class="table-responsive limited-height-table">
                    <table class="table table-sm table-hover align-middle caption-top">
                        <caption class="small text-muted">Listando {{ implantacoes_canceladas_lista | length }}
                            implantações canceladas.</caption>
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Empresa</th>
                                <th scope="col">Implantador</th>
                                <th scope="col">Data do Cancelamento</th>
                                <th scope="col">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for impl in implantacoes_canceladas_lista %}
                            <tr>
                                <td class="text-truncate" style="max-width: 250px;">{{ impl.nome_empresa |
                                    default('N/A') }}</td>
                                <td class="text-truncate" style="max-width: 200px;">{{ impl.cs_nome | default('N/A') }}
                                </td>
                                <td>{{ impl.data_cancelamento | format_date_br(include_time=False) }}</td>
                                <td>
                                    <a href="{{ url_for('onboarding.ver_implantacao', impl_id=impl.id) }}"
                                        class="btn btn-sm btn-outline-primary py-0 px-2">Ver</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card metric-card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Lista Detalhada de Módulos em Implantação</h5>
            </div>
            <div class="card-body">
                {% set modules_lista = modules_implantacao_lista | default([]) %}
                {% if not modules_lista %}
                <div class="alert alert-light text-center small py-2 mb-0">Nenhum módulo listado para os filtros
                    selecionados.</div>
                {% else %}
                <div class="table-responsive limited-height-table">
                    <table class="table table-sm table-hover align-middle caption-top">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Empresa</th>
                                <th scope="col">Responsável</th>
                                <th scope="col">Status</th>
                                <th scope="col">Dias</th>
                                <th scope="col">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in modules_lista %}
                            <tr>
                                <td class="text-truncate" style="max-width: 250px;">{{ item.nome_empresa |
                                    default('N/A') }}</td>
                                <td class="text-truncate" style="max-width: 200px;">{{ item.cs_nome | default('N/A') }}
                                </td>
                                <td>
                                    {% if item.status == 'finalizada' %}
                                    <span class="badge bg-success">Concluído</span>
                                    {% elif item.status == 'andamento' %}
                                    <span class="badge bg-warning text-dark">Em Andamento</span>
                                    {% elif item.status == 'parada' %}
                                    <span class="badge bg-danger">Parada</span>
                                    {% elif item.status == 'futura' %}
                                    <span class="badge bg-info text-dark">Futura</span>
                                    {% elif item.status == 'cancelada' %}
                                    <span class="badge bg-secondary">Cancelada</span>
                                    {% elif item.status == 'nova' %}
                                    <span class="badge bg-dark">Nova</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ item.status | default('N/A') }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-nowrap"><span class="badge bg-secondary text-dark">{{ item.dias |
                                        default(0) }} dias</span></td>
                                <td>
                                    <a href="{{ url_for('onboarding.ver_implantacao', impl_id=item.impl_id | default(item.id)) }}"
                                        class="btn btn-sm btn-outline-primary py-0 px-2">Ver</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card metric-card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Ranking Implantação por Colaborador <i class="bi bi-question-circle-fill text-muted"
                        style="font-size: 0.9rem; cursor: help;" data-bs-toggle="tooltip" data-bs-placement="top"
                        title="Total de implantações atribuídas a cada colaborador CS, considerando os filtros aplicados. Útil para balanceamento de carga."></i>
                </h5>
            </div>
            <div class="card-body card-body-chart">
                <p class="small text-muted mb-3">Total de implantações (baseado nos filtros principais) por colaborador.
                </p>
                <div class="chart-container">
                    <div class="chart-loading-overlay" id="loadingRankingColab">
                        <div class="spinner-border text-primary chart-spinner" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                    <canvas id="chartRankingColaborador"></canvas>
                </div>
            </div>
        </div>
        <div class="card metric-card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Ranking Implantação por Período <i class="bi bi-question-circle-fill text-muted"
                        style="font-size: 0.9rem; cursor: help;" data-bs-toggle="tooltip" data-bs-placement="top"
                        title="Total de implantações finalizadas no ano corrente, agrupadas por mês. Mostra a evolução mensal de entregas."></i>
                </h5>
            </div>
            <div class="card-body card-body-chart">
                <p class="small text-muted mb-3">Total de implantações <span
                        class="fw-bold text-success">finalizadas</span> no ano corrente, agrupadas por mês (respeita o
                    filtro principal de Colaborador).</p>
                <div class="chart-container">
                    <div class="chart-loading-overlay" id="loadingRankingPeriodo">
                        <div class="spinner-border text-primary chart-spinner" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                    <canvas id="chartRankingPeriodo"></canvas>
                </div>
            </div>
        </div>

        <!-- Bloco 9: Inteligência & Previsão -->
        <div class="row g-4 mt-1">
            <div class="col-12">
                <h5 class="text-secondary border-bottom pb-2">Análise de Performance & Previsão</h5>
            </div>
            <div class="col-lg-6">
                <div class="card metric-card h-100">
                    <div class="card-header bg-white">
                        <h6 class="mb-0 text-primary"><i class="bi bi-speedometer2 me-2"></i>Velocidade de Entrega <i
                                class="bi bi-question-circle-fill text-muted" style="font-size: 0.8rem; cursor: help;"
                                data-bs-toggle="tooltip" data-bs-placement="top"
                                title="Histograma mostrando quantas implantações foram finalizadas em cada faixa de tempo: 0-30 dias (rápidas), 31-60, 61-90 e 90+ dias (lentas)."></i>
                        </h6>
                    </div>
                    <div class="card-body card-body-chart">
                        <p class="small text-muted mb-2">Quantos dias leva para finalizar uma implantação (Histograma).
                        </p>
                        <div class="chart-container">
                            <div class="chart-loading-overlay" id="loadingVelocidade">
                                <div class="spinner-border text-primary chart-spinner" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </div>
                            <canvas id="chartVelocidade"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card metric-card h-100">
                    <div class="card-header bg-white">
                        <h6 class="mb-0 text-success"><i class="bi bi-cash-coin me-2"></i>Previsibilidade de Entregas <i
                                class="bi bi-question-circle-fill text-muted" style="font-size: 0.8rem; cursor: help;"
                                data-bs-toggle="tooltip" data-bs-placement="top"
                                title="Previsão de término de implantações em andamento e futuras, agrupadas por mês. Baseado na data de previsão de término cadastrada."></i>
                        </h6>
                    </div>
                    <div class="card-body card-body-chart">
                        <p class="small text-muted mb-2">Previsão de término para implantações em andamento/futuras (Mês
                            a Mês).</p>
                        <div class="chart-container">
                            <div class="chart-loading-overlay" id="loadingPrevisao">
                                <div class="spinner-border text-success chart-spinner" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </div>
                            <canvas id="chartPrevisao"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
    // Passa os dados do Flask (convertidos para JSON) para o JavaScript
    const chartData = {{ (chart_data or { }) | tojson | safe }};

    document.addEventListener('DOMContentLoaded', function () {

        // TEMPORARIAMENTE DESABILITADO - Plugin ChartDataLabels causa lag
        // Chart.register(ChartDataLabels);

        // Opções de tooltip (popup)
        const tooltipOptions = {
            backgroundColor: '#212529',
            titleFont: { size: 14, weight: 'bold' },
            bodyFont: { size: 12 },
            padding: 10,
            cornerRadius: 6,
            displayColors: false,
        };

        // Opções de rótulos (datalabels) para barras
        const barDatalabelOptions = {
            anchor: 'end',
            align: 'top',
            color: '#333',
            font: {
                weight: 'bold'
            },
            formatter: (value) => {
                return value > 0 ? value : null;
            }
        };

        // Ajusta a cor dos rótulos no Dark Mode
        if (document.body.classList.contains('dark-mode')) {
            barDatalabelOptions.color = '#e0e0e0';
        }

        const ctxNivel = document.getElementById('chartNivelReceita');
        const ctxStatus = document.getElementById('chartStatusClientes');
        const ctxRankingColab = document.getElementById('chartRankingColaborador');
        const ctxRankingPeriodo = document.getElementById('chartRankingPeriodo');
        const ctxGargalos = document.getElementById('chartGargalos');
        const ctxVelocidade = document.getElementById('chartVelocidade');
        const ctxPrevisao = document.getElementById('chartPrevisao');

        // Define a cor azul padrão
        const corAzul = 'rgba(54, 162, 235, 0.7)';
        const corBordaAzul = 'rgba(54, 162, 235, 1)';

        const barColors = [
            'rgba(54, 162, 235, 0.7)', // Blue
            'rgba(255, 99, 132, 0.7)', // Red
            'rgba(255, 206, 86, 0.7)', // Yellow
            'rgba(75, 192, 192, 0.7)', // Green
            'rgba(153, 102, 255, 0.7)', // Purple
            'rgba(255, 159, 64, 0.7)', // Orange
            'rgba(100, 100, 100, 0.7)'  // Gray
        ];

        const statusColors = {
            'Novas': 'rgba(108, 117, 125, 0.7)',
            'Em Andamento': 'rgba(255, 206, 86, 0.7)', // Yellow
            'Finalizadas': 'rgba(75, 192, 192, 0.7)', // Green
            'Futuras': 'rgba(54, 162, 235, 0.7)', // Blue
            'Paradas': 'rgba(255, 99, 132, 0.7)', // Red
            'Canceladas': 'rgba(0, 0, 0, 0.6)' // Dark Gray/Blackish for Canceled
        };

        // OTIMIZAÇÃO MÁXIMA: Desabilitar TODAS as animações para evitar travamento
        Chart.defaults.animation = false;
        Chart.defaults.animations = false;
        Chart.defaults.transitions = false;

        // SOLUÇÃO DEFINITIVA: Lazy Loading com Intersection Observer
        // Gráficos só são renderizados quando ficam visíveis na tela

        const chartConfigs = {
            ctxNivel: {
                element: ctxNivel,
                data: chartData.nivel_receita,
                loadingId: 'loadingNivel',
                config: {
                    type: 'bar',
                    data: {
                        labels: chartData.nivel_receita?.labels || [],
                        datasets: [{
                            label: 'Qtd. Clientes',
                            data: chartData.nivel_receita?.data || [],
                            backgroundColor: corAzul,
                            borderColor: corBordaAzul,
                            borderWidth: 1,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: { x: { beginAtZero: true }, y: { beginAtZero: true } },
                        plugins: { legend: { display: false }, tooltip: tooltipOptions }
                    }
                }
            },
            ctxStatus: {
                element: ctxStatus,
                data: chartData.status_clientes,
                loadingId: 'loadingStatus',
                config: function () {
                    const statusData = chartData.status_clientes;
                    const backgroundColorsStatus = statusData.labels.map(label => statusColors[label] || 'rgba(100, 100, 100, 0.7)');
                    const total = statusData.data.reduce((acc, value) => acc + value, 0);
                    return {
                        type: 'doughnut',
                        data: {
                            labels: statusData.labels,
                            datasets: [{
                                label: 'Qtd. Clientes',
                                data: statusData.data,
                                backgroundColor: backgroundColorsStatus,
                                borderColor: backgroundColorsStatus.map(c => c.replace('0.7', '1')),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: true, position: 'bottom' }, tooltip: tooltipOptions }
                        }
                    };
                }
            },
            ctxRankingColab: {
                element: ctxRankingColab,
                data: chartData.ranking_colaborador,
                loadingId: 'loadingRankingColab',
                config: {
                    type: 'bar',
                    data: {
                        labels: chartData.ranking_colaborador?.labels || [],
                        datasets: [{
                            label: 'Total Implantações (Filtro)',
                            data: chartData.ranking_colaborador?.data || [],
                            backgroundColor: corAzul,
                            borderColor: corBordaAzul,
                            borderWidth: 1,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } },
                        plugins: { legend: { display: false }, tooltip: tooltipOptions }
                    }
                }
            },
            ctxRankingPeriodo: {
                element: ctxRankingPeriodo,
                data: chartData.ranking_periodo,
                loadingId: 'loadingRankingPeriodo',
                config: {
                    type: 'bar',
                    data: {
                        labels: chartData.ranking_periodo?.labels || [],
                        datasets: [{
                            label: 'Impl. Finalizadas (Ano Corrente)',
                            data: chartData.ranking_periodo?.data || [],
                            backgroundColor: 'rgba(153, 102, 255, 0.7)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } },
                        plugins: { legend: { display: false }, tooltip: tooltipOptions }
                    }
                }
            },
            ctxGargalos: {
                element: ctxGargalos,
                data: chartData.gargalos_parada,
                loadingId: 'loadingGargalos',
                config: {
                    type: 'doughnut',
                    data: {
                        labels: chartData.gargalos_parada?.labels || [],
                        datasets: [{
                            data: chartData.gargalos_parada?.data || [],
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.8)',
                                'rgba(255, 159, 64, 0.8)',
                                'rgba(255, 205, 86, 0.8)',
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(153, 102, 255, 0.8)',
                                'rgba(201, 203, 207, 0.8)'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { boxWidth: 10, font: { size: 10 } }
                            },
                            tooltip: tooltipOptions
                        },
                        layout: { padding: 10 }
                    }
                }
            },
            ctxVelocidade: {
                element: ctxVelocidade,
                data: chartData.velocidade_entrega,
                loadingId: 'loadingVelocidade',
                config: {
                    type: 'bar',
                    data: {
                        labels: chartData.velocidade_entrega?.labels || [],
                        datasets: [{
                            label: 'Implantações',
                            data: chartData.velocidade_entrega?.data || [],
                            backgroundColor: corAzul,
                            borderColor: corBordaAzul,
                            borderWidth: 1,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } },
                        plugins: { legend: { display: false }, tooltip: tooltipOptions }
                    }
                }
            },
            ctxPrevisao: {
                element: ctxPrevisao,
                data: chartData.previsao_receita,
                loadingId: 'loadingPrevisao',
                config: {
                    type: 'bar',
                    data: {
                        labels: chartData.previsao_receita?.labels || [],
                        datasets: [{
                            label: 'Previsão de Entrega (Qtd)',
                            data: chartData.previsao_receita?.data || [],
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } },
                        plugins: { legend: { display: false }, tooltip: tooltipOptions }
                    }
                }
            }
        };

        // Intersection Observer para lazy loading
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && entry.target.dataset.chartKey) {
                    const key = entry.target.dataset.chartKey;
                    const chartConfig = chartConfigs[key];

                    if (chartConfig && chartConfig.element && !entry.target.dataset.loaded) {
                        // Remover spinner
                        if (chartConfig.loadingId) {
                            const spinner = document.getElementById(chartConfig.loadingId);
                            if (spinner) spinner.style.display = 'none';
                        }

                        // Renderizar gráfico
                        if (chartConfig.config) {
                            const config = typeof chartConfig.config === 'function' ? chartConfig.config() : chartConfig.config;
                            new Chart(chartConfig.element, config);
                        }

                        entry.target.dataset.loaded = 'true';
                        observer.unobserve(entry.target);
                    }
                }
            });
        }, { rootMargin: '0px' });

        // Observar cada canvas
        Object.keys(chartConfigs).forEach(key => {
            const chartConfig = chartConfigs[key];
            if (chartConfig.element) {
                chartConfig.element.dataset.chartKey = key;
                observer.observe(chartConfig.element);
            }
        });

        // Inicializar tooltips do Bootstrap
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });


        // 5. Tags por Usuário - NOW USING TABLE FORMAT (chart code disabled)
        /*
        const ctxTagsByUser = document.getElementById('chartTagsByUser');
        const tagsData = {{ tags_chart_data | tojson | safe
    }};
     
    if (ctxTagsByUser && tagsData && tagsData.labels && tagsData.labels.length > 0) {
        new Chart(ctxTagsByUser, {
            type: 'bar',
            data: {
                labels: tagsData.labels,
                datasets: tagsData.datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y', // Horizontal bars for better readability
                scales: {
                    x: {
                        beginAtZero: true,
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Quantidade de Tarefas Concluídas'
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            boxWidth: 12,
                            padding: 10
                        }
                    },
                    tooltip: {
                        ...tooltipOptions,
                        callbacks: {
                            label: function (context) {
                                const label = context.dataset.label || '';
                                const value = context.parsed.x || 0;
                                return `${label}: ${value} tarefa${value !== 1 ? 's' : ''}`;
                            }
                        }
                    },
                    datalabels: {
                        anchor: 'center',
                        align: 'center',
                        color: '#fff',
                        font: {
                            weight: 'bold',
                            size: 11
                        },
                        formatter: (value) => {
                            return value > 0 ? value : null;
                        }
                    }
                }
            }
        });
    } else if (ctxTagsByUser) {
        // Show empty state
        const ctx = ctxTagsByUser.getContext('2d');
        ctx.font = '14px Arial';
        ctx.fillStyle = '#6c757d';
        ctx.textAlign = 'center';
        ctx.fillText('Nenhum dado disponível para o período selecionado', ctxTagsByUser.width / 2, ctxTagsByUser.height / 2);
    }
    */

        // Inicialização dos filtros com flatpickr e máscara BR
        if (window.flatpickr) {
            var fpStart = window.flatpickr('#start_date_filter', { dateFormat: 'Y-m-d', altInput: true, altFormat: 'd/m/Y', allowInput: true });
            var fpEnd = window.flatpickr('#end_date_filter', { dateFormat: 'Y-m-d', altInput: true, altFormat: 'd/m/Y', allowInput: true });
            var btnStart = document.getElementById('btn-cal-start_date_filter');
            var btnEnd = document.getElementById('btn-cal-end_date_filter');
            if (btnStart && fpStart) btnStart.addEventListener('click', function () { fpStart.open(); });
            if (btnEnd && fpEnd) btnEnd.addEventListener('click', function () { fpEnd.open(); });
            function attachMask(fp) {
                var alt = fp && fp._input ? fp._input : null;
                if (!alt) return;
                alt.setAttribute('placeholder', 'DD/MM/AAAA');
                alt.addEventListener('input', function (e) {
                    var v = e.target.value.replace(/[^\d]/g, '').slice(0, 8);
                    var out = '';
                    if (v.length >= 2) out = v.slice(0, 2);
                    if (v.length >= 4) out = out + '/' + v.slice(2, 4);
                    if (v.length >= 5) out = out + '/' + v.slice(4, 8);
                    e.target.value = out;
                });
            }
            attachMask(fpStart);
            attachMask(fpEnd);
        }
    });
</script>
{% endblock %}