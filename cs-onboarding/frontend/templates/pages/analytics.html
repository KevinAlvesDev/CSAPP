{% extends "base.html" %}

{% block title %}Dashboard Gerencial{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/analytics_dashboard.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
{% set k = kpi_cards or {} %}
{% set stats_total = k.total_clientes | default(0) %}
{% set stats_novas = k.total_novas | default(0) %}
{% set stats_andamento = k.total_andamento | default(0) %}
{% set stats_futuras = k.total_futuras | default(0) %}
{% set stats_paradas = k.total_paradas | default(0) %}
{% set stats_canceladas = k.total_canceladas | default(0) %}
{% set stats_finalizadas = k.total_finalizadas | default(0) %}

{% set mrr_ns = namespace(values={}) %}
{% if chart_data and chart_data.nivel_receita and chart_data.nivel_receita.labels and chart_data.nivel_receita.data %}
{% for idx in range(chart_data.nivel_receita.labels | length) %}
{% set _ = mrr_ns.values.update({ (chart_data.nivel_receita.labels[idx] | string): (chart_data.nivel_receita.data[idx] | int) }) %}
{% endfor %}
{% endif %}
{% set mrr_prata = mrr_ns.values.get('Prata (MRR < 699)', 0) %}
{% set mrr_ouro = mrr_ns.values.get('Ouro (MRR 700-999)', 0) %}
{% set mrr_platina = mrr_ns.values.get('Platina (MRR 1k-1.9k)', 0) %}
{% set mrr_diamante = mrr_ns.values.get('Diamante (MRR > 2k)', 0) %}
{% set mrr_pendente = mrr_ns.values.get('Não Definido', 0) + mrr_ns.values.get('Nao Definido', 0) %}
{% set mrr_total = mrr_prata + mrr_ouro + mrr_platina + mrr_diamante + mrr_pendente %}

<div class="gerencial-page">
    <header class="header-bg p-3 d-flex align-items-center position-relative rounded-3">
        <h1 class="main-title mb-0 fs-4 w-100 text-center">Dashboard Gerencial</h1>
        <div class="d-flex align-items-center position-absolute end-0 top-50 translate-middle-y pe-3">
            <a href="{{ url_for(current_dashboard) }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-house me-1"></i> Dashboard
            </a>
        </div>
    </header>

    <main class="gerencial-main">
        <section class="ger-card filter-card">
            <div class="card-title-row">
                <h2>Filtros Globais</h2>
                <span class="muted" id="updatedAtLabel">Atualizado: agora</span>
            </div>
            <form method="GET" action="{{ url_for('analytics.analytics_dashboard') }}" class="filters-grid">
                {% if current_task_cs_email %}
                <input type="hidden" name="task_cs_email" value="{{ current_task_cs_email }}">
                {% endif %}
                <input type="hidden" name="task_start_date" value="{{ current_task_start_date | default('') }}">
                <input type="hidden" name="task_end_date" value="{{ current_task_end_date | default('') }}">
                {% if context %}
                <input type="hidden" name="context" value="{{ context }}">
                {% endif %}

                <label class="field-wrap">
                    <span>Colaborador</span>
                    <select name="cs_email">
                        <option value="">Todos os Especialistas</option>
                        {% for cs in all_cs %}
                        <option value="{{ cs.usuario }}" {% if cs.usuario == current_cs_email %}selected{% endif %}>{{ cs.nome }}</option>
                        {% endfor %}
                    </select>
                </label>

                <label class="field-wrap">
                    <span>Status</span>
                    <select name="status_filter">
                        {% for opt in status_options %}
                        <option value="{{ opt.value }}" {% if opt.value == current_status_filter %}selected{% endif %}>{{ opt.label }}</option>
                        {% endfor %}
                    </select>
                </label>

                <label class="field-wrap">
                    <span>Início</span>
                    <div class="input-icon-wrap">
                        <input type="text" class="flatpickr-date" name="start_date" id="start_date_filter" placeholder="DD/MM/AAAA" value="{{ current_start_date or '' }}">
                        <i class="bi bi-calendar3"></i>
                    </div>
                </label>

                <label class="field-wrap">
                    <span>Fim</span>
                    <div class="input-icon-wrap">
                        <input type="text" class="flatpickr-date" name="end_date" id="end_date_filter" placeholder="DD/MM/AAAA" value="{{ current_end_date or '' }}">
                        <i class="bi bi-calendar3"></i>
                    </div>
                </label>

                <div class="filter-actions">
                    <button class="btn-apply" type="submit"><i class="bi bi-funnel"></i> Aplicar</button>
                    <a class="btn-reset" href="{{ url_for('analytics.analytics_dashboard', context=context) }}" aria-label="Limpar filtros"><i class="bi bi-arrow-clockwise"></i></a>
                </div>
            </form>
        </section>

        <section class="kpi-grid">
            <article class="kpi-card tone-total"><span>Total Clientes</span><strong>{{ stats_total }}</strong></article>
            <article class="kpi-card tone-novas"><span>Novas</span><strong>{{ stats_novas }}</strong></article>
            <article class="kpi-card tone-andamento"><span>Em Andamento</span><strong>{{ stats_andamento }}</strong></article>
            <article class="kpi-card tone-futuras"><span>Futuras</span><strong>{{ stats_futuras }}</strong></article>
            <article class="kpi-card tone-paradas"><span>Paradas</span><strong>{{ stats_paradas }}</strong></article>
            <article class="kpi-card tone-canceladas"><span>Canceladas</span><strong>{{ stats_canceladas }}</strong></article>
            <article class="kpi-card tone-finalizadas"><span>Finalizadas</span><strong>{{ stats_finalizadas }}</strong></article>
        </section>

        <section class="charts-grid">
            <article class="ger-card">
                <div class="card-title-row">
                    <h3>Carteira por MRR</h3>
                </div>
                <p class="muted">Distribuição de clientes por faixa de receita recorrente</p>

                <div class="mrr-list">
                    <div class="mrr-item"><span>Prata (MRR &lt; 699)</span><b>{{ (mrr_prata * 100 / mrr_total) | round(0) if mrr_total else 0 }}%</b><i style="--fill: {{ (mrr_prata * 100 / mrr_total) | round(2) if mrr_total else 0 }}%"></i></div>
                    <div class="mrr-item"><span>Ouro (MRR 700-999)</span><b>{{ (mrr_ouro * 100 / mrr_total) | round(0) if mrr_total else 0 }}%</b><i style="--fill: {{ (mrr_ouro * 100 / mrr_total) | round(2) if mrr_total else 0 }}%"></i></div>
                    <div class="mrr-item"><span>Platina (MRR 1k-1.9k)</span><b>{{ (mrr_platina * 100 / mrr_total) | round(0) if mrr_total else 0 }}%</b><i style="--fill: {{ (mrr_platina * 100 / mrr_total) | round(2) if mrr_total else 0 }}%"></i></div>
                    <div class="mrr-item"><span>Diamante (MRR &gt; 2k)</span><b>{{ (mrr_diamante * 100 / mrr_total) | round(0) if mrr_total else 0 }}%</b><i style="--fill: {{ (mrr_diamante * 100 / mrr_total) | round(2) if mrr_total else 0 }}%"></i></div>
                    <div class="mrr-item highlight"><span>Não Definido / Pendente</span><b>{{ mrr_pendente }} Clientes</b><i style="--fill: {{ (mrr_pendente * 100 / mrr_total) | round(2) if mrr_total else 0 }}%"></i></div>
                </div>
            </article>

            <article class="ger-card">
                <div class="card-title-row">
                    <h3>Status das Implantações</h3>
                </div>
                <p class="muted">Visão geral do pipeline de onboarding</p>
                <div class="status-chart-wrap">
                    <canvas id="chartStatusClientes" height="230"></canvas>
                </div>
            </article>
        </section>

        <section class="ger-card table-card">
            <div class="card-title-row">
                <div>
                    <h3>Produtividade por Tags</h3>
                    <p class="muted">Tarefas concluídas agrupadas por tipo de atividade</p>
                </div>
                <form method="GET" class="mini-filter">
                    {% if current_cs_email %}<input type="hidden" name="cs_email" value="{{ current_cs_email }}">{% endif %}
                    {% if current_status_filter %}<input type="hidden" name="status_filter" value="{{ current_status_filter }}">{% endif %}
                    {% if current_start_date %}<input type="hidden" name="start_date" value="{{ current_start_date }}">{% endif %}
                    {% if current_end_date %}<input type="hidden" name="end_date" value="{{ current_end_date }}">{% endif %}
                    {% if context %}<input type="hidden" name="context" value="{{ context }}">{% endif %}
                    <select name="task_cs_email">
                        <option value="">Todos os Usuários</option>
                        {% for cs in all_cs %}
                        <option value="{{ cs.usuario }}" {% if cs.usuario == current_task_cs_email %}selected{% endif %}>{{ cs.nome }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit"><i class="bi bi-funnel-fill"></i> Filtrar</button>
                </form>
            </div>

            <div class="table-wrap">
                <table class="ger-table tags-table">
                    <thead>
                        <tr>
                            <th>COLABORADOR</th>
                            <th>INTERNO</th>
                            <th>EXTERNO</th>
                            <th>AÇÃO INTERNA</th>
                            <th>REUNIÃO</th>
                            <th>NO SHOW</th>
                            <th>REGISTRO SIMPLES</th>
                            <th>TOTAL GERAL</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if tags_chart_data and tags_chart_data.labels and tags_chart_data.datasets %}
                        {% set totals = namespace(interno=0, externo=0, acao=0, reuniao=0, no_show=0, simples=0, geral=0) %}
                        {% for user_idx in range(tags_chart_data.labels|length) %}
                        {% set row = namespace(interno=0, externo=0, acao=0, reuniao=0, no_show=0, simples=0, total=0) %}
                        {% for ds in tags_chart_data.datasets %}
                        {% set label = (ds.label | default('') | lower) %}
                        {% set value = (ds.data[user_idx] | default(0) | int) %}
                        {% if 'interno' in label %}{% set row.interno = value %}{% endif %}
                        {% if 'externo' in label %}{% set row.externo = value %}{% endif %}
                        {% if 'ação interna' in label or 'acao interna' in label %}{% set row.acao = value %}{% endif %}
                        {% if 'reunião' in label or 'reuniao' in label %}{% set row.reuniao = value %}{% endif %}
                        {% if 'no show' in label %}{% set row.no_show = value %}{% endif %}
                        {% if 'simples registro' in label %}{% set row.simples = value %}{% endif %}
                        {% endfor %}
                        {% set row.total = row.interno + row.externo + row.acao + row.reuniao + row.no_show + row.simples %}
                        {% set totals.interno = totals.interno + row.interno %}
                        {% set totals.externo = totals.externo + row.externo %}
                        {% set totals.acao = totals.acao + row.acao %}
                        {% set totals.reuniao = totals.reuniao + row.reuniao %}
                        {% set totals.no_show = totals.no_show + row.no_show %}
                        {% set totals.simples = totals.simples + row.simples %}
                        {% set totals.geral = totals.geral + row.total %}

                        <tr>
                            <td>{{ tags_chart_data.labels[user_idx] }}</td>
                            <td><span class="tag-badge neutral">{{ row.interno if row.interno else '-' }}</span></td>
                            <td><span class="tag-badge neutral">{{ row.externo if row.externo else '-' }}</span></td>
                            <td><span class="tag-badge blue">{{ row.acao if row.acao else '-' }}</span></td>
                            <td><span class="tag-badge green">{{ row.reuniao if row.reuniao else '-' }}</span></td>
                            <td><span class="tag-badge amber">{{ row.no_show if row.no_show else '-' }}</span></td>
                            <td><span class="tag-badge purple">{{ row.simples if row.simples else '-' }}</span></td>
                            <td class="total-cell">{{ row.total }}</td>
                        </tr>
                        {% endfor %}
                        <tr class="consolidated-row">
                            <td>TOTAL CONSOLIDADO</td>
                            <td>{{ totals.interno }}</td>
                            <td>{{ totals.externo }}</td>
                            <td>{{ totals.acao }}</td>
                            <td>{{ totals.reuniao }}</td>
                            <td>{{ totals.no_show }}</td>
                            <td>{{ totals.simples }}</td>
                            <td><span class="pill-total">{{ totals.geral }}</span></td>
                        </tr>
                        {% else %}
                        <tr><td colspan="8" class="empty-state">Nenhum dado disponível para os filtros selecionados.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </section>

        <section class="ger-card table-card">
            <div class="card-title-row">
                <div>
                    <h3>Lista de Implantações</h3>
                    <p class="muted">Total de {{ implantacoes_lista_detalhada | length }} registros encontrados</p>
                </div>
                <div class="table-actions">
                    <button type="button" class="icon-button"><i class="bi bi-download"></i></button>
                    <button type="button" class="icon-button"><i class="bi bi-printer"></i></button>
                </div>
            </div>

            <div class="table-wrap">
                <table class="ger-table impl-table">
                    <thead>
                        <tr>
                            <th>EMPRESA</th>
                            <th>IMPLANTADOR</th>
                            <th>INÍCIO IMPL.</th>
                            <th>INÍCIO PROD.</th>
                            <th>STATUS</th>
                            <th>AÇÕES</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if implantacoes_lista_detalhada %}
                        {% for impl in implantacoes_lista_detalhada[:5] %}
                        {% set status = impl.status | default('nova') %}
                        <tr>
                            <td>{{ impl.nome_empresa | default('-') }}</td>
                            <td>{{ impl.cs_nome | default(impl.usuario_cs) | default('-') }}</td>
                            <td>{{ impl.data_criacao.strftime('%d/%m/%Y') if impl.data_criacao and impl.data_criacao.strftime is defined else (impl.data_criacao|string)[:10] | replace('-', '/') }}</td>
                            <td>{{ impl.data_inicio_efetivo.strftime('%d/%m/%Y') if impl.data_inicio_efetivo and impl.data_inicio_efetivo.strftime is defined else ((impl.data_inicio_efetivo|string)[:10] | replace('-', '/')) if impl.data_inicio_efetivo else '-' }}</td>
                            <td>
                                <span class="status-pill status-{{ status | replace('_', '-') }}">
                                    {% if status == 'andamento' %}Em Andamento{% elif status == 'finalizada' %}Concluído{% elif status == 'futura' %}Futura{% elif status == 'parada' %}Parada{% elif status == 'cancelada' %}Cancelada{% else %}Nova{% endif %}
                                </span>
                            </td>
                            <td>
                                <a href="{{ url_for((context if context and context != 'None' else 'onboarding') + '.ver_implantacao', impl_id=impl.id) }}" class="icon-link" aria-label="Visualizar"><i class="bi bi-eye-fill"></i></a>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr><td colspan="6" class="empty-state">Nenhuma implantação encontrada.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </section>

        <section class="ger-card stopped-card">
            <div class="card-title-row">
                <div>
                    <h3><span class="danger-square"><i class="bi bi-exclamation-triangle-fill"></i></span> Implantações Paradas</h3>
                    <p class="muted">Atenção requerida: {{ implantacoes_paradas_lista | length }} casos com atraso significativo</p>
                </div>
            </div>

            <div class="stopped-grid">
                <div class="table-wrap">
                    <table class="ger-table">
                        <thead>
                            <tr>
                                <th>EMPRESA</th>
                                <th>MOTIVO DO BLOQUEIO</th>
                                <th>TEMPO PARADO</th>
                                <th>DETALHES</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if implantacoes_paradas_lista %}
                            {% for item in implantacoes_paradas_lista[:3] %}
                            <tr>
                                <td>{{ item.nome_empresa | default('-') }}</td>
                                <td class="stop-motive">{{ item.motivo_parada | default('Motivo não informado') }}</td>
                                <td><span class="danger-pill">{{ item.dias_parada | default(0) }} dias</span></td>
                                <td><a href="{{ url_for((context if context and context != 'None' else 'onboarding') + '.ver_implantacao', impl_id=item.id) }}" class="text-link">Ver</a></td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr><td colspan="4" class="empty-state">Sem implantações paradas.</td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                <div class="stopped-chart-box">
                    <h4>Distribuição de Motivos</h4>
                    <div class="stopped-chart-wrap">
                        <canvas id="chartGargalos"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section class="ger-card table-card">
            <div class="card-title-row">
                <div>
                    <h3>Implantações Canceladas</h3>
                    <p class="muted">Listando {{ implantacoes_canceladas_lista | length }} implantações canceladas.</p>
                </div>
            </div>
            <div class="table-wrap">
                <table class="ger-table">
                    <thead>
                        <tr>
                            <th>EMPRESA</th>
                            <th>IMPLANTADOR</th>
                            <th>DATA DO CANCELAMENTO</th>
                            <th>AÇÕES</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if implantacoes_canceladas_lista %}
                        {% for item in implantacoes_canceladas_lista[:5] %}
                        <tr>
                            <td>{{ item.nome_empresa | default('-') }}</td>
                            <td>{{ item.cs_nome | default('-') }}</td>
                            <td>{{ item.data_cancelamento.strftime('%d/%m/%Y') if item.data_cancelamento and item.data_cancelamento.strftime is defined else ((item.data_cancelamento|string)[:10] | replace('-', '/')) if item.data_cancelamento else '-' }}</td>
                            <td>
                                <a href="{{ url_for((context if context and context != 'None' else 'onboarding') + '.ver_implantacao', impl_id=item.id) }}" class="mini-action-link">Ver</a>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr><td colspan="4" class="empty-state">Nenhuma implantação cancelada encontrada.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </section>

        <section class="ger-card table-card">
            <div class="card-title-row">
                <div>
                    <h3>Lista Detalhada de Módulos em Implantação</h3>
                </div>
            </div>
            <div class="table-wrap">
                <table class="ger-table">
                    <thead>
                        <tr>
                            <th>EMPRESA</th>
                            <th>RESPONSÁVEL</th>
                            <th>STATUS</th>
                            <th>DIAS</th>
                            <th>AÇÕES</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if modules_implantacao_lista %}
                        {% for mod in modules_implantacao_lista[:5] %}
                        {% set mod_status = mod.status | default('nova') %}
                        <tr>
                            <td>{{ mod.nome_empresa | default('-') }}</td>
                            <td>{{ mod.cs_nome | default('-') }}</td>
                            <td>
                                <span class="status-pill status-{{ mod_status | replace('_', '-') }}">
                                    {% if mod_status == 'andamento' %}Em Andamento{% elif mod_status == 'finalizada' %}Concluído{% elif mod_status == 'futura' %}Futura{% elif mod_status == 'parada' %}Parada{% elif mod_status == 'cancelada' %}Cancelada{% elif mod_status == 'sem_previsao' %}sem_previsao{% else %}Nova{% endif %}
                                </span>
                            </td>
                            <td><span class="days-pill">{{ mod.dias | default(0) }} dias</span></td>
                            <td>
                                <a href="{{ url_for((context if context and context != 'None' else 'onboarding') + '.ver_implantacao', impl_id=mod.id) }}" class="mini-action-link">Ver</a>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr><td colspan="5" class="empty-state">Nenhum módulo em implantação encontrado.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            {% if modules_implantacao_lista %}
            <div class="table-footer-note">Mostrando 1 a {{ 5 if modules_implantacao_lista|length > 5 else modules_implantacao_lista|length }} de {{ modules_implantacao_lista|length }} resultados</div>
            {% endif %}
        </section>

        <section class="ger-card chart-large-card">
            <div class="card-title-row">
                <div>
                    <h3>Ranking Implantação por Período</h3>
                    <p class="muted">Total de implantações finalizadas no ano corrente, agrupadas por mês.</p>
                </div>
            </div>
            <div class="chart-large-wrap">
                <canvas id="chartRankingPeriodo"></canvas>
            </div>
        </section>

        <section class="performance-block">
            <h3 class="perf-title">Análise de Performance &amp; Previsão</h3>
            <div class="performance-grid">
                <article class="ger-card">
                    <div class="card-title-row">
                        <h3>Velocidade de Entrega</h3>
                    </div>
                    <p class="muted">Distribuição de dias para finalizar implantações (Histograma).</p>
                    <div class="perf-chart-wrap">
                        <canvas id="chartVelocidade"></canvas>
                    </div>
                </article>
                <article class="ger-card">
                    <div class="card-title-row">
                        <h3>Previsibilidade de Entregas</h3>
                    </div>
                    <p class="muted">Previsão de término para implantações em andamento/futuras.</p>
                    <div class="perf-chart-wrap">
                        <canvas id="chartPrevisao"></canvas>
                    </div>
                </article>
            </div>
        </section>
    </main>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
(function () {
    let liveSignature = {{ (analytics_signature or '') | tojson | safe }};
    const statusData = {{ (chart_data.status_clientes if chart_data else {}) | tojson | safe }};
    const gargalosData = {{ (chart_data.gargalos_parada if chart_data else {}) | tojson | safe }};
    const rankingData = {{ (chart_data.ranking_periodo if chart_data else {}) | tojson | safe }};
    const velocidadeData = {{ (chart_data.velocidade_entrega if chart_data else {}) | tojson | safe }};
    const previsaoData = {{ (chart_data.previsao_receita if chart_data else {}) | tojson | safe }};
    const paradasList = {{ (implantacoes_paradas_lista or []) | tojson | safe }};

    function createDoughnut(id, labels, values, colors, cutout, showLegendRight, showPercent, fallbackLabels) {
        const el = document.getElementById(id);
        if (!el || !window.Chart || !Array.isArray(values) || !values.length) return;
        const resolvedLabels = (Array.isArray(labels) && labels.length === values.length && labels.every((item) => typeof item === 'string' && item.trim()))
            ? labels
            : (Array.isArray(fallbackLabels) && fallbackLabels.length >= values.length ? fallbackLabels.slice(0, values.length) : values.map((_, idx) => `Item ${idx + 1}`));
        const total = values.reduce((sum, value) => sum + Number(value || 0), 0);
        new Chart(el, {
            type: 'doughnut',
            data: {
                labels: resolvedLabels,
                datasets: [{ data: values, backgroundColor: colors, borderWidth: 0 }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: cutout || '68%',
                plugins: {
                    legend: {
                        display: true,
                        position: showLegendRight ? 'right' : 'right',
                        labels: {
                            boxWidth: 8,
                            boxHeight: 8,
                            usePointStyle: true,
                            pointStyle: 'circle',
                            padding: 12,
                            color: '#4b5563',
                            generateLabels(chart) {
                                const dataset = chart.data.datasets[0] || {};
                                const bgColors = Array.isArray(dataset.backgroundColor) ? dataset.backgroundColor : [];
                                return (chart.data.labels || []).map((label, idx) => {
                                    const value = Number(dataset.data?.[idx] || 0);
                                    const pct = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return {
                                        text: showPercent ? `${label} ${pct}%` : String(label),
                                        fillStyle: bgColors[idx] || '#94a3b8',
                                        strokeStyle: bgColors[idx] || '#94a3b8',
                                        pointStyle: 'circle',
                                        lineWidth: 0,
                                        hidden: !chart.getDataVisibility(idx),
                                        index: idx
                                    };
                                });
                            }
                        }
                    }
                }
            }
        });
    }

    function createBar(id, labels, values, color) {
        const el = document.getElementById(id);
        if (!el || !window.Chart || !Array.isArray(values) || !values.length) return;
        new Chart(el, {
            type: 'bar',
            data: {
                labels: labels || [],
                datasets: [{
                    data: values,
                    backgroundColor: color,
                    borderRadius: 8,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { color: '#9ca3af', font: { size: 11 } } },
                    y: { beginAtZero: true, grid: { color: '#eef2f7' }, ticks: { color: '#9ca3af', font: { size: 11 } } }
                }
            }
        });
    }

    function createLineArea(id, labels, values) {
        const el = document.getElementById(id);
        if (!el || !window.Chart || !Array.isArray(values) || !values.length) return;
        new Chart(el, {
            type: 'line',
            data: {
                labels: labels || [],
                datasets: [{
                    data: values,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.18)',
                    fill: true,
                    tension: 0.35,
                    pointRadius: 2,
                    pointBackgroundColor: '#3b82f6'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { color: '#9ca3af', font: { size: 11 } } },
                    y: { beginAtZero: true, grid: { color: '#eef2f7' }, ticks: { color: '#9ca3af', font: { size: 11 } } }
                }
            }
        });
    }

    createDoughnut(
        'chartStatusClientes',
        statusData.labels || [],
        statusData.data || [],
        ['#9CA3AF', '#F59E0B', '#10B981', '#3B82F6', '#EF4444', '#475569'],
        '70%',
        true,
        true,
        ['Novas', 'Em Andamento', 'Finalizadas', 'Futuras', 'Paradas', 'Canceladas']
    );

    let gargalosLabels = Array.isArray(gargalosData.labels) ? gargalosData.labels : [];
    let gargalosValues = Array.isArray(gargalosData.data) ? gargalosData.data : [];
    if (!gargalosValues.length && Array.isArray(paradasList) && paradasList.length) {
        const motivosMap = {};
        paradasList.forEach((item) => {
            const motivo = (item && item.motivo_parada) ? String(item.motivo_parada) : 'Motivo não informado';
            motivosMap[motivo] = (motivosMap[motivo] || 0) + 1;
        });
        gargalosLabels = Object.keys(motivosMap);
        gargalosValues = Object.values(motivosMap);
    }
    createDoughnut(
        'chartGargalos',
        gargalosLabels,
        gargalosValues,
        ['#EC4899', '#F97316', '#F59E0B', '#38BDF8', '#8B5CF6', '#94A3B8'],
        '58%',
        true,
        false,
        []
    );

    createLineArea(
        'chartRankingPeriodo',
        rankingData.labels || [],
        rankingData.data || []
    );

    createBar(
        'chartVelocidade',
        velocidadeData.labels || [],
        velocidadeData.data || [],
        'rgba(59, 130, 246, 0.85)'
    );

    createBar(
        'chartPrevisao',
        previsaoData.labels || [],
        previsaoData.data || [],
        'rgba(20, 184, 166, 0.72)'
    );

    if (window.flatpickr) {
        window.flatpickr('#start_date_filter', { dateFormat: 'Y-m-d', altInput: true, altFormat: 'd/m/Y', allowInput: true });
        window.flatpickr('#end_date_filter', { dateFormat: 'Y-m-d', altInput: true, altFormat: 'd/m/Y', allowInput: true });
    }

    const now = new Date();
    const hour = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    const updatedLabel = document.getElementById('updatedAtLabel');
    if (updatedLabel) updatedLabel.textContent = `Atualizado: Hoje, ${hour}`;

    async function checkLiveUpdates() {
        if (document.visibilityState !== 'visible') return;
        try {
            const qs = window.location.search || '';
            const response = await fetch(`/analytics/live/check${qs}`, {
                method: 'GET',
                credentials: 'include',
                cache: 'no-store',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (!response.ok) return;
            const payload = await response.json();
            if (!payload || !payload.ok || !payload.signature) return;

            if (!liveSignature) {
                liveSignature = payload.signature;
                return;
            }

            if (payload.signature !== liveSignature) {
                window.location.reload();
            }
        } catch (_) {
            // Silent fail: não bloquear uso da página em caso de falha de rede temporária.
        }
    }

    setInterval(checkLiveUpdates, 5000);
})();
</script>
{% endblock %}
