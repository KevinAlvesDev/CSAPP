{% extends "base.html" %}
{% from 'macros/dashboard.html' import empresa_data_attrs %}

{% block title %}Detalhes da Implantação - {{ implantacao.nome_empresa }}{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/implantacao_detalhes.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid p-4 content-wrapper" id="main-content" data-context="onboarding"
    data-implantacao-id="{{ implantacao.id }}" data-email-usuario-logado="{{ email_usuario_logado }}"
    data-email-responsavel="{{ implantacao.email_responsavel or '' }}"
    data-is-manager="{{ 'true' if g.perfil and g.perfil.get('perfil_acesso') in ['Administrador', 'Gerente', 'Coordenador'] else 'false' }}">

    <header class="header-bg p-3 d-flex align-items-center position-relative rounded-3 mb-4">
        <h1 class="main-title mb-0 fs-4 w-100 text-center">Detalhes da Implantação</h1>
        <div class="d-flex align-items-center position-absolute end-0 top-50 translate-middle-y">
            <a href="{{ url_for('onboarding.dashboard') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-house me-1"></i> Dashboard
            </a>
        </div>
    </header>

    <!-- Flash messages agora são exibidos como toasts flutuantes automaticamente -->

    <div class="row g-3">
        <!-- Sidebar (Coluna Esquerda) -->
        <div class="sidebar-column">

            <!-- Card Plano de Sucesso (Lógica Importante) -->
            {% if plano_sucesso and plano_sucesso.status != 'concluido' %}
            <div class="custom-card border-primary border-top border-4">
                <div class="custom-card-header">
                    <h5 class="custom-card-title"><i class="bi bi-diagram-3-fill me-2 text-primary"></i>Plano Atual</h5>
                    <div class="d-flex gap-1">
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
                            data-bs-target="#modalSelecionarPlano">Alterar</button>
                        <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
                            data-bs-target="#modalRemoverPlano" title="Remover plano da implantação">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="custom-card-body">
                    <h5 class="fw-bold mb-1">{{ plano_sucesso.nome }}</h5>
                    <p class="text-muted small mb-3">{{ plano_sucesso.descricao }}</p>

                    <!-- Info de datas da implantação -->
                    <div class="plano-datas-info">
                        <div class="data-item">
                            <span class="data-label"><i class="bi bi-calendar-event me-1"></i>Início</span>
                            <span class="data-value">{{ implantacao.data_inicio_efetivo_fmt_d or
                                implantacao.data_criacao_fmt_d or 'Não definido' }}</span>
                        </div>
                        {% if plano_sucesso.dias_duracao %}
                        <div class="data-item">
                            <span class="data-label"><i class="bi bi-hourglass-split me-1"></i>Duração</span>
                            <span class="data-value">{{ plano_sucesso.dias_duracao }} dias</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label"><i class="bi bi-calendar-check me-1"></i>Previsão Término</span>
                            <span class="data-value destaque">{{ implantacao.data_previsao_termino_fmt_d or
                                'Calculando...' }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% elif plano_sucesso and plano_sucesso.status == 'concluido' %}
            <div class="custom-card cta-card mb-4">
                <div class="custom-card-body text-center">
                    <div class="mb-3 text-primary">
                        <i class="bi bi-check-circle-fill" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="cta-title mb-2">Plano Concluído</h5>
                    <p class="text-muted small mb-0">O plano de sucesso foi concluído. Veja o conteúdo completo na aba
                        <strong>Plano de sucesso concluído</strong>.</p>
                </div>
            </div>
            {% else %}
            <div class="custom-card cta-card mb-4">
                <div class="custom-card-body text-center">
                    <div class="mb-3 text-danger">
                        <i class="bi bi-exclamation-circle-fill" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="cta-title mb-2">Nenhum Plano Definido</h5>
                    <p class="text-muted small mb-3">Esta implantação ainda não possui um plano de sucesso vinculado.
                        Selecione um para gerar as tarefas.</p>
                    <button class="btn btn-danger w-100 fw-bold shadow-sm" data-bs-toggle="modal"
                        data-bs-target="#modalSelecionarPlano">
                        <i class="bi bi-plus-circle me-2"></i>Selecionar Plano Agora
                    </button>
                </div>
            </div>
            {% endif %}

            <!-- Card Ações Rápidas -->
            <div class="custom-card">
                <div class="custom-card-header">
                    <h5 class="custom-card-title">Ações Rápidas</h5>
                </div>
                <div class="list-group list-group-flush">
                    <!-- Removido: Adicionar Tarefa -->
                    <button class="list-group-item list-group-item-action py-3 d-flex align-items-center gap-3" {{
                        empresa_data_attrs(implantacao) }}>
                        <div class="bg-light p-2 rounded text-info"><i class="bi bi-pencil-square"></i></div>
                        <div>
                            <h6 class="mb-0 fw-bold">Editar Detalhes</h6>
                        </div>
                    </button>

                    {% if implantacao.status == 'andamento' %}
                    <button class="list-group-item list-group-item-action py-3 d-flex align-items-center gap-3"
                        data-bs-toggle="modal" data-bs-target="#modalFinalizar">
                        <div class="bg-success bg-opacity-10 p-2 rounded text-success"><i class="bi bi-check-lg"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold text-dark">Finalizar Implantação</h6>
                        </div>
                    </button>
                    <button class="list-group-item list-group-item-action py-3 d-flex align-items-center gap-3"
                        data-bs-toggle="modal" data-bs-target="#modalParar">
                        <div class="bg-warning bg-opacity-10 p-2 rounded text-warning"><i class="bi bi-pause-fill"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold text-dark">Parar Implantação</h6>
                        </div>
                    </button>
                    <button class="list-group-item list-group-item-action py-3 d-flex align-items-center gap-3"
                        data-bs-toggle="modal" data-bs-target="#modalDesfazerInicio">
                        <div class="bg-secondary bg-opacity-10 p-2 rounded text-secondary"><i
                                class="bi bi-arrow-counterclockwise"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold text-dark">Cancelar início</h6>
                        </div>
                    </button>
                    {% elif implantacao.status == 'parada' %}
                    <button class="list-group-item list-group-item-action py-3 d-flex align-items-center gap-3"
                        data-bs-toggle="modal" data-bs-target="#modalRetomar">
                        <div class="bg-primary bg-opacity-10 p-2 rounded text-primary"><i class="bi bi-play-fill"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold text-dark">Retomar Implantação</h6>
                        </div>
                    </button>
                    {% endif %}

                    <button class="list-group-item list-group-item-action py-3 d-flex align-items-center gap-3"
                        data-bs-toggle="modal" data-bs-target="#modalTransferir">
                        <div class="bg-info bg-opacity-10 p-2 rounded text-info"><i class="bi bi-arrow-left-right"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold text-dark">Transferir Implantação</h6>
                        </div>
                    </button>

                    {% if implantacao.status != 'cancelada' %}
                    <button class="list-group-item list-group-item-action py-3 d-flex align-items-center gap-3"
                        data-bs-toggle="modal" data-bs-target="#modalCancelar">
                        <div class="bg-warning bg-opacity-10 p-2 rounded text-warning"><i class="bi bi-x-circle"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold text-dark">Cancelar Implantação</h6>
                        </div>
                    </button>
                    {% else %}
                    <button class="list-group-item list-group-item-action py-3 d-flex align-items-center gap-3"
                        data-bs-toggle="modal" data-bs-target="#modalDesfazerCancelamento">
                        <div class="bg-primary bg-opacity-10 p-2 rounded text-primary"><i
                                class="bi bi-arrow-counterclockwise"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold text-dark">Desfazer cancelamento</h6>
                        </div>
                    </button>
                    {% endif %}

                    <button class="list-group-item list-group-item-action py-3 d-flex align-items-center gap-3"
                        data-bs-toggle="modal" data-bs-target="#modalExcluirImplantacao">
                        <div class="bg-danger bg-opacity-10 p-2 rounded text-danger"><i class="bi bi-trash"></i></div>
                        <div>
                            <h6 class="mb-0 fw-bold text-dark">Excluir Implantação</h6>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Card Resumo da Empresa -->
            <div class="custom-card mt-3">
                <div class="custom-card-header border-0 pb-0">
                    <h5 class="custom-card-title d-flex align-items-center">
                        <div class="rounded-circle bg-primary bg-opacity-10 p-2 me-2 d-flex align-items-center justify-content-center"
                            style="width: 32px; height: 32px;">
                            <i class="bi bi-building text-primary"></i>
                        </div>
                        Resumo da Empresa
                    </h5>
                </div>
                <div class="custom-card-body pt-3">
                    <!-- Informações Principais -->
                    <div class="company-summary d-flex flex-column gap-3">

                        <!-- Nome da Empresa -->
                        <div class="d-flex align-items-center">
                            <div class="min-w-40px">
                                <div class="bg-primary bg-opacity-10 text-primary rounded p-2 d-inline-flex align-items-center justify-content-center"
                                    style="width: 36px; height: 36px;">
                                    <i class="bi bi-building-fill"></i>
                                </div>
                            </div>
                            <div class="ms-3">
                                <div class="text-muted small fw-semibold text-uppercase"
                                    style="font-size: 0.75rem; letter-spacing: 0.5px;">Empresa</div>
                                <div class="fw-bold text-dark">{{ implantacao.nome_empresa }}</div>
                            </div>
                        </div>

                        <!-- Status da Implantação -->
                        <div class="d-flex align-items-center">
                            <div class="min-w-40px">
                                {% set status_color = 'primary' %}
                                {% set status_icon = 'bi-activity' %}

                                {% if implantacao.status == 'nova' %}
                                {% set status_color = 'secondary' %}
                                {% set status_icon = 'bi-star-fill' %}
                                {% elif implantacao.status == 'futura' %}
                                {% set status_color = 'info' %}
                                {% set status_icon = 'bi-calendar-plus-fill' %}
                                {% elif implantacao.status == 'andamento' %}
                                {% set status_color = 'primary' %}
                                {% set status_icon = 'bi-play-circle-fill' %}
                                {% elif implantacao.status == 'parada' %}
                                {% set status_color = 'warning' %}
                                {% set status_icon = 'bi-pause-circle-fill' %}
                                {% elif implantacao.status == 'finalizada' %}
                                {% set status_color = 'success' %}
                                {% set status_icon = 'bi-check-circle-fill' %}
                                {% elif implantacao.status == 'cancelada' %}
                                {% set status_color = 'danger' %}
                                {% set status_icon = 'bi-x-circle-fill' %}
                                {% endif %}

                                <div class="bg-{{ status_color }} bg-opacity-10 text-{{ status_color }} rounded p-2 d-inline-flex align-items-center justify-content-center"
                                    style="width: 36px; height: 36px;">
                                    <i class="bi {{ status_icon }}"></i>
                                </div>
                            </div>
                            <div class="ms-3">
                                <div class="text-muted small fw-semibold text-uppercase"
                                    style="font-size: 0.75rem; letter-spacing: 0.5px;">Status</div>
                                <div>
                                    <span class="badge bg-{{ status_color }} bg-opacity-75">{{ implantacao.status|title
                                        }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Data de Início -->
                        <div class="d-flex align-items-center">
                            <div class="min-w-40px">
                                <div class="bg-info bg-opacity-10 text-info rounded p-2 d-inline-flex align-items-center justify-content-center"
                                    style="width: 36px; height: 36px;">
                                    <i class="bi bi-calendar2-week-fill"></i>
                                </div>
                            </div>
                            <div class="ms-3">
                                <div class="text-muted small fw-semibold text-uppercase"
                                    style="font-size: 0.75rem; letter-spacing: 0.5px;">Data de Início</div>
                                <div class="fw-medium">
                                    {% if implantacao.data_inicio_efetivo_fmt_d %}
                                    {{ implantacao.data_inicio_efetivo_fmt_d }} <span
                                        class="badge bg-light text-muted border ms-1">Efetivo</span>
                                    {% elif implantacao.data_inicio_previsto_fmt_d %}
                                    {{ implantacao.data_inicio_previsto_fmt_d }} <span
                                        class="badge bg-light text-muted border ms-1">Previsto</span>
                                    {% elif implantacao.data_criacao_fmt_d %}
                                    {{ implantacao.data_criacao_fmt_d }} <span
                                        class="badge bg-light text-muted border ms-1">Criação</span>
                                    {% else %}
                                    <span class="text-muted fst-italic">Não definida</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- ID Favorecido -->
                        {% if implantacao.id_favorecido %}
                        <div class="d-flex align-items-center">
                            <div class="min-w-40px">
                                <div class="bg-secondary bg-opacity-10 text-secondary rounded p-2 d-inline-flex align-items-center justify-content-center"
                                    style="width: 36px; height: 36px;">
                                    <i class="bi bi-fingerprint"></i>
                                </div>
                            </div>
                            <div class="ms-3">
                                <div class="text-muted small fw-semibold text-uppercase"
                                    style="font-size: 0.75rem; letter-spacing: 0.5px;">ID Favorecido</div>
                                <div class="font-monospace user-select-all">{{ implantacao.id_favorecido }}</div>
                            </div>
                        </div>
                        {% endif %}

                    </div>
                </div>
            </div>

            <!-- Card Responsável e Contato -->
            {% if implantacao.responsavel_cliente or implantacao.email_responsavel or implantacao.telefone_responsavel
            %}
            <div class="custom-card mt-3">
                <div class="custom-card-header border-0 pb-0">
                    <h5 class="custom-card-title d-flex align-items-center">
                        <div class="rounded-circle bg-success bg-opacity-10 p-2 me-2 d-flex align-items-center justify-content-center"
                            style="width: 32px; height: 32px;">
                            <i class="bi bi-person-lines-fill text-success"></i>
                        </div>
                        Contato
                    </h5>
                </div>
                <div class="custom-card-body pt-3">
                    <div class="d-flex flex-column gap-3">

                        <!-- Responsável -->
                        {% if implantacao.responsavel_cliente %}
                        <div class="d-flex align-items-center">
                            <div class="min-w-40px">
                                <div class="bg-success bg-opacity-10 text-success rounded p-2 d-inline-flex align-items-center justify-content-center"
                                    style="width: 36px; height: 36px;">
                                    <i class="bi bi-person-fill"></i>
                                </div>
                            </div>
                            <div class="ms-3">
                                <div class="text-muted small fw-semibold text-uppercase"
                                    style="font-size: 0.75rem; letter-spacing: 0.5px;">Responsável</div>
                                <div class="fw-medium text-dark">
                                    {{ implantacao.responsavel_cliente }}
                                    {% if implantacao.cargo_responsavel %}
                                    <span class="text-muted small">({{ implantacao.cargo_responsavel }})</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Contato (Email/Tel) -->
                        {% if implantacao.email_responsavel %}
                        <div class="d-flex align-items-center">
                            <div class="min-w-40px">
                                <div class="bg-warning bg-opacity-10 text-warning rounded p-2 d-inline-flex align-items-center justify-content-center"
                                    style="width: 36px; height: 36px;">
                                    <i class="bi bi-envelope-fill"></i>
                                </div>
                            </div>
                            <div class="ms-3">
                                <div class="text-muted small fw-semibold text-uppercase"
                                    style="font-size: 0.75rem; letter-spacing: 0.5px;">E-mail</div>
                                <div>
                                    <a href="mailto:{{ implantacao.email_responsavel }}" class="text-decoration-none">{{
                                        implantacao.email_responsavel }}</a>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if implantacao.telefone_responsavel %}
                        <div class="d-flex align-items-center">
                            <div class="min-w-40px">
                                <div class="bg-info bg-opacity-10 text-info rounded p-2 d-inline-flex align-items-center justify-content-center"
                                    style="width: 36px; height: 36px;">
                                    <i class="bi bi-telephone-fill"></i>
                                </div>
                            </div>
                            <div class="ms-3">
                                <div class="text-muted small fw-semibold text-uppercase"
                                    style="font-size: 0.75rem; letter-spacing: 0.5px;">Telefone</div>
                                <div>
                                    <a href="https://wa.me/55{{ implantacao.telefone_responsavel|replace(' ','')|replace('-','')|replace('(','')|replace(')','') }}"
                                        target="_blank" class="text-decoration-none">
                                        {{ implantacao.telefone_responsavel }} <i
                                            class="bi bi-whatsapp text-success ms-1 small"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                    </div>
                </div>
            </div>
            {% endif %}
        </div> <!-- Fecha sidebar-column -->

        <!-- Coluna Principal (Conteúdo) -->
        <div class="main-column">

            <!-- Card Unificado: Plano de Sucesso + Linha do Tempo -->
            <div class="custom-card" style="min-height: 400px;">
                <div class="custom-card-header flex-column align-items-stretch gap-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="custom-card-title mb-0">
                            <i class="bi bi-clipboard-data me-2 text-primary"></i>Acompanhamento
                        </h5>
                    </div>

                    <!-- Tabs de navegação -->
                    <ul class="nav tab-switcher" id="contentTabs" role="tablist">
                          <li class="nav-item" role="presentation">
                              <button class="nav-link {% if not plano_concluido_atual %}active{% endif %}"
                                  id="plano-andamento-tab" data-bs-toggle="tab"
                                  data-bs-target="#plano-andamento-content" type="button" role="tab"
                                  aria-selected="{{ 'true' if not plano_concluido_atual else 'false' }}">
                                  <i class="bi bi-play-circle me-1"></i>Plano de sucesso em andamento
                              </button>
                          </li>
                          <li class="nav-item" role="presentation">
                              <button class="nav-link {% if plano_concluido_atual %}active{% endif %}"
                                  id="plano-concluido-tab" data-bs-toggle="tab"
                                  data-bs-target="#plano-concluido-content" type="button" role="tab"
                                  aria-selected="{{ 'true' if plano_concluido_atual else 'false' }}">
                                  <i class="bi bi-check-circle me-1"></i>Plano de sucesso concluído
                              </button>
                          </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="timeline-tab" data-bs-toggle="tab"
                                data-bs-target="#timeline-content" type="button" role="tab">
                                <i class="bi bi-clock-history me-1"></i>Linha do Tempo
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="comments-tab" data-bs-toggle="tab"
                                data-bs-target="#comments-content" type="button" role="tab">
                                <i class="bi bi-chat-square-text me-1"></i>Comentários
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="carteira-tab" data-bs-toggle="tab"
                                data-bs-target="#carteira-content" type="button" role="tab">
                                <i class="bi bi-briefcase me-1"></i>Definição de Carteira
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="avisos-tab" data-bs-toggle="tab"
                                data-bs-target="#avisos-content" type="button" role="tab">
                                <i class="bi bi-exclamation-triangle me-1"></i>Avisos
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="jira-tab" data-bs-toggle="tab" data-bs-target="#jira-content"
                                type="button" role="tab">
                                <i class="bi bi-layers me-1"></i>Jira
                            </button>
                        </li>

                    </ul>
                </div>

                <div class="tab-content">
                    <style>
                        .custom-card .tab-content>.tab-pane:not(.active) {
                            display: none !important;
                        }

                        .custom-card .tab-content>.tab-pane.active {
                            display: block !important;
                        }
                    </style>
                    {% set progresso_atual = progresso_porcentagem if progresso_porcentagem is defined else 0 %}
                    {% set pode_concluir = progresso_atual >= 100 %}
                    {% set plano_concluido_atual = (plano_sucesso and plano_sucesso.status == 'concluido' and not is_historico_view) %}

                    <!-- Tab: Plano de Sucesso em Andamento -->
                      <div class="tab-pane fade {% if not plano_concluido_atual %}show active{% endif %}"
                          id="plano-andamento-content" role="tabpanel">
                        <div class="custom-card-body">
                            {% if plano_ativo_instancia %}
                            {% if is_historico_view %}
                            <div class="alert alert-secondary mb-3">
                                <i class="bi bi-clock-history me-2"></i>Você está visualizando o histórico do plano:
                                <strong>{{ plano_ativo_instancia.nome.split(' (Concluído')[0] }}</strong>.
                                <a href="{{ url_for('onboarding.ver_implantacao', impl_id=implantacao.id) }}"
                                    class="btn btn-sm btn-outline-dark ms-3">Voltar para Plano Atual</a>
                            </div>
                            {% endif %}

                            <div
                                class="alert alert-light border d-flex justify-content-between align-items-center mb-3 shadow-sm">
                                <div>
                                    <h5 class="alert-heading mb-1 text-primary fw-bold">{{
                                        plano_ativo_instancia.nome.split(' (Concluído')[0] }}</h5>
                                    <p class="mb-0 text-muted small">{{ plano_ativo_instancia.descricao or 'Sem
                                        descrição' }}</p>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <small class="text-muted me-2">Iniciado em: {{
                                        plano_ativo_instancia.data_criacao_fmt }}</small>

                                    {% if (is_manager or is_owner) and not is_historico_view %}
                                        <form id="formConcluirPlanoImplantacao"
                                            action="{{ url_for('onboarding_actions.concluir_plano_implantacao') }}"
                                            method="POST">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                                            <input type="hidden" name="plano_instancia_id"
                                                value="{{ plano_ativo_instancia.id }}">
                                            <button type="submit" class="btn btn-success btn-sm fw-bold"
                                                data-concluir-plano-btn {% if not pode_concluir %}disabled{% endif %}>
                                                <i class="bi bi-check-lg me-1"></i>Concluir Plano
                                            </button>
                                        </form>
                                    {% elif is_historico_view and plano_ativo_instancia.status == 'concluido' %}
                                    <span class="badge bg-success">Concluído</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% elif not plano_sucesso and planos_lista is defined and planos_lista|length > 0 %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-circle me-2"></i>Todos os planos foram concluídos.
                                Inicie um novo plano se necessário.
                            </div>

                            {# Se checklist estiver 100% e usuário for manager, oferecer botão para concluir (cria
                            instância se necessário) #}
                            {% if (is_manager or is_owner) and not is_historico_view and progresso_porcentagem is
                            defined and progresso_porcentagem >= 100 %}
                                <div class="mt-2">
                                    <form action="{{ url_for('onboarding_actions.concluir_plano_implantacao') }}"
                                        method="POST">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                                        <input type="hidden" name="plano_instancia_id" value="">
                                        <button type="submit" class="btn btn-success btn-sm fw-bold"
                                            data-concluir-plano-btn {% if not pode_concluir %}disabled{% endif %}>
                                            <i class="bi bi-check-lg me-1"></i>Concluir Plano
                                        </button>
                                    </form>
                                </div>
                            {% endif %}
                            {% endif %}

                            {% if not plano_concluido_atual %}
                            {% include 'partials/_plano_sucesso_checklist_onboarding.html' %}
                            {% else %}
                            <div class="alert alert-light border d-flex align-items-center gap-2 mb-0 shadow-sm">
                                <i class="bi bi-info-circle text-primary"></i>
                                <span>Este plano foi concluído. Veja o conteúdo completo na aba
                                    <strong>Plano de sucesso concluído</strong>.</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Tab: Plano de Sucesso Concluído -->
                      <div class="tab-pane fade {% if plano_concluido_atual %}show active{% endif %}"
                          id="plano-concluido-content" role="tabpanel">
                        <div class="custom-card-body">
                            {% if plano_concluido_atual %}
                            <div
                                class="alert alert-light border d-flex justify-content-between align-items-center mb-3 shadow-sm">
                                <div>
                                    <h5 class="alert-heading mb-1 text-primary fw-bold">{{
                                        plano_sucesso.nome.split(' (Concluído')[0] }}</h5>
                                    <p class="mb-0 text-muted small">{{ plano_sucesso.descricao or 'Sem descrição' }}</p>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <small class="text-muted me-2">Iniciado em: {{
                                        plano_sucesso.data_criacao_fmt }}</small>
                                    <span class="badge bg-success">Concluído</span>
                                </div>
                            </div>
                            {% include 'partials/_plano_sucesso_checklist_onboarding.html' %}
                            {% elif planos_lista %}
                            {% set ns = namespace(tem_concluidos=false) %}
                            <div class="list-group">
                                {% for plano in planos_lista %}
                                {% if plano.status == 'concluido' %}
                                {% set ns.tem_concluidos = true %}
                                <div
                                    class="list-group-item list-group-item-action flex-column align-items-start p-4 mb-2 border rounded shadow-sm">
                                    <div class="d-flex w-100 justify-content-between mb-2">
                                        <h5 class="mb-1 fw-bold text-success">
                                            <i class="bi bi-check-circle-fill me-2"></i>{{ plano.nome.split('
                                            (Concluído')[0] }}
                                        </h5>
                                        <small class="text-muted">Concluído em: {{ plano.data_conclusao_fmt or
                                            'N/A' }}</small>
                                    </div>
                                    <p class="mb-2 text-secondary">{{ plano.descricao or 'Sem descrição' }}</p>

                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <small class="text-muted">
                                            <i class="bi bi-calendar-event me-1"></i>Início: {{
                                            plano.data_criacao_fmt }}
                                            {% if plano.concluido_por %}
                                            <span class="ms-3"><i class="bi bi-person-check me-1"></i>Por: {{
                                                plano.concluido_por }}</span>
                                            {% endif %}
                                        </small>

                                        <button type="button" class="btn btn-outline-secondary btn-sm"
                                            onclick="abrirModalHistoricoPlano({{ plano.id }}, '{{ plano.nome|replace('\'', '\\\'') }}')">
                                            <i class="bi bi-eye me-1"></i>Visualizar Itens
                                        </button>
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>

                            {% if not ns.tem_concluidos %}
                            <div class="text-center py-5 text-muted">
                                <i class="bi bi-clipboard-x display-4 mb-3 d-block opacity-50"></i>
                                <h5>Nenhum plano concluído ainda</h5>
                                <p>Os planos finalizados aparecerão aqui.</p>
                            </div>
                            {% endif %}
                            {% else %}
                            <div class="text-center py-5 text-muted">
                                <i class="bi bi-inbox display-4 mb-3 d-block opacity-50"></i>
                                <h5>Histórico vazio</h5>
                                <p>Nenhum plano foi registrado nesta implantação ainda.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Tab: Linha do Tempo -->
                    <div class="tab-pane fade" id="timeline-content" role="tabpanel"
                        data-impl-id="{{ implantacao.id }}">
                        <div class="custom-card-body" style="max-height: calc(100vh - 350px); overflow-y: auto;">
                            <ul class="timeline-list" id="timeline-list">
                                {% if not logs_timeline %}
                                <li class="alert alert-light text-center small py-2">Nenhum evento registrado.</li>
                                {% endif %}
                                {% for log in logs_timeline %}
                                <li class="timeline-item">
                                    <div class="timeline-icon">
                                        {% if log.tipo_evento == 'novo_comentario' %} <i
                                            class="bi bi-chat-left-text-fill"></i>
                                        {% elif 'tarefa' in log.tipo_evento %} <i class="bi bi-check-circle-fill"></i>
                                        {% elif 'status' in log.tipo_evento %} <i class="bi bi-flag-fill"></i>
                                        {% else %} <i class="bi bi-info-circle-fill"></i>
                                        {% endif %}
                                    </div>
                                    <div class="timeline-content shadow-sm">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="fw-bold text-primary">{{ log.usuario_nome }}</span>
                                            <span class="small text-muted">{{ log.data_criacao_fmt_dt_hr }}</span>
                                        </div>
                                        <p class="mb-0 text-secondary">{{ log.detalhes | safe | replace('\n', '<br>') }}
                                        </p>
                                        <div class="mt-2 d-flex gap-2">
                                            {% if log.tipo_evento == 'novo_comentario' and log.related_item_id %}
                                            <button class="btn btn-sm btn-outline-primary timeline-action-comments"
                                                data-item-id="{{ log.related_item_id }}">
                                                Ver comentários
                                            </button>
                                            {% endif %}

                                        </div>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <!-- Tab: Comentários -->
                    <div class="tab-pane fade" id="comments-content" role="tabpanel">
                        <div class="custom-card-body">
                            <div id="comments-list-container" class="d-flex flex-column gap-3"
                                style="max-height: calc(100vh - 350px); overflow-y: auto;">
                                <!-- Comments will be loaded here -->
                                <div class="text-center py-5 text-muted" id="comments-loading">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Carregando...</span>
                                    </div>
                                    <p class="mt-2 small">Carregando comentários...</p>
                                </div>
                                <div class="text-center py-5 text-muted d-none" id="comments-empty">
                                    <i class="bi bi-chat-square text-secondary fs-1"></i>
                                    <p class="mt-2">Nenhum comentário encontrado nesta implantação.</p>
                                </div>
                            </div>
                            <div class="text-center mt-3 d-none" id="comments-pagination">
                                <button class="btn btn-sm btn-outline-primary" id="btn-load-more-comments">
                                    Carregar mais
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Jira -->
                    <div class="tab-pane fade" id="jira-content" role="tabpanel">
                        <div class="custom-card-body">
                            <!-- Header da Aba -->
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <h5 class="mb-1 text-dark fw-bold">Tickets Jira</h5>
                                    <p class="text-muted small mb-0">Gerencie bugs e tarefas deste cliente.</p>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <button
                                        class="btn btn-white text-secondary d-flex align-items-center gap-2 shadow-sm border"
                                        id="btn-consulta-jira" style="border-radius: 8px;">
                                        <i class="bi bi-search"></i> Consultar Jira
                                    </button>
                                    <button class="btn btn-primary d-flex align-items-center gap-2 shadow-sm"
                                        id="btn-novo-ticket-jira"
                                        style="border-radius: 8px; background-color: #4F46E5; border-color: #4F46E5;">
                                        <i class="bi bi-plus-lg"></i> Novo Item
                                    </button>
                                </div>
                            </div>

                            <div id="jira-loading" class="text-center py-5 d-none">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                                <p class="mt-2 text-muted">Sincronizando com Jira...</p>
                            </div>
                            <div id="jira-error"
                                class="alert alert-danger d-none my-3 border-0 bg-danger bg-opacity-10 text-danger rounded-3">
                            </div>
                            <div id="jira-empty" class="text-center py-5 d-none">
                                <div class="mb-3 bg-light rounded-circle d-inline-flex align-items-center justify-content-center"
                                    style="width: 64px; height: 64px;">
                                    <i class="bi bi-layers text-secondary fs-3"></i>
                                </div>
                                <h6 class="text-dark fw-bold">Nenhum ticket encontrado</h6>
                                <p class="text-muted small">Crie o primeiro ticket para iniciar o acompanhamento.</p>
                            </div>

                            <!-- Lista de Cards -->
                            <div id="jira-list-container" class="d-none">
                                <div class="d-flex justify-content-end mb-2">
                                    <button class="btn btn-sm btn-light text-muted border-0" id="btn-refresh-jira"
                                        title="Atualizar lista">
                                        <i class="bi bi-arrow-clockwise"></i> Atualizar
                                    </button>
                                </div>
                                <div class="row g-3" id="jira-cards-container">
                                    <!-- Cards serão injetados via JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Definição de Carteira -->
                    <div class="tab-pane fade" id="carteira-content" role="tabpanel">
                        <div class="custom-card-body">
                            <div class="alert alert-info mb-4">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Definição de Carteira</strong>
                                <p class="mb-0 mt-2 small">Adicione informações importantes sobre esta implantação:
                                    contatos, grupos de WhatsApp, requisitos técnicos, etc.</p>
                            </div>

                            <!-- Modo de Edição / Visualização -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">
                                    <i class="bi bi-file-text me-2"></i>Informações da Carteira
                                </h6>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="btn-edit-carteira">
                                        <i class="bi bi-pencil me-1"></i>Editar
                                    </button>
                                    <button type="button" class="btn btn-sm btn-success d-none" id="btn-save-carteira">
                                        <i class="bi bi-check-lg me-1"></i>Salvar
                                    </button>
                                    <button type="button" class="btn btn-sm btn-secondary d-none"
                                        id="btn-cancel-carteira">
                                        <i class="bi bi-x-lg me-1"></i>Cancelar
                                    </button>
                                </div>
                            </div>

                            <!-- Área de Visualização -->
                            <div id="carteira-view-mode">
                                <div class="card">
                                    <div class="card-body" id="carteira-content-display"
                                        style="min-height: 300px; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.9rem; line-height: 1.6; text-align: left; display: block;">
                                        <div class="text-muted text-center">
                                            <p class="mb-2">Nenhuma informação adicionada ainda.</p>
                                            <p class="small mb-0">Clique em "Editar" para adicionar informações sobre
                                                esta implantação.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Área de Edição -->
                            <div id="carteira-edit-mode" class="d-none">
                                <div class="mb-3">
                                    <label for="carteira-textarea" class="form-label fw-bold">
                                        Conteúdo
                                        <span class="text-muted small">(Links serão automaticamente clicáveis na
                                            visualização)</span>
                                    </label>
                                    <textarea class="form-control font-monospace" id="carteira-textarea" rows="20"
                                        placeholder="Exemplo:

1- Grupo de WhatsApp
https://chat.whatsapp.com/exemplo

2- Contato do responsável
Nome: João Silva
Telefone: (11) 99999-9999
Email: joao@exemplo.com

3- Cliente referência
Sim - Academia XYZ

4- Observações importantes
..."></textarea>
                                    <div class="form-text">
                                        <i class="bi bi-lightbulb me-1"></i>
                                        Dica: Você pode usar formatação livre. Links HTTP/HTTPS serão automaticamente
                                        convertidos em links clicáveis.
                                    </div>
                                </div>
                            </div>

                            <!-- Indicador de salvamento -->
                            <div id="carteira-save-status" class="mt-2 small text-muted d-none">
                                <i class="bi bi-clock-history me-1"></i>
                                <span id="carteira-save-text">Salvando...</span>
                            </div>
                        </div>
                    </div>


                    <!-- Tab: Avisos -->
                    <div class="tab-pane fade" id="avisos-content" role="tabpanel">
                        <div class="custom-card-body">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <h6 class="mb-1">
                                        <i class="bi bi-exclamation-triangle me-2"></i>Central de Avisos
                                    </h6>
                                    <p class="text-muted small mb-0">Alertas automáticos e avisos personalizados</p>
                                </div>
                                <button type="button" class="btn btn-sm btn-primary" id="btn-add-aviso">
                                    <i class="bi bi-plus-circle me-1"></i>Adicionar Aviso
                                </button>
                            </div>

                            <!-- Avisos Automáticos do Sistema -->
                            <div class="mb-4">
                                <h6 class="fw-bold mb-3 text-muted small">
                                    <i class="bi bi-robot me-1"></i>AVISOS AUTOMÁTICOS DO SISTEMA
                                </h6>
                                <div id="avisos-sistema">
                                    {% if implantacao.status == 'parada' %}
                                    <div class="alert alert-danger d-flex align-items-start" role="alert">
                                        <i class="bi bi-exclamation-octagon-fill fs-4 me-3 flex-shrink-0"></i>
                                        <div>
                                            <h6 class="alert-heading mb-2">Implantação Parada</h6>
                                            <p class="mb-1">Esta implantação está parada desde {{
                                                implantacao.data_parada_fmt if implantacao.data_parada_fmt else 'data
                                                não disponível' }}.</p>
                                            {% if implantacao.motivo_parada %}
                                            <p class="mb-0"><strong>Motivo:</strong> {{ implantacao.motivo_parada }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    {% if not plano_sucesso %}
                                    <div class="alert alert-warning d-flex align-items-start" role="alert">
                                        <i class="bi bi-exclamation-triangle-fill fs-4 me-3 flex-shrink-0"></i>
                                        <div>
                                            <h6 class="alert-heading mb-2">Plano de Sucesso Não Definido</h6>
                                            <p class="mb-0">Esta implantação ainda não possui um plano de sucesso
                                                vinculado. Selecione um plano para gerar as tarefas.</p>
                                        </div>
                                    </div>
                                    {% endif %}

                                    {% if implantacao.progresso and implantacao.progresso < 20 and
                                        implantacao.dias_passados and implantacao.dias_passados> 15 %}
                                        <div class="alert alert-warning d-flex align-items-start" role="alert">
                                            <i class="bi bi-clock-fill fs-4 me-3 flex-shrink-0"></i>
                                            <div>
                                                <h6 class="alert-heading mb-2">Progresso Baixo</h6>
                                                <p class="mb-0">Esta implantação está há {{ implantacao.dias_passados }}
                                                    dias em andamento com apenas {{ implantacao.progresso }}% de
                                                    progresso.</p>
                                            </div>
                                        </div>
                                        {% endif %}

                                        {% if implantacao.data_previsao_termino and implantacao.atrasada %}
                                        <div class="alert alert-danger d-flex align-items-start" role="alert">
                                            <i class="bi bi-calendar-x-fill fs-4 me-3 flex-shrink-0"></i>
                                            <div>
                                                <h6 class="alert-heading mb-2">Prazo Vencido</h6>
                                                <p class="mb-0">A previsão de término era {{
                                                    implantacao.data_previsao_termino_fmt_d }}. Esta implantação está
                                                    atrasada.</p>
                                            </div>
                                        </div>
                                        {% endif %}

                                        {% if implantacao.status != 'parada' and plano_sucesso and (not
                                        implantacao.progresso or implantacao.progresso >= 20 or not
                                        implantacao.dias_passados or implantacao.dias_passados <= 15) and (not
                                            implantacao.atrasada) %} <div
                                            class="alert alert-success d-flex align-items-start" role="alert">
                                            <i class="bi bi-check-circle-fill fs-4 me-3 flex-shrink-0"></i>
                                            <div>
                                                <h6 class="alert-heading mb-2">Tudo em Ordem</h6>
                                                <p class="mb-0">Não há avisos ou alertas críticos para esta implantação
                                                    no momento.</p>
                                            </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Avisos Personalizados -->
                        <div>
                            <h6 class="fw-bold mb-3 text-muted small">
                                <i class="bi bi-person-fill me-1"></i>AVISOS PERSONALIZADOS
                            </h6>
                            <div id="avisos-personalizados-list">
                                <!-- Avisos serão carregados aqui via JavaScript -->
                                <div class="text-center py-4 text-muted" id="avisos-loading">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Carregando...</span>
                                    </div>
                                    <p class="mt-2 small">Carregando avisos...</p>
                                </div>
                                <div class="alert alert-info d-none" id="avisos-empty">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Nenhum aviso personalizado adicionado. Clique em "Adicionar Aviso" para criar um.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
</div>
</div> <!-- Fecha main-column -->
</div> <!-- Fecha row g-3 -->

<!-- Modal Adicionar/Editar Aviso -->
<div class="modal fade" id="modalAviso" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header-bg">
                <h5 class="modal-title" id="modalAvisoLabel">Adicionar Aviso</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formAviso">
                    <input type="hidden" id="aviso-id" value="">

                    <div class="mb-3">
                        <label for="aviso-tipo" class="form-label">Tipo de Aviso</label>
                        <select class="form-select" id="aviso-tipo" required>
                            <option value="info">Informação (Azul)</option>
                            <option value="warning">Atenção (Amarelo)</option>
                            <option value="danger">Urgente (Vermelho)</option>
                            <option value="success">Sucesso (Verde)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="aviso-titulo" class="form-label">Título</label>
                        <input type="text" class="form-control" id="aviso-titulo" placeholder="Ex: Reunião agendada"
                            maxlength="100" required>
                    </div>

                    <div class="mb-3">
                        <label for="aviso-mensagem" class="form-label">Mensagem</label>
                        <textarea class="form-control" id="aviso-mensagem" rows="4" placeholder="Descreva o aviso..."
                            maxlength="500" required></textarea>
                        <div class="form-text">
                            <span id="aviso-char-count">0</span>/500 caracteres
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer header-bg">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-save-aviso">Salvar Aviso</button>
            </div>
        </div>
    </div>
</div>


<!-- Offcanvas Mobile Sidebar (Menu de Ações) -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="mobileSidebar">
    <div class="offcanvas-header bg-light">
        <h5 class="offcanvas-title">Menu de Ações</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        <div class="d-grid gap-2">
            <button class="btn btn-outline-dark" {{ empresa_data_attrs(implantacao) }}>
                Editar Detalhes
            </button>
            <!-- Mais botões mobile aqui se necessário -->
        </div>
    </div>
</div>

<!-- Modais Originais (Preservados para manter funcionalidade) -->
<!-- Modal Detalhes Empresa -->
<!-- Modal Remover Plano (com opção de comentários) -->
<div class="modal fade" id="modalRemoverPlano" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Remover Plano</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja remover o plano <strong>{{ plano_sucesso.nome if plano_sucesso else ''
                        }}</strong> desta implantação?</p>
                <p class="text-muted small mb-3">
                    <i class="bi bi-info-circle me-1"></i>
                    Esta ação irá remover todas as fases, ações e tarefas associadas a este plano.
                </p>

                <!-- Seção de comentários (aparece apenas se houver comentários) -->
                <div id="remover-plano-comentarios-section" class="d-none">
                    <hr>
                    <div class="alert alert-warning mb-3">
                        <i class="bi bi-chat-left-text me-2"></i>
                        <strong>Atenção:</strong> Esta implantação possui <span id="remover-plano-count"></span>
                        comentário(s).
                    </div>
                    <p class="mb-2"><strong>O que deseja fazer com os comentários?</strong></p>
                    <div class="d-flex flex-column gap-2">
                        <div class="form-check border rounded p-3">
                            <input class="form-check-input" type="radio" name="acao_comentarios" id="manter_comentarios"
                                value="manter" checked>
                            <label class="form-check-label" for="manter_comentarios">
                                <strong><i class="bi bi-check-circle text-success me-1"></i> Manter comentários</strong>
                                <br><small class="text-muted">Os comentários serão preservados na aba
                                    "Comentários"</small>
                            </label>
                        </div>
                        <div class="form-check border rounded p-3">
                            <input class="form-check-input" type="radio" name="acao_comentarios"
                                id="excluir_comentarios" value="excluir">
                            <label class="form-check-label" for="excluir_comentarios">
                                <strong><i class="bi bi-trash text-danger me-1"></i> Excluir comentários</strong>
                                <br><small class="text-muted">Todos os comentários serão removidos
                                    permanentemente</small>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarRemoverPlano"
                    data-implantacao-id="{{ implantacao.id }}">
                    <i class="bi bi-trash me-1"></i>Confirmar Remoção
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        'use strict';

        const modalRemoverPlano = document.getElementById('modalRemoverPlano');
        if (!modalRemoverPlano) return;

        const comentariosSection = document.getElementById('remover-plano-comentarios-section');
        const comentariosCount = document.getElementById('remover-plano-count');
        const btnConfirmar = document.getElementById('btnConfirmarRemoverPlano');

        // Quando o modal abrir, verificar se há comentários
        modalRemoverPlano.addEventListener('show.bs.modal', async function () {
            const implantacaoId = btnConfirmar.dataset.implantacaoId;

            try {
                const contagem = await window.apiFetch(`/planos/implantacao/${implantacaoId}/comentarios/count`);
                if (contagem.success && contagem.total > 0) {
                    comentariosCount.textContent = contagem.total;
                    comentariosSection.classList.remove('d-none');
                } else {
                    comentariosSection.classList.add('d-none');
                }
            } catch (e) {
                console.warn('Erro ao contar comentários:', e);
                comentariosSection.classList.add('d-none');
            }
        });

        // Ao confirmar remoção
        btnConfirmar.addEventListener('click', async function () {
            const implantacaoId = this.dataset.implantacaoId;
            const originalText = this.innerHTML;

            // Verificar ação selecionada para os comentários
            const radioExcluir = document.getElementById('excluir_comentarios');
            const excluirComentarios = radioExcluir && radioExcluir.checked;

            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Removendo...';

            try {
                const response = await window.apiFetch(`/planos/implantacao/${implantacaoId}/plano`, {
                    method: 'DELETE',
                    body: JSON.stringify({
                        excluir_comentarios: excluirComentarios
                    })
                });

                if (response.success) {
                    const msg = excluirComentarios
                        ? 'Plano removido e comentários excluídos.'
                        : 'Plano removido. Comentários preservados na aba "Comentários".';
                    if (window.showToast) window.showToast(msg, 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    throw new Error(response.error || 'Erro ao remover plano');
                }
            } catch (error) {
                this.disabled = false;
                this.innerHTML = originalText;
                // apiFetch já mostra toast de erro
            }
        });
    })();
</script>



<!-- Modal Finalizar -->
<div class="modal fade" id="modalFinalizar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header-bg">
                <h5 class="modal-title">Finalizar Implantação</h5><button type="button" class="btn-close"
                    data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('onboarding_actions.finalizar_implantacao') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <p class="mb-2"><i class="bi bi-exclamation-triangle-fill me-2"></i><strong>Regra
                                Obrigatória:</strong></p>
                        <ul class="mb-0 ps-3">
                            <li>O <strong>Plano de Sucesso</strong> deve estar concluído e arquivado no histórico.</li>
                            <li>Não podem existir tarefas pendentes na aba "Plano de Sucesso".</li>
                        </ul>
                    </div>
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <input type="hidden" name="redirect_to" value="detalhes">
                    <div class="mb-3">
                        <label for="data_finalizacao" class="form-label fw-bold">Data da Finalização *</label>
                        <div class="input-group">
                            <input type="text" class="form-control custom-datepicker date-mask no-datepicker"
                                id="data_finalizacao" name="data_finalizacao" required placeholder="DD/MM/AAAA">
                            <button class="btn btn-outline-secondary" type="button" id="btn_cal_data_finalizacao"><i
                                    class="bi bi-calendar3"></i></button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Confirmar Finalização</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Parar -->
<div class="modal fade" id="modalParar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header-bg">
                <h5 class="modal-title">Parar Implantação</h5><button type="button" class="btn-close"
                    data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('onboarding_actions.parar_implantacao') }}" method="POST"
                id="formPararImplantacao">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <div class="mb-3">
                        <label for="data_parada" class="form-label fw-bold">Data da Parada *</label>
                        <input type="text" class="form-control" id="data_parada" name="data_parada" required
                            placeholder="DD/MM/AAAA">
                        <small class="text-danger d-none" id="data_parada_error">A data da parada é obrigatória.</small>
                    </div>
                    <div class="mb-3">
                        <label for="motivo_parada" class="form-label">Motivo *</label>
                        <select class="form-select" id="motivo_parada" name="motivo_parada" required>
                            <option value="">Selecione...</option>
                            {% for motivo in justificativas_parada %}
                            <option value="{{ motivo }}">{{ motivo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Parar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Retomar -->
<div class="modal fade" id="modalRetomar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header-bg">
                <h5 class="modal-title">Retomar Implantação</h5><button type="button" class="btn-close"
                    data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('onboarding_actions.retomar_implantacao') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <p>Deseja retomar esta implantação e alterar o status para "Em Andamento"?</p>
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <input type="hidden" name="redirect_to" value="detalhes">
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Retomar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Desfazer Início -->
<div class="modal fade" id="modalDesfazerInicio" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title"><i class="bi bi-arrow-counterclockwise me-2"></i>Cancelar Início</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja cancelar o início da implantação?</p>
                <p class="text-muted small mb-0">
                    <i class="bi bi-info-circle me-1"></i>
                    O status voltará para "Nova" e a data de início será removida.
                </p>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-confirmar-desfazer-inicio">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Reabrir -->
<div class="modal fade" id="modalReabrir" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header-bg">
                <h5 class="modal-title">Reabrir Implantação</h5><button type="button" class="btn-close"
                    data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('onboarding_actions.reabrir_implantacao') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <p>A implantação voltará para o status "Em Andamento". Confirmar?</p>
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <input type="hidden" name="redirect_to" value="detalhes">
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">Reabrir</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Adicionar Tarefa - DESABILITADO: endpoint 'actions.adicionar_tarefa' não implementado
<div class="modal fade" id="adicionarTarefaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header-bg">
                <h5 class="modal-title">Adicionar Tarefa Avulsa</h5><button type="button" class="btn-close"
                    data-bs-dismiss="modal"></button>
            </div>
            <form action="#" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <div class="mb-3">
                        <label class="form-label">Nome da Tarefa</label>
                        <input type="text" class="form-control" name="tarefa_filho" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Módulo (Grupo)</label>
                        <select class="form-select" name="tarefa_pai" required>
                            <option value="">Selecione...</option>
                            {% for modulo in todos_modulos %}
                            <option value="{{ modulo }}">{{ modulo }}</option>
                            {% endfor %}
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tag</label>
                        <select class="form-select" name="tag">
                            <option value="Ação interna">Ação interna</option>
                            <option value="Reunião">Reunião</option>
                            <option value="Configuração">Configuração</option>
                            <option value="Rede">Rede</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" disabled title="Funcionalidade não implementada">Adicionar</button>
                </div>
            </form>
        </div>
    </div>
</div>
-->

<!-- Modal Transferir -->
<div class="modal fade" id="modalTransferir" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header-bg">
                <h5 class="modal-title">Transferir CS</h5><button type="button" class="btn-close"
                    data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('onboarding_actions.transferir_implantacao') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <p>Transferir <strong>{{ implantacao.nome_empresa }}</strong> de <strong>{{ implantacao.usuario_cs
                            }}</strong> para:</p>
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <div class="mb-3">
                        <label class="form-label">Novo CS</label>
                        <select class="form-select" name="novo_usuario_cs" required>
                            <option value="">Selecione...</option>
                            {% for user in all_cs_users %}
                            {% if user.usuario != implantacao.usuario_cs %}
                            <option value="{{ user.usuario }}">{{ user.nome }} ({{ user.usuario }})</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-info text-white">Confirmar Transferência</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Excluir -->
<div class="modal fade" id="modalExcluirImplantacao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header-bg">
                <h5 class="modal-title text-danger">Excluir Implantação</h5><button type="button" class="btn-close"
                    data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('onboarding_actions.excluir_implantacao') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <h5 class="text-danger fw-bold"><i class="bi bi-exclamation-octagon-fill me-2"></i>Atenção!
                        Irreversível!</h5>
                    <p>Tem certeza que deseja excluir permanentemente a implantação de <strong>{{
                            implantacao.nome_empresa }}</strong>?</p>
                    <p class="text-muted small">Todos os dados, tarefas e histórico serão perdidos.</p>
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Excluir Permanentemente</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Cancelar -->
<div class="modal fade" id="modalCancelar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header-bg">
                <h5 class="modal-title text-danger">Cancelar Implantação</h5><button type="button" class="btn-close"
                    data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('onboarding_actions.cancelar_implantacao') }}" method="POST"
                enctype="multipart/form-data" id="formCancelarImplantacao">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <p class="fw-bold">Deseja realmente cancelar esta implantação?</p>
                    <input type="hidden" name="implantacao_id" value="{{ implantacao.id }}">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Data do Cancelamento *</label>
                        <input type="text" class="form-control" id="data_cancelamento" name="data_cancelamento" required
                            placeholder="DD/MM/AAAA">
                        <small class="text-danger d-none" id="data_cancelamento_error">A data do cancelamento é
                            obrigatória.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Motivo *</label>
                        <textarea class="form-control" name="motivo_cancelamento" rows="3" required
                            placeholder="Descreva o motivo..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Comprovante (Print/PDF) *</label>
                        <input type="file" class="form-control" name="comprovante_cancelamento"
                            accept="image/*, application/pdf" required>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Voltar</button>
                    <button type="submit" class="btn btn-danger">Confirmar Cancelamento</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Desfazer Cancelamento -->
<div class="modal fade" id="modalDesfazerCancelamento" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header-bg">
                <h5 class="modal-title">Desfazer Cancelamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja desfazer o cancelamento desta implantação?</p>
                <p class="text-muted small">O status retornará para <strong>Em Andamento</strong> e os dados de
                    cancelamento serão removidos.</p>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Voltar</button>
                <button type="button" class="btn btn-primary"
                    id="btn-confirmar-desfazer-cancelamento">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Dados do checklist para renderização
    window.CHECKLIST_DATA = {{ checklist_tree | tojson if checklist_tree else '[]' }};
    window.IMPLANTACAO_ID = {{ implantacao.id }};
    window.IS_HISTORICO_VIEW = {{ 'true' if is_historico_view else 'false' }};
    window.PLANO_PERMITE_EXCLUIR_TAREFAS = {{ 'true' if plano_sucesso and plano_sucesso.get('permite_excluir_tarefas') else 'false' }};
</script>

<!-- Service Layer Scripts (SOLID architecture) -->
<script src="{{ url_for('static', filename='js/core/service-container.js') }}"></script>
<script src="{{ url_for('static', filename='js/services/api-service.js') }}"></script>
<script src="{{ url_for('static', filename='js/services/notification-service.js') }}"></script>
<script src="{{ url_for('static', filename='js/services/checklist-api.js') }}"></script>
<script src="{{ url_for('static', filename='js/services/checklist-service.js') }}"></script>
<script>
    // Inicializa serviços após carregamento
    if (window.initializeServices) {
        window.initializeServices();
    }

    // Auto-switch to active plan tab (which shows historical items) if viewing historical plan
    document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('plano_historico_id')) {
            const checklistTab = document.getElementById('plano-andamento-tab');
            if (checklistTab) {
                const tab = new bootstrap.Tab(checklistTab);
                tab.show();
            }
        }
    });
</script>

<script src="{{ url_for('static', filename='js/components/checklist/checklist_drag_drop.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/checklist/checklist_comments.js') }}"></script>
<script
    src="{{ url_for('static', filename='js/components/checklist_renderer.js') }}?v={{ range(1, 10000) | random }}"></script>

<script src="{{ url_for('static', filename='js/utils/checklist_comments_ui.js') }}"></script>
<script src="{{ url_for('static', filename='js/utils/drag_drop_visual_patch.js') }}"></script>
<script src="{{ url_for('static', filename='js/utils/placeholder_drop_fix.js') }}"></script>


<script src="{{ url_for('static', filename='js/pages/implantacao_detalhes_ui.js') }}"></script>

<!-- Modal Selecionar Plano (Externo) -->
{% include 'partials/_modal_selecionar_plano.html' %}

<!-- Modal Detalhes da Empresa -->
{% include 'modals/_detalhes_empresa.html' %}

<!-- Modal Consultar Ticket Jira -->
<div class="modal fade" id="modalConsultarTicketJira" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 12px;">
            <div class="modal-header border-0 pb-0 pt-4 px-4 align-items-center">
                <h5 class="modal-title fw-bold text-dark text-start w-100">Consultar Ticket Jira</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="formConsultarTicketJira">
                    <div class="form-group">
                        <label class="form-label fw-bold text-secondary style=" font-size: 0.85rem;">CHAVE DO
                            TICKET</label>
                        <input type="text" class="form-control form-control-lg" id="jira-consulta-key"
                            placeholder="Ex: M1-1234" required style="text-transform: uppercase;">
                    </div>
                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-primary btn-lg"
                            style="background-color: #4F46E5; border-color: #4F46E5;">
                            <span id="btn-consulta-jira-spinner" class="spinner-border spinner-border-sm me-2 d-none"
                                role="status" aria-hidden="true"></span>
                            Buscar Ticket
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Novo Ticket Jira -->
<div class="modal fade" id="modalNovoTicketJira" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 12px;">
            <!-- Header Minimalista -->
            <div class="modal-header border-0 pb-0 pt-4 px-4 align-items-center">
                <div class="d-flex flex-column">
                    <h5 class="modal-title fw-bold text-dark fs-4">Novo item</h5>
                    <div class="d-flex gap-3 mt-3">
                        <!-- Etiquetas de topo (Visuais) -->
                        <div class="d-flex align-items-center text-primary bg-primary bg-opacity-10 px-3 py-1 rounded-pill small"
                            role="button">
                            <i class="bi bi-calendar-event me-2"></i> <span class="fw-semibold">Vencimento</span>
                        </div>
                        <div class="d-flex align-items-center text-primary bg-primary bg-opacity-10 px-3 py-1 rounded-pill small"
                            role="button">
                            <i class="bi bi-person me-2"></i> <span class="fw-semibold">{{ g.user.name if g.user and
                                g.user.name else 'Responsável' }}</span>
                        </div>
                        <div class="d-flex align-items-center text-muted bg-light px-3 py-1 rounded-pill small"
                            role="button">
                            <i class="bi bi-tag me-2"></i> <span>Etiquetas</span>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-close align-self-start mt-1" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>

            <div class="modal-body px-4 pt-4 pb-4">
                <form id="formNovoTicketJira">
                    <div class="vstack gap-4">

                        <!-- Título -->
                        <div class="form-group">
                            <label class="form-label fw-bold text-secondary" style="font-size: 0.85rem;">Título <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-lg" id="jira-titulo"
                                placeholder="Resumo do problema ou tarefa" required style="font-size: 1rem;">
                        </div>

                        <!-- Descrição -->
                        <div class="form-group position-relative">
                            <label class="form-label fw-bold text-secondary"
                                style="font-size: 0.85rem;">Descrição</label>
                            <textarea class="form-control p-3" id="jira-descricao" rows="5"
                                placeholder="Descreva os detalhes..."
                                style="resize: vertical; font-size: 0.95rem;"></textarea>
                            <div class="text-end text-muted mt-1" style="font-size: 0.75rem;">0/8000</div>
                        </div>

                        <!-- Anexos -->
                        <div class="form-group">
                            <label class="form-label fw-bold text-secondary" style="font-size: 0.85rem;">Anexos
                                (Arquivos/Prints)</label>
                            <input type="file" class="form-control" id="jira-arquivos" multiple>
                            <div class="form-text text-muted" style="font-size: 0.75rem;">Você pode selecionar múltiplos
                                arquivos para anexar ao ticket.</div>
                        </div>

                        <!-- Contatos & Origem -->
                        <div class="row g-3">
                            <div class="col-12 col-md-6">
                                <label class="form-label fw-bold text-secondary"
                                    style="font-size: 0.85rem;">Contatos</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0 ps-3"><i
                                            class="bi bi-search text-muted small"></i></span>
                                    <input type="text" class="form-control" id="jira-contatos"
                                        placeholder="Nome do contato" style="font-size: 0.95rem;">
                                </div>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="form-group position-relative">
                                    <label class="form-label fw-bold text-secondary" style="font-size: 0.85rem;">Ticket
                                        Origem</label>
                                    <input type="text" class="form-control" id="jira-origem" placeholder="Ex: #1234"
                                        style="font-size: 0.95rem;">
                                    <div class="text-end text-muted position-absolute end-0 bottom-50 pe-3 mb-1"
                                        style="font-size: 0.7rem;">0/2000</div>
                                </div>
                            </div>
                        </div>

                        <!-- Configurações Jira (Selects) -->
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-bold text-secondary" style="font-size: 0.85rem;">Projeto
                                    Jira <span class="text-danger">*</span></label>
                                <select class="form-select" id="jira-projeto" required style="font-size: 0.95rem;">
                                    <option value="" selected disabled>Selecione...</option>
                                    <option value="M1">M1 - ADM / CRM / Notas</option>
                                    <option value="MJ">MJ - MIGRAÇÃO JOÃO</option>
                                    <option value="M5">M5 - DESKTOP</option>
                                    <option value="GC">GC - GRANDES CONTAS</option>
                                    <option value="PAY">PAY - PACTOPAY</option>
                                    <option value="TW">TW - TREINO</option>
                                    <option value="IN">IN - INFRA</option>
                                    <option value="APPS">APPS - APLICATIVOS</option>
                                    <option value="E2">E2 - MIGRAÇÃO LUIZ</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold text-secondary" style="font-size: 0.85rem;">Tipo do
                                    Jira <span class="text-danger">*</span></label>
                                <select class="form-select" id="jira-tipo" required style="font-size: 0.95rem;">
                                    <option value="10021" selected>Bug</option>
                                    <option value="10055">Ajuste BD</option>
                                    <option value="10062">Evolução / Melhoria</option>
                                    <option value="10057">Customização</option>
                                    <option value="10019">Tarefa</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold text-secondary" style="font-size: 0.85rem;">SLA do Jira
                                    <span class="text-danger">*</span></label>
                                <select class="form-select" id="jira-sla" required style="font-size: 0.95rem;">
                                    <option value="" selected disabled>Selecione...</option>
                                    <option value="1">Nível 1 - Alto</option>
                                    <option value="2">Nível 2 - Normal</option>
                                    <option value="3">Nível 3 - Baixo</option>
                                </select>
                            </div>
                        </div>

                        <!-- Info Readonly Jira -->
                        <div class="form-group">
                            <label class="form-label fw-bold text-secondary" style="font-size: 0.85rem;">Jira (ID
                                Gerado)</label>
                            <input type="text" class="form-control bg-light border-0 text-muted"
                                value="Gerado automaticamente" disabled readonly
                                style="font-size: 0.95rem; font-style: italic;">
                        </div>

                        <!-- Link E-notas -->
                        <div class="form-group position-relative">
                            <label class="form-label fw-bold text-secondary" style="font-size: 0.85rem;">Link do ticket
                                E-notas</label>
                            <input type="url" class="form-control" id="jira-link-enotas" placeholder="https://..."
                                style="font-size: 0.95rem;">
                            <div class="text-end text-muted position-absolute end-0 bottom-50 pe-3 mb-1"
                                style="font-size: 0.7rem;">0/2000</div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Footer -->
            <div class="modal-footer border-0 px-4 pb-4 pt-0">
                <button type="button" class="btn btn-outline-secondary border-0 fw-semibold px-3"
                    data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="formNovoTicketJira" class="btn btn-primary px-4 fw-bold shadow-sm"
                    style="background-color: #4F46E5; border-color: #4F46E5; border-radius: 8px;">
                    <span class="d-none spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"
                        id="btn-save-jira-spinner"></span>
                    Salvar
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Modal Histórico Plano -->
<div class="modal fade" id="modalHistoricoPlano" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold" id="modalHistoricoPlanoTitle">Histórico do Plano</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0" id="modalHistoricoPlanoBody">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Carregando itens do histórico...</p>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
    function abrirModalHistoricoPlano(planoId, planoNome) {
        // Usar bootstrap globalmente ou via window
        const modalEl = document.getElementById('modalHistoricoPlano');
        const modalInstance = new bootstrap.Modal(modalEl);

        const safePlanoNome = String(planoNome).replace(/\s*\(Conclu[íi]do.*\)\s*$/i, '');
        document.getElementById('modalHistoricoPlanoTitle').innerHTML = `<i class="bi bi-clock-history me-2 text-primary"></i>Itens do Plano: <span class="text-primary">${safePlanoNome}</span>`;
        const body = document.getElementById('modalHistoricoPlanoBody');
        body.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-3 text-muted">Buscando estrutura do plano...</p></div>';

        modalInstance.show();

        fetch(`/api/checklist/tree?plano_id=${planoId}&format=nested`)
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    renderizarChecklistNoModal(body, data.items);
                } else {
                    body.innerHTML = `<div class="p-4"><div class="alert alert-danger border-0 shadow-sm"><i class="bi bi-exclamation-triangle me-2"></i>Erro ao carregar itens: ${data.error || 'Erro desconhecido'}</div></div>`;
                }
            })
            .catch(err => {
                body.innerHTML = `<div class="p-4"><div class="alert alert-danger border-0 shadow-sm"><i class="bi bi-exclamation-triangle me-2"></i>Erro de conexão: ${err.message}</div></div>`;
            });
    }

    function renderizarChecklistNoModal(container, items) {
        if (!items || items.length === 0) {
            container.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-inbox fs-1 d-block mb-2"></i>Nenhum item encontrado neste plano.</div>';
            return;
        }

        let html = '<div class="list-group list-group-flush">';

        // Converte várias formas de timestamp para DD/MM/AAAA
        function formatDateBR(dateStr) {
            if (!dateStr) return '';
            // Aceita formatos: "YYYY-MM-DD HH:MM:SS...", "YYYY-MM-DDTHH:MM:SSZ" ou apenas "YYYY-MM-DD"
            const m = dateStr.match(/(\d{4})-(\d{2})-(\d{2})/);
            if (m) return `${m[3]}/${m[2]}/${m[1]}`;
            return dateStr;
        }

        function processItem(item, level = 0) {
            const padding = level * 25;
            const isCompleted = item.completed;
            const hasChildren = item.children && item.children.length > 0;

            html += `
                <div class="list-group-item py-2 border-bottom" style="padding-left: ${padding + 15}px !important; background-color: ${level === 0 ? '#f8f9fa' : 'transparent'}">
                    <div class="d-flex align-items-center gap-3">
                        <div class="flex-shrink-0">
                            <i class="bi ${isCompleted ? 'bi-check-circle-fill text-success' : 'bi-circle text-muted'}" style="font-size: 1.1rem;"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="${level === 0 ? 'fw-bold text-dark' : 'text-secondary'} ${isCompleted ? 'text-decoration-line-through opacity-75' : ''}">${item.title}</div>
                            ${item.comment ? `<div class="small text-muted mt-1 fst-italic"><i class="bi bi-chat-dots me-1"></i>${item.comment}</div>` : ''}
                        </div>
                        ${item.responsavel ? `<div class="badge bg-light text-dark border small fw-normal">${item.responsavel}</div>` : ''}
                        ${item.data_conclusao ? `<div class="text-muted small">${formatDateBR(item.data_conclusao)}</div>` : ''}
                    </div>
                </div>
            `;

            if (hasChildren) {
                item.children.forEach(child => processItem(child, level + 1));
            }
        }

        items.forEach(item => processItem(item));
        html += '</div>';
        container.innerHTML = html;
    }
</script>

{% endblock %}

{% block scripts_extra %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="{{ url_for('static', filename='js/utils/modal_cleanup.js') }}"></script>
<script src="{{ url_for('static', filename='js/pages/carteira_editor.js') }}"></script>
<script src="{{ url_for('static', filename='js/components/avisos_manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/utils/comment_image_patch.js') }}"></script>
<script src="{{ url_for('static', filename='js/utils/comment_image_upload.js') }}"></script>
<script src="{{ url_for('static', filename='js/pages/checklist_finalizacao.js') }}"></script>
{% endblock %}
/* cabeçalho e linhas continuam com flex; larguras são controladas pelos wrappers de coluna */
