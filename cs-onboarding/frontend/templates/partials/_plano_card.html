<div class="plano-card {% if not plano.ativo %}inactive{% endif %}">
    <div class="plano-card-header">
        <div class="flex-grow-1">
            <h3 class="plano-card-title">
                <i class="bi bi-diagram-3 me-2"></i>{{ plano.nome }}
            </h3>
            <span class="plano-status-badge {% if plano.ativo %}active{% else %}inactive{% endif %}">
                {% if plano.ativo %}
                <i class="bi bi-check-circle-fill me-1"></i>Ativo
                {% else %}
                <i class="bi bi-archive-fill me-1"></i>Inativo
                {% endif %}
            </span>
        </div>
    </div>

    <p class="plano-description">
        {{ plano.descricao or 'Sem descrição' }}
    </p>

    <div class="plano-meta">
        <div class="plano-meta-item">
            <i class="bi bi-person-fill"></i>
            <span>{{ plano.criado_por or 'Sistema' }}</span>
        </div>
        <div class="plano-meta-item">
            <i class="bi bi-calendar-fill"></i>
            <span>{{ plano.data_criacao|format_date_br if plano.data_criacao else 'N/A' }}</span>
        </div>
    </div>

    <div class="plano-actions">
        {% if pode_editar %}
        <a href="{{ url_for('planos.obter_plano', plano_id=plano.id) }}?modo=editar"
            class="btn btn-plano btn-plano-primary" title="Editar plano">
            <i class="bi bi-pencil"></i>Editar
        </a>
        {% endif %}

        <button type="button" class="btn btn-plano btn-plano-secondary" data-bs-toggle="modal"
            data-bs-target="#modalPreviewPlano{{ plano.id }}" title="Preview da estrutura">
            <i class="bi bi-list-nested"></i>Preview
        </button>

        {% if pode_excluir %}
        <button type="button" class="btn btn-plano btn-plano-danger btn-excluir-plano" data-bs-toggle="modal"
            data-bs-target="#modalExcluirPlano" data-plano-id="{{ plano.id }}" data-plano-nome="{{ plano.nome }}"
            title="Excluir plano">
            <i class="bi bi-trash"></i>Excluir
        </button>
        {% endif %}
    </div>
</div>

<div class="modal fade" id="modalPreviewPlano{{ plano.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title">
                    <i class="bi bi-diagram-3 me-2"></i>{{ plano.nome }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="previewContent{{ plano.id }}">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2 text-muted">Carregando preview...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <a href="{{ url_for('planos.obter_plano', plano_id=plano.id) }}" class="btn btn-primary">
                    <i class="bi bi-eye me-1"></i>Ver Detalhes Completos
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const modal{{ plano.id }} = document.getElementById('modalPreviewPlano{{ plano.id }}');
        if (modal{{ plano.id }}) {
            modal{{ plano.id }}.addEventListener('show.bs.modal', function () {
                const previewContent = document.getElementById('previewContent{{ plano.id }}');

                fetch('/planos/{{ plano.id }}/preview')
                    .then(response => response.text())
                    .then(html => {
                        previewContent.innerHTML = html;
                    })
                    .catch(error => {
                        previewContent.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Erro ao carregar preview: ${error.message}
                            </div>
                        `;
                    });
            });
        }
    });
</script>
