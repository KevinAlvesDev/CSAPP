name: Tests & Quality

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ==============================================
  # LINTING E FORMATA√á√ÉO
  # ==============================================
  lint:
    name: üîç Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ruff
        run: pip install ruff

      - name: Ruff Lint
        run: ruff check backend/ --output-format=github

      - name: Ruff Format Check
        run: ruff format backend/ --check

  # ==============================================
  # SEGURAN√áA
  # ==============================================
  security:
    name: üõ°Ô∏è Security Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Bandit
        run: pip install "bandit[toml]"

      - name: Run Bandit
        run: bandit -c pyproject.toml -r backend/ --quiet

  # ==============================================
  # TESTES UNIT√ÅRIOS
  # ==============================================
  test:
    name: üß™ Tests
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-mock

      - name: Run Tests
        env:
          SECRET_KEY: "test-secret-key-for-ci"
          USE_SQLITE_LOCALLY: "True"
          FLASK_ENV: "testing"
          AUTH0_ENABLED: "false"
          DEBUG: "True"
        run: |
          pytest tests/ \
            --cov=backend/project \
            --cov-report=xml \
            --cov-report=term-missing \
            -v \
            --tb=short

      - name: Upload Coverage Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

      # Descomentar quando tiver conta no Codecov
      # - name: Upload to Codecov
      #   uses: codecov/codecov-action@v4
      #   with:
      #     file: coverage.xml
      #     fail_ci_if_error: false

  # ==============================================
  # TYPE CHECKING
  # ==============================================
  typecheck:
    name: üîí Type Check
    runs-on: ubuntu-latest
    continue-on-error: true  # Non-blocking at√© cobertura total de types
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install mypy types-requests
      - name: Run Mypy
        run: mypy backend/project/common backend/project/core backend/project/config --check-untyped-defs --ignore-missing-imports

